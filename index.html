<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jyotish Vidya — Vedic Astrology</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Newsreader:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#FAFAF7;--bg-card:#FFFFFF;--bg-card2:#F8F7F4;
  --saffron:#D4710A;--saffron-light:#E8873A;--indigo:#4A3580;--indigo-light:#7B68AE;
  --text:#2D2B3D;--text-dim:#6B6880;--text-bright:#1A1828;
  --accent-red:#DC4A38;--accent-blue:#2563EB;--accent-green:#0D9488;
  --border:rgba(0,0,0,0.08);--glow:rgba(74,53,128,0.1);
}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:linear-gradient(165deg,#FAFAF7 0%,#FFF5EB 50%,#F5F0FF 100%);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:15px;line-height:1.6}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 10%,rgba(232,135,58,0.04) 0%,transparent 50%),radial-gradient(ellipse at 80% 90%,rgba(74,53,128,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}

.container{max-width:1100px;margin:0 auto;padding:0 24px;position:relative;z-index:1}

/* HEADER */
header{text-align:center;padding:48px 0 32px;border-bottom:1px solid var(--border)}
header h1{font-family:'Plus Jakarta Sans',sans-serif;font-size:2.6em;font-weight:700;background:linear-gradient(135deg,var(--saffron),#B85A00,var(--indigo));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1px}
header p{font-family:'Newsreader',serif;font-size:1.15em;color:var(--text-dim);margin-top:6px;font-style:italic;letter-spacing:0.5px}
.om-symbol{font-size:1.6em;color:var(--saffron);margin-bottom:8px;display:block}

/* SECTIONS */
.section{margin:32px 0;padding:32px;background:var(--bg-card);border-radius:20px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 16px rgba(0,0,0,0.03)}
.section-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:1.3em;font-weight:600;color:var(--saffron);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-title .icon{font-size:1.2em}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media(max-width:700px){.form-grid{grid-template-columns:1fr}}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;font-weight:500}
.form-group input,.form-group select{background:#F5F4F0;border:1px solid var(--border);color:var(--text-bright);padding:12px 14px;border-radius:12px;font-size:0.95em;font-family:'Inter',sans-serif;transition:border 0.3s,box-shadow 0.3s;outline:none}
.form-group input:focus,.form-group select:focus{border-color:var(--saffron);box-shadow:0 0 0 3px rgba(212,113,10,0.1)}
.form-group input::placeholder{color:var(--text-dim);opacity:0.6}
.city-wrapper{position:relative}
.city-dropdown{position:absolute;top:100%;left:0;right:0;background:#FFFFFF;border:1px solid var(--border);border-radius:0 0 12px 12px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.08)}
.city-dropdown.active{display:block}
.city-option{padding:12px 14px;cursor:pointer;font-size:0.88em;border-bottom:1px solid var(--border);transition:background 0.2s;-webkit-tap-highlight-color:rgba(212,113,10,0.1);touch-action:manipulation}
.city-option:hover,.city-option:active{background:rgba(212,113,10,0.06)}
.city-option .country{color:var(--text-dim);font-size:0.82em}

.btn-generate{grid-column:1/-1;margin-top:8px;padding:14px 32px;background:linear-gradient(135deg,var(--saffron),#B85A00);color:#FFFFFF;font-family:'Plus Jakarta Sans',sans-serif;font-size:1.05em;font-weight:600;border:none;border-radius:14px;cursor:pointer;letter-spacing:1px;transition:all 0.3s;text-transform:uppercase;-webkit-tap-highlight-color:rgba(212,113,10,0.2);touch-action:manipulation}
.btn-generate:hover,.btn-generate:active{box-shadow:0 4px 20px rgba(212,113,10,0.25);transform:translateY(-1px)}

/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:24px;flex-wrap:wrap;border-bottom:2px solid var(--border);padding-bottom:0}
.tab{padding:12px 20px;background:transparent;color:var(--text-dim);border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.88em;font-weight:500;cursor:pointer;letter-spacing:0.5px;transition:all 0.3s;border-bottom:2px solid transparent;position:relative;bottom:-2px;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.tab:hover{color:var(--text)}
.tab.active{color:var(--saffron);border-bottom-color:var(--saffron);font-weight:600}
.tab-content{display:none;animation:fadeIn 0.4s ease}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* CHART */
.chart-toggle{display:flex;gap:8px;margin-bottom:20px;justify-content:center}
.chart-toggle button{padding:8px 20px;background:var(--bg-card2);border:1px solid var(--border);color:var(--text-dim);border-radius:24px;cursor:pointer;font-size:0.85em;transition:all 0.3s}
.chart-toggle button.active{background:rgba(212,113,10,0.08);border-color:var(--saffron);color:var(--saffron);font-weight:500}
.chart-container{display:flex;justify-content:center;padding:20px 0}
.chart-container svg{filter:drop-shadow(0 2px 12px rgba(0,0,0,0.06))}
.chart-info{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:24px}
@media(max-width:600px){.chart-info{grid-template-columns:1fr}}
.chart-info-card{background:var(--bg-card2);padding:14px 18px;border-radius:14px;border:1px solid var(--border)}
.chart-info-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.85em;font-weight:600;margin-bottom:6px}
.chart-info-card p{font-size:0.9em;color:var(--text);line-height:1.6}

/* PLANETS TABLE */
.planets-table{width:100%;border-collapse:collapse;font-size:0.88em}
.planets-table th{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-weight:600;text-align:left;padding:12px 10px;border-bottom:2px solid var(--border);font-size:0.82em;letter-spacing:1px;text-transform:uppercase}
.planets-table td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
.planets-table tr:hover td{background:rgba(212,113,10,0.03)}
.planet-symbol{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;font-size:0.85em;font-weight:600;margin-right:8px}
.planet-name{font-weight:500;color:var(--text-bright)}
.retro{color:var(--accent-red);font-size:0.75em;font-weight:600;margin-left:4px}
.nakshatra-badge{background:rgba(74,53,128,0.08);padding:3px 10px;border-radius:12px;font-size:0.82em;color:var(--indigo)}

/* DASHA */
.dasha-controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.dasha-controls label{font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
.dasha-controls select{background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;font-size:0.88em;outline:none}
.dasha-controls select:focus{border-color:var(--saffron)}
.dasha-timeline{position:relative;padding-left:28px}
.dasha-period{position:relative;margin-bottom:4px;border-left:2px solid var(--border);padding:0 0 0 20px}
.dasha-period::before{content:'';position:absolute;left:-6px;top:14px;width:10px;height:10px;border-radius:50%;border:2px solid var(--saffron);background:#FFFFFF}
.dasha-period.current::before{background:var(--saffron);box-shadow:0 0 8px rgba(212,113,10,0.3)}
.dasha-header{cursor:pointer;padding:12px 16px;background:var(--bg-card2);border-radius:12px;border:1px solid var(--border);transition:all 0.3s;display:flex;justify-content:space-between;align-items:center}
.dasha-header:hover{border-color:rgba(212,113,10,0.2);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.dasha-header.current{border-color:var(--saffron);background:rgba(212,113,10,0.04)}
.dasha-planet{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600}
.dasha-dates{font-size:0.8em;color:var(--text-dim)}
.dasha-body{padding:16px;display:none;margin:4px 0 8px;background:var(--bg-card2);border-radius:0 0 12px 12px;border:1px solid var(--border);border-top:none}
.dasha-body.open{display:block}
.dasha-body p{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.75;color:var(--text);margin-bottom:10px}
.sub-dasha{margin-top:12px}
.sub-dasha-item{display:flex;justify-content:space-between;padding:8px 12px;border-radius:8px;font-size:0.84em;border-bottom:1px solid var(--border)}
.sub-dasha-item:hover{background:rgba(212,113,10,0.03)}
.sub-dasha-item.current{background:rgba(212,113,10,0.06);border:1px solid rgba(212,113,10,0.15);border-radius:8px}

/* TRANSITS */
.transit-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:600px){.transit-grid{grid-template-columns:1fr}}
.transit-card{background:var(--bg-card2);padding:16px;border-radius:14px;border:1px solid var(--border);transition:all 0.3s}
.transit-card:hover{border-color:rgba(212,113,10,0.15);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.transit-planet{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600;margin-bottom:6px}
.transit-sign{font-size:0.88em;color:var(--indigo)}
.transit-house{font-size:0.82em;color:var(--text-dim);margin-top:2px}
.transit-effect{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text);margin-top:10px;line-height:1.65;padding-top:10px;border-top:1px solid var(--border)}

/* REMEDIES */
.remedy-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media(max-width:800px){.remedy-grid{grid-template-columns:1fr 1fr}}
@media(max-width:500px){.remedy-grid{grid-template-columns:1fr}}
.remedy-card{background:var(--bg-card2);padding:18px;border-radius:14px;border:1px solid var(--border);transition:all 0.3s}
.remedy-card:hover{border-color:rgba(212,113,10,0.15);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.05)}
.remedy-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.9em;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.remedy-item{display:flex;gap:8px;margin-bottom:8px;font-size:0.88em;line-height:1.5}
.remedy-label{color:var(--text-dim);min-width:80px;font-size:0.8em;text-transform:uppercase;letter-spacing:0.5px}
.remedy-value{color:var(--text)}
.remedy-priority{display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-left:auto}
.priority-high{background:rgba(220,74,56,0.08);color:#DC4A38}
.priority-medium{background:rgba(212,113,10,0.08);color:var(--saffron)}
.priority-low{background:rgba(13,148,136,0.08);color:#0D9488}

/* CHART READING */
.reading-section{background:var(--bg-card2);border-radius:16px;border:1px solid var(--border);padding:24px 28px;transition:all 0.3s}
.reading-section:hover{border-color:rgba(212,113,10,0.12);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.reading-section h3{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:1.05em;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:10px}
.reading-section h3 .rs-icon{font-size:1.3em}
.reading-section .reading-body{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.8;color:var(--text)}
.reading-section .reading-body b{color:var(--text-bright)}

/* TRANSIT ALERTS */
.transit-alert{padding:16px 20px;border-radius:14px;margin-bottom:12px;font-size:0.92em;line-height:1.6}
.transit-alert.high{background:rgba(220,74,56,0.05);border:1px solid rgba(220,74,56,0.15);color:var(--text)}
.transit-alert.normal{background:rgba(74,53,128,0.04);border:1px solid rgba(74,53,128,0.1)}
.transit-alert h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);margin-bottom:8px;font-size:0.95em;font-weight:600}
.transit-alert p{font-family:'Newsreader',serif;font-size:1.02em;line-height:1.7;color:var(--text)}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(74,53,128,0.15);border-radius:3px}

/* RESULTS AREA */
#results{display:none}
#results.visible{display:block}

/* LOADING */
.loading{text-align:center;padding:40px;color:var(--saffron)}
.loading .spinner{display:inline-block;width:40px;height:40px;border:3px solid rgba(212,113,10,0.15);border-top-color:var(--saffron);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* FOOTER */
footer{text-align:center;padding:32px 0;color:var(--text-dim);font-size:0.78em;border-top:1px solid var(--border);margin-top:40px}
footer span{color:var(--saffron)}

/* STARS BACKGROUND - hidden in light theme */
.stars{display:none}
.star{display:none}

/* YOGAS */
.yoga-list{display:flex;flex-direction:column;gap:10px}
.yoga-item{background:var(--bg-card2);padding:14px 18px;border-radius:12px;border:1px solid var(--border)}
.yoga-name{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.9em;font-weight:600}
.yoga-desc{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text);margin-top:6px;line-height:1.65}

/* YEARLY FORECAST */
.year-overview{background:linear-gradient(135deg,rgba(212,113,10,0.04),rgba(74,53,128,0.04));border:1px solid var(--border);border-radius:16px;padding:24px 28px}
.year-overview h3{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:1.1em;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:10px}
.year-overview .overview-body{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.8;color:var(--text)}
.quarter-card{background:var(--bg-card2);border-radius:14px;border:1px solid var(--border);padding:20px 24px;transition:all 0.3s}
.quarter-card:hover{border-color:rgba(212,113,10,0.12);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.quarter-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-size:0.95em;font-weight:600;margin-bottom:4px}
.quarter-card .q-dates{font-size:0.8em;color:var(--text-dim);margin-bottom:12px}
.quarter-card .q-dasha{font-size:0.82em;color:var(--saffron);font-weight:500;margin-bottom:10px;padding:6px 12px;background:rgba(212,113,10,0.05);border-radius:8px;display:inline-block}
.quarter-card .q-body{font-family:'Newsreader',serif;font-size:1em;line-height:1.75;color:var(--text)}
.year-area{background:var(--bg-card2);border-radius:14px;border:1px solid var(--border);padding:20px 24px}
.year-area h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.year-area .area-body{font-family:'Newsreader',serif;font-size:1em;line-height:1.75;color:var(--text)}

.hidden{display:none!important}
.flex-center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div class="stars" id="stars"></div>

<div class="container">
  <header>
    <span class="om-symbol">&#x0950;</span>
    <h1>Jyotish Vidya</h1>
    <p>The Sacred Science of Vedic Astrology</p>
  </header>

  <!-- BIRTH DETAILS INPUT -->
  <div class="section" id="inputSection">
    <div class="section-title"><span class="icon">&#9788;</span> Birth Details</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Date of Birth</label>
        <input type="date" id="dob" value="1990-01-15">
      </div>
      <div class="form-group">
        <label>Time of Birth</label>
        <input type="time" id="tob" value="06:30" step="60">
      </div>
      <div class="form-group city-wrapper">
        <label>City of Birth</label>
        <input type="text" id="city" placeholder="Start typing a city..." autocomplete="off">
        <div class="city-dropdown" id="cityDropdown"></div>
        <input type="hidden" id="cityLat">
        <input type="hidden" id="cityLon">
        <input type="hidden" id="cityTz">
      </div>
      <button class="btn-generate" id="btnGenerate" onclick="generateChart()">&#9788; Generate Kundali</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <!-- SUMMARY -->
    <div class="section" id="summarySection">
      <div class="section-title"><span class="icon">&#9733;</span> Birth Chart Summary</div>
      <div class="chart-info" id="summaryInfo"></div>
    </div>

    <!-- TABS -->
    <div class="section" id="mainSection">
      <div class="tabs" id="mainTabs">
        <button class="tab active" data-tab="chart">Kundali Chart</button>
        <button class="tab" data-tab="reading">Chart Reading</button>
        <button class="tab" data-tab="planets">Planets &amp; Nakshatras</button>
        <button class="tab" data-tab="dasha">Dasha Predictions</button>
        <button class="tab" data-tab="transits">Current Transits</button>
        <button class="tab" data-tab="yearly">Yearly Forecast</button>
        <button class="tab" data-tab="remedies">Remedies</button>
      </div>

      <!-- CHART TAB -->
      <div class="tab-content active" id="tab-chart">
        <div class="chart-toggle">
          <button class="active" onclick="setChartStyle('north')">North Indian</button>
          <button onclick="setChartStyle('south')">South Indian</button>
        </div>
        <div class="chart-container" id="chartContainer"></div>
      </div>

      <!-- CHART READING TAB -->
      <div class="tab-content" id="tab-reading">
        <div id="chartReadingContainer" style="display:flex;flex-direction:column;gap:20px"></div>
      </div>

      <!-- PLANETS TAB -->
      <div class="tab-content" id="tab-planets">
        <div style="overflow-x:auto">
          <table class="planets-table" id="planetsTable"></table>
        </div>
        <div style="margin-top:28px">
          <div class="section-title" style="font-size:1.1em"><span class="icon">&#10038;</span> Yogas in Chart</div>
          <div class="yoga-list" id="yogaList"></div>
        </div>
      </div>

      <!-- DASHA TAB -->
      <div class="tab-content" id="tab-dasha">
        <div class="dasha-controls">
          <label>Granularity:</label>
          <select id="dashaGranularity" onchange="renderDasha()">
            <option value="maha">Mahadasha (Major Periods)</option>
            <option value="antar">Antardasha (Sub-Periods)</option>
            <option value="pratyantar">Pratyantardasha (Sub-Sub)</option>
          </select>
          <label style="margin-left:12px">Jump to Age:</label>
          <select id="dashaAge" onchange="jumpToDashaAge()">
          </select>
        </div>
        <div class="dasha-timeline" id="dashaTimeline"></div>
      </div>

      <!-- TRANSITS TAB -->
      <div class="tab-content" id="tab-transits">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Current planetary positions and their influence on your natal chart</p>
        <div id="transitAlerts" style="margin-bottom:20px"></div>
        <div class="transit-grid" id="transitGrid"></div>
        <div id="transitDeepReading" style="margin-top:24px"></div>
      </div>

      <!-- YEARLY FORECAST TAB -->
      <div class="tab-content" id="tab-yearly">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
          <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500">Select Year</label>
          <select id="yearSelect" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderYearPrediction()">
          </select>
          <span id="yearDashaLabel" style="font-size:0.85em;color:var(--indigo);font-weight:500"></span>
        </div>
        <div id="yearPredictionContainer" style="display:flex;flex-direction:column;gap:20px"></div>
      </div>

      <!-- REMEDIES TAB -->
      <div class="tab-content" id="tab-remedies">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Personalized remedies based on planetary strengths and afflictions in your chart</p>
        <div class="remedy-grid" id="remedyGrid"></div>
      </div>
    </div>
  </div>

  <footer>Crafted with reverence for the ancient wisdom of <span>Jyotish Shastra</span></footer>
</div>

<script>
// ============================================================
//  JYOTISH VIDYA — Complete Vedic Astrology Engine
// ============================================================

// ---- CONSTANTS ----
const DEG = Math.PI / 180;
const RAD = 180 / Math.PI;

// ---- CITY DATABASE ----
const CITIES = [
  {name:"New Delhi",country:"India",lat:28.6139,lon:77.2090,tz:5.5},
  {name:"Mumbai",country:"India",lat:19.0760,lon:72.8777,tz:5.5},
  {name:"Kolkata",country:"India",lat:22.5726,lon:88.3639,tz:5.5},
  {name:"Chennai",country:"India",lat:13.0827,lon:80.2707,tz:5.5},
  {name:"Bangalore",country:"India",lat:12.9716,lon:77.5946,tz:5.5},
  {name:"Hyderabad",country:"India",lat:17.3850,lon:78.4867,tz:5.5},
  {name:"Pune",country:"India",lat:18.5204,lon:73.8567,tz:5.5},
  {name:"Ahmedabad",country:"India",lat:23.0225,lon:72.5714,tz:5.5},
  {name:"Jaipur",country:"India",lat:26.9124,lon:75.7873,tz:5.5},
  {name:"Lucknow",country:"India",lat:26.8467,lon:80.9462,tz:5.5},
  {name:"Varanasi",country:"India",lat:25.3176,lon:82.9739,tz:5.5},
  {name:"Patna",country:"India",lat:25.6093,lon:85.1376,tz:5.5},
  {name:"Bhopal",country:"India",lat:23.2599,lon:77.4126,tz:5.5},
  {name:"Chandigarh",country:"India",lat:30.7333,lon:76.7794,tz:5.5},
  {name:"Kochi",country:"India",lat:9.9312,lon:76.2673,tz:5.5},
  {name:"Thiruvananthapuram",country:"India",lat:8.5241,lon:76.9366,tz:5.5},
  {name:"Srinagar",country:"India",lat:34.0837,lon:74.7973,tz:5.5},
  {name:"Indore",country:"India",lat:22.7196,lon:75.8577,tz:5.5},
  {name:"Nagpur",country:"India",lat:21.1458,lon:79.0882,tz:5.5},
  {name:"Coimbatore",country:"India",lat:11.0168,lon:76.9558,tz:5.5},
  {name:"Amritsar",country:"India",lat:31.6340,lon:74.8723,tz:5.5},
  {name:"Visakhapatnam",country:"India",lat:17.6868,lon:83.2185,tz:5.5},
  {name:"Guwahati",country:"India",lat:26.1445,lon:91.7362,tz:5.5},
  {name:"Dehradun",country:"India",lat:30.3165,lon:78.0322,tz:5.5},
  {name:"Mangalore",country:"India",lat:12.9141,lon:74.8560,tz:5.5},
  {name:"Mysore",country:"India",lat:12.2958,lon:76.6394,tz:5.5},
  {name:"Ujjain",country:"India",lat:23.1765,lon:75.7885,tz:5.5},
  {name:"Rishikesh",country:"India",lat:30.0869,lon:78.2676,tz:5.5},
  {name:"Agra",country:"India",lat:27.1767,lon:78.0081,tz:5.5},
  {name:"Jodhpur",country:"India",lat:26.2389,lon:73.0243,tz:5.5},
  {name:"Udaipur",country:"India",lat:24.5854,lon:73.7125,tz:5.5},
  {name:"Surat",country:"India",lat:21.1702,lon:72.8311,tz:5.5},
  {name:"Kanpur",country:"India",lat:26.4499,lon:80.3319,tz:5.5},
  {name:"Goa",country:"India",lat:15.2993,lon:74.1240,tz:5.5},
  {name:"Ranchi",country:"India",lat:23.3441,lon:85.3096,tz:5.5},
  {name:"Bhubaneswar",country:"India",lat:20.2961,lon:85.8245,tz:5.5},
  {name:"Raipur",country:"India",lat:21.2514,lon:81.6296,tz:5.5},
  {name:"New York",country:"USA",lat:40.7128,lon:-74.0060,tz:-5},
  {name:"Los Angeles",country:"USA",lat:34.0522,lon:-118.2437,tz:-8},
  {name:"Chicago",country:"USA",lat:41.8781,lon:-87.6298,tz:-6},
  {name:"San Francisco",country:"USA",lat:37.7749,lon:-122.4194,tz:-8},
  {name:"Houston",country:"USA",lat:29.7604,lon:-95.3698,tz:-6},
  {name:"London",country:"UK",lat:51.5074,lon:-0.1278,tz:0},
  {name:"Toronto",country:"Canada",lat:43.6532,lon:-79.3832,tz:-5},
  {name:"Vancouver",country:"Canada",lat:49.2827,lon:-123.1207,tz:-8},
  {name:"Sydney",country:"Australia",lat:-33.8688,lon:151.2093,tz:11},
  {name:"Melbourne",country:"Australia",lat:-37.8136,lon:144.9631,tz:11},
  {name:"Dubai",country:"UAE",lat:25.2048,lon:55.2708,tz:4},
  {name:"Singapore",country:"Singapore",lat:1.3521,lon:103.8198,tz:8},
  {name:"Tokyo",country:"Japan",lat:35.6762,lon:139.6503,tz:9},
  {name:"Hong Kong",country:"China",lat:22.3193,lon:114.1694,tz:8},
  {name:"Beijing",country:"China",lat:39.9042,lon:116.4074,tz:8},
  {name:"Bangkok",country:"Thailand",lat:13.7563,lon:100.5018,tz:7},
  {name:"Kuala Lumpur",country:"Malaysia",lat:3.1390,lon:101.6869,tz:8},
  {name:"Colombo",country:"Sri Lanka",lat:6.9271,lon:79.8612,tz:5.5},
  {name:"Kathmandu",country:"Nepal",lat:27.7172,lon:85.3240,tz:5.75},
  {name:"Dhaka",country:"Bangladesh",lat:23.8103,lon:90.4125,tz:6},
  {name:"Lahore",country:"Pakistan",lat:31.5204,lon:74.3587,tz:5},
  {name:"Karachi",country:"Pakistan",lat:24.8607,lon:67.0011,tz:5},
  {name:"Islamabad",country:"Pakistan",lat:33.6844,lon:73.0479,tz:5},
  {name:"Nairobi",country:"Kenya",lat:-1.2921,lon:36.8219,tz:3},
  {name:"Johannesburg",country:"South Africa",lat:-26.2041,lon:28.0473,tz:2},
  {name:"Berlin",country:"Germany",lat:52.5200,lon:13.4050,tz:1},
  {name:"Paris",country:"France",lat:48.8566,lon:2.3522,tz:1},
  {name:"Amsterdam",country:"Netherlands",lat:52.3676,lon:4.9041,tz:1},
  {name:"Zurich",country:"Switzerland",lat:47.3769,lon:8.5417,tz:1},
  {name:"Moscow",country:"Russia",lat:55.7558,lon:37.6173,tz:3},
  {name:"Cairo",country:"Egypt",lat:30.0444,lon:31.2357,tz:2},
  {name:"Lagos",country:"Nigeria",lat:6.5244,lon:3.3792,tz:1},
  {name:"Seoul",country:"South Korea",lat:37.5665,lon:126.9780,tz:9},
  {name:"Jakarta",country:"Indonesia",lat:-6.2088,lon:106.8456,tz:7},
  {name:"Manila",country:"Philippines",lat:14.5995,lon:120.9842,tz:8},
  {name:"Champaign",country:"USA",lat:40.1164,lon:-88.2434,tz:-6},
  {name:"Austin",country:"USA",lat:30.2672,lon:-97.7431,tz:-6},
  {name:"Seattle",country:"USA",lat:47.6062,lon:-122.3321,tz:-8},
  {name:"Boston",country:"USA",lat:42.3601,lon:-71.0589,tz:-5},
  {name:"Atlanta",country:"USA",lat:33.7490,lon:-84.3880,tz:-5},
  {name:"Denver",country:"USA",lat:39.7392,lon:-104.9903,tz:-7},
  {name:"Miami",country:"USA",lat:25.7617,lon:-80.1918,tz:-5},
  {name:"Washington DC",country:"USA",lat:38.9072,lon:-77.0369,tz:-5},
  {name:"Philadelphia",country:"USA",lat:39.9526,lon:-75.1652,tz:-5},
  {name:"Dallas",country:"USA",lat:32.7767,lon:-96.7970,tz:-6},
  {name:"San Diego",country:"USA",lat:32.7157,lon:-117.1611,tz:-8},
  {name:"Phoenix",country:"USA",lat:33.4484,lon:-112.0740,tz:-7},
];

// ---- RASHIS (Signs) ----
const RASHIS = [
  {name:"Mesha",eng:"Aries",symbol:"\u2648",lord:"Mars",element:"Fire",quality:"Movable"},
  {name:"Vrishabha",eng:"Taurus",symbol:"\u2649",lord:"Venus",element:"Earth",quality:"Fixed"},
  {name:"Mithuna",eng:"Gemini",symbol:"\u264A",lord:"Mercury",element:"Air",quality:"Dual"},
  {name:"Karka",eng:"Cancer",symbol:"\u264B",lord:"Moon",element:"Water",quality:"Movable"},
  {name:"Simha",eng:"Leo",symbol:"\u264C",lord:"Sun",element:"Fire",quality:"Fixed"},
  {name:"Kanya",eng:"Virgo",symbol:"\u264D",lord:"Mercury",element:"Earth",quality:"Dual"},
  {name:"Tula",eng:"Libra",symbol:"\u264E",lord:"Venus",element:"Air",quality:"Movable"},
  {name:"Vrischika",eng:"Scorpio",symbol:"\u264F",lord:"Mars",element:"Water",quality:"Fixed"},
  {name:"Dhanu",eng:"Sagittarius",symbol:"\u2650",lord:"Jupiter",element:"Fire",quality:"Dual"},
  {name:"Makara",eng:"Capricorn",symbol:"\u2651",lord:"Saturn",element:"Earth",quality:"Movable"},
  {name:"Kumbha",eng:"Aquarius",symbol:"\u2652",lord:"Saturn",element:"Air",quality:"Fixed"},
  {name:"Meena",eng:"Pisces",symbol:"\u2653",lord:"Jupiter",element:"Water",quality:"Dual"},
];

// ---- NAKSHATRAS ----
const NAKSHATRAS = [
  {name:"Ashwini",lord:"Ketu",deity:"Ashwini Kumaras",pada:[1,2,3,4]},
  {name:"Bharani",lord:"Venus",deity:"Yama",pada:[1,2,3,4]},
  {name:"Krittika",lord:"Sun",deity:"Agni",pada:[1,2,3,4]},
  {name:"Rohini",lord:"Moon",deity:"Brahma",pada:[1,2,3,4]},
  {name:"Mrigashira",lord:"Mars",deity:"Soma",pada:[1,2,3,4]},
  {name:"Ardra",lord:"Rahu",deity:"Rudra",pada:[1,2,3,4]},
  {name:"Punarvasu",lord:"Jupiter",deity:"Aditi",pada:[1,2,3,4]},
  {name:"Pushya",lord:"Saturn",deity:"Brihaspati",pada:[1,2,3,4]},
  {name:"Ashlesha",lord:"Mercury",deity:"Nagas",pada:[1,2,3,4]},
  {name:"Magha",lord:"Ketu",deity:"Pitrs",pada:[1,2,3,4]},
  {name:"Purva Phalguni",lord:"Venus",deity:"Bhaga",pada:[1,2,3,4]},
  {name:"Uttara Phalguni",lord:"Sun",deity:"Aryaman",pada:[1,2,3,4]},
  {name:"Hasta",lord:"Moon",deity:"Savitar",pada:[1,2,3,4]},
  {name:"Chitra",lord:"Mars",deity:"Tvashtar",pada:[1,2,3,4]},
  {name:"Swati",lord:"Rahu",deity:"Vayu",pada:[1,2,3,4]},
  {name:"Vishakha",lord:"Jupiter",deity:"Indragni",pada:[1,2,3,4]},
  {name:"Anuradha",lord:"Saturn",deity:"Mitra",pada:[1,2,3,4]},
  {name:"Jyeshtha",lord:"Mercury",deity:"Indra",pada:[1,2,3,4]},
  {name:"Mula",lord:"Ketu",deity:"Nirrti",pada:[1,2,3,4]},
  {name:"Purva Ashadha",lord:"Venus",deity:"Apas",pada:[1,2,3,4]},
  {name:"Uttara Ashadha",lord:"Sun",deity:"Vishvedevas",pada:[1,2,3,4]},
  {name:"Shravana",lord:"Moon",deity:"Vishnu",pada:[1,2,3,4]},
  {name:"Dhanishta",lord:"Mars",deity:"Vasus",pada:[1,2,3,4]},
  {name:"Shatabhisha",lord:"Rahu",deity:"Varuna",pada:[1,2,3,4]},
  {name:"Purva Bhadrapada",lord:"Jupiter",deity:"Ajaikapada",pada:[1,2,3,4]},
  {name:"Uttara Bhadrapada",lord:"Saturn",deity:"Ahirbudhnya",pada:[1,2,3,4]},
  {name:"Revati",lord:"Mercury",deity:"Pushan",pada:[1,2,3,4]},
];

// ---- DASHA ORDER & YEARS ----
const DASHA_ORDER = ["Ketu","Venus","Sun","Moon","Mars","Rahu","Jupiter","Saturn","Mercury"];
const DASHA_YEARS = {Ketu:7,Venus:20,Sun:6,Moon:10,Mars:7,Rahu:18,Jupiter:16,Saturn:19,Mercury:17};
const PLANET_COLORS = {
  Sun:"#C75B12",Moon:"#4A6FA5",Mars:"#B8352A",Mercury:"#1A8A5C",
  Jupiter:"#B8860B",Venus:"#C2185B",Saturn:"#37474F",Rahu:"#546E7A",Ketu:"#6A1B9A",Asc:"#D4710A"
};

// ---- PLANET DATA ----
const PLANETS_INFO = {
  Sun:{name:"Sun",sanskrit:"Surya",symbol:"\u2609",nature:"Benefic",gender:"Male",gem:"Ruby",mantra:"Om Suryaya Namaha",color:"Orange/Saffron",day:"Sunday",metal:"Gold",deity:"Lord Surya",donate:"Wheat, jaggery, copper",fast:"Sunday"},
  Moon:{name:"Moon",sanskrit:"Chandra",symbol:"\u263D",nature:"Benefic",gender:"Female",gem:"Pearl",mantra:"Om Chandraya Namaha",color:"White/Silver",day:"Monday",metal:"Silver",deity:"Lord Shiva",donate:"Rice, milk, white cloth",fast:"Monday"},
  Mars:{name:"Mars",sanskrit:"Mangal",symbol:"\u2642",nature:"Malefic",gender:"Male",gem:"Red Coral",mantra:"Om Mangalaya Namaha",color:"Red",day:"Tuesday",metal:"Copper",deity:"Lord Hanuman",donate:"Red lentils, jaggery",fast:"Tuesday"},
  Mercury:{name:"Mercury",sanskrit:"Budha",symbol:"\u263F",nature:"Neutral",gender:"Neutral",gem:"Emerald",mantra:"Om Budhaya Namaha",color:"Green",day:"Wednesday",metal:"Bronze",deity:"Lord Vishnu",donate:"Green moong, green cloth",fast:"Wednesday"},
  Jupiter:{name:"Jupiter",sanskrit:"Guru",symbol:"\u2643",nature:"Benefic",gender:"Male",gem:"Yellow Sapphire",mantra:"Om Gurave Namaha",color:"Yellow",day:"Thursday",metal:"Gold",deity:"Lord Brihaspati",donate:"Yellow cloth, turmeric, chana dal",fast:"Thursday"},
  Venus:{name:"Venus",sanskrit:"Shukra",symbol:"\u2640",nature:"Benefic",gender:"Female",gem:"Diamond",mantra:"Om Shukraya Namaha",color:"White/Pink",day:"Friday",metal:"Silver",deity:"Goddess Lakshmi",donate:"White rice, white sweets, ghee",fast:"Friday"},
  Saturn:{name:"Saturn",sanskrit:"Shani",symbol:"\u2644",nature:"Malefic",gender:"Neutral",gem:"Blue Sapphire",mantra:"Om Shanaischaraya Namaha",color:"Blue/Black",day:"Saturday",metal:"Iron",deity:"Lord Shani Dev",donate:"Black sesame, mustard oil, iron",fast:"Saturday"},
  Rahu:{name:"Rahu",sanskrit:"Rahu",symbol:"\u260A",nature:"Malefic",gender:"Male",gem:"Hessonite (Gomed)",mantra:"Om Rahuve Namaha",color:"Smoke/Grey",day:"Saturday",metal:"Lead",deity:"Goddess Durga",donate:"Black blanket, mustard",fast:"Saturday"},
  Ketu:{name:"Ketu",sanskrit:"Ketu",symbol:"\u260B",nature:"Malefic",gender:"Neutral",gem:"Cat's Eye (Lehsunia)",mantra:"Om Ketave Namaha",color:"Grey/Brown",day:"Tuesday",metal:"Mixed metals",deity:"Lord Ganesha",donate:"Blanket, sesame, seven grains",fast:"Tuesday/Saturday"},
};

// ---- MAHADASHA PREDICTIONS ----
const DASHA_PREDICTIONS = {
  Sun: "A period of leadership, authority, and self-expression. Government relations and father figures become significant. Health focus on vitality. Career sees prominence. Confidence and willpower strengthen. Spiritual awareness through dharmic pursuits deepens.",
  Moon: "An emotionally rich period. Mother figures, home, and comfort take center stage. Travel, especially over water, is possible. Mental peace, creativity, and public dealings are highlighted. Nurturing relationships blossom. Intuition sharpens considerably.",
  Mars: "A dynamic, action-oriented period. Courage, ambition, and competitive spirit surge. Property matters, siblings, and technical skills are prominent. Guard against haste and conflicts. Physical energy peaks. Land and real estate dealings are favored.",
  Mercury: "An intellectual, communicative period. Education, writing, commerce, and analytical abilities shine. Social connections multiply. Business acumen improves. Speech and wit become powerful tools. Short travels and learning new skills are highlighted.",
  Jupiter: "A period of wisdom, expansion, and good fortune. Spiritual growth, higher education, and mentorship opportunities arise. Marriage, children, and wealth are favored. Dharmic activities bring blessings. Teachers and advisors play important roles in life.",
  Venus: "A period of comfort, luxury, and artistic expression. Relationships, marriage, and partnerships are highlighted. Material gains, vehicles, and beautiful possessions come. Creative talents flourish. Social life becomes vibrant and pleasurable.",
  Saturn: "A period of discipline, hard work, and karmic lessons. Patience and perseverance are tested but ultimately rewarded. Career stability through sustained effort. Service, humility, and detachment bring wisdom. Health requires attention, especially bones and joints.",
  Rahu: "A period of unconventional experiences and worldly ambitions. Foreign connections, technology, and out-of-the-box thinking are highlighted. Material desires intensify. Sudden changes and unexpected opportunities arise. Guard against illusions and obsessions.",
  Ketu: "A period of spiritual awakening and inner transformation. Detachment from material pursuits grows. Past-life karmas surface for resolution. Intuition and psychic abilities heighten. Pilgrimages and retreats are beneficial. Let go of what no longer serves."
};

// ---- TRANSIT EFFECTS ----
const TRANSIT_HOUSE_EFFECTS = {
  Sun: ["Strong vitality and new beginnings","Financial gains through effort","Courage and communication improve","Domestic matters need attention","Creative expression flourishes","Health focus needed, service opportunities","Partnership and relationship focus","Transformation and hidden matters surface","Fortune, travel, and higher learning","Career peak and public recognition","Gains and fulfilled desires","Spiritual growth, expenses for good causes"],
  Moon: ["Emotional new beginnings","Comfort and financial security","Communicative and social mood","Domestic peace and nurturing","Creative and romantic energy","Service-minded, health aware","Relationship harmony","Emotional depth and transformation","Optimistic and philosophical","Professional recognition","Social fulfillment","Spiritual introspection"],
  Mars: ["High energy and initiative","Financial drive intensifies","Bold communication","Property and vehicle matters","Passionate creativity","Competitive in service","Dynamic partnerships","Deep transformations","Adventurous pursuits","Career ambitions surge","Active social goals","Spiritual warrior energy"],
  Mercury: ["Quick thinking and new ideas","Financial planning sharpens","Excellent for communication","Domestic problem-solving","Creative intelligence peaks","Analytical work excels","Negotiation skills heighten","Research and investigation","Higher learning focus","Professional communication","Networking opportunities","Reflective contemplation"],
  Jupiter: ["Blessings and personal growth","Wealth expansion period","Auspicious for learning","Domestic happiness increases","Children and creativity blessed","Health improvements, service","Marriage and partnerships blessed","Transformative wisdom","Great fortune and dharma","Career expansion and honors","Fulfillment of great desires","Spiritual liberation focus"],
  Venus: ["Charm and personal magnetism","Material comfort increases","Social graces and artistry","Home beautification","Romance and creative joy","Harmonious service","Love and partnership bliss","Intimate transformations","Cultural enrichment","Professional grace","Social pleasures abound","Devotional and artistic"],
  Saturn: ["Self-discipline strengthens","Financial responsibility","Serious communication","Home restructuring","Disciplined creativity","Health discipline needed","Committed partnerships","Deep karmic clearing","Philosophical maturity","Career consolidation","Long-term goal planning","Karmic resolution and release"],
  Rahu: ["Ambitious new identity","Unconventional wealth paths","Innovative communication","Unusual domestic changes","Eccentric creativity","Foreign health approaches","Unusual partnerships","Occult transformations","Foreign education/travel","Sudden career changes","Unexpected gains","Spiritual breakthroughs"],
  Ketu: ["Spiritual self-discovery","Detachment from possessions","Intuitive communication","Past-life home connections","Mystical creativity","Selfless service","Karmic relationships","Psychic depth","Spiritual pilgrimages","Letting go of ambition","Detached from gains","Liberation and moksha"]
};

// ============================================================
//  ASTRONOMICAL CALCULATIONS
// ============================================================

function julianDay(year, month, day, hour) {
  if (month <= 2) { year--; month += 12; }
  const A = Math.floor(year / 100);
  const B = 2 - A + Math.floor(A / 4);
  return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + hour / 24 + B - 1524.5;
}

function centuriesFromJ2000(jd) {
  return (jd - 2451545.0) / 36525.0;
}

function normalize(deg) {
  deg = deg % 360;
  return deg < 0 ? deg + 360 : deg;
}

function sinD(d) { return Math.sin(d * DEG); }
function cosD(d) { return Math.cos(d * DEG); }
function tanD(d) { return Math.tan(d * DEG); }
function asinD(x) { return Math.asin(x) * RAD; }
function acosD(x) { return Math.acos(Math.max(-1, Math.min(1, x))) * RAD; }
function atan2D(y, x) { return Math.atan2(y, x) * RAD; }

// Lahiri Ayanamsa (Chitrapaksha standard)
// Uses precession polynomial matching IAU 2006 model, calibrated to
// the Indian Calendar Reform Committee (1956) definition: Chitra at 180° sidereal
function lahiriAyanamsa(jd) {
  const T = (jd - 2451545.0) / 36525.0;  // Julian centuries from J2000
  // Polynomial fit matching Swiss Ephemeris Lahiri to < 3 arcsec over 1900–2100
  return 23.85710 + 1.39717 * T + 0.000312 * T * T;
}

// Obliquity of the ecliptic
function obliquity(T) {
  return 23.439291 - 0.0130042 * T - 1.64e-7 * T * T + 5.04e-7 * T * T * T;
}

// ---- JPL Keplerian Orbital Elements (Standish 1992, 3000 BC — 3000 AD) ----
// Format: [a(AU), e, I(°), L(°), lonPeri(°), lonNode(°)]
//   + rates per Julian century [da, de, dI, dL, dlonPeri, dlonNode]
const ORB = {
  Mercury: { a:0.38709927, e:0.20563593, I:7.00497902, L:252.25032350, wp:77.45779628, Om:48.33076593,
             da:0.00000037, de:0.00001906, dI:-0.00594749, dL:149472.67411175, dwp:0.16047689, dOm:-0.12534081 },
  Venus:   { a:0.72333566, e:0.00677672, I:3.39467605, L:181.97909950, wp:131.60246718, Om:76.67984255,
             da:0.00000390, de:-0.00004107, dI:-0.00078890, dL:58517.81538729, dwp:0.00268329, dOm:-0.27769418 },
  Earth:   { a:1.00000261, e:0.01671123, I:-0.00001531, L:100.46457166, wp:102.93768193, Om:0.0,
             da:0.00000562, de:-0.00004392, dI:-0.01294668, dL:35999.37244981, dwp:0.32327364, dOm:0.0 },
  Mars:    { a:1.52371034, e:0.09339410, I:1.84969142, L:-4.55343205, wp:-23.94362959, Om:49.55953891,
             da:0.00001847, de:0.00007882, dI:-0.00813131, dL:19140.30268499, dwp:0.44441088, dOm:-0.29257343 },
  Jupiter: { a:5.20288700, e:0.04838624, I:1.30439695, L:34.39644051, wp:14.72847983, Om:100.47390909,
             da:-0.00011607, de:-0.00013253, dI:-0.00183714, dL:3034.74612775, dwp:0.21252668, dOm:0.20469106 },
  Saturn:  { a:9.53667594, e:0.05386179, I:2.48599187, L:49.95424423, wp:92.59887831, Om:113.66242448,
             da:-0.00125060, de:-0.00050991, dI:0.00193609, dL:1222.49362201, dwp:-0.41897216, dOm:-0.28867794 }
};

// Solve Kepler's equation: M = E - e·sin(E)  (Newton–Raphson)
function solveKepler(M_deg, e) {
  let M = normalize(M_deg) * DEG;
  let E = M + e * Math.sin(M) * (1 + e * Math.cos(M)); // better initial guess
  for (let i = 0; i < 30; i++) {
    const dE = (M - (E - e * Math.sin(E))) / (1 - e * Math.cos(E));
    E += dE;
    if (Math.abs(dE) < 1e-12) break;
  }
  return E; // radians
}

// Extra perturbation terms for Jupiter & Saturn (JPL, 3000BC–3000AD table)
const ORB_EXTRA = {
  Jupiter: { b:-0.00012452, c:0.06064060, s:-0.35635438, f:38.35125000 },
  Saturn:  { b:0.00025899, c:-0.13434469, s:0.87320147, f:38.35125000 }
};

// Compute heliocentric ecliptic XYZ from Keplerian elements
function helioPosition(name, T) {
  const p = ORB[name];
  const a  = p.a  + p.da  * T;
  const e  = p.e  + p.de  * T;
  const I  = (p.I  + p.dI  * T) * DEG;
  let   L  = p.L  + p.dL  * T;
  const wp = p.wp + p.dwp * T;
  const Om = (p.Om + p.dOm * T) * DEG;

  // Apply extra perturbation terms for Jupiter & Saturn
  if (ORB_EXTRA[name]) {
    const ex = ORB_EXTRA[name];
    L += ex.b * T * T + ex.c * cosD(ex.f * T) + ex.s * sinD(ex.f * T);
  }

  const M = normalize(L - wp);          // mean anomaly (°)
  const w = (wp - p.Om - p.dOm * T) * DEG; // argument of perihelion (rad)

  const E = solveKepler(M, e);
  const xp = a * (Math.cos(E) - e);
  const yp = a * Math.sqrt(1 - e * e) * Math.sin(E);

  // True anomaly
  const nu = Math.atan2(yp, xp);
  const r  = Math.sqrt(xp * xp + yp * yp);

  // 3D heliocentric ecliptic (rotate orbital plane → ecliptic)
  const cosW = Math.cos(w + nu), sinW = Math.sin(w + nu);
  const cosO = Math.cos(Om),     sinO = Math.sin(Om);
  const cosI = Math.cos(I),      sinI = Math.sin(I);

  const X = r * (cosO * cosW - sinO * sinW * cosI);
  const Y = r * (sinO * cosW + cosO * sinW * cosI);
  const Z = r * (sinW * sinI);

  return { X, Y, Z, r, helioLon: normalize(Math.atan2(Y, X) * RAD) };
}

// Sun geocentric tropical longitude (standard Meeus formula — accurate)
function sunLongitude(T) {
  const L0 = normalize(280.46646 + 36000.76983 * T + 0.0003032 * T * T);
  const M  = normalize(357.52911 + 35999.05029 * T - 0.0001537 * T * T);
  const C  = (1.914602 - 0.004817 * T - 0.000014 * T * T) * sinD(M)
           + (0.019993 - 0.000101 * T) * sinD(2 * M)
           + 0.000289 * sinD(3 * M);
  return normalize(L0 + C);
}

// Moon geocentric tropical longitude — Meeus Ch.47, Table 47.A (full 60-term series)
// with eccentricity correction E for terms involving Sun's mean anomaly M
function moonLongitude(T) {
  const Lp = normalize(218.3164477 + 481267.88123421 * T
             - 0.0015786 * T*T + T*T*T / 538841.0 - T*T*T*T / 65194000.0);
  const D  = normalize(297.8501921 + 445267.1114034  * T
             - 0.0018819 * T*T + T*T*T / 545868.0 - T*T*T*T / 113065000.0);
  const M  = normalize(357.5291092 + 35999.0502909   * T
             - 0.0001536 * T*T + T*T*T / 24490000.0);
  const Mp = normalize(134.9633964 + 477198.8675055  * T
             + 0.0087414 * T*T + T*T*T / 69699.0 - T*T*T*T / 14712000.0);
  const F  = normalize(93.2720950  + 483202.0175233  * T
             - 0.0036539 * T*T - T*T*T / 3526000.0 + T*T*T*T / 863310000.0);

  // Eccentricity of Earth's orbit correction
  const E  = 1.0 - 0.002516 * T - 0.0000074 * T * T;
  const E2 = E * E;

  const A1 = normalize(119.75 + 131.849 * T);
  const A2 = normalize(53.09 + 479264.290 * T);
  const A3 = normalize(313.45 + 481266.484 * T);

  // Meeus Table 47.A — coefficients in micro-degrees (÷1e6 for degrees)
  // Format: [D, M, Mp, F, coeff_micro_degrees]
  // Terms involving M (col 2) are multiplied by E^|M|
  const terms = [
    [0, 0, 1, 0, 6288774], [2, 0,-1, 0, 1274027], [2, 0, 0, 0, 658314],
    [0, 0, 2, 0, 213618], [0, 1, 0, 0,-185116], [0, 0, 0, 2,-114332],
    [2, 0,-2, 0, 58793],  [2,-1,-1, 0, 57066],  [2, 0, 1, 0, 53322],
    [2,-1, 0, 0, 45758],  [0, 1,-1, 0,-40923],  [1, 0, 0, 0,-34720],
    [0, 1, 1, 0,-30383],  [2, 0, 0,-2, 15327],  [0, 0, 1, 2,-12528],
    [0, 0, 1,-2, 10980],  [4, 0,-1, 0, 10675],  [0, 0, 3, 0, 10034],
    [4, 0,-2, 0, 8548],   [2, 1,-1, 0,-7888],   [2, 1, 0, 0,-6766],
    [1, 0,-1, 0,-5163],   [1, 1, 0, 0, 4987],   [2,-1, 1, 0, 4036],
    [2, 0, 2, 0, 3994],   [4, 0, 0, 0, 3861],   [2, 0,-3, 0, 3665],
    [0, 1,-2, 0,-2689],   [2, 0,-1, 2,-2602],   [2,-1,-2, 0, 2390],
    [1, 0, 1, 0,-2348],   [2,-2, 0, 0, 2236],   [0, 1, 2, 0,-2120],
    [0, 2, 0, 0,-2069],   [2,-2,-1, 0, 2048],   [2, 0, 1,-2,-1773],
    [2, 0, 0, 2,-1595],   [4,-1,-1, 0, 1215],   [0, 0, 2, 2,-1110],
    [3, 0,-1, 0,-892],    [2, 1, 1, 0,-810],     [4,-1,-2, 0, 759],
    [0, 2,-1, 0,-713],    [2, 2,-1, 0,-700],     [2, 1,-2, 0, 691],
    [2,-1, 0,-2, 596],    [4, 0, 1, 0, 549],     [0, 0, 4, 0, 537],
    [4,-1, 0, 0, 520],    [1, 0,-2, 0,-487],     [2, 1, 0,-2,-399],
    [0, 0, 2,-2,-381],    [1, 1, 1, 0, 351],     [3, 0,-2, 0,-340],
    [4, 0,-3, 0, 330],    [2,-1, 2, 0, 327],     [0, 2, 1, 0,-323],
    [1, 1,-1, 0, 299],    [2, 0, 3, 0, 294]
  ];

  let sumL = 0;
  for (const [tD, tM, tMp, tF, coeff] of terms) {
    const arg = tD * D + tM * M + tMp * Mp + tF * F;
    let c = coeff;
    // Apply eccentricity correction for terms involving Sun's anomaly
    if (Math.abs(tM) === 1) c *= E;
    else if (Math.abs(tM) === 2) c *= E2;
    sumL += c * sinD(arg);
  }

  // Convert micro-degrees to degrees and add to Lp
  let lon = Lp + sumL / 1000000.0;

  // Additional corrections (Meeus p.342)
  lon += 0.003958 * sinD(A1)
       + 0.001962 * sinD(Lp - F)
       + 0.000318 * sinD(A2);

  return normalize(lon);
}

// Rahu: Mean Lunar North Node (Meeus, higher-order terms)
function rahuLongitude(T) {
  return normalize(125.0445479 - 1934.1362891 * T
    + 0.0020754 * T * T + T * T * T / 467441.0 - T * T * T * T / 60616000.0);
}

// ---- Master planet calculator: proper heliocentric→geocentric ----
function calculatePlanets(jd) {
  const T   = centuriesFromJ2000(jd);
  const aya = lahiriAyanamsa(jd);

  // Earth heliocentric position (needed for geocentric conversion of all others)
  const earth = helioPosition('Earth', T);

  const tropical = {};

  // Sun & Moon are inherently geocentric — use dedicated formulae
  tropical.Sun  = sunLongitude(T);
  tropical.Moon = moonLongitude(T);

  // Five visible planets: heliocentric → geocentric via vector subtraction
  ['Mercury','Venus','Mars','Jupiter','Saturn'].forEach(name => {
    const pl = helioPosition(name, T);
    const dx = pl.X - earth.X;
    const dy = pl.Y - earth.Y;
    tropical[name] = normalize(atan2D(dy, dx));
  });

  // Lunar nodes
  tropical.Rahu = rahuLongitude(T);
  tropical.Ketu = normalize(tropical.Rahu + 180);

  // Tropical → Sidereal (subtract Lahiri ayanamsa)
  const sidereal = {};
  for (const p in tropical) {
    sidereal[p] = normalize(tropical[p] - aya);
  }

  // Attach debug payload so the UI can display it
  sidereal._debug = { T, aya, jd, tropical: { ...tropical } };
  return sidereal;
}

// Greenwich Sidereal Time (degrees) — IAU formula
function greenwichSiderealTime(jd) {
  const T = centuriesFromJ2000(jd);
  let gst = 280.46061837 + 360.98564736629 * (jd - 2451545.0)
            + 0.000387933 * T * T - T * T * T / 38710000;
  return normalize(gst);
}

// Ascendant (Lagna) — tropical, then sidereal
// Formula: λ = atan2(cos(RAMC), −[sin(RAMC)·cos(ε) + tan(φ)·sin(ε)])
// Ref: Swiss Ephemeris (Asc1) with proper quadrant handling — both atan2
// arguments are negated vs. the "descendant" form to select the rising point.
function calculateAscendant(jd, lat, lon) {
  const gst = greenwichSiderealTime(jd);
  const lst = normalize(gst + lon);       // Local Sidereal Time = RAMC (°)
  const T   = centuriesFromJ2000(jd);
  const eps = obliquity(T);
  const y = cosD(lst);
  const x = -(sinD(lst) * cosD(eps) + tanD(lat) * sinD(eps));
  let asc = atan2D(y, x);
  asc = normalize(asc);
  const aya = lahiriAyanamsa(jd);
  return normalize(asc - aya);
}

// ============================================================
//  VEDIC ASTROLOGY LOGIC
// ============================================================

// Format decimal degrees as D°M'S"
function degToDMS(deg) {
  const d = Math.floor(deg);
  const mFull = (deg - d) * 60;
  const m = Math.floor(mFull);
  const s = Math.round((mFull - m) * 60);
  return `${d}\u00b0${String(m).padStart(2,'0')}'${String(s).padStart(2,'0')}"`;
}

function getRashi(longitude) {
  const idx = Math.floor(longitude / 30) % 12;
  return { index: idx, ...RASHIS[idx], degrees: longitude % 30 };
}

function getNakshatra(longitude) {
  const nakshatraSpan = 360 / 27; // 13.333...
  const idx = Math.floor(longitude / nakshatraSpan) % 27;
  const posInNak = longitude - idx * nakshatraSpan;
  const pada = Math.floor(posInNak / (nakshatraSpan / 4)) + 1;
  return { index: idx, ...NAKSHATRAS[idx], currentPada: Math.min(pada, 4), degInNak: posInNak };
}

function getHouse(planetLong, ascLong) {
  // Whole-sign house system (Vedic): 1st house = entire sign of the ascendant
  // House boundaries start at the beginning of the lagna rashi, not the exact degree
  const ascSignStart = Math.floor(ascLong / 30) * 30;
  let diff = normalize(planetLong - ascSignStart);
  return Math.floor(diff / 30) + 1;
}

function calculateFullChart(dob, tob, lat, lon, tz) {
  const [year, month, day] = dob.split('-').map(Number);
  const [hours, minutes] = tob.split(':').map(Number);
  const localDecimalHour = hours + minutes / 60;
  const utcHour = localDecimalHour - tz;
  const jd = julianDay(year, month, day, utcHour);

  const planets = calculatePlanets(jd);
  const ascendant = calculateAscendant(jd, lat, lon);

  const chartData = { jd, ascendant, planets: {}, ascRashi: getRashi(ascendant) };

  // Planet details (skip _debug key)
  for (const p in planets) {
    if (p === '_debug') continue;
    const pLon = planets[p];
    const rashi = getRashi(pLon);
    const nak = getNakshatra(pLon);
    const house = getHouse(pLon, ascendant);
    chartData.planets[p] = { longitude: pLon, rashi, nakshatra: nak, house };
  }

  // Store full debug / calculation log
  const aya = lahiriAyanamsa(jd);
  chartData.debug = {
    inputLat: lat, inputLon: lon, inputTz: tz,
    localTime: `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`,
    utcHour: utcHour.toFixed(4),
    julianDay: jd.toFixed(5),
    ayanamsa: aya.toFixed(4),
    gst: greenwichSiderealTime(jd).toFixed(4),
    lst: normalize(greenwichSiderealTime(jd) + lon).toFixed(4),
    tropical: planets._debug ? planets._debug.tropical : {},
  };

  // Dasha calculation
  chartData.dashas = calculateVimshottariDasha(planets.Moon, year, month, day, hours, minutes);

  // Yogas
  chartData.yogas = detectYogas(chartData);

  return chartData;
}

// ============================================================
//  VIMSHOTTARI DASHA
// ============================================================

function calculateVimshottariDasha(moonLong, year, month, day, hours, minutes) {
  const nak = getNakshatra(moonLong);
  const nakLord = nak.lord;
  const nakSpan = 360 / 27;
  const posInNak = nak.degInNak;
  const fractionPassed = posInNak / nakSpan;

  // Find starting dasha lord (= nakshatra lord)
  let startIdx = DASHA_ORDER.indexOf(nakLord);
  const totalYears = DASHA_YEARS[nakLord];
  const remainingYears = totalYears * (1 - fractionPassed);

  // Build dasha sequence
  const birthDate = new Date(year, month - 1, day, hours, minutes);
  const dashas = [];
  let currentDate = new Date(birthDate);

  // First (partial) dasha
  let endDate = addYears(currentDate, remainingYears);
  dashas.push({
    lord: nakLord,
    startDate: new Date(currentDate),
    endDate: new Date(endDate),
    years: remainingYears
  });
  currentDate = new Date(endDate);

  // Subsequent full dashas (cover 120 years total)
  for (let i = 1; i <= 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const yrs = DASHA_YEARS[lord];
    endDate = addYears(currentDate, yrs);
    dashas.push({
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: yrs
    });
    currentDate = new Date(endDate);
  }

  // Calculate antardashas for each mahadasha
  dashas.forEach(md => {
    md.antardashas = calculateAntardashas(md);
  });

  return dashas;
}

function calculateAntardashas(mahadasha) {
  const mdLord = mahadasha.lord;
  const mdYears = mahadasha.years;
  const mdStart = new Date(mahadasha.startDate);
  const startIdx = DASHA_ORDER.indexOf(mdLord);
  const antars = [];
  let currentDate = new Date(mdStart);

  for (let i = 0; i < 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const proportion = DASHA_YEARS[lord] / 120;
    const adYears = mdYears * proportion;
    const endDate = addYears(currentDate, adYears);
    const ad = {
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: adYears
    };
    // Pratyantardashas
    ad.pratyantardashas = calculatePratyantardashas(ad);
    antars.push(ad);
    currentDate = new Date(endDate);
  }
  return antars;
}

function calculatePratyantardashas(antardasha) {
  const adLord = antardasha.lord;
  const adYears = antardasha.years;
  const startIdx = DASHA_ORDER.indexOf(adLord);
  const pads = [];
  let currentDate = new Date(antardasha.startDate);

  for (let i = 0; i < 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const proportion = DASHA_YEARS[lord] / 120;
    const padYears = adYears * proportion;
    const endDate = addYears(currentDate, padYears);
    pads.push({
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: padYears
    });
    currentDate = new Date(endDate);
  }
  return pads;
}

function addYears(date, years) {
  const ms = years * 365.25 * 24 * 60 * 60 * 1000;
  return new Date(date.getTime() + ms);
}

// ============================================================
//  YOGA DETECTION (Simplified)
// ============================================================

function detectYogas(chart) {
  const yogas = [];
  const planets = chart.planets;
  const ascHouse = 1;

  // Gajakesari Yoga: Jupiter in kendra from Moon
  const moonH = planets.Moon.house;
  const jupH = planets.Jupiter.house;
  const diffMJ = ((jupH - moonH + 12) % 12);
  if ([0, 3, 6, 9].includes(diffMJ)) {
    yogas.push({ name: "Gajakesari Yoga", desc: "Jupiter is in a kendra (quadrant) from Moon. This yoga bestows wisdom, wealth, lasting fame, and strong character. The native is blessed with intelligence and good fortune." });
  }

  // Budhaditya Yoga: Sun and Mercury in same sign
  if (planets.Sun.rashi.index === planets.Mercury.rashi.index) {
    yogas.push({ name: "Budhaditya Yoga", desc: "Sun and Mercury are conjoined in the same sign. This bestows sharp intellect, eloquent speech, and success in education and communication fields. The native is skilled in arts and sciences." });
  }

  // Chandra-Mangal Yoga: Moon and Mars in same sign
  if (planets.Moon.rashi.index === planets.Mars.rashi.index) {
    yogas.push({ name: "Chandra-Mangal Yoga", desc: "Moon and Mars are conjoined. This brings wealth through enterprise, courage in emotional matters, and success in business. The native has a dynamic and prosperous disposition." });
  }

  // Hamsa Yoga: Jupiter in kendra in own/exaltation sign
  if ([1, 4, 7, 10].includes(jupH)) {
    const jupSign = planets.Jupiter.rashi.index;
    if (jupSign === 8 || jupSign === 11 || jupSign === 3) { // Sagittarius, Pisces, Cancer
      yogas.push({ name: "Hamsa Yoga", desc: "Jupiter occupies a kendra in its own or exaltation sign. This is one of the Pancha Mahapurusha Yogas, granting wisdom, righteousness, and a noble, respected life." });
    }
  }

  // Malavya Yoga: Venus in kendra in own/exaltation sign
  const venH = planets.Venus.house;
  if ([1, 4, 7, 10].includes(venH)) {
    const venSign = planets.Venus.rashi.index;
    if (venSign === 1 || venSign === 6 || venSign === 11) { // Taurus, Libra, Pisces
      yogas.push({ name: "Malavya Yoga", desc: "Venus occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga bestowing beauty, artistic talents, luxurious life, and happy marriage." });
    }
  }

  // Ruchaka Yoga: Mars in kendra in own/exaltation sign
  const marsH = planets.Mars.house;
  if ([1, 4, 7, 10].includes(marsH)) {
    const marsSign = planets.Mars.rashi.index;
    if (marsSign === 0 || marsSign === 7 || marsSign === 9) { // Aries, Scorpio, Capricorn
      yogas.push({ name: "Ruchaka Yoga", desc: "Mars occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga granting courage, commanding personality, leadership abilities, and physical strength." });
    }
  }

  // Shasha Yoga: Saturn in kendra in own/exaltation sign
  const satH = planets.Saturn.house;
  if ([1, 4, 7, 10].includes(satH)) {
    const satSign = planets.Saturn.rashi.index;
    if (satSign === 9 || satSign === 10 || satSign === 6) { // Capricorn, Aquarius, Libra
      yogas.push({ name: "Shasha Yoga", desc: "Saturn occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga granting authority, discipline, power over others, and a long, structured life." });
    }
  }

  // Kemadruma Yoga: No planets adjacent to Moon's sign
  const moonSign = planets.Moon.rashi.index;
  const adjSigns = [(moonSign + 1) % 12, (moonSign + 11) % 12];
  let hasAdj = false;
  for (const p of ["Sun","Mars","Mercury","Jupiter","Venus","Saturn"]) {
    if (adjSigns.includes(planets[p].rashi.index)) { hasAdj = true; break; }
  }
  if (!hasAdj) {
    yogas.push({ name: "Kemadruma Yoga", desc: "No planets occupy the signs adjacent to Moon. This can indicate periods of loneliness or financial fluctuation, but is often cancelled by other factors. Remedies for Moon can help mitigate effects." });
  }

  // Raja Yoga: Lord of trikona and kendra conjunct
  // Simplified check: if 9th lord and 10th lord are in same sign
  const ninthSign = (chart.ascRashi.index + 8) % 12;
  const tenthSign = (chart.ascRashi.index + 9) % 12;
  const ninthLord = RASHIS[ninthSign].lord;
  const tenthLord = RASHIS[tenthSign].lord;
  if (ninthLord !== tenthLord && planets[ninthLord] && planets[tenthLord]) {
    if (planets[ninthLord].rashi.index === planets[tenthLord].rashi.index) {
      yogas.push({ name: "Raja Yoga", desc: "The lords of the 9th and 10th houses are conjoined, forming a powerful Raja Yoga. This combination brings fortune through career, authority, fame, and success in professional endeavors." });
    }
  }

  if (yogas.length === 0) {
    yogas.push({ name: "Chart Analysis", desc: "Your chart shows a unique combination of planetary positions. The specific house placements and aspects create a personalized pattern of strengths and growth areas. Consult the Dasha predictions for detailed life period analysis." });
  }

  return yogas;
}

// ============================================================
//  MASTER VEDIC ASTROLOGY PREDICTION ENGINE
// ============================================================

const SIGN_LORDS = ['Mars','Venus','Mercury','Moon','Sun','Mercury','Venus','Mars','Jupiter','Saturn','Saturn','Jupiter'];
const HOUSE_AREAS = {
  1:{area:'self, personality, health, vitality, appearance',short:'Self',life:'personal identity and physical well-being'},
  2:{area:'wealth, family, speech, food, values',short:'Wealth',life:'financial security and family life'},
  3:{area:'courage, siblings, communication, short journeys, skills',short:'Courage',life:'initiative, communication, and sibling bonds'},
  4:{area:'home, mother, vehicles, property, emotional happiness',short:'Home',life:'domestic peace, property, and inner contentment'},
  5:{area:'children, education, creativity, romance, past-life merit (purva punya)',short:'Children',life:'creative expression, children, and intellect'},
  6:{area:'enemies, debts, disease, service, competition, daily work',short:'Service',life:'overcoming obstacles, health discipline, and service'},
  7:{area:'marriage, partnerships, business, public dealings, foreign travel',short:'Marriage',life:'relationships, partnerships, and public image'},
  8:{area:'longevity, sudden events, occult, inheritance, transformation',short:'Transformation',life:'deep transformation, hidden knowledge, and longevity'},
  9:{area:'fortune, dharma, guru, father, higher education, long journeys',short:'Fortune',life:'luck, spiritual wisdom, higher learning, and dharmic path'},
  10:{area:'career, status, authority, karma, public reputation',short:'Career',life:'professional achievement, authority, and life purpose'},
  11:{area:'gains, income, friends, elder siblings, aspirations, large networks',short:'Gains',life:'fulfillment of desires, gains, and social networks'},
  12:{area:'losses, foreign lands, liberation, expenses, isolation, moksha',short:'Liberation',life:'spiritual liberation, foreign connections, and letting go'}
};

// Natural planet significations
const PLANET_KARAKAS = {
  Sun:'soul, father, authority, government, confidence, vitality, leadership',
  Moon:'mind, mother, emotions, nurturing, public, comfort, intuition',
  Mars:'courage, energy, brothers, property, surgery, engineering, athletics',
  Mercury:'intellect, speech, commerce, writing, education, analytical ability',
  Jupiter:'wisdom, children, guru, wealth, dharma, expansion, spirituality',
  Venus:'love, beauty, luxury, vehicles, arts, marriage, material comforts',
  Saturn:'discipline, karma, longevity, service, delays, hard work, detachment',
  Rahu:'foreign things, technology, unconventional paths, obsession, illusion, material ambition',
  Ketu:'spirituality, liberation, past-life karma, detachment, mysticism, healing'
};

// Exaltation/Debilitation/Own/Moolatrikona sign indices
const DIGNITY_DATA = {
  Sun:{exalt:0,debil:6,own:[4],moola:4},
  Moon:{exalt:1,debil:7,own:[3],moola:1},
  Mars:{exalt:9,debil:3,own:[0,7],moola:0},
  Mercury:{exalt:5,debil:11,own:[2,5],moola:5},
  Jupiter:{exalt:3,debil:9,own:[8,11],moola:8},
  Venus:{exalt:11,debil:5,own:[1,6],moola:6},
  Saturn:{exalt:6,debil:0,own:[9,10],moola:10}
};

// Functional benefic/malefic classification by lagna sign index
function classifyPlanets(ascIdx) {
  // Returns {yogakaraka, benefics, malefics, neutrals} for the given lagna
  const lords = {};
  for (let h = 1; h <= 12; h++) {
    const sIdx = (ascIdx + h - 1) % 12;
    const lord = SIGN_LORDS[sIdx];
    if (!lords[lord]) lords[lord] = [];
    lords[lord].push(h);
  }

  const benefics = [], malefics = [], neutrals = [];
  let yogakaraka = null;

  for (const [planet, houses] of Object.entries(lords)) {
    const hasKendra = houses.some(h => [1,4,7,10].includes(h));
    const hasTrikona = houses.some(h => [1,5,9].includes(h));
    const hasDusthana = houses.some(h => [6,8,12].includes(h));
    const hasMaraka = houses.some(h => [2,7].includes(h));

    if (hasKendra && hasTrikona) { yogakaraka = planet; benefics.push(planet); }
    else if (hasTrikona) benefics.push(planet);
    else if (hasKendra && !hasDusthana) neutrals.push(planet);
    else if (hasDusthana) malefics.push(planet);
    else if (hasMaraka) neutrals.push(planet);
    else neutrals.push(planet);
  }

  return { yogakaraka, benefics, malefics, neutrals, lords };
}

// Get houses ruled by a planet from a given lagna
function getLordships(planet, ascIdx) {
  const houses = [];
  for (let h = 1; h <= 12; h++) {
    const sIdx = (ascIdx + h - 1) % 12;
    if (SIGN_LORDS[sIdx] === planet) houses.push(h);
  }
  return houses;
}

// Get dignity status of a planet
function getDignity(planet, signIdx) {
  const d = DIGNITY_DATA[planet];
  if (!d) return 'neutral';
  if (signIdx === d.exalt) return 'exalted';
  if (signIdx === d.debil) return 'debilitated';
  if (d.own.includes(signIdx)) return 'own-sign';
  if (signIdx === d.moola) return 'moolatrikona';
  // Check friendly/enemy dispositions
  return 'neutral';
}

// Find planets in the same house
function getConjunctions(planet, chart) {
  const h = chart.planets[planet].house;
  return Object.keys(chart.planets).filter(p => p !== planet && p !== '_debug' && chart.planets[p].house === h);
}

// Get aspects received by a house
function getAspectsOnHouse(houseNum, chart) {
  const aspecting = [];
  const pNames = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  const specialAsp = { Mars:[4,8], Jupiter:[5,9], Saturn:[3,10], Rahu:[5,9], Ketu:[5,9] };

  pNames.forEach(p => {
    if (!chart.planets[p]) return;
    const pH = chart.planets[p].house;
    // 7th aspect
    if (((pH - 1 + 7 - 1) % 12) + 1 === houseNum) aspecting.push(p);
    // Special aspects
    if (specialAsp[p]) {
      specialAsp[p].forEach(a => {
        if (((pH - 1 + a - 1) % 12) + 1 === houseNum) {
          if (!aspecting.includes(p)) aspecting.push(p);
        }
      });
    }
  });
  return aspecting;
}

// ---- COMPREHENSIVE BIRTH CHART READING ----
function generateChartReading(chart) {
  const asc = chart.ascRashi.index;
  const cls = classifyPlanets(asc);
  const sections = [];

  // 1. PERSONALITY & LAGNA ANALYSIS
  const ascSign = RASHIS[asc];
  const lagnaLord = SIGN_LORDS[asc];
  const llData = chart.planets[lagnaLord];
  const llHouse = llData.house;
  const llDig = getDignity(lagnaLord, llData.rashi.index);
  const llConj = getConjunctions(lagnaLord, chart);
  const h1Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 1);

  let personality = `<b>Lagna: ${ascSign.name} (${ascSign.eng})</b> — `;
  const signTraits = {
    0:'You are a natural leader with pioneering spirit, courage, and directness. Independent and action-oriented.',
    1:'You possess stability, patience, and an appreciation for beauty and material comforts. Loyal and determined.',
    2:'You are intellectually curious, versatile, and communicative. Adaptable with a quick, analytical mind.',
    3:'You are emotionally sensitive, nurturing, and intuitive. Deeply connected to home and family.',
    4:'You carry natural charisma, confidence, and a regal bearing. Creative and generous, with leadership qualities.',
    5:'You are analytical, detail-oriented, and service-minded. Practical with a sharp intellect.',
    6:'You seek harmony, balance, and beauty in all things. Diplomatic and relationship-oriented.',
    7:'You possess deep intensity, transformative power, and strong willpower. Investigative and determined.',
    8:'You are optimistic, philosophical, and expansive in vision. A natural seeker of truth and wisdom.',
    9:'You are disciplined, ambitious, and practical. Patient with a strong sense of duty and structure.',
    10:'You are innovative, humanitarian, and independent-minded. A visionary thinker concerned with collective welfare.',
    11:'You are intuitive, compassionate, and spiritually inclined. Imaginative with deep empathy for others.'
  };
  personality += signTraits[asc] || '';

  personality += `<br><br><b>Lagna Lord ${lagnaLord}</b> is placed in the <b>${ordinal(llHouse)} house</b>`;
  if (llDig === 'exalted') personality += ' in <span style="color:var(--accent-green)">exaltation</span>';
  else if (llDig === 'debilitated') personality += ' in <span style="color:var(--accent-red)">debilitation</span>';
  else if (llDig === 'own-sign') personality += ' in its <span style="color:var(--accent-green)">own sign</span>';
  personality += '. ';

  const llHouseDesc = {
    1:'This gives strong self-confidence, good health, and a self-made quality. You define your own path.',
    2:'Focus on building wealth, maintaining family traditions, and developing eloquent speech.',
    3:'Courage, initiative, and communication skills define you. Strong bond with siblings. A doer.',
    4:'Deep attachment to home, mother, and motherland. Emotional security is paramount. Property gains likely.',
    5:'Creative intelligence, love for learning, and good fortune through children. Past-life merit supports you.',
    6:'You overcome enemies and obstacles through sheer perseverance. Service-oriented with strong competitive drive.',
    7:'Partnerships and relationships shape your identity significantly. Business acumen is strong.',
    8:'A transformative life journey with interest in occult/hidden knowledge. Resilient through upheavals.',
    9:'Naturally fortunate and dharmic. Strong connection to teachers, philosophy, and higher learning.',
    10:'Career-focused personality. Authority and public reputation are central to your identity. Ambitious.',
    11:'Gains come through personal effort. Strong social network. Aspirations are fulfilled over time.',
    12:'Spiritual inclination, possible foreign connections. Expenditure needs management. Inner world is rich.'
  };
  personality += llHouseDesc[llHouse] || '';

  if (llConj.length > 0) {
    personality += ` Lagna lord conjoins ${llConj.join(', ')}, creating a complex personality blend.`;
  }

  if (h1Planets.length > 0) {
    personality += `<br><br>Your 1st house hosts <b>${h1Planets.join(', ')}</b>, `;
    if (h1Planets.includes('Jupiter')) personality += 'giving you <span style="color:var(--saffron)">Jupiterian wisdom, optimism, and a naturally benevolent disposition</span>. ';
    if (h1Planets.includes('Venus')) personality += '<span style="color:#e91e8c">Venus here bestows attractiveness, artistic sensibility, and a love of comfort</span>. ';
    if (h1Planets.includes('Moon')) personality += '<span style="color:#bdc3c7">Moon in the ascendant makes you emotionally expressive, intuitive, and publicly visible</span>. ';
  }

  sections.push({title:'Personality & Self', icon:'\u2648', content:personality});

  // 2. WEALTH & CAREER
  const h2Lord = SIGN_LORDS[(asc+1)%12];
  const h10Lord = SIGN_LORDS[(asc+9)%12];
  const h11Lord = SIGN_LORDS[(asc+10)%12];
  const h2Data = chart.planets[h2Lord];
  const h10Data = chart.planets[h10Lord];

  let career = '<b>Career & Wealth Analysis:</b><br>';

  // 10th house analysis
  const h10Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 10);
  career += `Your 10th lord <b>${h10Lord}</b> is in the <b>${ordinal(h10Data.house)} house</b>. `;

  const careerByH10 = {
    1:'Career is deeply tied to your identity. Self-employment or leadership roles suit you best.',
    2:'Career brings wealth. Family business or finance-related work is indicated.',
    3:'Communication, writing, media, or skilled trades define your career. Entrepreneurial energy.',
    4:'Career connects to property, vehicles, home, education, or government. May work from home.',
    5:'Creative, speculative, educational, or entertainment career. Working with children possible.',
    6:'Service sector, healthcare, law, or competitive fields. Overcoming daily challenges professionally.',
    7:'Business partnerships, client-facing roles, consulting, or diplomacy define your work.',
    8:'Research, investigation, insurance, occult sciences, or transformative work. Hidden earnings.',
    9:'Teaching, law, religion, philosophy, publishing, or international career.',
    10:'Very strong career placement. Ambitious, authoritative, and publicly recognized.',
    11:'Gains through career are excellent. Large organizations, networks, and technology.',
    12:'Foreign career, hospitals, ashrams, charity, or behind-the-scenes work. Spiritual vocation possible.'
  };
  career += (careerByH10[h10Data.house] || '') + '<br><br>';

  if (h10Planets.length > 0) {
    career += `<b>${h10Planets.join(', ')}</b> in 10th house: `;
    if (h10Planets.includes('Rahu')) career += 'Rahu in the 10th gives <span style="color:var(--saffron)">powerful ambition, unconventional career path, rise in worldly status, and possible foreign career connections</span>. This is one of the strongest placements for Rahu — it drives relentless professional ambition. ';
    if (h10Planets.includes('Sun')) career += 'Sun in 10th gives authority, government connections, and leadership roles. ';
    if (h10Planets.includes('Saturn')) career += 'Saturn in 10th gives slow but lasting career success through discipline. ';
    if (h10Planets.includes('Jupiter')) career += 'Jupiter in 10th gives fortune in career, respected position, and ethical profession. ';
    if (h10Planets.includes('Mars')) career += 'Mars in 10th gives dynamic career, engineering, military, or technical fields. ';
  }

  // Wealth houses
  career += `<br><b>Wealth:</b> 2nd lord <b>${h2Lord}</b> in ${ordinal(h2Data.house)} house, 11th lord <b>${h11Lord}</b> in ${ordinal(chart.planets[h11Lord].house)} house. `;
  if (chart.planets[h11Lord].house === 1) career += 'The 11th lord in 1st house is excellent — gains come to you naturally through personal effort and reputation. ';
  if (chart.planets[h2Lord].house === 1) career += 'The 2nd lord in 1st house indicates self-earned wealth and good financial sense. ';

  sections.push({title:'Career & Wealth', icon:'\u2617', content:career});

  // 3. RELATIONSHIPS & MARRIAGE
  const h7Lord = SIGN_LORDS[(asc+6)%12];
  const h7Data = chart.planets[h7Lord];
  const venusData = chart.planets.Venus;
  const h7Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 7);

  let marriage = '<b>Marriage & Relationships:</b><br>';
  marriage += `7th lord <b>${h7Lord}</b> is in the <b>${ordinal(h7Data.house)} house</b>`;
  const h7Dig = getDignity(h7Lord, h7Data.rashi.index);
  if (h7Dig === 'exalted') marriage += ' in <span style="color:var(--accent-green)">exaltation</span>';
  marriage += '. ';

  const marriageBy7L = {
    1:'Spouse is devoted and connected to your identity. Marriage is defining experience.',
    2:'Spouse contributes to family wealth. Material stability through marriage.',
    3:'Spouse is communicative, possibly artistic. Marriage requires mutual intellectual engagement.',
    4:'Spouse brings domestic happiness. Good home life and emotional support.',
    5:'Romantic, loving partnership. Children strengthen the marriage bond.',
    6:'Some challenges in marriage possible — communication and patience are key remedies.',
    7:'Strong marriage potential. Spouse is independent and influential.',
    8:'Deep, transformative relationship. Trust and loyalty are paramount. Inheritance possible through spouse.',
    9:'Fortunate marriage. Spouse may be from different cultural/philosophical background.',
    10:'Marriage enhances career and public standing. Spouse is ambitious and supportive.',
    11:'Marriage brings gains and social expansion. Friendship is the foundation of the relationship.',
    12:'Spouse may have foreign connections. Private, deeply spiritual bond. Expenses related to marriage.'
  };
  marriage += (marriageBy7L[h7Data.house] || '') + '<br><br>';

  marriage += `<b>Venus</b> (natural karaka of marriage) is in the <b>${ordinal(venusData.house)} house</b> in <b>${venusData.rashi.name}</b>. `;
  if (venusData.house === 1) marriage += 'Venus in the ascendant blesses with charm, attractiveness, and a love of beauty. Spouse is likely beautiful and culturally refined. ';
  else if (venusData.house === 7) marriage += 'Venus in the 7th is ideal for a happy, harmonious marriage. ';

  const venConj = getConjunctions('Venus', chart);
  if (venConj.includes('Jupiter')) marriage += 'Venus-Jupiter conjunction brings a dharmic, generous, and fortunate marriage. ';
  if (venConj.includes('Moon')) marriage += 'Venus-Moon conjunction gives emotional richness and romantic sensibility in relationships. ';
  if (venConj.includes('Saturn')) marriage += 'Venus-Saturn aspect/conjunction may cause some delays in marriage but bestows loyalty and stability once committed. ';

  // Manglik check
  const marsH = chart.planets.Mars.house;
  if ([1,2,4,7,8,12].includes(marsH)) {
    marriage += `<br><span style="color:var(--accent-red)"><b>Manglik Consideration:</b> Mars in the ${ordinal(marsH)} house creates Mangal Dosha. This is mitigated if Mars is in its own sign, if Saturn aspects Mars, or if the spouse also has Mangal Dosha. Performing Mangal Shanti puja and wearing Red Coral can help.</span>`;
  }

  sections.push({title:'Marriage & Relationships', icon:'\u2665', content:marriage});

  // 4. HEALTH
  let health = '<b>Health Analysis:</b><br>';
  const h6Lord = SIGN_LORDS[(asc+5)%12];
  const h8Lord = SIGN_LORDS[(asc+7)%12];

  health += `6th lord <b>${h6Lord}</b> in ${ordinal(chart.planets[h6Lord].house)} house, 8th lord <b>${h8Lord}</b> in ${ordinal(chart.planets[h8Lord].house)} house. `;

  if (chart.planets[h6Lord].house === 1) health += 'The 6th lord in the 1st house requires attention to health throughout life. Immune system may need strengthening. However, you possess the ability to overcome diseases through willpower. ';

  // Body constitution based on lagna element
  const elem = RASHIS[asc].element;
  if (elem === 'Air') health += '<br>Your airy constitution (Vata) suggests attention to nervous system, joints, and circulation. Regular routine and warm foods balance this. ';
  else if (elem === 'Fire') health += '<br>Your fiery constitution (Pitta) suggests attention to digestion, inflammation, and heat-related conditions. Cooling practices help. ';
  else if (elem === 'Earth') health += '<br>Your earthy constitution (Kapha) suggests attention to weight, congestion, and lethargy. Active lifestyle and light diet balance this. ';
  else if (elem === 'Water') health += '<br>Your watery constitution suggests attention to emotional health, fluid balance, and respiratory system. ';

  // Specific planetary indicators
  if (chart.planets.Saturn.house === 1 || getAspectsOnHouse(1, chart).includes('Saturn')) {
    health += 'Saturn\'s influence on the ascendant indicates a lean build, longevity, but possibly slow metabolism. Joint and bone health need attention in later years. ';
  }
  if (chart.planets.Mars.house === 1 || getAspectsOnHouse(1, chart).includes('Mars')) {
    health += 'Mars\'s influence gives strong physical stamina and muscular build but watch for inflammation, accidents, and blood-related issues. ';
  }

  sections.push({title:'Health & Vitality', icon:'\u2695', content:health});

  // 5. SPIRITUALITY & DHARMA
  const h9Lord = SIGN_LORDS[(asc+8)%12];
  const h12Lord = SIGN_LORDS[(asc+11)%12];
  const jupData = chart.planets.Jupiter;
  const ketuData = chart.planets.Ketu;

  let spirit = '<b>Spiritual & Dharmic Path:</b><br>';
  spirit += `9th lord (dharma) <b>${h9Lord}</b> in ${ordinal(chart.planets[h9Lord].house)} house, 12th lord (moksha) <b>${h12Lord}</b> in ${ordinal(chart.planets[h12Lord].house)} house. `;

  if (chart.planets[h9Lord].house === 1) spirit += '<span style="color:var(--saffron)">The 9th lord in 1st house is a powerful blessing — you carry dharmic fortune in your very being. Naturally righteous and fortunate.</span> ';
  spirit += `<br><br>Jupiter (Guru) in ${ordinal(jupData.house)} house indicates `;
  if (jupData.house === 1) spirit += 'a naturally wise, philosophical, and spiritually inclined personality. Teachers and wisdom traditions play a vital role in your life. ';
  else if (jupData.house === 9) spirit += 'the most fortunate placement for spiritual growth and guru connections. ';
  else if (jupData.house === 5) spirit += 'strong devotional nature and past-life spiritual merit. ';

  spirit += `<br>Ketu in ${ordinal(ketuData.house)} house suggests `;
  if (ketuData.house === 4) spirit += 'spiritual detachment from material comforts and domestic attachment. Past-life spiritual practices create a naturally renunciate quality. Deep meditation ability. ';
  else if (ketuData.house === 12) spirit += 'strong moksha potential and natural inclination toward liberation. ';
  else if (ketuData.house === 9) spirit += 'past-life guru connections and deep philosophical insights. ';

  sections.push({title:'Spirituality & Dharma', icon:'\u0950', content:spirit});

  // 6. YOGAS (already computed, but provide deeper analysis)
  let yogaText = '<b>Significant Yogas in Your Chart:</b><br><br>';
  chart.yogas.forEach(y => {
    yogaText += `<span style="color:var(--saffron)"><b>${y.name}</b></span>: ${y.desc}<br><br>`;
  });

  // Add yogakaraka analysis
  if (cls.yogakaraka) {
    yogaText += `<span style="color:var(--saffron)"><b>Yogakaraka Planet: ${cls.yogakaraka}</b></span> — `;
    yogaText += `As the lord of both a kendra and a trikona, ${cls.yogakaraka} is the single most beneficial planet for your ${RASHIS[asc].name} lagna. `;
    yogaText += `Its dasha periods, transits, and gemstone (${PLANETS_INFO[cls.yogakaraka].gem}) are especially favorable. `;
    const ykH = chart.planets[cls.yogakaraka].house;
    yogaText += `Placed in your ${ordinal(ykH)} house, it activates themes of ${HOUSE_AREAS[ykH].area}.<br><br>`;
  }

  sections.push({title:'Yogas & Special Combinations', icon:'\u2726', content:yogaText});

  return sections;
}

// ---- CHART-SPECIFIC MAHADASHA PREDICTIONS ----
function generateDashaPrediction(chart, lord) {
  const asc = chart.ascRashi.index;
  const houses = getLordships(lord, asc);
  const cls = classifyPlanets(asc);
  const p = chart.planets[lord];
  const dig = p ? getDignity(lord, p.rashi.index) : 'neutral';
  const conj = p ? getConjunctions(lord, chart) : [];
  const hAreas = houses.map(h => HOUSE_AREAS[h].short).join(' & ');
  const hFull = houses.map(h => `${ordinal(h)} (${HOUSE_AREAS[h].area})`).join(' and ');

  let pred = '';

  // Opener — lordship context
  if (houses.length > 0) {
    pred += `<b>${lord} rules your ${hFull} houses</b> and is placed in your <b>${ordinal(p.house)} house</b> (${HOUSE_AREAS[p.house].area}). `;
  } else {
    pred += `<b>${lord}</b> (shadow planet) occupies your <b>${ordinal(p.house)} house</b> (${HOUSE_AREAS[p.house].area}). `;
  }

  // Dignity effect
  if (dig === 'exalted') pred += `<span style="color:var(--accent-green)">Being exalted, ${lord} delivers its results with exceptional strength and positivity during this period.</span> `;
  else if (dig === 'debilitated') pred += `<span style="color:var(--accent-red)">${lord} is debilitated, meaning results may come with difficulty, delays, or after overcoming challenges. Remedies for ${lord} are strongly recommended.</span> `;
  else if (dig === 'own-sign') pred += `In its own sign, ${lord} delivers its results with confidence and natural authority. `;

  // Yogakaraka status
  if (cls.yogakaraka === lord) {
    pred += `<span style="color:var(--saffron)"><b>${lord} is your Yogakaraka — the most auspicious planet for your lagna.</b> This is one of the most favorable periods of your life.</span> `;
  }

  pred += '<br><br>';

  // House-specific predictions based on lordship
  houses.forEach(h => {
    pred += `<b>As ${ordinal(h)} lord:</b> `;
    const hl = HOUSE_AREAS[h];
    if (h === 1) pred += 'Focus on personal development, health improvement, and self-expression. Your identity transforms during this period. ';
    if (h === 2) pred += 'Family matters, accumulation of wealth, and speech/communication become prominent. Financial decisions carry long-term significance. ';
    if (h === 3) pred += 'Courage, initiative, and new skills develop. Sibling relationships are highlighted. Short travels and learning opportunities arise. ';
    if (h === 4) pred += 'Home, property, mother, vehicles, and emotional well-being are activated. Possible property acquisition or home changes. ';
    if (h === 5) pred += 'Children, education, creativity, and romance flourish. Speculative gains possible. Intelligence and creative expression peak. ';
    if (h === 6) pred += 'Health challenges may arise but are overcome. Competition in work, legal matters, and service-oriented activities become prominent. ';
    if (h === 7) pred += 'Marriage, partnerships, and business relationships dominate. For unmarried natives, marriage prospects arise. Public dealings increase. ';
    if (h === 8) pred += 'Transformation, sudden changes, research, and occult interests intensify. Inheritance or insurance matters surface. Watch health of close ones. ';
    if (h === 9) pred += 'Fortune, spiritual growth, long-distance travel, higher education, and connection with teachers/mentors are activated. A dharmic period. ';
    if (h === 10) pred += 'Career advancement, professional recognition, and public authority are highlighted. This is a period of achievement and responsibility. ';
    if (h === 11) pred += 'Income increases, desires are fulfilled, and social connections expand. Friends and elder siblings play important roles. ';
    if (h === 12) pred += 'Foreign travel or residence, spiritual practices, and increased expenditure are indicated. Letting go of attachments brings peace. ';
  });

  // Placement-specific effects
  pred += `<br><b>Placed in ${ordinal(p.house)} house:</b> The themes of ${HOUSE_AREAS[p.house].area} form the arena where ${hAreas} matters manifest. `;

  // Conjunction effects
  if (conj.length > 0) {
    pred += `<br><b>Conjunction with ${conj.join(', ')}:</b> `;
    conj.forEach(c => {
      const cHouses = getLordships(c, asc);
      if (cHouses.length) pred += `${c} (lord of ${cHouses.map(h => ordinal(h)).join(', ')}) brings ${HOUSE_AREAS[cHouses[0]].short.toLowerCase()} themes into this dasha. `;
    });
  }

  // Natural signification
  pred += `<br><br><b>Key themes:</b> ${PLANET_KARAKAS[lord]}. `;

  return pred;
}

// ---- ANTARDASHA PREDICTIONS ----
function generateAntarPrediction(chart, mdLord, adLord) {
  const asc = chart.ascRashi.index;
  const mdHouses = getLordships(mdLord, asc);
  const adHouses = getLordships(adLord, asc);
  const adP = chart.planets[adLord];
  const mdP = chart.planets[mdLord];

  let pred = '';
  const adHArea = adHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' and ');
  const mdHArea = mdHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' and ');

  if (mdLord === adLord) {
    pred += `${mdLord}'s own sub-period intensifies its Mahadasha effects. The themes of ${mdHArea || mdLord + '\'s significations'} are at their peak. A defining sub-period within this Mahadasha. `;
  } else {
    pred += `${adLord} activates themes of ${adHArea || adLord + '\'s significations'} within the broader ${mdLord} Mahadasha context of ${mdHArea || mdLord + '\'s significations'}. `;
  }

  // Check mutual relationship
  if (adP && mdP && adP.house === mdP.house) {
    pred += `${mdLord} and ${adLord} are conjoined in the natal chart — this sub-period is especially potent and can bring significant events. `;
  }

  // Dignity of AD lord
  const dig = adP ? getDignity(adLord, adP.rashi.index) : '';
  if (dig === 'exalted') pred += `${adLord} is exalted — expect positive outcomes. `;
  if (dig === 'debilitated') pred += `${adLord} is debilitated — challenges may arise, requiring patience and remedies. `;

  // House placement meaning
  if (adP) {
    pred += `${adLord} in the ${ordinal(adP.house)} house brings focus to ${HOUSE_AREAS[adP.house].life}. `;
  }

  return pred;
}

// ---- ENHANCED TRANSIT READING ----
function generateTransitReading(chart, transitPlanets) {
  const asc = chart.ascRashi.index;
  const moonSign = chart.planets.Moon.rashi.index;
  const readings = [];

  // Sade Sati check (Saturn transiting 12th, 1st, or 2nd from natal Moon)
  const satTransitSign = Math.floor(transitPlanets.Saturn / 30) % 12;
  const satFromMoon = ((satTransitSign - moonSign + 12) % 12);
  let sadeSati = null;
  if (satFromMoon === 11) sadeSati = {phase:'Rising (1st phase)',desc:'Saturn transiting the 12th from Moon — the beginning phase of Sade Sati. Expenses increase, mental restlessness, and changes in environment. Focus on savings and mental peace.'};
  else if (satFromMoon === 0) sadeSati = {phase:'Peak (2nd phase)',desc:'Saturn transiting over natal Moon — the peak of Sade Sati. Emotional challenges, health of self and mother needs care, career pressures mount. This is the most intense phase. Meditation, Saturn mantras, and patience are essential.'};
  else if (satFromMoon === 1) sadeSati = {phase:'Setting (3rd phase)',desc:'Saturn transiting the 2nd from Moon — the final phase of Sade Sati. Financial pressure, family tensions, and speech-related issues. The challenges begin to ease. Charitable activities bring relief.'};

  if (sadeSati) {
    readings.push({
      type: 'sadeSati',
      title: `Sade Sati — ${sadeSati.phase}`,
      content: sadeSati.desc,
      severity: 'high'
    });
  }

  // Major transits analysis
  ['Jupiter','Saturn','Rahu','Ketu'].forEach(pName => {
    const tLon = transitPlanets[pName];
    const tSign = Math.floor(tLon / 30) % 12;
    const tHouse = getHouse(tLon, chart.ascendant);
    const fromMoon = ((tSign - moonSign + 12) % 12) + 1;

    let content = `<b>${pName} transiting ${ordinal(tHouse)} house from Lagna, ${ordinal(fromMoon)} from Moon.</b><br>`;

    // From Lagna
    content += `<b>From Lagna:</b> ${pName} activates ${HOUSE_AREAS[tHouse].area}. `;

    // Specific transit effects
    if (pName === 'Jupiter') {
      if ([1,2,5,7,9,11].includes(tHouse)) content += '<span style="color:var(--accent-green)">This is a favorable transit for Jupiter — expansion and blessings in this area of life.</span> ';
      else content += 'Jupiter here brings lessons through expansion in challenging areas. Focus on wisdom over indulgence. ';

      if ([2,5,7,9,11].includes(fromMoon)) content += 'Jupiter\'s transit from Moon is also favorable — emotional well-being and fortune improve. ';
    }
    if (pName === 'Saturn') {
      if ([3,6,11].includes(fromMoon)) content += '<span style="color:var(--accent-green)">Saturn transiting the ' + ordinal(fromMoon) + ' from Moon is favorable — obstacles diminish and effort bears fruit.</span> ';
      else content += 'Saturn here demands discipline, patience, and hard work in the area of ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. ';
    }
    if (pName === 'Rahu') {
      content += 'Rahu\'s transit here creates intense desire, ambition, and unconventional developments in ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. Stay grounded and avoid shortcuts. ';
    }
    if (pName === 'Ketu') {
      content += 'Ketu\'s transit brings spiritual lessons, detachment, and past-karma resolution regarding ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. ';
    }

    // Which natal planets does the transit aspect
    const natalInHouse = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === tHouse);
    if (natalInHouse.length > 0) {
      content += `<br><b>Transit ${pName} conjuncts natal ${natalInHouse.join(', ')}</b> — this significantly activates these planets' significations. `;
    }

    readings.push({ type: 'transit', title: `${PLANETS_INFO[pName].symbol} ${pName} Transit`, content, severity: 'normal' });
  });

  return readings;
}

// ============================================================
//  YEARLY FORECAST ENGINE
// ============================================================

function generateYearPrediction(chart, year) {
  const asc = chart.ascRashi.index;
  const cls = classifyPlanets(asc);
  const moonSign = chart.planets.Moon.rashi.index;

  // --- Find all dasha periods active during this year ---
  const yearStart = new Date(year, 0, 1);
  const yearEnd = new Date(year, 11, 31, 23, 59, 59);

  // Find Mahadasha(s) active this year
  const yearMDs = [];
  chart.dashas.forEach(md => {
    if (md.endDate >= yearStart && md.startDate <= yearEnd) {
      // Find antardashas active during this year
      const yearADs = [];
      md.antardashas.forEach(ad => {
        if (ad.endDate >= yearStart && ad.startDate <= yearEnd) {
          yearADs.push(ad);
        }
      });
      yearMDs.push({ ...md, activeADs: yearADs });
    }
  });

  // --- Compute transits at 4 quarterly midpoints ---
  const quarters = [
    { label: 'Q1: Jan — Mar', month: 1, day: 15 },
    { label: 'Q2: Apr — Jun', month: 4, day: 15 },
    { label: 'Q3: Jul — Sep', month: 7, day: 15 },
    { label: 'Q4: Oct — Dec', month: 10, day: 15 }
  ];

  const quarterData = quarters.map(q => {
    const jd = julianDay(year, q.month, q.day, 12);
    const planets = calculatePlanets(jd);
    // Compute house positions from lagna
    const positions = {};
    ['Jupiter','Saturn','Rahu','Ketu','Sun','Mars','Venus','Mercury'].forEach(p => {
      const lon = planets[p];
      positions[p] = {
        lon,
        sign: Math.floor(lon / 30) % 12,
        house: getHouse(lon, chart.ascendant),
        rashi: getRashi(lon)
      };
    });

    // Find active MD/AD for this quarter
    const qDate = new Date(year, q.month - 1, q.day);
    let qMD = '', qAD = '';
    chart.dashas.forEach(md => {
      if (qDate >= md.startDate && qDate < md.endDate) {
        qMD = md.lord;
        md.antardashas.forEach(ad => {
          if (qDate >= ad.startDate && qDate < ad.endDate) {
            qAD = ad.lord;
          }
        });
      }
    });

    return { ...q, positions, md: qMD, ad: qAD };
  });

  // --- 1. YEAR OVERVIEW ---
  const primaryMD = yearMDs[0];
  const mdLord = primaryMD ? primaryMD.lord : '?';
  const mdHouses = getLordships(mdLord, asc);
  const mdAreas = mdHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' & ');
  const mdDig = primaryMD && chart.planets[mdLord] ? getDignity(mdLord, chart.planets[mdLord].rashi.index) : '';

  let overview = `<b>${year} is governed by the ${mdLord} Mahadasha</b>`;
  if (yearMDs.length > 1) overview += `, transitioning to ${yearMDs[1].lord} Mahadasha`;
  overview += '. ';

  // Antardasha transitions
  const adNames = [];
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const s = ad.startDate > yearStart ? ad.startDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Jan';
      const e = ad.endDate < yearEnd ? ad.endDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Dec';
      adNames.push(`<b>${ad.lord}</b> (${s} — ${e})`);
    });
  }
  if (adNames.length > 0) overview += `Sub-periods active: ${adNames.join(', ')}. `;

  overview += `<br><br>The overarching theme revolves around <b>${mdAreas || mdLord + '\'s significations'}</b>. `;
  if (mdDig === 'exalted') overview += `<span style="color:var(--accent-green)">${mdLord} is exalted in your chart — this year carries an especially auspicious and empowered energy.</span> `;
  else if (mdDig === 'debilitated') overview += `<span style="color:var(--accent-red)">${mdLord} is debilitated — challenges and growth through adversity define this period. Remedies are strongly recommended.</span> `;
  else if (mdDig === 'own-sign') overview += `${mdLord} is in its own sign, giving stability and authenticity to this year's themes. `;

  if (cls.yogakaraka === mdLord) overview += `<br><span style="color:var(--saffron)"><b>${mdLord} is your Yogakaraka — this year is among the most favorable in your life cycle.</b> Embrace opportunities boldly.</span> `;
  if (cls.malefics.includes(mdLord)) overview += `Being a functional malefic for your lagna, this year requires extra caution, patience, and proactive remedial measures. `;

  // Major transit overview for the year
  const jupQ1 = quarterData[0].positions.Jupiter;
  const satQ1 = quarterData[0].positions.Saturn;
  overview += `<br><br><b>Key transits:</b> Jupiter transits your <b>${ordinal(jupQ1.house)} house</b> (${RASHIS[jupQ1.sign].eng})`;
  const jupQ4 = quarterData[3].positions.Jupiter;
  if (jupQ4.house !== jupQ1.house) overview += ` moving to <b>${ordinal(jupQ4.house)} house</b> (${RASHIS[jupQ4.sign].eng}) later in the year`;
  overview += `. Saturn occupies your <b>${ordinal(satQ1.house)} house</b> (${RASHIS[satQ1.sign].eng})`;
  const satQ4 = quarterData[3].positions.Saturn;
  if (satQ4.house !== satQ1.house) overview += ` shifting to <b>${ordinal(satQ4.house)} house</b>`;
  overview += '. ';

  // Sade Sati check for the year
  const satSignQ1 = satQ1.sign;
  const satFromMoonQ1 = ((satSignQ1 - moonSign + 12) % 12);
  if ([11,0,1].includes(satFromMoonQ1)) {
    const phases = {11:'Rising (1st phase)',0:'Peak (2nd phase)',1:'Setting (3rd phase)'};
    overview += `<br><span style="color:var(--accent-red)"><b>Sade Sati is active (${phases[satFromMoonQ1]})</b> — this adds an overlay of karmic lessons, emotional tests, and the need for patience throughout ${year}.</span> `;
  }

  // --- 2. QUARTERLY BREAKDOWN ---
  const quarterPredictions = quarterData.map(q => {
    let text = '';

    // Major slow planet transits
    ['Jupiter','Saturn','Rahu','Ketu'].forEach(p => {
      const pos = q.positions[p];
      text += `<b>${p}</b> in ${ordinal(pos.house)} house (${RASHIS[pos.sign].eng}). `;
    });

    text += '<br><br>';

    // Dasha context for this quarter
    const adHouses = getLordships(q.ad, asc);
    const adAreas = adHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' & ');
    text += `Under <b>${q.md}-${q.ad}</b> period, focus is on <b>${adAreas || q.ad + '\'s significations'}</b>. `;
    text += generateAntarPrediction(chart, q.md, q.ad) + ' ';

    // Jupiter's blessing or challenge
    const jH = q.positions.Jupiter.house;
    if ([1,2,5,7,9,11].includes(jH)) {
      text += `<br><span style="color:var(--accent-green)">Jupiter\'s favorable transit through the ${ordinal(jH)} house supports growth in ${HOUSE_AREAS[jH].short.toLowerCase()}.</span> `;
    }

    // Saturn's pressure or support
    const sH = q.positions.Saturn.house;
    const satFromMoon = ((q.positions.Saturn.sign - moonSign + 12) % 12) + 1;
    if ([3,6,11].includes(satFromMoon)) {
      text += `Saturn\'s transit is favorable from Moon — ${HOUSE_AREAS[sH].short.toLowerCase()} efforts bear fruit. `;
    } else {
      text += `Saturn in ${ordinal(sH)} demands discipline regarding ${HOUSE_AREAS[sH].life}. `;
    }

    // Any natal conjunctions from transits
    ['Jupiter','Saturn','Rahu'].forEach(tp => {
      const tHouse = q.positions[tp].house;
      const natal = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === tHouse);
      if (natal.length > 0) {
        text += `Transit ${tp} activates natal ${natal.join(', ')} — significant developments in ${HOUSE_AREAS[tHouse].short.toLowerCase()}. `;
      }
    });

    return { ...q, prediction: text };
  });

  // --- 3. LIFE AREA PREDICTIONS ---
  // Career
  const h10Lord = SIGN_LORDS[(asc+9)%12];
  const h10Data = chart.planets[h10Lord];
  let careerPred = '';
  const jupHouses = quarterData.map(q => q.positions.Jupiter.house);
  const satHouses = quarterData.map(q => q.positions.Saturn.house);
  if (jupHouses.includes(10) || jupHouses.includes(1) || jupHouses.includes(9)) {
    careerPred += '<span style="color:var(--accent-green)">Jupiter\'s transit through career-enhancing houses this year brings expansion, promotions, and recognition.</span> ';
  }
  if (satHouses.includes(10)) {
    careerPred += 'Saturn transiting the 10th house demands hard work and may bring restructuring, but lasting achievement follows. ';
  }
  careerPred += `Your 10th lord ${h10Lord} is natally in the ${ordinal(h10Data.house)} house — its dasha/antardasha activation determines the timing of career peaks. `;
  // MD lord connection to career
  if (mdHouses.includes(10) || mdHouses.includes(1) || mdHouses.includes(7)) {
    careerPred += `The ruling ${mdLord} Mahadasha directly connects to your career axis, making ${year} professionally significant. `;
  }
  // Check active ADs for career relevance
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const adH = getLordships(ad.lord, asc);
      if (adH.includes(10) || adH.includes(6)) {
        const s = ad.startDate.toLocaleDateString('en-US',{month:'short'});
        const e = ad.endDate.toLocaleDateString('en-US',{month:'short'});
        careerPred += `${ad.lord} antardasha (${s}-${e}) rules career/work houses — a period of heightened professional activity. `;
      }
    });
  }

  // Finance
  const h2Lord = SIGN_LORDS[(asc+1)%12];
  const h11Lord = SIGN_LORDS[(asc+10)%12];
  let financePred = '';
  if (jupHouses.includes(2) || jupHouses.includes(11)) {
    financePred += '<span style="color:var(--accent-green)">Jupiter transiting wealth houses (2nd/11th) is a strong indicator of financial growth and new income sources.</span> ';
  }
  if (satHouses.includes(2)) {
    financePred += 'Saturn in the 2nd house calls for disciplined saving and careful financial management. ';
  }
  if (satHouses.includes(11)) {
    financePred += 'Saturn in the 11th restricts gains initially but rewards sustained effort by year end. ';
  }
  financePred += `2nd lord ${h2Lord} (wealth) in ${ordinal(chart.planets[h2Lord].house)} house, 11th lord ${h11Lord} (gains) in ${ordinal(chart.planets[h11Lord].house)} house shape your baseline earning potential. `;
  if (mdHouses.includes(2) || mdHouses.includes(11)) {
    financePred += `The ${mdLord} Mahadasha directly activates wealth houses — financial themes are prominent in ${year}. `;
  }

  // Relationships
  const h7Lord = SIGN_LORDS[(asc+6)%12];
  let relPred = '';
  if (jupHouses.includes(7)) {
    relPred += '<span style="color:var(--accent-green)">Jupiter transiting the 7th house blesses partnerships and may bring marriage or a significant relationship.</span> ';
  }
  if (satHouses.includes(7)) {
    relPred += 'Saturn in the 7th tests relationships through responsibility and maturity. Commitment deepens for those who persevere. ';
  }
  const rahuHouses = quarterData.map(q => q.positions.Rahu.house);
  if (rahuHouses.includes(7)) {
    relPred += 'Rahu in the 7th brings intense desire for partnership, unconventional relationships, or foreign spouse connections. ';
  }
  relPred += `7th lord ${h7Lord} in the ${ordinal(chart.planets[h7Lord].house)} house and Venus in the ${ordinal(chart.planets.Venus.house)} house define your relationship karma. `;
  if (mdHouses.includes(7) || mdHouses.includes(5)) {
    relPred += `${mdLord} Mahadasha activates relationship/romance houses this year. `;
  }
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const adH = getLordships(ad.lord, asc);
      if (adH.includes(7) || adH.includes(5)) {
        const s = ad.startDate.toLocaleDateString('en-US',{month:'short'});
        const e = ad.endDate.toLocaleDateString('en-US',{month:'short'});
        relPred += `${ad.lord} sub-period (${s}-${e}) activates romance/partnership — watch for key relationship events. `;
      }
    });
  }

  // Health
  const h6Lord = SIGN_LORDS[(asc+5)%12];
  let healthPred = '';
  if (satHouses.includes(1) || satHouses.includes(6) || satHouses.includes(8)) {
    healthPred += 'Saturn transiting health-sensitive houses requires attention to physical stamina, bone/joint health, and chronic conditions. ';
  }
  if (jupHouses.includes(1) || jupHouses.includes(6)) {
    healthPred += '<span style="color:var(--accent-green)">Jupiter\'s protective influence on health houses provides recovery and vitality.</span> ';
  }
  const marsHouses = quarterData.map(q => q.positions.Mars.house);
  if (marsHouses.includes(1) || marsHouses.includes(6) || marsHouses.includes(8)) {
    healthPred += 'Mars transiting health houses can bring acute conditions, fevers, or accident risk — exercise caution during these months. ';
  }
  healthPred += `Your 6th lord ${h6Lord} in the ${ordinal(chart.planets[h6Lord].house)} house defines disease patterns. `;
  if (mdHouses.includes(6) || mdHouses.includes(8)) {
    healthPred += `The ruling Mahadasha activates health/transformation houses — proactive health management is advised in ${year}. `;
  }

  // Spiritual
  const h9Lord = SIGN_LORDS[(asc+8)%12];
  let spiritPred = '';
  if (jupHouses.includes(9) || jupHouses.includes(12) || jupHouses.includes(5)) {
    spiritPred += '<span style="color:var(--accent-green)">Jupiter in dharma/moksha houses enhances spiritual insight, guru connections, and philosophical growth.</span> ';
  }
  const ketuHouses = quarterData.map(q => q.positions.Ketu.house);
  if (ketuHouses.includes(12) || ketuHouses.includes(9) || ketuHouses.includes(5)) {
    spiritPred += 'Ketu transiting spiritual houses deepens meditation, past-life awareness, and detachment from material pursuits. ';
  }
  spiritPred += `9th lord ${h9Lord} in ${ordinal(chart.planets[h9Lord].house)} house and Jupiter in ${ordinal(chart.planets.Jupiter.house)} house shape your spiritual foundation. `;
  if (mdHouses.includes(9) || mdHouses.includes(12)) {
    spiritPred += `${mdLord} Mahadasha activates spiritual houses — ${year} can be a year of profound inner growth. `;
  }

  return {
    overview,
    quarterPredictions,
    areas: [
      { title: 'Career & Professional Life', icon: '\u2617', content: careerPred },
      { title: 'Finance & Wealth', icon: '&#x1F4B0;', content: financePred },
      { title: 'Relationships & Marriage', icon: '\u2665', content: relPred },
      { title: 'Health & Vitality', icon: '\u2695', content: healthPred },
      { title: 'Spiritual Growth', icon: '\u0950', content: spiritPred }
    ],
    mdLord,
    yearMDs
  };
}

// ============================================================
//  CHART RENDERING (SVG)
// ============================================================

function renderNorthIndianChart(chart) {
  const S = 380; // chart size
  const C = S / 2; // center
  const TL=[0,0],TR=[S,0],BR=[S,S],BL=[0,S];
  const T=[C,0],R=[S,C],B=[C,S],L=[0,C];
  const CT=[C,C];

  // Intersection points of outer diagonals with diamond edges
  const P1=[S*0.25,S*0.25]; // TL diagonal meets T-L edge
  const P2=[S*0.75,S*0.25]; // TR diagonal meets T-R edge
  const P3=[S*0.75,S*0.75]; // TL diagonal meets R-B edge
  const P4=[S*0.25,S*0.75]; // TR diagonal meets B-L edge

  // 12 house polygons
  const houses = [
    /*1*/  [T,P2,CT,P1],
    /*2*/  [T,TR,P2],
    /*3*/  [TR,R,P2],
    /*4*/  [P2,R,P3,CT],
    /*5*/  [R,BR,P3],
    /*6*/  [BR,B,P3],
    /*7*/  [P3,B,P4,CT],
    /*8*/  [B,BL,P4],
    /*9*/  [BL,L,P4],
    /*10*/ [P4,L,P1,CT],
    /*11*/ [L,TL,P1],
    /*12*/ [TL,T,P1],
  ];

  // Label positions (center of each house)
  const labelPos = houses.map(poly => {
    const cx = poly.reduce((s,p)=>s+p[0],0)/poly.length;
    const cy = poly.reduce((s,p)=>s+p[1],0)/poly.length;
    return [cx, cy];
  });

  // Build planet-to-house mapping
  const housePlanets = {};
  for (let i = 1; i <= 12; i++) housePlanets[i] = [];
  // Add ascendant marker
  const ascHouse = 1; // by definition in whole-sign system
  for (const pName in chart.planets) {
    const h = chart.planets[pName].house;
    housePlanets[h].push(pName);
  }

  let svg = `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" xmlns="http://www.w3.org/2000/svg">`;
  // Background
  svg += `<rect x="0" y="0" width="${S}" height="${S}" rx="12" fill="#FFFCF8" stroke="rgba(74,53,128,0.15)" stroke-width="1.5"/>`;

  // Draw house polygons
  houses.forEach((poly, i) => {
    const points = poly.map(p => p.join(',')).join(' ');
    const fill = i === 0 ? 'rgba(212,113,10,0.06)' : 'rgba(74,53,128,0.02)';
    svg += `<polygon points="${points}" fill="${fill}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
  });

  // House numbers
  houses.forEach((poly, i) => {
    const [cx, cy] = labelPos[i];
    const houseNum = i + 1;
    svg += `<text x="${cx}" y="${cy - 20}" text-anchor="middle" fill="rgba(212,113,10,0.45)" font-size="11" font-family="Plus Jakarta Sans,sans-serif" font-weight="600">${houseNum}</text>`;

    // Rashi for this house (whole sign from ascendant)
    const rashiIdx = (chart.ascRashi.index + i) % 12;
    svg += `<text x="${cx}" y="${cy - 8}" text-anchor="middle" fill="rgba(74,53,128,0.5)" font-size="10" font-family="Inter">${RASHIS[rashiIdx].eng.substring(0,3)}</text>`;

    // Planets in this house
    const planetList = housePlanets[houseNum];
    planetList.forEach((pName, pi) => {
      const abbr = pName === "Mercury" ? "Me" : pName === "Jupiter" ? "Ju" : pName === "Venus" ? "Ve" : pName === "Saturn" ? "Sa" : pName.substring(0, 2);
      const color = PLANET_COLORS[pName] || '#2D2B3D';
      const yOffset = 6 + pi * 15;
      svg += `<text x="${cx}" y="${cy + yOffset}" text-anchor="middle" fill="${color}" font-size="12" font-weight="600" font-family="Inter">${abbr}</text>`;
    });
  });

  // ASC marker in house 1
  svg += `<text x="${C}" y="${S*0.18}" text-anchor="middle" fill="#D4710A" font-size="10" font-weight="700" font-family="Plus Jakarta Sans,sans-serif" letter-spacing="2">ASC</text>`;

  svg += '</svg>';
  return svg;
}

function renderSouthIndianChart(chart) {
  const S = 380;
  const cellW = S / 4;
  const cellH = S / 4;

  // South Indian chart: fixed sign positions in a 4x4 grid
  // Outer 12 cells hold the 12 signs, inner 4 are empty
  // Signs go clockwise starting from Pisces (index 11) at top-left
  const signPositions = [
    {sign:11,row:0,col:0}, // Pisces
    {sign:0,row:0,col:1},  // Aries
    {sign:1,row:0,col:2},  // Taurus
    {sign:2,row:0,col:3},  // Gemini
    {sign:3,row:1,col:3},  // Cancer
    {sign:4,row:2,col:3},  // Leo
    {sign:5,row:3,col:3},  // Virgo
    {sign:6,row:3,col:2},  // Libra
    {sign:7,row:3,col:1},  // Scorpio
    {sign:8,row:3,col:0},  // Sagittarius
    {sign:9,row:2,col:0},  // Capricorn
    {sign:10,row:1,col:0}, // Aquarius
  ];

  // Map planets to signs
  const signPlanets = {};
  for (let i = 0; i < 12; i++) signPlanets[i] = [];
  for (const pName in chart.planets) {
    const rashiIdx = chart.planets[pName].rashi.index;
    signPlanets[rashiIdx].push(pName);
  }

  let svg = `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" xmlns="http://www.w3.org/2000/svg">`;
  // Background
  svg += `<rect x="0" y="0" width="${S}" height="${S}" rx="12" fill="#FFFCF8" stroke="rgba(74,53,128,0.15)" stroke-width="1.5"/>`;

  // Draw grid
  for (let i = 0; i <= 4; i++) {
    svg += `<line x1="${i*cellW}" y1="0" x2="${i*cellW}" y2="${S}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
    svg += `<line x1="0" y1="${i*cellH}" x2="${S}" y2="${i*cellH}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
  }

  // Inner area
  svg += `<rect x="${cellW}" y="${cellH}" width="${cellW*2}" height="${cellH*2}" fill="rgba(212,113,10,0.03)"/>`;
  svg += `<text x="${S/2}" y="${S/2 - 8}" text-anchor="middle" fill="rgba(212,113,10,0.4)" font-size="14" font-family="Plus Jakarta Sans,sans-serif" font-weight="600">KUNDALI</text>`;
  svg += `<text x="${S/2}" y="${S/2 + 10}" text-anchor="middle" fill="rgba(74,53,128,0.35)" font-size="10" font-family="Plus Jakarta Sans,sans-serif">South Indian</text>`;

  // Draw signs and planets
  signPositions.forEach(sp => {
    const x = sp.col * cellW;
    const y = sp.row * cellH;
    const cx = x + cellW / 2;
    const cy = y + cellH / 2;
    const rashi = RASHIS[sp.sign];
    const isAscSign = sp.sign === chart.ascRashi.index;

    if (isAscSign) {
      svg += `<rect x="${x+1}" y="${y+1}" width="${cellW-2}" height="${cellH-2}" fill="rgba(212,113,10,0.06)"/>`;
      // Diagonal line in ASC cell (traditional marker)
      svg += `<line x1="${x+2}" y1="${y+2}" x2="${x+18}" y2="${y+18}" stroke="rgba(212,113,10,0.45)" stroke-width="1.5"/>`;
    }

    // Sign label: symbol + abbreviation on one line, top-left
    svg += `<text x="${x+6}" y="${y+14}" fill="rgba(212,113,10,0.35)" font-size="11">${rashi.symbol}</text>`;
    svg += `<text x="${x+20}" y="${y+14}" fill="rgba(74,53,128,0.5)" font-size="9" font-family="Inter">${rashi.eng.substring(0,3)}</text>`;

    // Planets in this sign — centered in cell, starting below the sign label
    const pList = signPlanets[sp.sign];
    pList.forEach((pName, pi) => {
      const abbr = pName === "Mercury" ? "Me" : pName === "Jupiter" ? "Ju" : pName === "Venus" ? "Ve" : pName === "Saturn" ? "Sa" : pName.substring(0, 2);
      const color = PLANET_COLORS[pName] || '#2D2B3D';
      const col = pi % 2;
      const row = Math.floor(pi / 2);
      const px = cx - 12 + col * 24;
      const py = y + 32 + row * 16;
      svg += `<text x="${px}" y="${py}" text-anchor="middle" fill="${color}" font-size="12" font-weight="600" font-family="Inter">${abbr}</text>`;
    });

    // House number
    const houseNum = ((sp.sign - chart.ascRashi.index + 12) % 12) + 1;
    svg += `<text x="${x + cellW - 8}" y="${y + cellH - 4}" text-anchor="end" fill="rgba(212,113,10,0.25)" font-size="9" font-family="Inter">${houseNum}</text>`;
  });

  svg += '</svg>';
  return svg;
}

// ============================================================
//  RENDERING FUNCTIONS
// ============================================================

let currentChart = null;
let chartStyle = 'north';

// Resolve city name → coordinates (handles both dropdown selection and manual typing)
function resolveCity(inputText) {
  const text = inputText.trim().toLowerCase();
  if (!text) return null;

  // 1. Exact match on "Name, Country" (from dropdown selection)
  let match = CITIES.find(c => (c.name + ', ' + c.country).toLowerCase() === text);
  if (match) return match;

  // 2. Exact match on city name alone
  match = CITIES.find(c => c.name.toLowerCase() === text);
  if (match) return match;

  // 3. Starts-with match (e.g. user typed "kanpur" without clicking dropdown)
  const startMatches = CITIES.filter(c => c.name.toLowerCase().startsWith(text));
  if (startMatches.length === 1) return startMatches[0];

  // 4. Contains match
  const containsMatches = CITIES.filter(c => c.name.toLowerCase().includes(text));
  if (containsMatches.length === 1) return containsMatches[0];

  return null;
}

function generateChart() {
  const dob = document.getElementById('dob').value;
  const tob = document.getElementById('tob').value;
  const cityText = document.getElementById('city').value;

  // Always resolve city from the text input — never rely solely on hidden fields
  const resolved = resolveCity(cityText);
  let lat, lon, tz, cityName;

  if (resolved) {
    lat = resolved.lat;
    lon = resolved.lon;
    tz  = resolved.tz;
    cityName = resolved.name + ', ' + resolved.country;
    // Sync hidden fields and display name
    document.getElementById('cityLat').value = lat;
    document.getElementById('cityLon').value = lon;
    document.getElementById('cityTz').value  = tz;
    document.getElementById('city').value    = cityName;
  } else {
    // Fall back to hidden fields (in case user manually edited them)
    lat = parseFloat(document.getElementById('cityLat').value);
    lon = parseFloat(document.getElementById('cityLon').value);
    tz  = parseFloat(document.getElementById('cityTz').value);
    cityName = cityText;
  }

  if (!dob || !tob || isNaN(lat) || isNaN(lon) || isNaN(tz)) {
    alert('Please select a valid city from the dropdown suggestions.\nType at least 2 letters and click a city from the list.');
    return;
  }

  currentChart = calculateFullChart(dob, tob, lat, lon, tz);
  currentChart.birthInfo = { dob, tob, city: cityName, lat, lon, tz };

  document.getElementById('results').classList.add('visible');

  renderSummary();
  renderChartSVG();
  renderChartReading();
  renderPlanetsTable();
  renderDasha();
  renderTransits();
  populateYearSelector();
  renderRemedies();

  document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

function renderSummary() {
  const c = currentChart;
  const d = c.debug;
  const moonNak = c.planets.Moon.nakshatra;
  const ascNak = getNakshatra(c.ascendant);
  const ascR = c.ascRashi;
  const moonR = c.planets.Moon.rashi;
  const sunR = c.planets.Sun.rashi;

  // Find current dasha
  const now = new Date();
  let currentMD = '', currentAD = '';
  for (const md of c.dashas) {
    if (now >= md.startDate && now < md.endDate) {
      currentMD = md.lord;
      for (const ad of md.antardashas) {
        if (now >= ad.startDate && now < ad.endDate) {
          currentAD = ad.lord;
          break;
        }
      }
      break;
    }
  }

  // Build tropical longitude debug rows
  let tropRows = '';
  if (d.tropical) {
    for (const p in d.tropical) {
      if (p === 'Ketu') continue; // skip to save space
      tropRows += `<span style="color:${PLANET_COLORS[p]||'#6B6880'}">${p}: ${d.tropical[p].toFixed(2)}°</span>  `;
    }
  }

  const html = `
    <div class="chart-info-card">
      <h4>&#9788; Ascendant (Lagna)</h4>
      <p>${ascR.name} (${ascR.eng}) ${ascR.symbol} at ${degToDMS(ascR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9789; Moon Sign (Rashi)</h4>
      <p>${moonR.name} (${moonR.eng}) ${moonR.symbol} at ${degToDMS(moonR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#10038; Janma Nakshatra (Moon)</h4>
      <p>${moonNak.name} (Pada ${moonNak.currentPada}) — Lord: ${moonNak.lord}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#10038; Lagna Nakshatra</h4>
      <p>${ascNak.name} (Pada ${ascNak.currentPada}) — Lord: ${ascNak.lord}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9788; Sun Sign</h4>
      <p>${sunR.name} (${sunR.eng}) ${sunR.symbol} at ${degToDMS(sunR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#8982; Current Dasha</h4>
      <p>${currentMD ? currentMD + ' / ' + currentAD : 'N/A (future birth date?)'}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9734; Birth Details</h4>
      <p>${c.birthInfo.city} — ${c.birthInfo.dob} at ${c.birthInfo.tob}</p>
    </div>

    <div class="chart-info-card" style="grid-column:1/-1;background:var(--bg-card2);border:1px dashed rgba(212,113,10,0.2)">
      <h4 style="cursor:pointer" onclick="document.getElementById('debugBody').style.display=document.getElementById('debugBody').style.display==='none'?'block':'none'">&#128269; Calculation Log (click to expand)</h4>
      <div id="debugBody" style="display:none;font-family:monospace;font-size:0.78em;line-height:1.8;color:var(--text-dim);margin-top:8px">
        <div><strong style="color:var(--saffron)">Location:</strong> Lat <b>${d.inputLat}</b>°, Lon <b>${d.inputLon}</b>°, TZ offset <b>${d.inputTz >= 0 ? '+' : ''}${d.inputTz}</b> hrs (UTC${d.inputTz >= 0 ? '+' : ''}${d.inputTz})</div>
        <div><strong style="color:var(--saffron)">Time:</strong> Local ${d.localTime} → UTC hour ${d.utcHour}</div>
        <div><strong style="color:var(--saffron)">Julian Day:</strong> ${d.julianDay}</div>
        <div><strong style="color:var(--saffron)">Lahiri Ayanamsa:</strong> ${d.ayanamsa}°</div>
        <div><strong style="color:var(--saffron)">GST:</strong> ${d.gst}° &nbsp; <strong style="color:var(--saffron)">LST:</strong> ${d.lst}°</div>
        <div style="margin-top:6px"><strong style="color:var(--saffron)">Tropical longitudes:</strong><br>${tropRows}</div>
        <div style="margin-top:4px;font-size:0.72em;color:var(--text-dim)">Engine: JPL Keplerian elements (Standish 1992) · Kepler eq. solved via Newton–Raphson · heliocentric→geocentric vector conversion · Lahiri (Chitrapaksha) ayanamsa</div>
      </div>
    </div>
  `;
  document.getElementById('summaryInfo').innerHTML = html;
}

function setChartStyle(style) {
  chartStyle = style;
  document.querySelectorAll('.chart-toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderChartSVG();
}

function renderChartSVG() {
  if (!currentChart) return;
  const svg = chartStyle === 'north'
    ? renderNorthIndianChart(currentChart)
    : renderSouthIndianChart(currentChart);
  document.getElementById('chartContainer').innerHTML = svg;
}

function renderChartReading() {
  if (!currentChart) return;
  const sections = generateChartReading(currentChart);
  let html = '';
  sections.forEach(s => {
    html += `<div class="reading-section">
      <h3><span class="rs-icon">${s.icon}</span> ${s.title}</h3>
      <div class="reading-body">${s.content}</div>
    </div>`;
  });
  document.getElementById('chartReadingContainer').innerHTML = html;
}

function renderPlanetsTable() {
  const c = currentChart;
  let html = `<thead><tr>
    <th>Planet</th><th>Sign</th><th>Degree</th><th>Nakshatra</th><th>Pada</th><th>House</th>
  </tr></thead><tbody>`;

  // Add Ascendant row
  const ascR = c.ascRashi;
  const ascNak = getNakshatra(c.ascendant);
  html += `<tr>
    <td><span class="planet-symbol" style="background:rgba(212,113,10,0.1);color:#D4710A">Asc</span><span class="planet-name">Ascendant</span></td>
    <td>${ascR.symbol} ${ascR.eng}</td>
    <td>${degToDMS(ascR.degrees)}</td>
    <td><span class="nakshatra-badge">${ascNak.name}</span></td>
    <td>${ascNak.currentPada}</td>
    <td>1</td>
  </tr>`;

  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];
  planetOrder.forEach(pName => {
    const p = c.planets[pName];
    const info = PLANETS_INFO[pName];
    const color = PLANET_COLORS[pName];
    html += `<tr>
      <td><span class="planet-symbol" style="background:${color}22;color:${color}">${info.symbol}</span><span class="planet-name">${info.sanskrit} (${pName})</span></td>
      <td>${p.rashi.symbol} ${p.rashi.eng}</td>
      <td>${degToDMS(p.rashi.degrees)}</td>
      <td><span class="nakshatra-badge">${p.nakshatra.name}</span></td>
      <td>${p.nakshatra.currentPada}</td>
      <td>${p.house}</td>
    </tr>`;
  });

  html += '</tbody>';
  document.getElementById('planetsTable').innerHTML = html;

  // Render Yogas
  let yogaHtml = '';
  c.yogas.forEach(y => {
    yogaHtml += `<div class="yoga-item">
      <div class="yoga-name">${y.name}</div>
      <div class="yoga-desc">${y.desc}</div>
    </div>`;
  });
  document.getElementById('yogaList').innerHTML = yogaHtml;
}

function renderDasha() {
  if (!currentChart) return;
  const granularity = document.getElementById('dashaGranularity').value;
  const c = currentChart;
  const now = new Date();
  const birthDate = new Date(c.birthInfo.dob + 'T' + c.birthInfo.tob);

  // Populate age selector
  const ageSelect = document.getElementById('dashaAge');
  if (ageSelect.options.length <= 1) {
    ageSelect.innerHTML = '<option value="">Current</option>';
    for (let age = 0; age <= 100; age += 10) {
      ageSelect.innerHTML += `<option value="${age}">Age ${age}</option>`;
    }
  }

  let html = '';
  c.dashas.forEach((md, mdIdx) => {
    const isCurrent = now >= md.startDate && now < md.endDate;
    const mdColor = PLANET_COLORS[md.lord] || '#2D2B3D';
    const ageAtStart = ((md.startDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);
    const ageAtEnd = ((md.endDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);

    html += `<div class="dasha-period ${isCurrent ? 'current' : ''}" id="md-${mdIdx}">
      <div class="dasha-header ${isCurrent ? 'current' : ''}" onclick="toggleDasha(this)">
        <div>
          <span class="dasha-planet" style="color:${mdColor}">${PLANETS_INFO[md.lord].symbol} ${md.lord} Mahadasha</span>
          <span style="font-size:0.78em;color:var(--text-dim);margin-left:8px">(Age ${ageAtStart} — ${ageAtEnd})</span>
          ${isCurrent ? '<span style="font-size:0.7em;background:rgba(212,113,10,0.1);color:var(--saffron);padding:2px 8px;border-radius:8px;margin-left:8px;font-weight:600">CURRENT</span>' : ''}
        </div>
        <span class="dasha-dates">${formatDate(md.startDate)} — ${formatDate(md.endDate)}</span>
      </div>
      <div class="dasha-body ${isCurrent ? 'open' : ''}">
        <div style="font-family:'Newsreader',serif;font-size:1.02em;line-height:1.7">${generateDashaPrediction(c, md.lord)}</div>`;

    if (granularity !== 'maha') {
      html += '<div class="sub-dasha"><strong style="color:var(--indigo-light);font-size:0.82em;text-transform:uppercase;letter-spacing:1px;display:block;margin:16px 0 8px">Antardashas (Sub-Periods)</strong>';
      md.antardashas.forEach(ad => {
        const isAdCurrent = now >= ad.startDate && now < ad.endDate;
        const adColor = PLANET_COLORS[ad.lord] || '#2D2B3D';
        const adPred = generateAntarPrediction(c, md.lord, ad.lord);
        html += `<div class="sub-dasha-item ${isAdCurrent ? 'current' : ''}" style="margin-bottom:6px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="color:${adColor};font-weight:500">${PLANETS_INFO[ad.lord].symbol} ${md.lord}/${ad.lord}</span>
            <span style="color:var(--text-dim);font-size:0.82em">${formatDate(ad.startDate)} — ${formatDate(ad.endDate)}</span>
          </div>
          <div style="font-family:'Newsreader',serif;font-size:0.92em;line-height:1.6;color:var(--text-dim);margin:4px 0 8px;padding-left:4px">${adPred}</div>
        </div>`;

        if (granularity === 'pratyantar' && ad.pratyantardashas) {
          ad.pratyantardashas.forEach(pad => {
            const isPadCurrent = now >= pad.startDate && now < pad.endDate;
            const padColor = PLANET_COLORS[pad.lord] || '#2D2B3D';
            html += `<div class="sub-dasha-item ${isPadCurrent ? 'current' : ''}" style="padding-left:28px;font-size:0.78em">
              <span style="color:${padColor}">${md.lord}/${ad.lord}/${pad.lord}</span>
              <span style="color:var(--text-dim)">${formatDate(pad.startDate)} — ${formatDate(pad.endDate)}</span>
            </div>`;
          });
        }
      });
      html += '</div>';
    }

    html += '</div></div>';
  });

  document.getElementById('dashaTimeline').innerHTML = html;
}

function renderTransits() {
  if (!currentChart) return;
  const now = new Date();
  const utcH = now.getUTCHours() + now.getUTCMinutes() / 60;
  const jdNow = julianDay(now.getFullYear(), now.getMonth() + 1, now.getDate(), utcH);
  const transitPlanets = calculatePlanets(jdNow);

  let html = '';
  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];
  planetOrder.forEach(pName => {
    const tLon = transitPlanets[pName];
    const tRashi = getRashi(tLon);
    const tHouse = getHouse(tLon, currentChart.ascendant);
    const info = PLANETS_INFO[pName];
    const color = PLANET_COLORS[pName];
    const effect = TRANSIT_HOUSE_EFFECTS[pName][tHouse - 1] || "General influence on this house.";

    html += `<div class="transit-card">
      <div class="transit-planet" style="color:${color}">${info.symbol} ${info.sanskrit} (${pName})</div>
      <div class="transit-sign">${tRashi.symbol} ${tRashi.eng} at ${degToDMS(tRashi.degrees)}</div>
      <div class="transit-house">Transiting your ${ordinal(tHouse)} House</div>
      <div class="transit-effect">${effect}</div>
    </div>`;
  });

  document.getElementById('transitGrid').innerHTML = html;

  // Enhanced transit reading (Sade Sati, major transits analysis)
  const transitReadings = generateTransitReading(currentChart, transitPlanets);
  let alertsHtml = '';
  let deepHtml = '';

  transitReadings.forEach(r => {
    if (r.type === 'sadeSati') {
      alertsHtml += `<div class="transit-alert high">
        <h4>\u26A0 ${r.title}</h4>
        <p>${r.content}</p>
      </div>`;
    } else {
      deepHtml += `<div class="transit-alert normal">
        <h4>${r.title}</h4>
        <p>${r.content}</p>
      </div>`;
    }
  });

  document.getElementById('transitAlerts').innerHTML = alertsHtml;
  document.getElementById('transitDeepReading').innerHTML =
    deepHtml ? '<div class="section-title" style="font-size:1em;margin-bottom:12px"><span class="icon">&#x1F52D;</span> Detailed Transit Analysis</div>' + deepHtml : '';
}

function populateYearSelector() {
  const sel = document.getElementById('yearSelect');
  if (!currentChart) return;
  sel.innerHTML = '';
  const now = new Date();
  const currentYear = now.getFullYear();
  // Find the range from dasha data
  const firstDasha = currentChart.dashas[0];
  const lastDasha = currentChart.dashas[currentChart.dashas.length - 1];
  const birthYear = firstDasha.startDate.getFullYear();
  const endYear = Math.min(lastDasha.endDate.getFullYear(), birthYear + 100);
  // Show years from 5 years ago to 10 years from now as the default visible range,
  // but allow full dasha range
  for (let y = birthYear; y <= endYear; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    sel.appendChild(opt);
  }
  renderYearPrediction();
}

function renderYearPrediction() {
  if (!currentChart) return;
  const year = parseInt(document.getElementById('yearSelect').value);
  if (!year) return;

  const pred = generateYearPrediction(currentChart, year);

  // Update dasha label
  const dashaLabel = document.getElementById('yearDashaLabel');
  if (pred.yearMDs.length > 0) {
    const mdNames = pred.yearMDs.map(m => m.lord).join(' → ');
    dashaLabel.textContent = `Mahadasha: ${mdNames}`;
  }

  let html = '';

  // Year Overview
  html += `<div class="year-overview">
    <h3>&#x1F52E; ${year} — Year Overview</h3>
    <div class="overview-body">${pred.overview}</div>
  </div>`;

  // Quarterly Breakdown
  html += `<div class="section-title" style="margin-top:8px;margin-bottom:-12px"><span class="icon">&#x1F4C5;</span> Quarterly Breakdown</div>`;
  pred.quarterPredictions.forEach(q => {
    html += `<div class="quarter-card">
      <h4>${q.label}</h4>
      <div class="q-dasha">${q.md} / ${q.ad}</div>
      <div class="q-body">${q.prediction}</div>
    </div>`;
  });

  // Life Area Forecasts
  html += `<div class="section-title" style="margin-top:8px;margin-bottom:-12px"><span class="icon">&#x1F3AF;</span> Life Area Forecasts</div>`;
  pred.areas.forEach(a => {
    html += `<div class="year-area">
      <h4><span>${a.icon}</span> ${a.title}</h4>
      <div class="area-body">${a.content}</div>
    </div>`;
  });

  document.getElementById('yearPredictionContainer').innerHTML = html;
}

function renderRemedies() {
  if (!currentChart) return;
  const c = currentChart;

  // Analyze chart for weak/afflicted planets
  const remedyPlanets = [];
  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];

  planetOrder.forEach(pName => {
    const p = c.planets[pName];
    const info = PLANETS_INFO[pName];
    let priority = 'low';
    let reason = '';

    // Check for debilitation
    const debilSigns = {Sun:6,Moon:7,Mars:3,Mercury:11,Jupiter:9,Venus:5,Saturn:0,Rahu:8,Ketu:2};
    if (p.rashi.index === debilSigns[pName]) {
      priority = 'high';
      reason = 'Debilitated — needs strengthening';
    }
    // Check for 6th, 8th, 12th house (dusthana)
    else if ([6, 8, 12].includes(p.house)) {
      priority = 'medium';
      reason = `Placed in ${ordinal(p.house)} house (challenging position)`;
    }
    // Malefic nature
    else if (['Mars','Saturn','Rahu','Ketu'].includes(pName)) {
      priority = 'low';
      reason = 'Natural malefic — propitiatory remedies beneficial';
    } else {
      reason = 'General strengthening recommended';
    }

    remedyPlanets.push({ name: pName, info, priority, reason, house: p.house, rashi: p.rashi });
  });

  // Sort by priority
  const priorityOrder = { high: 0, medium: 1, low: 2 };
  remedyPlanets.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

  let html = '';
  remedyPlanets.forEach(rp => {
    const i = rp.info;
    const color = PLANET_COLORS[rp.name];
    const priorityClass = `priority-${rp.priority}`;
    html += `<div class="remedy-card">
      <h4><span style="color:${color}">${i.symbol}</span> ${i.sanskrit} (${rp.name}) <span class="remedy-priority ${priorityClass}">${rp.priority}</span></h4>
      <p style="font-size:0.8em;color:var(--text-dim);margin-bottom:10px;font-style:italic">${rp.reason}</p>
      <div class="remedy-item"><span class="remedy-label">Gemstone</span><span class="remedy-value">${i.gem}</span></div>
      <div class="remedy-item"><span class="remedy-label">Mantra</span><span class="remedy-value">${i.mantra}</span></div>
      <div class="remedy-item"><span class="remedy-label">Color</span><span class="remedy-value">${i.color}</span></div>
      <div class="remedy-item"><span class="remedy-label">Day</span><span class="remedy-value">${i.day}</span></div>
      <div class="remedy-item"><span class="remedy-label">Deity</span><span class="remedy-value">${i.deity}</span></div>
      <div class="remedy-item"><span class="remedy-label">Donate</span><span class="remedy-value">${i.donate}</span></div>
      <div class="remedy-item"><span class="remedy-label">Fasting</span><span class="remedy-value">${i.fast}</span></div>
    </div>`;
  });

  document.getElementById('remedyGrid').innerHTML = html;
}

// ============================================================
//  UTILITY FUNCTIONS
// ============================================================

function formatDate(d) {
  if (!(d instanceof Date)) return '';
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}

function ordinal(n) {
  const s = ['th','st','nd','rd'], v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function toggleDasha(el) {
  const body = el.nextElementSibling;
  body.classList.toggle('open');
}

function jumpToDashaAge() {
  const ageVal = document.getElementById('dashaAge').value;
  if (!ageVal && ageVal !== '0') {
    // Scroll to current
    const curr = document.querySelector('.dasha-period.current');
    if (curr) curr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  const age = parseInt(ageVal);
  const birthDate = new Date(currentChart.birthInfo.dob + 'T' + currentChart.birthInfo.tob);
  const targetDate = addYears(birthDate, age);
  // Find the mahadasha containing this age
  currentChart.dashas.forEach((md, idx) => {
    if (targetDate >= md.startDate && targetDate < md.endDate) {
      const el = document.getElementById('md-' + idx);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const body = el.querySelector('.dasha-body');
        if (body && !body.classList.contains('open')) body.classList.add('open');
      }
    }
  });
}

// ============================================================
//  CITY AUTOCOMPLETE
// ============================================================

const cityInput = document.getElementById('city');
const cityDropdown = document.getElementById('cityDropdown');

cityInput.addEventListener('input', function() {
  const val = this.value.toLowerCase().trim();
  if (val.length < 2) { cityDropdown.classList.remove('active'); updateCityIndicator(null); return; }

  // Split input on commas/spaces to match each term independently
  // e.g. "Delhi, India" matches cities where name contains "delhi" AND combined string contains "india"
  const terms = val.split(/[,\s]+/).filter(t => t.length >= 2);
  const matches = CITIES.filter(c => {
    const combined = (c.name + ' ' + c.country).toLowerCase();
    return terms.every(t => combined.includes(t));
  }).slice(0, 10);

  if (matches.length === 0) { cityDropdown.classList.remove('active'); updateCityIndicator(null); return; }

  // Auto-resolve: if exact name match or only one result, lock in coordinates
  const resolved = resolveCity(this.value);
  updateCityIndicator(resolved);
  if (resolved) {
    document.getElementById('cityLat').value = resolved.lat;
    document.getElementById('cityLon').value = resolved.lon;
    document.getElementById('cityTz').value  = resolved.tz;
  }

  cityDropdown.innerHTML = matches.map(c =>
    `<div class="city-option" data-lat="${c.lat}" data-lon="${c.lon}" data-tz="${c.tz}" data-name="${c.name}, ${c.country}">
      ${c.name} <span class="country">${c.country} &nbsp; ${c.lat.toFixed(2)}&deg;N, ${c.lon.toFixed(2)}&deg;E</span>
    </div>`
  ).join('');

  cityDropdown.classList.add('active');
});

// Show a small indicator next to city input: ✓ resolved or ✗ not found
function updateCityIndicator(resolved) {
  let ind = document.getElementById('cityIndicator');
  if (!ind) {
    ind = document.createElement('div');
    ind.id = 'cityIndicator';
    ind.style.cssText = 'font-size:0.75em;margin-top:3px;min-height:1.1em;';
    cityInput.parentNode.appendChild(ind);
  }
  if (resolved) {
    ind.innerHTML = '<span style="color:#0D9488">&#10003; ' + resolved.name + ' (' + resolved.lat.toFixed(4) + '&deg;N, ' + resolved.lon.toFixed(4) + '&deg;E, UTC' + (resolved.tz>=0?'+':'') + resolved.tz + ')</span>';
  } else if (cityInput.value.trim().length >= 2) {
    ind.innerHTML = '<span style="color:#DC4A38">&#10007; City not found — select from dropdown</span>';
  } else {
    ind.innerHTML = '';
  }
}

function selectCityOption(e) {
  const opt = e.target.closest('.city-option');
  if (!opt) return;
  e.preventDefault();
  e.stopPropagation();
  cityInput.value = opt.dataset.name;
  document.getElementById('cityLat').value = opt.dataset.lat;
  document.getElementById('cityLon').value = opt.dataset.lon;
  document.getElementById('cityTz').value = opt.dataset.tz;
  cityDropdown.classList.remove('active');
  cityInput.blur(); // dismiss mobile keyboard
  const resolved = resolveCity(opt.dataset.name);
  updateCityIndicator(resolved);
}
cityDropdown.addEventListener('click', selectCityOption);
cityDropdown.addEventListener('touchend', selectCityOption);

document.addEventListener('click', function(e) {
  if (!e.target.closest('.city-wrapper')) cityDropdown.classList.remove('active');
});

// ============================================================
//  TAB NAVIGATION
// ============================================================

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
  });
});

// ============================================================
//  STARFIELD BACKGROUND
// ============================================================

(function createStars() {
  const container = document.getElementById('stars');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    const size = Math.random() * 2 + 0.5;
    star.style.width = size + 'px';
    star.style.height = size + 'px';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    star.style.setProperty('--dur', (Math.random() * 3 + 2) + 's');
    star.style.setProperty('--max-o', Math.random() * 0.5 + 0.3);
    star.style.animationDelay = Math.random() * 3 + 's';
    container.appendChild(star);
  }
})();

// ============================================================
//  SET DEFAULT CITY
// ============================================================
(function setDefault() {
  const defaultCity = CITIES[0]; // New Delhi
  cityInput.value = defaultCity.name + ', ' + defaultCity.country;
  document.getElementById('cityLat').value = defaultCity.lat;
  document.getElementById('cityLon').value = defaultCity.lon;
  document.getElementById('cityTz').value = defaultCity.tz;
})();
</script>
</body>
</html>
