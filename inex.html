<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jyotish Vidya — Vedic Astrology</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Newsreader:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#FAFAF7;--bg-card:#FFFFFF;--bg-card2:#F8F7F4;
  --saffron:#D4710A;--saffron-light:#E8873A;--indigo:#4A3580;--indigo-light:#7B68AE;
  --text:#2D2B3D;--text-dim:#6B6880;--text-bright:#1A1828;
  --accent-red:#DC4A38;--accent-blue:#2563EB;--accent-green:#0D9488;
  --border:rgba(0,0,0,0.08);--glow:rgba(74,53,128,0.1);
}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:linear-gradient(165deg,#FAFAF7 0%,#FFF5EB 50%,#F5F0FF 100%);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:15px;line-height:1.6}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 10%,rgba(232,135,58,0.04) 0%,transparent 50%),radial-gradient(ellipse at 80% 90%,rgba(74,53,128,0.03) 0%,transparent 50%);pointer-events:none;z-index:0}

.container{max-width:1100px;margin:0 auto;padding:0 24px;position:relative;z-index:1}
@media(max-width:768px){.container{padding:0 12px}}

/* HEADER */
header{text-align:center;padding:48px 0 32px;border-bottom:1px solid var(--border)}
header h1{font-family:'Plus Jakarta Sans',sans-serif;font-size:2.6em;font-weight:700;background:linear-gradient(135deg,var(--saffron),#B85A00,var(--indigo));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1px}
header p{font-family:'Newsreader',serif;font-size:1.15em;color:var(--text-dim);margin-top:6px;font-style:italic;letter-spacing:0.5px}
.om-symbol{font-size:1.6em;color:var(--saffron);margin-bottom:8px;display:block}
@media(max-width:768px){header{padding:28px 0 20px}header h1{font-size:1.8em}header p{font-size:0.95em}}

/* SECTIONS */
.section{margin:32px 0;padding:32px;background:var(--bg-card);border-radius:20px;border:1px solid var(--border);box-shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 16px rgba(0,0,0,0.03)}
@media(max-width:768px){.section{padding:20px 16px;margin:20px 0;border-radius:14px}}
.section-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:1.3em;font-weight:600;color:var(--saffron);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-title .icon{font-size:1.2em}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media(max-width:700px){.form-grid{grid-template-columns:1fr}}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;font-weight:500}
.form-group input,.form-group select{background:#F5F4F0;border:1px solid var(--border);color:var(--text-bright);padding:12px 14px;border-radius:12px;font-size:0.95em;font-family:'Inter',sans-serif;transition:border 0.3s,box-shadow 0.3s;outline:none}
.form-group input:focus,.form-group select:focus{border-color:var(--saffron);box-shadow:0 0 0 3px rgba(212,113,10,0.1)}
.form-group input::placeholder{color:var(--text-dim);opacity:0.6}
.city-wrapper{position:relative}
.city-dropdown{position:absolute;top:100%;left:0;right:0;background:#FFFFFF;border:1px solid var(--border);border-radius:0 0 12px 12px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.08)}
.city-dropdown.active{display:block}
.city-option{padding:12px 14px;cursor:pointer;font-size:0.88em;border-bottom:1px solid var(--border);transition:background 0.2s;-webkit-tap-highlight-color:rgba(212,113,10,0.1);touch-action:manipulation}
.city-option:hover,.city-option:active{background:rgba(212,113,10,0.06)}
.city-option .country{color:var(--text-dim);font-size:0.82em}

.btn-generate{grid-column:1/-1;margin-top:8px;padding:14px 32px;background:linear-gradient(135deg,var(--saffron),#B85A00);color:#FFFFFF;font-family:'Plus Jakarta Sans',sans-serif;font-size:1.05em;font-weight:600;border:none;border-radius:14px;cursor:pointer;letter-spacing:1px;transition:all 0.3s;text-transform:uppercase;-webkit-tap-highlight-color:rgba(212,113,10,0.2);touch-action:manipulation}
.btn-generate:hover,.btn-generate:active{box-shadow:0 4px 20px rgba(212,113,10,0.25);transform:translateY(-1px)}

/* TABS */
.tabs{display:flex;gap:6px;margin-bottom:24px;flex-wrap:wrap;border-bottom:2px solid var(--border);padding-bottom:0}
.tab{padding:11px 18px;background:transparent;color:var(--text-dim);border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.85em;font-weight:500;cursor:pointer;letter-spacing:0.3px;transition:all 0.25s;border-bottom:2px solid transparent;position:relative;bottom:-2px;-webkit-tap-highlight-color:transparent;touch-action:manipulation;white-space:nowrap}
.tab:hover{color:var(--text)}
.tab.active{color:var(--saffron);border-bottom-color:var(--saffron);font-weight:600}
@media(max-width:768px){
  .tabs{flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none;gap:0;padding-bottom:0;margin-left:-16px;margin-right:-16px;padding-left:16px;padding-right:16px;border-bottom:none;position:relative;margin-bottom:18px}
  .tabs::-webkit-scrollbar{display:none}
  .tabs::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--border)}
  .tab{padding:10px 16px;font-size:0.82em;flex-shrink:0;border-radius:8px 8px 0 0;border-bottom:2px solid transparent;margin-bottom:0;bottom:0}
  .tab.active{background:rgba(212,113,10,0.06);border-bottom:2px solid var(--saffron)}
}
@media(max-width:420px){
  .tab{padding:9px 12px;font-size:0.76em;letter-spacing:0}
}
.tab-content{display:none;animation:fadeIn 0.4s ease}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* CHART */
.chart-toggle{display:flex;gap:8px;margin-bottom:20px;justify-content:center}
.chart-toggle button{padding:8px 20px;background:var(--bg-card2);border:1px solid var(--border);color:var(--text-dim);border-radius:24px;cursor:pointer;font-size:0.85em;transition:all 0.3s}
.chart-toggle button.active{background:rgba(212,113,10,0.08);border-color:var(--saffron);color:var(--saffron);font-weight:500}
.chart-container{display:flex;justify-content:center;padding:20px 0}
.chart-container svg{filter:drop-shadow(0 2px 12px rgba(0,0,0,0.06))}
.chart-info{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:24px}
@media(max-width:600px){.chart-info{grid-template-columns:1fr}}
.chart-info-card{background:var(--bg-card2);padding:14px 18px;border-radius:14px;border:1px solid var(--border)}
.chart-info-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.85em;font-weight:600;margin-bottom:6px}
.chart-info-card p{font-size:0.9em;color:var(--text);line-height:1.6}

/* PLANETS TABLE */
.planets-table{width:100%;border-collapse:collapse;font-size:0.88em}
.planets-table th{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-weight:600;text-align:left;padding:12px 10px;border-bottom:2px solid var(--border);font-size:0.82em;letter-spacing:1px;text-transform:uppercase}
.planets-table td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
.planets-table tr:hover td{background:rgba(212,113,10,0.03)}
.planet-symbol{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;font-size:0.85em;font-weight:600;margin-right:8px}
.planet-name{font-weight:500;color:var(--text-bright)}
.retro{color:var(--accent-red);font-size:0.75em;font-weight:600;margin-left:4px}
.nakshatra-badge{background:rgba(74,53,128,0.08);padding:3px 10px;border-radius:12px;font-size:0.82em;color:var(--indigo)}

/* DASHA */
.dasha-controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.dasha-controls label{font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
.dasha-controls select{background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;font-size:0.88em;outline:none}
.dasha-controls select:focus{border-color:var(--saffron)}
.dasha-timeline{position:relative;padding-left:28px}
.dasha-period{position:relative;margin-bottom:4px;border-left:2px solid var(--border);padding:0 0 0 20px}
.dasha-period::before{content:'';position:absolute;left:-6px;top:14px;width:10px;height:10px;border-radius:50%;border:2px solid var(--saffron);background:#FFFFFF}
.dasha-period.current::before{background:var(--saffron);box-shadow:0 0 8px rgba(212,113,10,0.3)}
.dasha-header{cursor:pointer;padding:12px 16px;background:var(--bg-card2);border-radius:12px;border:1px solid var(--border);transition:all 0.3s;display:flex;justify-content:space-between;align-items:center}
.dasha-header:hover{border-color:rgba(212,113,10,0.2);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.dasha-header.current{border-color:var(--saffron);background:rgba(212,113,10,0.04)}
.dasha-planet{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600}
.dasha-dates{font-size:0.8em;color:var(--text-dim)}
.dasha-body{padding:16px;display:none;margin:4px 0 8px;background:var(--bg-card2);border-radius:0 0 12px 12px;border:1px solid var(--border);border-top:none}
.dasha-body.open{display:block}
.dasha-body p{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.75;color:var(--text);margin-bottom:10px}
.sub-dasha{margin-top:12px}
.sub-dasha-item{display:flex;justify-content:space-between;padding:8px 12px;border-radius:8px;font-size:0.84em;border-bottom:1px solid var(--border)}
.sub-dasha-item:hover{background:rgba(212,113,10,0.03)}
.sub-dasha-item.current{background:rgba(212,113,10,0.06);border:1px solid rgba(212,113,10,0.15);border-radius:8px}

/* TRANSITS */
.transit-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:600px){.transit-grid{grid-template-columns:1fr}}
.transit-card{background:var(--bg-card2);padding:16px;border-radius:14px;border:1px solid var(--border);transition:all 0.3s}
.transit-card:hover{border-color:rgba(212,113,10,0.15);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.transit-planet{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600;margin-bottom:6px}
.transit-sign{font-size:0.88em;color:var(--indigo)}
.transit-house{font-size:0.82em;color:var(--text-dim);margin-top:2px}
.transit-effect{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text);margin-top:10px;line-height:1.65;padding-top:10px;border-top:1px solid var(--border)}

/* REMEDIES */
.remedy-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media(max-width:800px){.remedy-grid{grid-template-columns:1fr 1fr}}
@media(max-width:500px){.remedy-grid{grid-template-columns:1fr}}
.remedy-card{background:var(--bg-card2);padding:18px;border-radius:14px;border:1px solid var(--border);transition:all 0.3s}
.remedy-card:hover{border-color:rgba(212,113,10,0.15);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.05)}
.remedy-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.9em;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.remedy-item{display:flex;gap:8px;margin-bottom:8px;font-size:0.88em;line-height:1.5}
.remedy-label{color:var(--text-dim);min-width:80px;font-size:0.8em;text-transform:uppercase;letter-spacing:0.5px}
.remedy-value{color:var(--text)}
.remedy-priority{display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-left:auto}
.priority-high{background:rgba(220,74,56,0.08);color:#DC4A38}
.priority-medium{background:rgba(212,113,10,0.08);color:var(--saffron)}
.priority-low{background:rgba(13,148,136,0.08);color:#0D9488}

/* CHART READING */
.reading-section{background:var(--bg-card2);border-radius:16px;border:1px solid var(--border);padding:24px 28px;transition:all 0.3s}
.reading-section:hover{border-color:rgba(212,113,10,0.12);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.reading-section h3{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:1.05em;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:10px}
.reading-section h3 .rs-icon{font-size:1.3em}
.reading-section .reading-body{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.8;color:var(--text)}
.reading-section .reading-body b{color:var(--text-bright)}

/* TRANSIT ALERTS */
.transit-alert{padding:16px 20px;border-radius:14px;margin-bottom:12px;font-size:0.92em;line-height:1.6}
.transit-alert.high{background:rgba(220,74,56,0.05);border:1px solid rgba(220,74,56,0.15);color:var(--text)}
.transit-alert.normal{background:rgba(74,53,128,0.04);border:1px solid rgba(74,53,128,0.1)}
.transit-alert h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);margin-bottom:8px;font-size:0.95em;font-weight:600}
.transit-alert p{font-family:'Newsreader',serif;font-size:1.02em;line-height:1.7;color:var(--text)}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(74,53,128,0.15);border-radius:3px}

/* RESULTS AREA */
#results{display:none}
#results.visible{display:block}

/* LOADING */
.loading{text-align:center;padding:40px;color:var(--saffron)}
.loading .spinner{display:inline-block;width:40px;height:40px;border:3px solid rgba(212,113,10,0.15);border-top-color:var(--saffron);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* FOOTER */
footer{text-align:center;padding:32px 0;color:var(--text-dim);font-size:0.78em;border-top:1px solid var(--border);margin-top:40px}
footer span{color:var(--saffron)}

/* STARS BACKGROUND - hidden in light theme */
.stars{display:none}
.star{display:none}

/* YOGAS */
.yoga-list{display:flex;flex-direction:column;gap:10px}
.yoga-item{background:var(--bg-card2);padding:14px 18px;border-radius:12px;border:1px solid var(--border)}
.yoga-name{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.9em;font-weight:600}
.yoga-desc{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text);margin-top:6px;line-height:1.65}

/* YEARLY FORECAST */
.year-overview{background:linear-gradient(135deg,rgba(212,113,10,0.04),rgba(74,53,128,0.04));border:1px solid var(--border);border-radius:16px;padding:24px 28px}
.year-overview h3{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:1.1em;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:10px}
.year-overview .overview-body{font-family:'Newsreader',serif;font-size:1.05em;line-height:1.8;color:var(--text)}
.quarter-card{background:var(--bg-card2);border-radius:14px;border:1px solid var(--border);padding:20px 24px;transition:all 0.3s}
.quarter-card:hover{border-color:rgba(212,113,10,0.12);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.quarter-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-size:0.95em;font-weight:600;margin-bottom:4px}
.quarter-card .q-dates{font-size:0.8em;color:var(--text-dim);margin-bottom:12px}
.quarter-card .q-dasha{font-size:0.82em;color:var(--saffron);font-weight:500;margin-bottom:10px;padding:6px 12px;background:rgba(212,113,10,0.05);border-radius:8px;display:inline-block}
.quarter-card .q-body{font-family:'Newsreader',serif;font-size:1em;line-height:1.75;color:var(--text)}
.year-area{background:var(--bg-card2);border-radius:14px;border:1px solid var(--border);padding:20px 24px}
.year-area h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.95em;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.year-area .area-body{font-family:'Newsreader',serif;font-size:1em;line-height:1.75;color:var(--text)}

.hidden{display:none!important}
.flex-center{display:flex;align-items:center;justify-content:center}

/* BHAVA CHALIT & CHART MODE TOGGLES */
.chart-mode-toggle{display:flex;gap:8px;margin-bottom:12px;justify-content:center}
.chart-mode-toggle button{padding:6px 16px;background:var(--bg-card2);border:1px solid var(--border);color:var(--text-dim);border-radius:20px;cursor:pointer;font-size:0.82em;transition:all 0.3s}
.chart-mode-toggle button.active{background:rgba(74,53,128,0.08);border-color:var(--indigo);color:var(--indigo);font-weight:500}
.bhava-shift-table{width:100%;border-collapse:collapse;font-size:0.85em;margin-top:16px}
.bhava-shift-table th{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-weight:600;text-align:left;padding:10px 8px;border-bottom:2px solid var(--border);font-size:0.8em;letter-spacing:1px;text-transform:uppercase}
.bhava-shift-table td{padding:8px;border-bottom:1px solid var(--border)}
.bhava-shift{color:var(--accent-red);font-weight:600;font-size:0.85em}
.bhava-same{color:var(--accent-green);font-size:0.85em}

/* VARGA CHARTS */
.varga-selector{display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.varga-selector label{font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500}
.varga-selector select{background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.92em;font-family:Inter,sans-serif;outline:none;min-width:260px}
.varga-selector select:focus{border-color:var(--saffron)}
.varga-info-card{background:linear-gradient(135deg,rgba(74,53,128,0.04),rgba(212,113,10,0.04));border:1px solid var(--border);border-radius:14px;padding:18px 22px;margin-bottom:20px}
.varga-info-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-size:0.92em;font-weight:600;margin-bottom:6px}
.varga-info-card p{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text);line-height:1.65}
.varga-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:16px}
.varga-pill{background:var(--bg-card2);border:1px solid var(--border);border-radius:10px;padding:8px 12px;text-align:center;cursor:pointer;transition:all 0.3s;font-size:0.84em}
.varga-pill:hover,.varga-pill.active{border-color:var(--saffron);background:rgba(212,113,10,0.06)}
.varga-pill .vp-name{font-weight:600;color:var(--saffron);font-size:0.9em}
.varga-pill .vp-area{color:var(--text-dim);font-size:0.78em;margin-top:2px}

/* VARSH PHAL */
.varsh-mode-toggle{display:flex;gap:8px;margin-bottom:20px}
.varsh-mode-toggle button{padding:8px 20px;background:var(--bg-card2);border:1px solid var(--border);color:var(--text-dim);border-radius:24px;cursor:pointer;font-size:0.85em;transition:all 0.3s}
.varsh-mode-toggle button.active{background:rgba(212,113,10,0.08);border-color:var(--saffron);color:var(--saffron);font-weight:500}
.varsh-summary{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:20px 0}
@media(max-width:600px){.varsh-summary{grid-template-columns:1fr}}
.varsh-card{background:var(--bg-card2);padding:14px 18px;border-radius:14px;border:1px solid var(--border)}
.varsh-card h4{font-family:'Plus Jakarta Sans',sans-serif;color:var(--saffron);font-size:0.85em;font-weight:600;margin-bottom:6px}
.varsh-card p{font-size:0.9em;color:var(--text);line-height:1.6}
.tajaka-yoga{background:var(--bg-card2);padding:14px 18px;border-radius:12px;border:1px solid var(--border);margin-bottom:8px}
.tajaka-yoga .ty-name{font-family:'Plus Jakarta Sans',sans-serif;color:var(--indigo);font-size:0.88em;font-weight:600}
.tajaka-yoga .ty-desc{font-family:'Newsreader',serif;font-size:0.92em;color:var(--text);margin-top:4px;line-height:1.6}

/* LANDING SCREEN */
#landingSection{margin:40px 0}
.landing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-top:16px}
@media(max-width:800px){.landing-grid{grid-template-columns:1fr}}
.landing-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:36px 28px;text-align:center;cursor:pointer;transition:all 0.3s ease;box-shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 16px rgba(0,0,0,0.03);position:relative;overflow:hidden}
.landing-card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.1);border-color:var(--saffron)}
.landing-card::after{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--saffron),var(--indigo));opacity:0;transition:opacity 0.3s}
.landing-card:hover::after{opacity:1}
.landing-card .lc-icon{font-size:3em;margin-bottom:16px;display:block}
.landing-card .lc-title{font-family:'Plus Jakarta Sans',sans-serif;font-size:1.25em;font-weight:700;color:var(--text-bright);margin-bottom:10px}
.landing-card .lc-desc{font-family:'Newsreader',serif;font-size:0.95em;color:var(--text-dim);line-height:1.6}
.landing-card .lc-tag{display:inline-block;margin-top:14px;font-size:0.75em;text-transform:uppercase;letter-spacing:1.5px;font-weight:600;color:var(--saffron);background:rgba(212,113,10,0.08);padding:4px 12px;border-radius:20px}
.back-btn{display:inline-flex;align-items:center;gap:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:0.88em;font-weight:500;color:var(--text-dim);background:none;border:1px solid var(--border);border-radius:10px;padding:8px 16px;cursor:pointer;transition:all 0.2s;margin-bottom:20px}
.back-btn:hover{color:var(--saffron);border-color:var(--saffron);background:rgba(212,113,10,0.04)}
#standaloneRashiPhal,#standaloneGochar{display:none}
.rashi-accordion{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;margin-bottom:10px;overflow:hidden}
.rashi-accordion-header{display:flex;align-items:center;gap:12px;padding:16px 20px;cursor:pointer;transition:background 0.2s;user-select:none}
.rashi-accordion-header:hover{background:rgba(212,113,10,0.03)}
.rashi-accordion-header .ra-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;background:linear-gradient(135deg,var(--saffron),var(--indigo));color:white;flex-shrink:0}
.rashi-accordion-header .ra-name{font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;color:var(--text-bright);font-size:1em}
.rashi-accordion-header .ra-eng{font-size:0.85em;color:var(--text-dim);margin-left:4px}
.rashi-accordion-header .ra-summary{margin-left:auto;font-size:0.85em;color:var(--text-dim);text-align:right}
.rashi-accordion-header .ra-arrow{margin-left:8px;color:var(--text-dim);transition:transform 0.3s;font-size:0.8em}
.rashi-accordion.open .ra-arrow{transform:rotate(180deg)}
.rashi-accordion-body{display:none;overflow:visible}
.rashi-accordion.open .rashi-accordion-body{display:block}
.rashi-accordion-content{padding:0 20px 20px 20px}
.lang-btn{background:transparent;color:var(--text-dim)}
.lang-btn.lang-active{background:var(--saffron);color:#fff}
.lang-btn:hover{color:var(--text-bright)}
</style>
</head>
<body>
<div class="stars" id="stars"></div>

<div class="container">
  <header>
    <span class="om-symbol">&#x0950;</span>
    <h1>Jyotish Vidya</h1>
    <p data-i18n="header_subtitle">The Sacred Science of Vedic Astrology</p>
    <div id="langToggle" style="margin-top:10px;display:inline-flex;background:rgba(245,244,240,0.9);border-radius:20px;overflow:hidden;border:1px solid var(--border)">
      <button onclick="setLang('en')" id="langBtnEn" class="lang-btn lang-active" style="padding:6px 18px;border:none;cursor:pointer;font-size:0.82em;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;letter-spacing:0.5px;transition:all 0.25s">English</button>
      <button onclick="setLang('hi')" id="langBtnHi" class="lang-btn" style="padding:6px 18px;border:none;cursor:pointer;font-size:0.82em;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;letter-spacing:0.5px;transition:all 0.25s">हिन्दी</button>
    </div>
  </header>

  <!-- LANDING SCREEN -->
  <div id="landingSection">
    <div style="text-align:center;margin-bottom:8px">
      <p style="font-family:Newsreader,serif;font-size:1.05em;color:var(--text-dim);max-width:600px;margin:0 auto" data-i18n="landing_subtitle">Choose a service to explore the ancient wisdom of Jyotish Shastra</p>
    </div>
    <div class="landing-grid">
      <div class="landing-card" onclick="showStandaloneRashiPhal()">
        <span class="lc-icon">&#x263D;</span>
        <div class="lc-title" data-i18n="landing_rashiPhal_title">Rashi Phal</div>
        <div class="lc-desc" data-i18n="landing_rashiPhal_desc">Yearly predictions for all 12 Moon signs based on Jupiter, Saturn, Rahu-Ketu transits and their effects on each Rashi</div>
        <span class="lc-tag" data-i18n="landing_rashiPhal_tag">All Rashis</span>
      </div>
      <div class="landing-card" onclick="showKundali()">
        <span class="lc-icon">&#9788;</span>
        <div class="lc-title" data-i18n="landing_kundali_title">Generate Kundali</div>
        <div class="lc-desc" data-i18n="landing_kundali_desc">Create a complete Vedic birth chart with planetary positions, dashas, divisional charts, readings, and personalized predictions</div>
        <span class="lc-tag" data-i18n="landing_kundali_tag">Personalized</span>
      </div>
      <div class="landing-card" onclick="showStandaloneGochar()">
        <span class="lc-icon">&#x1F30D;</span>
        <div class="lc-title" data-i18n="landing_gochar_title">Gochar</div>
        <div class="lc-desc" data-i18n="landing_gochar_desc">Precise planetary transit timings — when each planet enters a new sign, retrograde periods, and monthly transit calendar</div>
        <span class="lc-tag" data-i18n="landing_gochar_tag">Transit Timings</span>
      </div>
    </div>
  </div>

  <!-- STANDALONE RASHI PHAL (no kundali needed) -->
  <div id="standaloneRashiPhal">
    <div class="section">
      <button class="back-btn" onclick="showLanding()" data-i18n="back_home">&#x2190; Back to Home</button>
      <div class="section-title"><span class="icon">&#x263D;</span> <span data-i18n="sa_rashiPhal_title">Rashi Phal — Yearly Predictions for All Rashis</span></div>
      <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px" data-i18n="sa_rashiPhal_desc">Select a year to view Moon-sign-based predictions for all 12 Rashis, based on major planetary transits</p>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
        <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500" data-i18n="label_select_year">Select Year</label>
        <select id="saRashiPhalYear" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderStandaloneRashiPhal()">
        </select>
      </div>
      <div id="saRashiPhalContent"></div>
    </div>
  </div>

  <!-- STANDALONE GOCHAR (no kundali needed) -->
  <div id="standaloneGochar">
    <div class="section">
      <button class="back-btn" onclick="showLanding()" data-i18n="back_home">&#x2190; Back to Home</button>
      <div class="section-title"><span class="icon">&#x1F30D;</span> <span data-i18n="sa_gochar_title">Gochar — Planetary Transit Timings</span></div>
      <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px" data-i18n="sa_gochar_desc">Precise dates when each planet enters a new Rashi, retrograde periods, and a monthly transit calendar</p>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
        <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500" data-i18n="label_select_year">Select Year</label>
        <select id="saGocharYear" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderStandaloneGochar()">
        </select>
      </div>
      <div id="saGocharContent"></div>
    </div>
  </div>

  <!-- BIRTH DETAILS INPUT -->
  <div class="section" id="inputSection" style="display:none">
    <button class="back-btn" onclick="showLanding()" data-i18n="back_home">&#x2190; Back to Home</button>
    <div class="section-title"><span class="icon">&#9788;</span> <span data-i18n="birth_details_title">Birth Details</span></div>
    <div class="form-grid">
      <div class="form-group">
        <label data-i18n="label_dob">Date of Birth</label>
        <input type="date" id="dob" value="1990-01-15">
      </div>
      <div class="form-group">
        <label data-i18n="label_tob">Time of Birth</label>
        <input type="time" id="tob" value="06:30" step="60">
      </div>
      <div class="form-group city-wrapper">
        <label data-i18n="label_city">City of Birth</label>
        <input type="text" id="city" data-i18n-placeholder="placeholder_city" placeholder="Start typing a city..." autocomplete="off">
        <div class="city-dropdown" id="cityDropdown"></div>
        <input type="hidden" id="cityLat">
        <input type="hidden" id="cityLon">
        <input type="hidden" id="cityTz">
      </div>
      <button class="btn-generate" id="btnGenerate" onclick="generateChart()" data-i18n-html="btn_generate">&#9788; Generate Kundali</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <!-- SUMMARY -->
    <div class="section" id="summarySection">
      <div class="section-title"><span class="icon">&#9733;</span> <span data-i18n="birth_chart_summary">Birth Chart Summary</span></div>
      <div class="chart-info" id="summaryInfo"></div>
    </div>

    <!-- TABS -->
    <div class="section" id="mainSection">
      <div class="tabs" id="mainTabs">
        <button class="tab active" data-tab="chart" data-i18n="tab_chart">Kundali Chart</button>
        <button class="tab" data-tab="reading" data-i18n="tab_reading">Chart Reading</button>
        <button class="tab" data-tab="rashiphal" data-i18n="tab_rashiphal">Rashi Phal</button>
        <button class="tab" data-tab="varshphal" data-i18n="tab_varshphal">Varsh Phal</button>
        <button class="tab" data-tab="planets" data-i18n="tab_planets">Planets &amp; Nakshatras</button>
        <button class="tab" data-tab="dasha" data-i18n="tab_dasha">Dasha Predictions</button>
        <button class="tab" data-tab="gochar" data-i18n="tab_gochar">Gochar</button>
        <button class="tab" data-tab="transits" data-i18n="tab_transits">Current Transits</button>
        <button class="tab" data-tab="yearly" data-i18n="tab_yearly">Yearly Forecast</button>
        <button class="tab" data-tab="remedies" data-i18n="tab_remedies">Remedies</button>
        <button class="tab" data-tab="vargas" data-i18n="tab_vargas">Divisional Charts</button>
      </div>

      <!-- CHART TAB -->
      <div class="tab-content active" id="tab-chart">
        <div class="chart-mode-toggle">
          <button class="active" onclick="setChartMode('rashi')" data-i18n="chart_rashi">Rashi Chart</button>
          <button onclick="setChartMode('bhava')" data-i18n="chart_bhava">Bh&#x0101;va Chalit</button>
        </div>
        <div class="chart-toggle">
          <button class="active" onclick="setChartStyle('north')">North Indian</button>
          <button onclick="setChartStyle('south')">South Indian</button>
        </div>
        <div class="chart-container" id="chartContainer"></div>
        <div id="bhavaShiftInfo" style="display:none;margin-top:20px"></div>
      </div>

      <!-- CHART READING TAB -->
      <div class="tab-content" id="tab-reading">
        <div id="chartReadingContainer" style="display:flex;flex-direction:column;gap:20px"></div>
      </div>

      <!-- PLANETS TAB -->
      <div class="tab-content" id="tab-planets">
        <div style="overflow-x:auto">
          <table class="planets-table" id="planetsTable"></table>
        </div>
        <div style="margin-top:28px">
          <div class="section-title" style="font-size:1.1em"><span class="icon">&#10038;</span> Yogas in Chart</div>
          <div class="yoga-list" id="yogaList"></div>
        </div>
      </div>

      <!-- DASHA TAB -->
      <div class="tab-content" id="tab-dasha">
        <div class="dasha-controls">
          <label>Granularity:</label>
          <select id="dashaGranularity" onchange="renderDasha()">
            <option value="maha">Mahadasha (Major Periods)</option>
            <option value="antar">Antardasha (Sub-Periods)</option>
            <option value="pratyantar">Pratyantardasha (Sub-Sub)</option>
          </select>
          <label style="margin-left:12px">Jump to Age:</label>
          <select id="dashaAge" onchange="jumpToDashaAge()">
          </select>
        </div>
        <div class="dasha-timeline" id="dashaTimeline"></div>
      </div>

      <!-- GOCHAR (TRANSIT TIMINGS) TAB -->
      <div class="tab-content" id="tab-gochar">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px" data-i18n="gochar_tab_desc">Gochar — precise dates when each planet enters a new Rashi during the selected year, with effects from your Moon sign (Janma Rashi)</p>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
          <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500" data-i18n="label_select_year">Select Year</label>
          <select id="gocharYearSelect" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderGochar()">
          </select>
        </div>
        <div id="gocharContent"></div>
      </div>

      <!-- TRANSITS TAB -->
      <div class="tab-content" id="tab-transits">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Current planetary positions and their influence on your natal chart</p>
        <div id="transitAlerts" style="margin-bottom:20px"></div>
        <div class="transit-grid" id="transitGrid"></div>
        <div id="transitDeepReading" style="margin-top:24px"></div>
      </div>

      <!-- YEARLY FORECAST TAB -->
      <div class="tab-content" id="tab-yearly">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap">
          <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500">Select Year</label>
          <select id="yearSelect" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderYearPrediction()">
          </select>
          <span id="yearDashaLabel" style="font-size:0.85em;color:var(--indigo);font-weight:500"></span>
        </div>
        <div id="yearPredictionContainer" style="display:flex;flex-direction:column;gap:20px"></div>
      </div>

      <!-- REMEDIES TAB -->
      <div class="tab-content" id="tab-remedies">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Personalized remedies based on natal chart analysis, current planetary transits, dasha periods, and afflictions — prioritized like an expert Jyotishi consultation</p>
        <div id="remedyGrid"></div>
      </div>

      <!-- RASHI PHAL TAB -->
      <div class="tab-content" id="tab-rashiphal">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Yearly predictions based on your Moon Sign (Janma Rashi) — traditional Rashi Phal considering major planetary transits through the zodiac</p>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
          <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500">Select Year</label>
          <select id="rashiPhalYearSelect" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderRashiPhal()">
          </select>
        </div>
        <div id="rashiPhalContent"></div>
      </div>

      <!-- DIVISIONAL CHARTS TAB -->
      <div class="tab-content" id="tab-vargas">
        <div class="varga-selector">
          <label>Varga Chart</label>
          <select id="vargaSelect" onchange="renderVargaChart()">
            <option value="9">D9 — Navamsa (Marriage &amp; Dharma)</option>
            <option value="2">D2 — Hora (Wealth)</option>
            <option value="3">D3 — Drekkana (Siblings &amp; Courage)</option>
            <option value="4">D4 — Chaturthamsa (Property &amp; Fortune)</option>
            <option value="7">D7 — Saptamsa (Children)</option>
            <option value="10">D10 — Dashamsa (Career)</option>
            <option value="12">D12 — Dwadasamsa (Parents)</option>
            <option value="16">D16 — Shodasamsa (Vehicles &amp; Comforts)</option>
            <option value="20">D20 — Vimsamsa (Spiritual Life)</option>
            <option value="24">D24 — Chaturvimsamsa (Education)</option>
            <option value="27">D27 — Saptavimsamsa (Strengths)</option>
            <option value="30">D30 — Trimsamsa (Misfortunes)</option>
            <option value="40">D40 — Khavedamsa (Auspicious Effects)</option>
            <option value="45">D45 — Akshavedamsa (General)</option>
            <option value="60">D60 — Shashtiamsa (Past Karma)</option>
          </select>
        </div>
        <div id="vargaInfoCard" class="varga-info-card" style="display:none"></div>
        <div class="chart-toggle">
          <button class="active" onclick="setVargaChartStyle('north')">North Indian</button>
          <button onclick="setVargaChartStyle('south')">South Indian</button>
        </div>
        <div class="chart-container" id="vargaChartContainer"></div>
        <div style="overflow-x:auto;margin-top:24px">
          <table class="planets-table" id="vargaPlanetsTable"></table>
        </div>
        <div id="vargaReadingContainer"></div>
      </div>

      <!-- VARSH PHAL TAB -->
      <div class="tab-content" id="tab-varshphal">
        <p style="color:var(--text-dim);font-size:0.88em;margin-bottom:16px">Annual horoscope based on the Solar Return (Tajaka system) — the exact moment the Sun returns to its natal position each year</p>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">
          <label style="font-size:0.82em;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-weight:500">Select Year</label>
          <select id="varshYearSelect" style="background:#F5F4F0;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;font-size:0.95em;font-family:Inter,sans-serif;outline:none;min-width:120px" onchange="renderVarshPhal()">
          </select>
        </div>
        <div id="varshPhalLoading" class="loading" style="display:none"><div class="spinner"></div><p style="margin-top:12px">Computing Solar Return...</p></div>
        <div id="varshPhalContent" style="display:flex;flex-direction:column;gap:20px"></div>
      </div>
    </div>
  </div>

  <footer>Crafted with reverence for the ancient wisdom of <span>Jyotish Shastra</span></footer>
</div>

<script>
// ============================================================
//  JYOTISH VIDYA — Complete Vedic Astrology Engine
// ============================================================

// ---- INTERNATIONALIZATION (i18n) ----
let LANG = 'en';

const I18N = {
  // ---- Static UI ----
  header_subtitle: { en:'The Sacred Science of Vedic Astrology', hi:'वैदिक ज्योतिष का पवित्र विज्ञान' },
  landing_subtitle: { en:'Choose a service to explore the ancient wisdom of Jyotish Shastra', hi:'ज्योतिष शास्त्र के प्राचीन ज्ञान का अनुभव करें' },
  landing_rashiPhal_title: { en:'Rashi Phal', hi:'राशि फल' },
  landing_rashiPhal_desc: { en:'Yearly predictions for all 12 Moon signs based on Jupiter, Saturn, Rahu-Ketu transits and their effects on each Rashi', hi:'बृहस्पति, शनि, राहु-केतु गोचर के आधार पर सभी 12 राशियों के लिए वार्षिक भविष्यफल' },
  landing_rashiPhal_tag: { en:'All Rashis', hi:'सभी राशियाँ' },
  landing_kundali_title: { en:'Generate Kundali', hi:'कुण्डली बनाएँ' },
  landing_kundali_desc: { en:'Create a complete Vedic birth chart with planetary positions, dashas, divisional charts, readings, and personalized predictions', hi:'ग्रह स्थिति, दशा, वर्ग कुण्डली, फलादेश एवं व्यक्तिगत भविष्यवाणी सहित सम्पूर्ण वैदिक जन्म कुण्डली बनाएँ' },
  landing_kundali_tag: { en:'Personalized', hi:'व्यक्तिगत' },
  landing_gochar_title: { en:'Gochar', hi:'गोचर' },
  landing_gochar_desc: { en:'Precise planetary transit timings — when each planet enters a new sign, retrograde periods, and monthly transit calendar', hi:'ग्रहों के राशि-प्रवेश की सटीक तिथियाँ, वक्री काल, और मासिक गोचर पंचांग' },
  landing_gochar_tag: { en:'Transit Timings', hi:'गोचर समय' },
  back_home: { en:'\u2190 Back to Home', hi:'\u2190 मुख्य पृष्ठ' },
  birth_details_title: { en:'Birth Details', hi:'जन्म विवरण' },
  label_dob: { en:'Date of Birth', hi:'जन्म तिथि' },
  label_tob: { en:'Time of Birth', hi:'जन्म समय' },
  label_city: { en:'City of Birth', hi:'जन्म स्थान' },
  placeholder_city: { en:'Start typing a city...', hi:'शहर का नाम टाइप करें...' },
  btn_generate: { en:'☉ Generate Kundali', hi:'☉ कुण्डली बनाएँ' },
  birth_chart_summary: { en:'Birth Chart Summary', hi:'जन्म कुण्डली सारांश' },
  tab_chart: { en:'Kundali Chart', hi:'कुण्डली चार्ट' },
  tab_reading: { en:'Chart Reading', hi:'फलादेश' },
  tab_rashiphal: { en:'Rashi Phal', hi:'राशि फल' },
  tab_varshphal: { en:'Varsh Phal', hi:'वर्ष फल' },
  tab_planets: { en:'Planets & Nakshatras', hi:'ग्रह एवं नक्षत्र' },
  tab_dasha: { en:'Dasha Predictions', hi:'दशा फल' },
  tab_gochar: { en:'Gochar', hi:'गोचर' },
  tab_transits: { en:'Current Transits', hi:'वर्तमान गोचर' },
  tab_yearly: { en:'Yearly Forecast', hi:'वार्षिक भविष्यफल' },
  tab_remedies: { en:'Remedies', hi:'उपाय' },
  tab_vargas: { en:'Divisional Charts', hi:'वर्ग कुण्डली' },
  sa_rashiPhal_title: { en:'Rashi Phal — Yearly Predictions for All Rashis', hi:'राशि फल — सभी राशियों के लिए वार्षिक भविष्यफल' },
  sa_rashiPhal_desc: { en:'Select a year to view Moon-sign-based predictions for all 12 Rashis, based on major planetary transits', hi:'प्रमुख ग्रह गोचर के आधार पर सभी 12 राशियों का चन्द्र-राशि भविष्यफल देखने के लिए वर्ष चुनें' },
  sa_gochar_title: { en:'Gochar — Planetary Transit Timings', hi:'गोचर — ग्रह राशि-प्रवेश समय' },
  sa_gochar_desc: { en:'Precise dates when each planet enters a new Rashi, retrograde periods, and a monthly transit calendar', hi:'प्रत्येक ग्रह के राशि-प्रवेश की सटीक तिथियाँ, वक्री काल, और मासिक गोचर पंचांग' },
  label_select_year: { en:'Select Year', hi:'वर्ष चुनें' },
  gochar_tab_desc: { en:'Gochar — precise dates when each planet enters a new Rashi during the selected year, with effects from your Moon sign (Janma Rashi)', hi:'गोचर — चयनित वर्ष में प्रत्येक ग्रह के राशि-प्रवेश की सटीक तिथियाँ, आपकी चन्द्र राशि (जन्म राशि) से प्रभावों सहित' },
  chart_rashi: { en:'Rashi Chart', hi:'राशि चार्ट' },
  chart_bhava: { en:'Bhāva Chalit', hi:'भाव चलित' },

  // ---- Rashi names (Hindi) ----
  rashi_hi: ['मेष','वृषभ','मिथुन','कर्क','सिंह','कन्या','तुला','वृश्चिक','धनु','मकर','कुम्भ','मीन'],

  // ---- Planet names ----
  planet_hi: { Sun:'सूर्य', Moon:'चन्द्र', Mars:'मंगल', Mercury:'बुध', Jupiter:'बृहस्पति', Venus:'शुक्र', Saturn:'शनि', Rahu:'राहु', Ketu:'केतु' },
  planet_en: { Sun:'Sun', Moon:'Moon', Mars:'Mars', Mercury:'Mercury', Jupiter:'Jupiter', Venus:'Venus', Saturn:'Saturn', Rahu:'Rahu', Ketu:'Ketu' },

  // ---- Quarter labels ----
  quarter_labels_en: ['Q1: January — March','Q2: April — June','Q3: July — September','Q4: October — December'],
  quarter_labels_hi: ['प्रथम तिमाही: जनवरी — मार्च','द्वितीय तिमाही: अप्रैल — जून','तृतीय तिमाही: जुलाई — सितम्बर','चतुर्थ तिमाही: अक्टूबर — दिसम्बर'],
  quarter_names_en: ['first quarter (January–March)','second quarter (April–June)','third quarter (July–September)','fourth quarter (October–December)'],
  quarter_names_hi: ['प्रथम तिमाही (जनवरी–मार्च)','द्वितीय तिमाही (अप्रैल–जून)','तृतीय तिमाही (जुलाई–सितम्बर)','चतुर्थ तिमाही (अक्टूबर–दिसम्बर)'],

  // ---- Ratings ----
  rating_very_favorable: { en:'Very Favorable', hi:'अत्यन्त शुभ' },
  rating_favorable: { en:'Favorable', hi:'शुभ' },
  rating_mixed: { en:'Mixed', hi:'मिश्रित' },
  rating_challenging: { en:'Challenging', hi:'चुनौतीपूर्ण' },

  // ---- Section headings in buildExpertQuarterSummary ----
  h_career: { en:'Career & Professional Life:', hi:'करियर एवं व्यावसायिक जीवन:' },
  h_finance: { en:'Finances & Wealth:', hi:'धन एवं आर्थिक स्थिति:' },
  h_health: { en:'Health & Wellbeing:', hi:'स्वास्थ्य एवं कल्याण:' },
  h_relations: { en:'Relationships & Family:', hi:'सम्बन्ध एवं परिवार:' },
  h_spiritual: { en:'Spiritual Growth & Inner Life:', hi:'आध्यात्मिक विकास एवं आन्तरिक जीवन:' },
  h_overall: { en:'Overall Assessment:', hi:'समग्र मूल्यांकन:' },

  // ---- Rashi Phal heading ----
  rashiPhal_for: { en:'Rashi Phal for', hi:'राशि फल' },

  // ---- Remedies heading ----
  remedies_heading: { en:'Remedies & Guidance for this Quarter:', hi:'इस तिमाही के लिए उपाय एवं मार्गदर्शन:' },
  remedies_heading_good: { en:'Remedies & Guidance:', hi:'उपाय एवं मार्गदर्शन:' },
  remedies_general: { en:'General Practice:', hi:'सामान्य अभ्यास:' },
  remedies_for: { en:'For', hi:'के लिए' },

  // ---- Sade Sati ----
  sadeSati_title: { en:'Sade Sati Alert', hi:'साढ़े साती चेतावनी' },

  // ---- Ordinals in Hindi ----
  ordinal_hi: ['','प्रथम','द्वितीय','तृतीय','चतुर्थ','पंचम','षष्ठ','सप्तम','अष्टम','नवम','दशम','एकादश','द्वादश'],

  // ---- Bhava / House ----
  bhava: { en:'house', hi:'भाव' },
  from: { en:'from', hi:'से' },

  // ---- Months Hindi ----
  months_hi: ['','जनवरी','फरवरी','मार्च','अप्रैल','मई','जून','जुलाई','अगस्त','सितम्बर','अक्टूबर','नवम्बर','दिसम्बर'],
  months_en: ['','January','February','March','April','May','June','July','August','September','October','November','December'],
};

// Translation helper: T('key') returns the text for current LANG
function T(key) {
  const entry = I18N[key];
  if (!entry) return key;
  if (typeof entry === 'string') return entry;
  return entry[LANG] || entry['en'] || key;
}

// Get rashi name in current language
function rashiName(idx) {
  if (LANG === 'hi') return I18N.rashi_hi[idx];
  return RASHIS[idx].eng;
}

// Get rashi display: "Mesha (Aries)" or "मेष"
function rashiDisplay(idx) {
  if (LANG === 'hi') return I18N.rashi_hi[idx];
  return RASHIS[idx].name + ' (' + RASHIS[idx].eng + ')';
}

// Get planet name in current language
function planetName(p) {
  if (LANG === 'hi') return (I18N.planet_hi[p] || p);
  return p;
}

// Ordinal helper — language-aware
function ordinalL(n) {
  if (LANG === 'hi') return (I18N.ordinal_hi[n] || n + 'वाँ');
  const s = ['th','st','nd','rd'], v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

// "Xth house from Y" in current language
function houseFrom(n, rashiEng) {
  if (LANG === 'hi') {
    return ordinalL(n) + ' ' + T('bhava') + ' ' + T('from') + ' ' + rashiEng;
  }
  return ordinal(n) + ' from ' + rashiEng;
}

// Set language and refresh UI
function setLang(lang) {
  LANG = lang;
  // Toggle active button
  document.getElementById('langBtnEn').classList.toggle('lang-active', lang === 'en');
  document.getElementById('langBtnHi').classList.toggle('lang-active', lang === 'hi');

  // Update all static data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const val = T(key);
    if (val && val !== key) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    const val = T(key);
    if (val && val !== key) el.placeholder = val;
  });
  document.querySelectorAll('[data-i18n-html]').forEach(el => {
    const key = el.getAttribute('data-i18n-html');
    const val = T(key);
    if (val && val !== key) el.innerHTML = val;
  });

  // Re-render dynamic content if visible
  if (document.getElementById('standaloneRashiPhal').style.display === 'block') {
    renderStandaloneRashiPhal();
  }
  if (document.getElementById('standaloneGochar').style.display === 'block') {
    renderStandaloneGochar();
  }
  // Re-render kundali results if they were generated
  if (document.getElementById('results').classList.contains('visible') && window._lastChart) {
    generateChart();
  }
}

// ---- CONSTANTS ----
const DEG = Math.PI / 180;
const RAD = 180 / Math.PI;

// ---- CITY DATABASE ----
const CITIES = [
  {name:"New Delhi",country:"India",lat:28.6139,lon:77.2090,tz:5.5},
  {name:"Mumbai",country:"India",lat:19.0760,lon:72.8777,tz:5.5},
  {name:"Kolkata",country:"India",lat:22.5726,lon:88.3639,tz:5.5},
  {name:"Chennai",country:"India",lat:13.0827,lon:80.2707,tz:5.5},
  {name:"Bangalore",country:"India",lat:12.9716,lon:77.5946,tz:5.5},
  {name:"Hyderabad",country:"India",lat:17.3850,lon:78.4867,tz:5.5},
  {name:"Pune",country:"India",lat:18.5204,lon:73.8567,tz:5.5},
  {name:"Ahmedabad",country:"India",lat:23.0225,lon:72.5714,tz:5.5},
  {name:"Jaipur",country:"India",lat:26.9124,lon:75.7873,tz:5.5},
  {name:"Lucknow",country:"India",lat:26.8467,lon:80.9462,tz:5.5},
  {name:"Varanasi",country:"India",lat:25.3176,lon:82.9739,tz:5.5},
  {name:"Patna",country:"India",lat:25.6093,lon:85.1376,tz:5.5},
  {name:"Bhopal",country:"India",lat:23.2599,lon:77.4126,tz:5.5},
  {name:"Chandigarh",country:"India",lat:30.7333,lon:76.7794,tz:5.5},
  {name:"Kochi",country:"India",lat:9.9312,lon:76.2673,tz:5.5},
  {name:"Thiruvananthapuram",country:"India",lat:8.5241,lon:76.9366,tz:5.5},
  {name:"Srinagar",country:"India",lat:34.0837,lon:74.7973,tz:5.5},
  {name:"Indore",country:"India",lat:22.7196,lon:75.8577,tz:5.5},
  {name:"Nagpur",country:"India",lat:21.1458,lon:79.0882,tz:5.5},
  {name:"Coimbatore",country:"India",lat:11.0168,lon:76.9558,tz:5.5},
  {name:"Amritsar",country:"India",lat:31.6340,lon:74.8723,tz:5.5},
  {name:"Visakhapatnam",country:"India",lat:17.6868,lon:83.2185,tz:5.5},
  {name:"Guwahati",country:"India",lat:26.1445,lon:91.7362,tz:5.5},
  {name:"Dehradun",country:"India",lat:30.3165,lon:78.0322,tz:5.5},
  {name:"Mangalore",country:"India",lat:12.9141,lon:74.8560,tz:5.5},
  {name:"Mysore",country:"India",lat:12.2958,lon:76.6394,tz:5.5},
  {name:"Ujjain",country:"India",lat:23.1765,lon:75.7885,tz:5.5},
  {name:"Rishikesh",country:"India",lat:30.0869,lon:78.2676,tz:5.5},
  {name:"Agra",country:"India",lat:27.1767,lon:78.0081,tz:5.5},
  {name:"Jodhpur",country:"India",lat:26.2389,lon:73.0243,tz:5.5},
  {name:"Udaipur",country:"India",lat:24.5854,lon:73.7125,tz:5.5},
  {name:"Surat",country:"India",lat:21.1702,lon:72.8311,tz:5.5},
  {name:"Kanpur",country:"India",lat:26.4499,lon:80.3319,tz:5.5},
  {name:"Goa",country:"India",lat:15.2993,lon:74.1240,tz:5.5},
  {name:"Ranchi",country:"India",lat:23.3441,lon:85.3096,tz:5.5},
  {name:"Bhubaneswar",country:"India",lat:20.2961,lon:85.8245,tz:5.5},
  {name:"Raipur",country:"India",lat:21.2514,lon:81.6296,tz:5.5},
  {name:"New York",country:"USA",lat:40.7128,lon:-74.0060,tz:-5},
  {name:"Los Angeles",country:"USA",lat:34.0522,lon:-118.2437,tz:-8},
  {name:"Chicago",country:"USA",lat:41.8781,lon:-87.6298,tz:-6},
  {name:"San Francisco",country:"USA",lat:37.7749,lon:-122.4194,tz:-8},
  {name:"Houston",country:"USA",lat:29.7604,lon:-95.3698,tz:-6},
  {name:"London",country:"UK",lat:51.5074,lon:-0.1278,tz:0},
  {name:"Toronto",country:"Canada",lat:43.6532,lon:-79.3832,tz:-5},
  {name:"Vancouver",country:"Canada",lat:49.2827,lon:-123.1207,tz:-8},
  {name:"Sydney",country:"Australia",lat:-33.8688,lon:151.2093,tz:11},
  {name:"Melbourne",country:"Australia",lat:-37.8136,lon:144.9631,tz:11},
  {name:"Dubai",country:"UAE",lat:25.2048,lon:55.2708,tz:4},
  {name:"Singapore",country:"Singapore",lat:1.3521,lon:103.8198,tz:8},
  {name:"Tokyo",country:"Japan",lat:35.6762,lon:139.6503,tz:9},
  {name:"Hong Kong",country:"China",lat:22.3193,lon:114.1694,tz:8},
  {name:"Beijing",country:"China",lat:39.9042,lon:116.4074,tz:8},
  {name:"Bangkok",country:"Thailand",lat:13.7563,lon:100.5018,tz:7},
  {name:"Kuala Lumpur",country:"Malaysia",lat:3.1390,lon:101.6869,tz:8},
  {name:"Colombo",country:"Sri Lanka",lat:6.9271,lon:79.8612,tz:5.5},
  {name:"Kathmandu",country:"Nepal",lat:27.7172,lon:85.3240,tz:5.75},
  {name:"Dhaka",country:"Bangladesh",lat:23.8103,lon:90.4125,tz:6},
  {name:"Lahore",country:"Pakistan",lat:31.5204,lon:74.3587,tz:5},
  {name:"Karachi",country:"Pakistan",lat:24.8607,lon:67.0011,tz:5},
  {name:"Islamabad",country:"Pakistan",lat:33.6844,lon:73.0479,tz:5},
  {name:"Nairobi",country:"Kenya",lat:-1.2921,lon:36.8219,tz:3},
  {name:"Johannesburg",country:"South Africa",lat:-26.2041,lon:28.0473,tz:2},
  {name:"Berlin",country:"Germany",lat:52.5200,lon:13.4050,tz:1},
  {name:"Paris",country:"France",lat:48.8566,lon:2.3522,tz:1},
  {name:"Amsterdam",country:"Netherlands",lat:52.3676,lon:4.9041,tz:1},
  {name:"Zurich",country:"Switzerland",lat:47.3769,lon:8.5417,tz:1},
  {name:"Moscow",country:"Russia",lat:55.7558,lon:37.6173,tz:3},
  {name:"Cairo",country:"Egypt",lat:30.0444,lon:31.2357,tz:2},
  {name:"Lagos",country:"Nigeria",lat:6.5244,lon:3.3792,tz:1},
  {name:"Seoul",country:"South Korea",lat:37.5665,lon:126.9780,tz:9},
  {name:"Jakarta",country:"Indonesia",lat:-6.2088,lon:106.8456,tz:7},
  {name:"Manila",country:"Philippines",lat:14.5995,lon:120.9842,tz:8},
  {name:"Champaign",country:"USA",lat:40.1164,lon:-88.2434,tz:-6},
  {name:"Austin",country:"USA",lat:30.2672,lon:-97.7431,tz:-6},
  {name:"Seattle",country:"USA",lat:47.6062,lon:-122.3321,tz:-8},
  {name:"Boston",country:"USA",lat:42.3601,lon:-71.0589,tz:-5},
  {name:"Atlanta",country:"USA",lat:33.7490,lon:-84.3880,tz:-5},
  {name:"Denver",country:"USA",lat:39.7392,lon:-104.9903,tz:-7},
  {name:"Miami",country:"USA",lat:25.7617,lon:-80.1918,tz:-5},
  {name:"Washington DC",country:"USA",lat:38.9072,lon:-77.0369,tz:-5},
  {name:"Philadelphia",country:"USA",lat:39.9526,lon:-75.1652,tz:-5},
  {name:"Dallas",country:"USA",lat:32.7767,lon:-96.7970,tz:-6},
  {name:"San Diego",country:"USA",lat:32.7157,lon:-117.1611,tz:-8},
  {name:"Phoenix",country:"USA",lat:33.4484,lon:-112.0740,tz:-7},
];

// ---- RASHIS (Signs) ----
const RASHIS = [
  {name:"Mesha",eng:"Aries",symbol:"\u2648",lord:"Mars",element:"Fire",quality:"Movable"},
  {name:"Vrishabha",eng:"Taurus",symbol:"\u2649",lord:"Venus",element:"Earth",quality:"Fixed"},
  {name:"Mithuna",eng:"Gemini",symbol:"\u264A",lord:"Mercury",element:"Air",quality:"Dual"},
  {name:"Karka",eng:"Cancer",symbol:"\u264B",lord:"Moon",element:"Water",quality:"Movable"},
  {name:"Simha",eng:"Leo",symbol:"\u264C",lord:"Sun",element:"Fire",quality:"Fixed"},
  {name:"Kanya",eng:"Virgo",symbol:"\u264D",lord:"Mercury",element:"Earth",quality:"Dual"},
  {name:"Tula",eng:"Libra",symbol:"\u264E",lord:"Venus",element:"Air",quality:"Movable"},
  {name:"Vrischika",eng:"Scorpio",symbol:"\u264F",lord:"Mars",element:"Water",quality:"Fixed"},
  {name:"Dhanu",eng:"Sagittarius",symbol:"\u2650",lord:"Jupiter",element:"Fire",quality:"Dual"},
  {name:"Makara",eng:"Capricorn",symbol:"\u2651",lord:"Saturn",element:"Earth",quality:"Movable"},
  {name:"Kumbha",eng:"Aquarius",symbol:"\u2652",lord:"Saturn",element:"Air",quality:"Fixed"},
  {name:"Meena",eng:"Pisces",symbol:"\u2653",lord:"Jupiter",element:"Water",quality:"Dual"},
];

// ---- NAKSHATRAS ----
const NAKSHATRAS = [
  {name:"Ashwini",lord:"Ketu",deity:"Ashwini Kumaras",pada:[1,2,3,4]},
  {name:"Bharani",lord:"Venus",deity:"Yama",pada:[1,2,3,4]},
  {name:"Krittika",lord:"Sun",deity:"Agni",pada:[1,2,3,4]},
  {name:"Rohini",lord:"Moon",deity:"Brahma",pada:[1,2,3,4]},
  {name:"Mrigashira",lord:"Mars",deity:"Soma",pada:[1,2,3,4]},
  {name:"Ardra",lord:"Rahu",deity:"Rudra",pada:[1,2,3,4]},
  {name:"Punarvasu",lord:"Jupiter",deity:"Aditi",pada:[1,2,3,4]},
  {name:"Pushya",lord:"Saturn",deity:"Brihaspati",pada:[1,2,3,4]},
  {name:"Ashlesha",lord:"Mercury",deity:"Nagas",pada:[1,2,3,4]},
  {name:"Magha",lord:"Ketu",deity:"Pitrs",pada:[1,2,3,4]},
  {name:"Purva Phalguni",lord:"Venus",deity:"Bhaga",pada:[1,2,3,4]},
  {name:"Uttara Phalguni",lord:"Sun",deity:"Aryaman",pada:[1,2,3,4]},
  {name:"Hasta",lord:"Moon",deity:"Savitar",pada:[1,2,3,4]},
  {name:"Chitra",lord:"Mars",deity:"Tvashtar",pada:[1,2,3,4]},
  {name:"Swati",lord:"Rahu",deity:"Vayu",pada:[1,2,3,4]},
  {name:"Vishakha",lord:"Jupiter",deity:"Indragni",pada:[1,2,3,4]},
  {name:"Anuradha",lord:"Saturn",deity:"Mitra",pada:[1,2,3,4]},
  {name:"Jyeshtha",lord:"Mercury",deity:"Indra",pada:[1,2,3,4]},
  {name:"Mula",lord:"Ketu",deity:"Nirrti",pada:[1,2,3,4]},
  {name:"Purva Ashadha",lord:"Venus",deity:"Apas",pada:[1,2,3,4]},
  {name:"Uttara Ashadha",lord:"Sun",deity:"Vishvedevas",pada:[1,2,3,4]},
  {name:"Shravana",lord:"Moon",deity:"Vishnu",pada:[1,2,3,4]},
  {name:"Dhanishta",lord:"Mars",deity:"Vasus",pada:[1,2,3,4]},
  {name:"Shatabhisha",lord:"Rahu",deity:"Varuna",pada:[1,2,3,4]},
  {name:"Purva Bhadrapada",lord:"Jupiter",deity:"Ajaikapada",pada:[1,2,3,4]},
  {name:"Uttara Bhadrapada",lord:"Saturn",deity:"Ahirbudhnya",pada:[1,2,3,4]},
  {name:"Revati",lord:"Mercury",deity:"Pushan",pada:[1,2,3,4]},
];

// ---- DASHA ORDER & YEARS ----
const DASHA_ORDER = ["Ketu","Venus","Sun","Moon","Mars","Rahu","Jupiter","Saturn","Mercury"];
const DASHA_YEARS = {Ketu:7,Venus:20,Sun:6,Moon:10,Mars:7,Rahu:18,Jupiter:16,Saturn:19,Mercury:17};
const PLANET_COLORS = {
  Sun:"#C75B12",Moon:"#4A6FA5",Mars:"#B8352A",Mercury:"#1A8A5C",
  Jupiter:"#B8860B",Venus:"#C2185B",Saturn:"#37474F",Rahu:"#546E7A",Ketu:"#6A1B9A",Asc:"#D4710A"
};

// ---- PLANET DATA ----
const PLANETS_INFO = {
  Sun:{name:"Sun",sanskrit:"Surya",symbol:"\u2609",nature:"Benefic",gender:"Male",gem:"Ruby",mantra:"Om Suryaya Namaha",color:"Orange/Saffron",day:"Sunday",metal:"Gold",deity:"Lord Surya",donate:"Wheat, jaggery, copper",fast:"Sunday"},
  Moon:{name:"Moon",sanskrit:"Chandra",symbol:"\u263D",nature:"Benefic",gender:"Female",gem:"Pearl",mantra:"Om Chandraya Namaha",color:"White/Silver",day:"Monday",metal:"Silver",deity:"Lord Shiva",donate:"Rice, milk, white cloth",fast:"Monday"},
  Mars:{name:"Mars",sanskrit:"Mangal",symbol:"\u2642",nature:"Malefic",gender:"Male",gem:"Red Coral",mantra:"Om Mangalaya Namaha",color:"Red",day:"Tuesday",metal:"Copper",deity:"Lord Hanuman",donate:"Red lentils, jaggery",fast:"Tuesday"},
  Mercury:{name:"Mercury",sanskrit:"Budha",symbol:"\u263F",nature:"Neutral",gender:"Neutral",gem:"Emerald",mantra:"Om Budhaya Namaha",color:"Green",day:"Wednesday",metal:"Bronze",deity:"Lord Vishnu",donate:"Green moong, green cloth",fast:"Wednesday"},
  Jupiter:{name:"Jupiter",sanskrit:"Guru",symbol:"\u2643",nature:"Benefic",gender:"Male",gem:"Yellow Sapphire",mantra:"Om Gurave Namaha",color:"Yellow",day:"Thursday",metal:"Gold",deity:"Lord Brihaspati",donate:"Yellow cloth, turmeric, chana dal",fast:"Thursday"},
  Venus:{name:"Venus",sanskrit:"Shukra",symbol:"\u2640",nature:"Benefic",gender:"Female",gem:"Diamond",mantra:"Om Shukraya Namaha",color:"White/Pink",day:"Friday",metal:"Silver",deity:"Goddess Lakshmi",donate:"White rice, white sweets, ghee",fast:"Friday"},
  Saturn:{name:"Saturn",sanskrit:"Shani",symbol:"\u2644",nature:"Malefic",gender:"Neutral",gem:"Blue Sapphire",mantra:"Om Shanaischaraya Namaha",color:"Blue/Black",day:"Saturday",metal:"Iron",deity:"Lord Shani Dev",donate:"Black sesame, mustard oil, iron",fast:"Saturday"},
  Rahu:{name:"Rahu",sanskrit:"Rahu",symbol:"\u260A",nature:"Malefic",gender:"Male",gem:"Hessonite (Gomed)",mantra:"Om Rahuve Namaha",color:"Smoke/Grey",day:"Saturday",metal:"Lead",deity:"Goddess Durga",donate:"Black blanket, mustard",fast:"Saturday"},
  Ketu:{name:"Ketu",sanskrit:"Ketu",symbol:"\u260B",nature:"Malefic",gender:"Neutral",gem:"Cat's Eye (Lehsunia)",mantra:"Om Ketave Namaha",color:"Grey/Brown",day:"Tuesday",metal:"Mixed metals",deity:"Lord Ganesha",donate:"Blanket, sesame, seven grains",fast:"Tuesday/Saturday"},
};

// ---- MAHADASHA PREDICTIONS ----
const DASHA_PREDICTIONS = {
  Sun: "A period of leadership, authority, and self-expression. Government relations and father figures become significant. Health focus on vitality. Career sees prominence. Confidence and willpower strengthen. Spiritual awareness through dharmic pursuits deepens.",
  Moon: "An emotionally rich period. Mother figures, home, and comfort take center stage. Travel, especially over water, is possible. Mental peace, creativity, and public dealings are highlighted. Nurturing relationships blossom. Intuition sharpens considerably.",
  Mars: "A dynamic, action-oriented period. Courage, ambition, and competitive spirit surge. Property matters, siblings, and technical skills are prominent. Guard against haste and conflicts. Physical energy peaks. Land and real estate dealings are favored.",
  Mercury: "An intellectual, communicative period. Education, writing, commerce, and analytical abilities shine. Social connections multiply. Business acumen improves. Speech and wit become powerful tools. Short travels and learning new skills are highlighted.",
  Jupiter: "A period of wisdom, expansion, and good fortune. Spiritual growth, higher education, and mentorship opportunities arise. Marriage, children, and wealth are favored. Dharmic activities bring blessings. Teachers and advisors play important roles in life.",
  Venus: "A period of comfort, luxury, and artistic expression. Relationships, marriage, and partnerships are highlighted. Material gains, vehicles, and beautiful possessions come. Creative talents flourish. Social life becomes vibrant and pleasurable.",
  Saturn: "A period of discipline, hard work, and karmic lessons. Patience and perseverance are tested but ultimately rewarded. Career stability through sustained effort. Service, humility, and detachment bring wisdom. Health requires attention, especially bones and joints.",
  Rahu: "A period of unconventional experiences and worldly ambitions. Foreign connections, technology, and out-of-the-box thinking are highlighted. Material desires intensify. Sudden changes and unexpected opportunities arise. Guard against illusions and obsessions.",
  Ketu: "A period of spiritual awakening and inner transformation. Detachment from material pursuits grows. Past-life karmas surface for resolution. Intuition and psychic abilities heighten. Pilgrimages and retreats are beneficial. Let go of what no longer serves."
};

// ---- TRANSIT EFFECTS ----
const TRANSIT_HOUSE_EFFECTS = {
  Sun: ["Strong vitality and new beginnings","Financial gains through effort","Courage and communication improve","Domestic matters need attention","Creative expression flourishes","Health focus needed, service opportunities","Partnership and relationship focus","Transformation and hidden matters surface","Fortune, travel, and higher learning","Career peak and public recognition","Gains and fulfilled desires","Spiritual growth, expenses for good causes"],
  Moon: ["Emotional new beginnings","Comfort and financial security","Communicative and social mood","Domestic peace and nurturing","Creative and romantic energy","Service-minded, health aware","Relationship harmony","Emotional depth and transformation","Optimistic and philosophical","Professional recognition","Social fulfillment","Spiritual introspection"],
  Mars: ["High energy and initiative","Financial drive intensifies","Bold communication","Property and vehicle matters","Passionate creativity","Competitive in service","Dynamic partnerships","Deep transformations","Adventurous pursuits","Career ambitions surge","Active social goals","Spiritual warrior energy"],
  Mercury: ["Quick thinking and new ideas","Financial planning sharpens","Excellent for communication","Domestic problem-solving","Creative intelligence peaks","Analytical work excels","Negotiation skills heighten","Research and investigation","Higher learning focus","Professional communication","Networking opportunities","Reflective contemplation"],
  Jupiter: ["Blessings and personal growth","Wealth expansion period","Auspicious for learning","Domestic happiness increases","Children and creativity blessed","Health improvements, service","Marriage and partnerships blessed","Transformative wisdom","Great fortune and dharma","Career expansion and honors","Fulfillment of great desires","Spiritual liberation focus"],
  Venus: ["Charm and personal magnetism","Material comfort increases","Social graces and artistry","Home beautification","Romance and creative joy","Harmonious service","Love and partnership bliss","Intimate transformations","Cultural enrichment","Professional grace","Social pleasures abound","Devotional and artistic"],
  Saturn: ["Self-discipline strengthens","Financial responsibility","Serious communication","Home restructuring","Disciplined creativity","Health discipline needed","Committed partnerships","Deep karmic clearing","Philosophical maturity","Career consolidation","Long-term goal planning","Karmic resolution and release"],
  Rahu: ["Ambitious new identity","Unconventional wealth paths","Innovative communication","Unusual domestic changes","Eccentric creativity","Foreign health approaches","Unusual partnerships","Occult transformations","Foreign education/travel","Sudden career changes","Unexpected gains","Spiritual breakthroughs"],
  Ketu: ["Spiritual self-discovery","Detachment from possessions","Intuitive communication","Past-life home connections","Mystical creativity","Selfless service","Karmic relationships","Psychic depth","Spiritual pilgrimages","Letting go of ambition","Detached from gains","Liberation and moksha"]
};

// ============================================================
//  ASTRONOMICAL CALCULATIONS
// ============================================================

function julianDay(year, month, day, hour) {
  if (month <= 2) { year--; month += 12; }
  const A = Math.floor(year / 100);
  const B = 2 - A + Math.floor(A / 4);
  return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + hour / 24 + B - 1524.5;
}

function centuriesFromJ2000(jd) {
  return (jd - 2451545.0) / 36525.0;
}

function normalize(deg) {
  deg = deg % 360;
  return deg < 0 ? deg + 360 : deg;
}

function sinD(d) { return Math.sin(d * DEG); }
function cosD(d) { return Math.cos(d * DEG); }
function tanD(d) { return Math.tan(d * DEG); }
function asinD(x) { return Math.asin(x) * RAD; }
function acosD(x) { return Math.acos(Math.max(-1, Math.min(1, x))) * RAD; }
function atan2D(y, x) { return Math.atan2(y, x) * RAD; }

// Lahiri Ayanamsa (Chitrapaksha standard)
// Uses precession polynomial matching IAU 2006 model, calibrated to
// the Indian Calendar Reform Committee (1956) definition: Chitra at 180° sidereal
function lahiriAyanamsa(jd) {
  const T = (jd - 2451545.0) / 36525.0;  // Julian centuries from J2000
  // Polynomial fit matching Swiss Ephemeris Lahiri to < 3 arcsec over 1900–2100
  return 23.85710 + 1.39717 * T + 0.000312 * T * T;
}

// Obliquity of the ecliptic
function obliquity(T) {
  return 23.439291 - 0.0130042 * T - 1.64e-7 * T * T + 5.04e-7 * T * T * T;
}

// ---- JPL Keplerian Orbital Elements (Standish 1992, 3000 BC — 3000 AD) ----
// Format: [a(AU), e, I(°), L(°), lonPeri(°), lonNode(°)]
//   + rates per Julian century [da, de, dI, dL, dlonPeri, dlonNode]
const ORB = {
  Mercury: { a:0.38709927, e:0.20563593, I:7.00497902, L:252.25032350, wp:77.45779628, Om:48.33076593,
             da:0.00000037, de:0.00001906, dI:-0.00594749, dL:149472.67411175, dwp:0.16047689, dOm:-0.12534081 },
  Venus:   { a:0.72333566, e:0.00677672, I:3.39467605, L:181.97909950, wp:131.60246718, Om:76.67984255,
             da:0.00000390, de:-0.00004107, dI:-0.00078890, dL:58517.81538729, dwp:0.00268329, dOm:-0.27769418 },
  Earth:   { a:1.00000261, e:0.01671123, I:-0.00001531, L:100.46457166, wp:102.93768193, Om:0.0,
             da:0.00000562, de:-0.00004392, dI:-0.01294668, dL:35999.37244981, dwp:0.32327364, dOm:0.0 },
  Mars:    { a:1.52371034, e:0.09339410, I:1.84969142, L:-4.55343205, wp:-23.94362959, Om:49.55953891,
             da:0.00001847, de:0.00007882, dI:-0.00813131, dL:19140.30268499, dwp:0.44441088, dOm:-0.29257343 },
  Jupiter: { a:5.20288700, e:0.04838624, I:1.30439695, L:34.39644051, wp:14.72847983, Om:100.47390909,
             da:-0.00011607, de:-0.00013253, dI:-0.00183714, dL:3034.74612775, dwp:0.21252668, dOm:0.20469106 },
  Saturn:  { a:9.53667594, e:0.05386179, I:2.48599187, L:49.95424423, wp:92.59887831, Om:113.66242448,
             da:-0.00125060, de:-0.00050991, dI:0.00193609, dL:1222.49362201, dwp:-0.41897216, dOm:-0.28867794 }
};

// Solve Kepler's equation: M = E - e·sin(E)  (Newton–Raphson)
function solveKepler(M_deg, e) {
  let M = normalize(M_deg) * DEG;
  let E = M + e * Math.sin(M) * (1 + e * Math.cos(M)); // better initial guess
  for (let i = 0; i < 30; i++) {
    const dE = (M - (E - e * Math.sin(E))) / (1 - e * Math.cos(E));
    E += dE;
    if (Math.abs(dE) < 1e-12) break;
  }
  return E; // radians
}

// Extra perturbation terms for Jupiter & Saturn (JPL, 3000BC–3000AD table)
const ORB_EXTRA = {
  Jupiter: { b:-0.00012452, c:0.06064060, s:-0.35635438, f:38.35125000 },
  Saturn:  { b:0.00025899, c:-0.13434469, s:0.87320147, f:38.35125000 }
};

// Compute heliocentric ecliptic XYZ from Keplerian elements
function helioPosition(name, T) {
  const p = ORB[name];
  const a  = p.a  + p.da  * T;
  const e  = p.e  + p.de  * T;
  const I  = (p.I  + p.dI  * T) * DEG;
  let   L  = p.L  + p.dL  * T;
  const wp = p.wp + p.dwp * T;
  const Om = (p.Om + p.dOm * T) * DEG;

  // Apply extra perturbation terms for Jupiter & Saturn
  if (ORB_EXTRA[name]) {
    const ex = ORB_EXTRA[name];
    L += ex.b * T * T + ex.c * cosD(ex.f * T) + ex.s * sinD(ex.f * T);
  }

  const M = normalize(L - wp);          // mean anomaly (°)
  const w = (wp - p.Om - p.dOm * T) * DEG; // argument of perihelion (rad)

  const E = solveKepler(M, e);
  const xp = a * (Math.cos(E) - e);
  const yp = a * Math.sqrt(1 - e * e) * Math.sin(E);

  // True anomaly
  const nu = Math.atan2(yp, xp);
  const r  = Math.sqrt(xp * xp + yp * yp);

  // 3D heliocentric ecliptic (rotate orbital plane → ecliptic)
  const cosW = Math.cos(w + nu), sinW = Math.sin(w + nu);
  const cosO = Math.cos(Om),     sinO = Math.sin(Om);
  const cosI = Math.cos(I),      sinI = Math.sin(I);

  const X = r * (cosO * cosW - sinO * sinW * cosI);
  const Y = r * (sinO * cosW + cosO * sinW * cosI);
  const Z = r * (sinW * sinI);

  return { X, Y, Z, r, helioLon: normalize(Math.atan2(Y, X) * RAD) };
}

// Sun geocentric tropical longitude (standard Meeus formula — accurate)
function sunLongitude(T) {
  const L0 = normalize(280.46646 + 36000.76983 * T + 0.0003032 * T * T);
  const M  = normalize(357.52911 + 35999.05029 * T - 0.0001537 * T * T);
  const C  = (1.914602 - 0.004817 * T - 0.000014 * T * T) * sinD(M)
           + (0.019993 - 0.000101 * T) * sinD(2 * M)
           + 0.000289 * sinD(3 * M);
  return normalize(L0 + C);
}

// Moon geocentric tropical longitude — Meeus Ch.47, Table 47.A (full 60-term series)
// with eccentricity correction E for terms involving Sun's mean anomaly M
function moonLongitude(T) {
  const Lp = normalize(218.3164477 + 481267.88123421 * T
             - 0.0015786 * T*T + T*T*T / 538841.0 - T*T*T*T / 65194000.0);
  const D  = normalize(297.8501921 + 445267.1114034  * T
             - 0.0018819 * T*T + T*T*T / 545868.0 - T*T*T*T / 113065000.0);
  const M  = normalize(357.5291092 + 35999.0502909   * T
             - 0.0001536 * T*T + T*T*T / 24490000.0);
  const Mp = normalize(134.9633964 + 477198.8675055  * T
             + 0.0087414 * T*T + T*T*T / 69699.0 - T*T*T*T / 14712000.0);
  const F  = normalize(93.2720950  + 483202.0175233  * T
             - 0.0036539 * T*T - T*T*T / 3526000.0 + T*T*T*T / 863310000.0);

  // Eccentricity of Earth's orbit correction
  const E  = 1.0 - 0.002516 * T - 0.0000074 * T * T;
  const E2 = E * E;

  const A1 = normalize(119.75 + 131.849 * T);
  const A2 = normalize(53.09 + 479264.290 * T);
  const A3 = normalize(313.45 + 481266.484 * T);

  // Meeus Table 47.A — coefficients in micro-degrees (÷1e6 for degrees)
  // Format: [D, M, Mp, F, coeff_micro_degrees]
  // Terms involving M (col 2) are multiplied by E^|M|
  const terms = [
    [0, 0, 1, 0, 6288774], [2, 0,-1, 0, 1274027], [2, 0, 0, 0, 658314],
    [0, 0, 2, 0, 213618], [0, 1, 0, 0,-185116], [0, 0, 0, 2,-114332],
    [2, 0,-2, 0, 58793],  [2,-1,-1, 0, 57066],  [2, 0, 1, 0, 53322],
    [2,-1, 0, 0, 45758],  [0, 1,-1, 0,-40923],  [1, 0, 0, 0,-34720],
    [0, 1, 1, 0,-30383],  [2, 0, 0,-2, 15327],  [0, 0, 1, 2,-12528],
    [0, 0, 1,-2, 10980],  [4, 0,-1, 0, 10675],  [0, 0, 3, 0, 10034],
    [4, 0,-2, 0, 8548],   [2, 1,-1, 0,-7888],   [2, 1, 0, 0,-6766],
    [1, 0,-1, 0,-5163],   [1, 1, 0, 0, 4987],   [2,-1, 1, 0, 4036],
    [2, 0, 2, 0, 3994],   [4, 0, 0, 0, 3861],   [2, 0,-3, 0, 3665],
    [0, 1,-2, 0,-2689],   [2, 0,-1, 2,-2602],   [2,-1,-2, 0, 2390],
    [1, 0, 1, 0,-2348],   [2,-2, 0, 0, 2236],   [0, 1, 2, 0,-2120],
    [0, 2, 0, 0,-2069],   [2,-2,-1, 0, 2048],   [2, 0, 1,-2,-1773],
    [2, 0, 0, 2,-1595],   [4,-1,-1, 0, 1215],   [0, 0, 2, 2,-1110],
    [3, 0,-1, 0,-892],    [2, 1, 1, 0,-810],     [4,-1,-2, 0, 759],
    [0, 2,-1, 0,-713],    [2, 2,-1, 0,-700],     [2, 1,-2, 0, 691],
    [2,-1, 0,-2, 596],    [4, 0, 1, 0, 549],     [0, 0, 4, 0, 537],
    [4,-1, 0, 0, 520],    [1, 0,-2, 0,-487],     [2, 1, 0,-2,-399],
    [0, 0, 2,-2,-381],    [1, 1, 1, 0, 351],     [3, 0,-2, 0,-340],
    [4, 0,-3, 0, 330],    [2,-1, 2, 0, 327],     [0, 2, 1, 0,-323],
    [1, 1,-1, 0, 299],    [2, 0, 3, 0, 294]
  ];

  let sumL = 0;
  for (const [tD, tM, tMp, tF, coeff] of terms) {
    const arg = tD * D + tM * M + tMp * Mp + tF * F;
    let c = coeff;
    // Apply eccentricity correction for terms involving Sun's anomaly
    if (Math.abs(tM) === 1) c *= E;
    else if (Math.abs(tM) === 2) c *= E2;
    sumL += c * sinD(arg);
  }

  // Convert micro-degrees to degrees and add to Lp
  let lon = Lp + sumL / 1000000.0;

  // Additional corrections (Meeus p.342)
  lon += 0.003958 * sinD(A1)
       + 0.001962 * sinD(Lp - F)
       + 0.000318 * sinD(A2);

  return normalize(lon);
}

// Rahu: Mean Lunar North Node (Meeus, higher-order terms)
function rahuLongitude(T) {
  return normalize(125.0445479 - 1934.1362891 * T
    + 0.0020754 * T * T + T * T * T / 467441.0 - T * T * T * T / 60616000.0);
}

// ---- Master planet calculator: proper heliocentric→geocentric ----
function calculatePlanets(jd) {
  const T   = centuriesFromJ2000(jd);
  const aya = lahiriAyanamsa(jd);

  // Earth heliocentric position (needed for geocentric conversion of all others)
  const earth = helioPosition('Earth', T);

  const tropical = {};

  // Sun & Moon are inherently geocentric — use dedicated formulae
  tropical.Sun  = sunLongitude(T);
  tropical.Moon = moonLongitude(T);

  // Five visible planets: heliocentric → geocentric via vector subtraction
  ['Mercury','Venus','Mars','Jupiter','Saturn'].forEach(name => {
    const pl = helioPosition(name, T);
    const dx = pl.X - earth.X;
    const dy = pl.Y - earth.Y;
    tropical[name] = normalize(atan2D(dy, dx));
  });

  // Lunar nodes
  tropical.Rahu = rahuLongitude(T);
  tropical.Ketu = normalize(tropical.Rahu + 180);

  // Tropical → Sidereal (subtract Lahiri ayanamsa)
  const sidereal = {};
  for (const p in tropical) {
    sidereal[p] = normalize(tropical[p] - aya);
  }

  // Attach debug payload so the UI can display it
  sidereal._debug = { T, aya, jd, tropical: { ...tropical } };
  return sidereal;
}

// Greenwich Sidereal Time (degrees) — IAU formula
function greenwichSiderealTime(jd) {
  const T = centuriesFromJ2000(jd);
  let gst = 280.46061837 + 360.98564736629 * (jd - 2451545.0)
            + 0.000387933 * T * T - T * T * T / 38710000;
  return normalize(gst);
}

// Ascendant (Lagna) — tropical, then sidereal
// Formula: λ = atan2(cos(RAMC), −[sin(RAMC)·cos(ε) + tan(φ)·sin(ε)])
// Ref: Swiss Ephemeris (Asc1) with proper quadrant handling — both atan2
// arguments are negated vs. the "descendant" form to select the rising point.
function calculateAscendant(jd, lat, lon) {
  const gst = greenwichSiderealTime(jd);
  const lst = normalize(gst + lon);       // Local Sidereal Time = RAMC (°)
  const T   = centuriesFromJ2000(jd);
  const eps = obliquity(T);
  const y = cosD(lst);
  const x = -(sinD(lst) * cosD(eps) + tanD(lat) * sinD(eps));
  let asc = atan2D(y, x);
  asc = normalize(asc);
  const aya = lahiriAyanamsa(jd);
  return normalize(asc - aya);
}

// ============================================================
//  VEDIC ASTROLOGY LOGIC
// ============================================================

// Format decimal degrees as D°M'S"
function degToDMS(deg) {
  const d = Math.floor(deg);
  const mFull = (deg - d) * 60;
  const m = Math.floor(mFull);
  const s = Math.round((mFull - m) * 60);
  return `${d}\u00b0${String(m).padStart(2,'0')}'${String(s).padStart(2,'0')}"`;
}

function getRashi(longitude) {
  const idx = Math.floor(longitude / 30) % 12;
  return { index: idx, ...RASHIS[idx], degrees: longitude % 30 };
}

function getNakshatra(longitude) {
  const nakshatraSpan = 360 / 27; // 13.333...
  const idx = Math.floor(longitude / nakshatraSpan) % 27;
  const posInNak = longitude - idx * nakshatraSpan;
  const pada = Math.floor(posInNak / (nakshatraSpan / 4)) + 1;
  return { index: idx, ...NAKSHATRAS[idx], currentPada: Math.min(pada, 4), degInNak: posInNak };
}

function getHouse(planetLong, ascLong) {
  // Whole-sign house system (Vedic): 1st house = entire sign of the ascendant
  // House boundaries start at the beginning of the lagna rashi, not the exact degree
  const ascSignStart = Math.floor(ascLong / 30) * 30;
  let diff = normalize(planetLong - ascSignStart);
  return Math.floor(diff / 30) + 1;
}

// ============================================================
//  BHĀVA CHALIT CHART CALCULATIONS
// ============================================================

function getBhavaMidpoints(ascendant) {
  const midpoints = [];
  for (let i = 0; i < 12; i++) {
    midpoints.push(normalize(ascendant + i * 30));
  }
  return midpoints;
}

function getBhavaCusps(ascendant) {
  const cusps = [];
  for (let i = 0; i < 12; i++) {
    cusps.push(normalize(ascendant - 15 + i * 30));
  }
  return cusps;
}

function getBhavaFromLongitude(planetLong, ascendant) {
  const bhavaStart = normalize(ascendant - 15);
  const diff = normalize(planetLong - bhavaStart);
  return Math.floor(diff / 30) + 1;
}

function generateBhavaChartData(chart) {
  const bhavaChart = JSON.parse(JSON.stringify(chart));
  bhavaChart.isBhavaChart = true;
  bhavaChart.bhavaCusps = getBhavaCusps(chart.ascendant);
  bhavaChart.bhavaMidpoints = getBhavaMidpoints(chart.ascendant);

  for (const pName in chart.planets) {
    const origLon = chart.planets[pName].longitude;
    const bhava = getBhavaFromLongitude(origLon, chart.ascendant);
    const rashiHouse = chart.planets[pName].house;
    bhavaChart.planets[pName].house = bhava;
    bhavaChart.planets[pName].rashiHouse = rashiHouse;
    bhavaChart.planets[pName].shifted = (bhava !== rashiHouse);
  }
  return bhavaChart;
}

// ============================================================
//  DIVISIONAL CHART (VARGA) CALCULATIONS
// ============================================================

const VARGA_INFO = {
  2:  {name:'D2 — Hora',             area:'Wealth & Material Prosperity',desc:'Indicates financial gain, banking, treasure, and liquid assets. The Hora chart reveals earning potential and wealth accumulation.'},
  3:  {name:'D3 — Drekkana',         area:'Siblings & Courage',desc:'Shows relationships with siblings, valor, courage in endeavors, and co-born. Reveals the nature of one\'s initiative and enterprise.'},
  4:  {name:'D4 — Chaturthamsa',     area:'Property & Fortune',desc:'Indicates immovable assets, houses, landed property, vehicles, and material comforts. Shows fortune through fixed assets.'},
  7:  {name:'D7 — Saptamsa',         area:'Children & Progeny',desc:'Shows matters of children, procreation, creative output, and fertility. Reveals the nature and fortune of offspring.'},
  9:  {name:'D9 — Navamsa',          area:'Marriage & Dharma',desc:'The most important divisional chart after Rashi. Reveals spouse characteristics, marriage quality, spiritual dharma, and the soul\'s deeper purpose. Often called the "chart of destiny."'},
  10: {name:'D10 — Dashamsa',        area:'Career & Profession',desc:'Indicates professional life, reputation, public status, authority, and karmic work. Essential for career analysis.'},
  12: {name:'D12 — Dwadasamsa',      area:'Parents & Ancestry',desc:'Shows relationship with parents, inheritance, family legacy, and ancestral influences. Reveals parental karma.'},
  16: {name:'D16 — Shodasamsa',      area:'Vehicles & Comforts',desc:'Indicates acquisition of conveyances, comforts, luxuries, and pleasures from material possessions.'},
  20: {name:'D20 — Vimsamsa',        area:'Spiritual Life',desc:'Reveals spiritual practices, divine grace, worship preferences, meditation inclination, and spiritual advancement.'},
  24: {name:'D24 — Chaturvimsamsa',  area:'Education & Learning',desc:'Shows formal education, scholarship, intelligence, academic pursuits, and the nature of knowledge acquisition.'},
  27: {name:'D27 — Saptavimsamsa',   area:'Strengths & Stamina',desc:'Reveals inherent strengths, physical vitality, endurance, and karmic fortitude.'},
  30: {name:'D30 — Trimsamsa',       area:'Misfortunes & Evils',desc:'Indicates challenges, obstacles, hidden difficulties, and areas of vulnerability. Important for assessing afflictions.'},
  40: {name:'D40 — Khavedamsa',      area:'Auspicious Effects',desc:'Shows beneficial planetary effects and the grace received through accumulated good karma.'},
  45: {name:'D45 — Akshavedamsa',    area:'General Indications',desc:'Provides general planetary significations and their overall positive or negative effects on life.'},
  60: {name:'D60 — Shashtiamsa',     area:'Past-Life Karma',desc:'The finest division revealing past-life karmic imprints, spiritual evolution across lifetimes, and deepest soul patterns.'}
};

// D2 (Hora): Odd signs → 1st half Leo, 2nd half Cancer; Even signs → 1st half Cancer, 2nd half Leo
function getD2Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const isOdd = rashi % 2 === 0; // 0-indexed: Aries=0 (odd sign)
  if (isOdd) return degInSign < 15 ? 4 : 3; // Leo : Cancer
  else return degInSign < 15 ? 3 : 4; // Cancer : Leo
}

// D3 (Drekkana): 3 decanates of 10° each; 1st → same sign, 2nd → 5th from it, 3rd → 9th from it
function getD3Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 10);
  return (rashi + part * 4) % 12;
}

// D4 (Chaturthamsa): 4 parts of 7.5°; 1st → same, 2nd → 4th, 3rd → 7th, 4th → 10th
function getD4Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 7.5);
  return (rashi + part * 3) % 12;
}

// D7 (Saptamsa): 7 parts of ~4.286°; odd signs start from same sign, even from 7th
function getD7Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / (30 / 7));
  const isOdd = rashi % 2 === 0;
  const start = isOdd ? rashi : (rashi + 6) % 12;
  return (start + part) % 12;
}

// D9 (Navamsa): 9 padas of 3°20'; Fire→Aries, Earth→Cap, Air→Libra, Water→Cancer
function getD9Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const pada = Math.floor(degInSign / (30 / 9));
  const elementStarts = [0, 9, 6, 3]; // Fire, Earth, Air, Water
  const element = [0,1,2,3, 0,1,2,3, 0,1,2,3][rashi]; // Ari=fire,Tau=earth,...
  return (elementStarts[element] + pada) % 12;
}

// D10 (Dashamsa): 10 parts of 3°; odd signs start from same, even from 9th
function getD10Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 3);
  const isOdd = rashi % 2 === 0;
  const start = isOdd ? rashi : (rashi + 8) % 12;
  return (start + part) % 12;
}

// D12 (Dwadasamsa): 12 parts of 2.5°; always starts from same sign
function getD12Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 2.5);
  return (rashi + part) % 12;
}

// D16 (Shodasamsa): 16 parts of 1.875°; movable→Aries, fixed→Leo, dual→Sagittarius
function getD16Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / (30 / 16));
  const quality = RASHIS[rashi].quality;
  const start = quality === 'Movable' ? 0 : quality === 'Fixed' ? 4 : 8;
  return (start + part) % 12;
}

// D20 (Vimsamsa): 20 parts of 1.5°; movable→Aries, fixed→Sagittarius, dual→Leo
function getD20Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 1.5);
  const quality = RASHIS[rashi].quality;
  const start = quality === 'Movable' ? 0 : quality === 'Fixed' ? 8 : 4;
  return (start + part) % 12;
}

// D24 (Chaturvimsamsa): 24 parts of 1.25°; odd signs→Leo, even signs→Cancer
function getD24Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 1.25);
  const isOdd = rashi % 2 === 0;
  const start = isOdd ? 4 : 3; // Leo for odd, Cancer for even
  return (start + part) % 12;
}

// D27 (Saptavimsamsa): 27 parts of ~1.111°; fire→Aries, earth→Cancer, air→Libra, water→Capricorn
function getD27Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / (30 / 27));
  const element = [0,1,2,3, 0,1,2,3, 0,1,2,3][rashi];
  const starts = [0, 3, 6, 9]; // Fire→Aries, Earth→Cancer, Air→Libra, Water→Capricorn
  return (starts[element] + part) % 12;
}

// D30 (Trimsamsa): unequal division — 5°,5°,8°,7°,5° for odd signs; reversed for even
function getD30Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const isOdd = rashi % 2 === 0;
  // Odd sign rulers: Mars(5°),Saturn(5°),Jupiter(8°),Mercury(7°),Venus(5°)
  // Even sign rulers: Venus(5°),Mercury(7°),Jupiter(8°),Saturn(5°),Mars(5°)
  const oddBounds  = [{end:5,lord:0},{end:10,lord:7},{end:18,lord:8},{end:25,lord:2},{end:30,lord:1}]; // Ari,Sco,Sag,Gem,Tau sign indices
  const evenBounds = [{end:5,lord:1},{end:12,lord:5},{end:20,lord:8},{end:25,lord:7},{end:30,lord:0}]; // Tau,Vir,Sag,Sco,Ari
  const bounds = isOdd ? oddBounds : evenBounds;
  for (const b of bounds) {
    if (degInSign < b.end) return b.lord;
  }
  return bounds[4].lord;
}

// D40 (Khavedamsa): 40 parts of 0.75°; odd signs→Aries, even signs→Libra
function getD40Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 0.75);
  const isOdd = rashi % 2 === 0;
  const start = isOdd ? 0 : 6;
  return (start + part) % 12;
}

// D45 (Akshavedamsa): 45 parts of 0.667°; movable→Aries, fixed→Leo, dual→Sagittarius
function getD45Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / (30 / 45));
  const quality = RASHIS[rashi].quality;
  const start = quality === 'Movable' ? 0 : quality === 'Fixed' ? 4 : 8;
  return (start + part) % 12;
}

// D60 (Shashtiamsa): 60 parts of 0.5°; always starts from same sign
function getD60Sign(longitude) {
  const rashi = Math.floor(longitude / 30);
  const degInSign = longitude % 30;
  const part = Math.floor(degInSign / 0.5);
  return (rashi + part) % 12;
}

// Master function to get varga sign for any divisor
function getVargaSign(longitude, vargaDivisor) {
  switch (vargaDivisor) {
    case 2:  return getD2Sign(longitude);
    case 3:  return getD3Sign(longitude);
    case 4:  return getD4Sign(longitude);
    case 7:  return getD7Sign(longitude);
    case 9:  return getD9Sign(longitude);
    case 10: return getD10Sign(longitude);
    case 12: return getD12Sign(longitude);
    case 16: return getD16Sign(longitude);
    case 20: return getD20Sign(longitude);
    case 24: return getD24Sign(longitude);
    case 27: return getD27Sign(longitude);
    case 30: return getD30Sign(longitude);
    case 40: return getD40Sign(longitude);
    case 45: return getD45Sign(longitude);
    case 60: return getD60Sign(longitude);
    default: return Math.floor(longitude / 30) % 12;
  }
}

// Build a complete varga chart data object that can be fed to existing renderers
function calculateVargaChart(natalChart, vargaDivisor) {
  const vargaChart = {
    ascendant: 0,
    ascRashi: null,
    planets: {},
    vargaDivisor: vargaDivisor,
    isVargaChart: true,
    yogas: []
  };

  // Ascendant in varga
  const ascVargaSign = getVargaSign(natalChart.ascendant, vargaDivisor);
  const ascVargaLon = ascVargaSign * 30 + (natalChart.ascendant % 30);
  vargaChart.ascendant = normalize(ascVargaLon);
  vargaChart.ascRashi = getRashi(vargaChart.ascendant);

  // Planets in varga
  for (const pName in natalChart.planets) {
    const natPl = natalChart.planets[pName];
    const vargaSignIdx = getVargaSign(natPl.longitude, vargaDivisor);
    const vargaLon = vargaSignIdx * 30 + (natPl.longitude % 30);

    vargaChart.planets[pName] = {
      longitude: normalize(vargaLon),
      rashi: getRashi(normalize(vargaLon)),
      nakshatra: getNakshatra(normalize(vargaLon)),
      house: getHouse(normalize(vargaLon), vargaChart.ascendant),
      natalRashiIndex: natPl.rashi.index
    };
  }

  vargaChart.yogas = detectYogas(vargaChart);
  return vargaChart;
}

// ============================================================
//  VARSH PHAL (SOLAR RETURN) CALCULATIONS
// ============================================================

// Find exact JD when Sun returns to natal longitude (Newton-Raphson)
function findSolarReturnJD(natalSunSidereal, targetYear, birthMonth, birthDay) {
  // Start with approximate birthday in target year
  let jd = julianDay(targetYear, birthMonth, birthDay, 12);
  const aya0 = lahiriAyanamsa(jd);

  // Target tropical longitude = natal sidereal + ayanamsa
  // We search for when sunLongitude(T) - lahiriAyanamsa(jd) ≈ natalSunSidereal
  for (let iter = 0; iter < 20; iter++) {
    const T = centuriesFromJ2000(jd);
    const tropSun = sunLongitude(T);
    const aya = lahiriAyanamsa(jd);
    const sidSun = normalize(tropSun - aya);

    let diff = natalSunSidereal - sidSun;
    // Handle wrap-around at 0/360
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;

    if (Math.abs(diff) < 0.0001) break; // ~0.36 arcsec precision

    // Sun moves ~0.9856°/day in longitude
    jd += diff / 0.9856;
  }
  return jd;
}

function calculateSolarReturnChart(natalChart, year) {
  const [birthYear, birthMonth, birthDay] = natalChart.birthInfo.dob.split('-').map(Number);
  const natalSunLon = natalChart.planets.Sun.longitude;

  const srJD = findSolarReturnJD(natalSunLon, year, birthMonth, birthDay);
  const srPlanets = calculatePlanets(srJD);
  const srAscendant = calculateAscendant(srJD, natalChart.birthInfo.lat, natalChart.birthInfo.lon);
  const aya = lahiriAyanamsa(srJD);

  const srChart = {
    jd: srJD,
    ascendant: srAscendant,
    ascRashi: getRashi(srAscendant),
    planets: {},
    isSolarReturn: true,
    yogas: []
  };

  for (const p in srPlanets) {
    if (p === '_debug') continue;
    const pLon = srPlanets[p];
    srChart.planets[p] = {
      longitude: pLon,
      rashi: getRashi(pLon),
      nakshatra: getNakshatra(pLon),
      house: getHouse(pLon, srAscendant)
    };
  }

  srChart.yogas = detectYogas(srChart);

  // Varsh Phal specific data
  const age = year - birthYear;
  const munthSignIndex = (natalChart.ascRashi.index + age) % 12;
  const munthLon = munthSignIndex * 30;
  const munthHouse = getHouse(munthLon, srAscendant);

  // Year Lord = planet ruling the day of week of solar return
  const dayOfWeek = Math.floor(srJD + 1.5) % 7; // 0=Sun,1=Mon,...6=Sat
  const dayLords = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];
  const yearLord = dayLords[dayOfWeek];

  // Solar return date
  const srDateObj = jdToDate(srJD);

  srChart.varshInfo = {
    year: year,
    age: age,
    solarReturnDate: srDateObj,
    solarReturnJD: srJD,
    muntha: { signIndex: munthSignIndex, sign: RASHIS[munthSignIndex], house: munthHouse },
    yearLord: yearLord,
    dayOfWeek: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][dayOfWeek]
  };

  // Tajaka Yogas
  srChart.tajakaYogas = detectTajakaYogas(srChart, natalChart);

  return srChart;
}

// Convert Julian Day to Date object
function jdToDate(jd) {
  const z = Math.floor(jd + 0.5);
  const f = jd + 0.5 - z;
  let a = z;
  if (z >= 2299161) {
    const alpha = Math.floor((z - 1867216.25) / 36524.25);
    a = z + 1 + alpha - Math.floor(alpha / 4);
  }
  const b = a + 1524;
  const c = Math.floor((b - 122.1) / 365.25);
  const d = Math.floor(365.25 * c);
  const e = Math.floor((b - d) / 30.6001);
  const day = b - d - Math.floor(30.6001 * e);
  const month = e < 14 ? e - 1 : e - 13;
  const year = month > 2 ? c - 4716 : c - 4715;
  const hours = f * 24;
  const h = Math.floor(hours);
  const m = Math.floor((hours - h) * 60);
  return new Date(year, month - 1, day, h, m);
}

// Detect Tajaka Yogas in annual chart
function detectTajakaYogas(annualChart, natalChart) {
  const yogas = [];
  const yearLord = annualChart.varshInfo.yearLord;
  const ylPl = annualChart.planets[yearLord];
  const muntha = annualChart.varshInfo.muntha;

  // 1. Ishkbal Yoga: Year lord strong (in kendra or trikona)
  if (ylPl && [1,4,7,10,5,9].includes(ylPl.house)) {
    yogas.push({name:'Ishkbal Yoga',desc:`The Year Lord ${yearLord} is well-placed in the ${ordinal(ylPl.house)} house of the annual chart. This indicates a year of strength, authority, and favorable outcomes in endeavors.`});
  }

  // 2. Muntha in kendra or trikona
  if ([1,4,7,10,5,9].includes(muntha.house)) {
    yogas.push({name:'Muntha in Auspicious House',desc:`Muntha is placed in the ${ordinal(muntha.house)} house (${muntha.sign.eng}). When Muntha occupies a kendra or trikona, it promises general prosperity, good health, and success during the year.`});
  }

  // 3. Jupiter in kendra — Gaja Kesari in annual chart
  const jupH = annualChart.planets.Jupiter ? annualChart.planets.Jupiter.house : 0;
  if ([1,4,7,10].includes(jupH)) {
    yogas.push({name:'Jupiter in Kendra',desc:`Jupiter occupies the ${ordinal(jupH)} house in the annual chart. Jupiter in a kendra brings wisdom, divine grace, and expansion in the areas signified by this house.`});
  }

  // 4. Malefic year lord or muntha affliction
  const malefics = ['Saturn','Mars','Rahu','Ketu'];
  if (malefics.includes(yearLord) && ylPl && [6,8,12].includes(ylPl.house)) {
    yogas.push({name:'Year Lord Afflicted',desc:`The Year Lord ${yearLord} is a natural malefic placed in the ${ordinal(ylPl.house)} house (a dusthana). This may bring challenges and obstacles that require patience and perseverance.`});
  }

  // 5. Ithasala Yoga: Faster planet applying to slower planet
  const sunH = annualChart.planets.Sun ? annualChart.planets.Sun.house : 0;
  const moonH = annualChart.planets.Moon ? annualChart.planets.Moon.house : 0;
  if (sunH === moonH) {
    yogas.push({name:'Luminaries Conjunct',desc:'Sun and Moon are in the same house in the annual chart, concentrating life force and emotional energy in the same area of life. This brings intense focus and significant developments.'});
  }

  // 6. Benefics in kendra
  const benefics = ['Jupiter','Venus','Mercury'];
  const beneficsInKendra = benefics.filter(p => annualChart.planets[p] && [1,4,7,10].includes(annualChart.planets[p].house));
  if (beneficsInKendra.length >= 2) {
    yogas.push({name:'Benefics Fortify Kendras',desc:`${beneficsInKendra.join(' and ')} occupy kendra houses in the solar return chart. Multiple benefics in angular houses indicate a fortunate year with support, growth, and opportunities.`});
  }

  // 7. Muntha lord strong
  const munthLord = muntha.sign.lord;
  const mlPl = annualChart.planets[munthLord];
  if (mlPl && [1,4,5,7,9,10].includes(mlPl.house)) {
    yogas.push({name:'Strong Muntha Lord',desc:`The Muntha lord ${munthLord} is well-placed in the ${ordinal(mlPl.house)} house. A strong Muntha lord ensures the year\'s overall direction is positive and promising.`});
  }

  return yogas;
}

function calculateFullChart(dob, tob, lat, lon, tz) {
  const [year, month, day] = dob.split('-').map(Number);
  const [hours, minutes] = tob.split(':').map(Number);
  const localDecimalHour = hours + minutes / 60;
  const utcHour = localDecimalHour - tz;
  const jd = julianDay(year, month, day, utcHour);

  const planets = calculatePlanets(jd);
  const ascendant = calculateAscendant(jd, lat, lon);

  const chartData = { jd, ascendant, planets: {}, ascRashi: getRashi(ascendant) };

  // Planet details (skip _debug key)
  for (const p in planets) {
    if (p === '_debug') continue;
    const pLon = planets[p];
    const rashi = getRashi(pLon);
    const nak = getNakshatra(pLon);
    const house = getHouse(pLon, ascendant);
    chartData.planets[p] = { longitude: pLon, rashi, nakshatra: nak, house };
  }

  // Store full debug / calculation log
  const aya = lahiriAyanamsa(jd);
  chartData.debug = {
    inputLat: lat, inputLon: lon, inputTz: tz,
    localTime: `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`,
    utcHour: utcHour.toFixed(4),
    julianDay: jd.toFixed(5),
    ayanamsa: aya.toFixed(4),
    gst: greenwichSiderealTime(jd).toFixed(4),
    lst: normalize(greenwichSiderealTime(jd) + lon).toFixed(4),
    tropical: planets._debug ? planets._debug.tropical : {},
  };

  // Dasha calculation
  chartData.dashas = calculateVimshottariDasha(planets.Moon, year, month, day, hours, minutes);

  // Yogas
  chartData.yogas = detectYogas(chartData);

  return chartData;
}

// ============================================================
//  VIMSHOTTARI DASHA
// ============================================================

function calculateVimshottariDasha(moonLong, year, month, day, hours, minutes) {
  const nak = getNakshatra(moonLong);
  const nakLord = nak.lord;
  const nakSpan = 360 / 27;
  const posInNak = nak.degInNak;
  const fractionPassed = posInNak / nakSpan;

  // Find starting dasha lord (= nakshatra lord)
  let startIdx = DASHA_ORDER.indexOf(nakLord);
  const totalYears = DASHA_YEARS[nakLord];
  const remainingYears = totalYears * (1 - fractionPassed);

  // Build dasha sequence
  const birthDate = new Date(year, month - 1, day, hours, minutes);
  const dashas = [];
  let currentDate = new Date(birthDate);

  // First (partial) dasha
  let endDate = addYears(currentDate, remainingYears);
  dashas.push({
    lord: nakLord,
    startDate: new Date(currentDate),
    endDate: new Date(endDate),
    years: remainingYears
  });
  currentDate = new Date(endDate);

  // Subsequent full dashas (cover 120 years total)
  for (let i = 1; i <= 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const yrs = DASHA_YEARS[lord];
    endDate = addYears(currentDate, yrs);
    dashas.push({
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: yrs
    });
    currentDate = new Date(endDate);
  }

  // Calculate antardashas for each mahadasha
  dashas.forEach(md => {
    md.antardashas = calculateAntardashas(md);
  });

  return dashas;
}

function calculateAntardashas(mahadasha) {
  const mdLord = mahadasha.lord;
  const mdYears = mahadasha.years;
  const mdStart = new Date(mahadasha.startDate);
  const startIdx = DASHA_ORDER.indexOf(mdLord);
  const antars = [];
  let currentDate = new Date(mdStart);

  for (let i = 0; i < 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const proportion = DASHA_YEARS[lord] / 120;
    const adYears = mdYears * proportion;
    const endDate = addYears(currentDate, adYears);
    const ad = {
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: adYears
    };
    // Pratyantardashas
    ad.pratyantardashas = calculatePratyantardashas(ad);
    antars.push(ad);
    currentDate = new Date(endDate);
  }
  return antars;
}

function calculatePratyantardashas(antardasha) {
  const adLord = antardasha.lord;
  const adYears = antardasha.years;
  const startIdx = DASHA_ORDER.indexOf(adLord);
  const pads = [];
  let currentDate = new Date(antardasha.startDate);

  for (let i = 0; i < 9; i++) {
    const idx = (startIdx + i) % 9;
    const lord = DASHA_ORDER[idx];
    const proportion = DASHA_YEARS[lord] / 120;
    const padYears = adYears * proportion;
    const endDate = addYears(currentDate, padYears);
    pads.push({
      lord,
      startDate: new Date(currentDate),
      endDate: new Date(endDate),
      years: padYears
    });
    currentDate = new Date(endDate);
  }
  return pads;
}

function addYears(date, years) {
  const ms = years * 365.25 * 24 * 60 * 60 * 1000;
  return new Date(date.getTime() + ms);
}

// ============================================================
//  YOGA DETECTION (Simplified)
// ============================================================

function detectYogas(chart) {
  const yogas = [];
  const planets = chart.planets;
  const ascHouse = 1;

  // Gajakesari Yoga: Jupiter in kendra from Moon
  const moonH = planets.Moon.house;
  const jupH = planets.Jupiter.house;
  const diffMJ = ((jupH - moonH + 12) % 12);
  if ([0, 3, 6, 9].includes(diffMJ)) {
    yogas.push({ name: "Gajakesari Yoga", desc: "Jupiter is in a kendra (quadrant) from Moon. This yoga bestows wisdom, wealth, lasting fame, and strong character. The native is blessed with intelligence and good fortune." });
  }

  // Budhaditya Yoga: Sun and Mercury in same sign
  if (planets.Sun.rashi.index === planets.Mercury.rashi.index) {
    yogas.push({ name: "Budhaditya Yoga", desc: "Sun and Mercury are conjoined in the same sign. This bestows sharp intellect, eloquent speech, and success in education and communication fields. The native is skilled in arts and sciences." });
  }

  // Chandra-Mangal Yoga: Moon and Mars in same sign
  if (planets.Moon.rashi.index === planets.Mars.rashi.index) {
    yogas.push({ name: "Chandra-Mangal Yoga", desc: "Moon and Mars are conjoined. This brings wealth through enterprise, courage in emotional matters, and success in business. The native has a dynamic and prosperous disposition." });
  }

  // Hamsa Yoga: Jupiter in kendra in own/exaltation sign
  if ([1, 4, 7, 10].includes(jupH)) {
    const jupSign = planets.Jupiter.rashi.index;
    if (jupSign === 8 || jupSign === 11 || jupSign === 3) { // Sagittarius, Pisces, Cancer
      yogas.push({ name: "Hamsa Yoga", desc: "Jupiter occupies a kendra in its own or exaltation sign. This is one of the Pancha Mahapurusha Yogas, granting wisdom, righteousness, and a noble, respected life." });
    }
  }

  // Malavya Yoga: Venus in kendra in own/exaltation sign
  const venH = planets.Venus.house;
  if ([1, 4, 7, 10].includes(venH)) {
    const venSign = planets.Venus.rashi.index;
    if (venSign === 1 || venSign === 6 || venSign === 11) { // Taurus, Libra, Pisces
      yogas.push({ name: "Malavya Yoga", desc: "Venus occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga bestowing beauty, artistic talents, luxurious life, and happy marriage." });
    }
  }

  // Ruchaka Yoga: Mars in kendra in own/exaltation sign
  const marsH = planets.Mars.house;
  if ([1, 4, 7, 10].includes(marsH)) {
    const marsSign = planets.Mars.rashi.index;
    if (marsSign === 0 || marsSign === 7 || marsSign === 9) { // Aries, Scorpio, Capricorn
      yogas.push({ name: "Ruchaka Yoga", desc: "Mars occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga granting courage, commanding personality, leadership abilities, and physical strength." });
    }
  }

  // Shasha Yoga: Saturn in kendra in own/exaltation sign
  const satH = planets.Saturn.house;
  if ([1, 4, 7, 10].includes(satH)) {
    const satSign = planets.Saturn.rashi.index;
    if (satSign === 9 || satSign === 10 || satSign === 6) { // Capricorn, Aquarius, Libra
      yogas.push({ name: "Shasha Yoga", desc: "Saturn occupies a kendra in its own or exaltation sign. A Pancha Mahapurusha Yoga granting authority, discipline, power over others, and a long, structured life." });
    }
  }

  // Kemadruma Yoga: No planets adjacent to Moon's sign
  const moonSign = planets.Moon.rashi.index;
  const adjSigns = [(moonSign + 1) % 12, (moonSign + 11) % 12];
  let hasAdj = false;
  for (const p of ["Sun","Mars","Mercury","Jupiter","Venus","Saturn"]) {
    if (adjSigns.includes(planets[p].rashi.index)) { hasAdj = true; break; }
  }
  if (!hasAdj) {
    yogas.push({ name: "Kemadruma Yoga", desc: "No planets occupy the signs adjacent to Moon. This can indicate periods of loneliness or financial fluctuation, but is often cancelled by other factors. Remedies for Moon can help mitigate effects." });
  }

  // Raja Yoga: Lord of trikona and kendra conjunct
  // Simplified check: if 9th lord and 10th lord are in same sign
  const ninthSign = (chart.ascRashi.index + 8) % 12;
  const tenthSign = (chart.ascRashi.index + 9) % 12;
  const ninthLord = RASHIS[ninthSign].lord;
  const tenthLord = RASHIS[tenthSign].lord;
  if (ninthLord !== tenthLord && planets[ninthLord] && planets[tenthLord]) {
    if (planets[ninthLord].rashi.index === planets[tenthLord].rashi.index) {
      yogas.push({ name: "Raja Yoga", desc: "The lords of the 9th and 10th houses are conjoined, forming a powerful Raja Yoga. This combination brings fortune through career, authority, fame, and success in professional endeavors." });
    }
  }

  if (yogas.length === 0) {
    yogas.push({ name: "Chart Analysis", desc: "Your chart shows a unique combination of planetary positions. The specific house placements and aspects create a personalized pattern of strengths and growth areas. Consult the Dasha predictions for detailed life period analysis." });
  }

  return yogas;
}

// ============================================================
//  MASTER VEDIC ASTROLOGY PREDICTION ENGINE
// ============================================================

const SIGN_LORDS = ['Mars','Venus','Mercury','Moon','Sun','Mercury','Venus','Mars','Jupiter','Saturn','Saturn','Jupiter'];
const HOUSE_AREAS = {
  1:{area:'self, personality, health, vitality, appearance',short:'Self',life:'personal identity and physical well-being'},
  2:{area:'wealth, family, speech, food, values',short:'Wealth',life:'financial security and family life'},
  3:{area:'courage, siblings, communication, short journeys, skills',short:'Courage',life:'initiative, communication, and sibling bonds'},
  4:{area:'home, mother, vehicles, property, emotional happiness',short:'Home',life:'domestic peace, property, and inner contentment'},
  5:{area:'children, education, creativity, romance, past-life merit (purva punya)',short:'Children',life:'creative expression, children, and intellect'},
  6:{area:'enemies, debts, disease, service, competition, daily work',short:'Service',life:'overcoming obstacles, health discipline, and service'},
  7:{area:'marriage, partnerships, business, public dealings, foreign travel',short:'Marriage',life:'relationships, partnerships, and public image'},
  8:{area:'longevity, sudden events, occult, inheritance, transformation',short:'Transformation',life:'deep transformation, hidden knowledge, and longevity'},
  9:{area:'fortune, dharma, guru, father, higher education, long journeys',short:'Fortune',life:'luck, spiritual wisdom, higher learning, and dharmic path'},
  10:{area:'career, status, authority, karma, public reputation',short:'Career',life:'professional achievement, authority, and life purpose'},
  11:{area:'gains, income, friends, elder siblings, aspirations, large networks',short:'Gains',life:'fulfillment of desires, gains, and social networks'},
  12:{area:'losses, foreign lands, liberation, expenses, isolation, moksha',short:'Liberation',life:'spiritual liberation, foreign connections, and letting go'}
};

// Natural planet significations
const PLANET_KARAKAS = {
  Sun:'soul, father, authority, government, confidence, vitality, leadership',
  Moon:'mind, mother, emotions, nurturing, public, comfort, intuition',
  Mars:'courage, energy, brothers, property, surgery, engineering, athletics',
  Mercury:'intellect, speech, commerce, writing, education, analytical ability',
  Jupiter:'wisdom, children, guru, wealth, dharma, expansion, spirituality',
  Venus:'love, beauty, luxury, vehicles, arts, marriage, material comforts',
  Saturn:'discipline, karma, longevity, service, delays, hard work, detachment',
  Rahu:'foreign things, technology, unconventional paths, obsession, illusion, material ambition',
  Ketu:'spirituality, liberation, past-life karma, detachment, mysticism, healing'
};

// Exaltation/Debilitation/Own/Moolatrikona sign indices
const DIGNITY_DATA = {
  Sun:{exalt:0,debil:6,own:[4],moola:4},
  Moon:{exalt:1,debil:7,own:[3],moola:1},
  Mars:{exalt:9,debil:3,own:[0,7],moola:0},
  Mercury:{exalt:5,debil:11,own:[2,5],moola:5},
  Jupiter:{exalt:3,debil:9,own:[8,11],moola:8},
  Venus:{exalt:11,debil:5,own:[1,6],moola:6},
  Saturn:{exalt:6,debil:0,own:[9,10],moola:10}
};

// Functional benefic/malefic classification by lagna sign index
function classifyPlanets(ascIdx) {
  // Returns {yogakaraka, benefics, malefics, neutrals} for the given lagna
  const lords = {};
  for (let h = 1; h <= 12; h++) {
    const sIdx = (ascIdx + h - 1) % 12;
    const lord = SIGN_LORDS[sIdx];
    if (!lords[lord]) lords[lord] = [];
    lords[lord].push(h);
  }

  const benefics = [], malefics = [], neutrals = [];
  let yogakaraka = null;

  for (const [planet, houses] of Object.entries(lords)) {
    const hasKendra = houses.some(h => [1,4,7,10].includes(h));
    const hasTrikona = houses.some(h => [1,5,9].includes(h));
    const hasDusthana = houses.some(h => [6,8,12].includes(h));
    const hasMaraka = houses.some(h => [2,7].includes(h));

    if (hasKendra && hasTrikona) { yogakaraka = planet; benefics.push(planet); }
    else if (hasTrikona) benefics.push(planet);
    else if (hasKendra && !hasDusthana) neutrals.push(planet);
    else if (hasDusthana) malefics.push(planet);
    else if (hasMaraka) neutrals.push(planet);
    else neutrals.push(planet);
  }

  return { yogakaraka, benefics, malefics, neutrals, lords };
}

// Get houses ruled by a planet from a given lagna
function getLordships(planet, ascIdx) {
  const houses = [];
  for (let h = 1; h <= 12; h++) {
    const sIdx = (ascIdx + h - 1) % 12;
    if (SIGN_LORDS[sIdx] === planet) houses.push(h);
  }
  return houses;
}

// Get dignity status of a planet
function getDignity(planet, signIdx) {
  const d = DIGNITY_DATA[planet];
  if (!d) return 'neutral';
  if (signIdx === d.exalt) return 'exalted';
  if (signIdx === d.debil) return 'debilitated';
  if (d.own.includes(signIdx)) return 'own-sign';
  if (signIdx === d.moola) return 'moolatrikona';
  // Check friendly/enemy dispositions
  return 'neutral';
}

// Find planets in the same house
function getConjunctions(planet, chart) {
  const h = chart.planets[planet].house;
  return Object.keys(chart.planets).filter(p => p !== planet && p !== '_debug' && chart.planets[p].house === h);
}

// Get aspects received by a house
function getAspectsOnHouse(houseNum, chart) {
  const aspecting = [];
  const pNames = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  const specialAsp = { Mars:[4,8], Jupiter:[5,9], Saturn:[3,10], Rahu:[5,9], Ketu:[5,9] };

  pNames.forEach(p => {
    if (!chart.planets[p]) return;
    const pH = chart.planets[p].house;
    // 7th aspect
    if (((pH - 1 + 7 - 1) % 12) + 1 === houseNum) aspecting.push(p);
    // Special aspects
    if (specialAsp[p]) {
      specialAsp[p].forEach(a => {
        if (((pH - 1 + a - 1) % 12) + 1 === houseNum) {
          if (!aspecting.includes(p)) aspecting.push(p);
        }
      });
    }
  });
  return aspecting;
}

// ---- COMPREHENSIVE BIRTH CHART READING ----
function generateChartReading(chart) {
  const asc = chart.ascRashi.index;
  const cls = classifyPlanets(asc);
  const sections = [];

  // 1. PERSONALITY & LAGNA ANALYSIS
  const ascSign = RASHIS[asc];
  const lagnaLord = SIGN_LORDS[asc];
  const llData = chart.planets[lagnaLord];
  const llHouse = llData.house;
  const llDig = getDignity(lagnaLord, llData.rashi.index);
  const llConj = getConjunctions(lagnaLord, chart);
  const h1Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 1);

  let personality = `<b>Lagna: ${ascSign.name} (${ascSign.eng})</b> — `;
  const signTraits = {
    0:'You are a natural leader with pioneering spirit, courage, and directness. Independent and action-oriented.',
    1:'You possess stability, patience, and an appreciation for beauty and material comforts. Loyal and determined.',
    2:'You are intellectually curious, versatile, and communicative. Adaptable with a quick, analytical mind.',
    3:'You are emotionally sensitive, nurturing, and intuitive. Deeply connected to home and family.',
    4:'You carry natural charisma, confidence, and a regal bearing. Creative and generous, with leadership qualities.',
    5:'You are analytical, detail-oriented, and service-minded. Practical with a sharp intellect.',
    6:'You seek harmony, balance, and beauty in all things. Diplomatic and relationship-oriented.',
    7:'You possess deep intensity, transformative power, and strong willpower. Investigative and determined.',
    8:'You are optimistic, philosophical, and expansive in vision. A natural seeker of truth and wisdom.',
    9:'You are disciplined, ambitious, and practical. Patient with a strong sense of duty and structure.',
    10:'You are innovative, humanitarian, and independent-minded. A visionary thinker concerned with collective welfare.',
    11:'You are intuitive, compassionate, and spiritually inclined. Imaginative with deep empathy for others.'
  };
  personality += signTraits[asc] || '';

  personality += `<br><br><b>Lagna Lord ${lagnaLord}</b> is placed in the <b>${ordinal(llHouse)} house</b>`;
  if (llDig === 'exalted') personality += ' in <span style="color:var(--accent-green)">exaltation</span>';
  else if (llDig === 'debilitated') personality += ' in <span style="color:var(--accent-red)">debilitation</span>';
  else if (llDig === 'own-sign') personality += ' in its <span style="color:var(--accent-green)">own sign</span>';
  personality += '. ';

  const llHouseDesc = {
    1:'This gives strong self-confidence, good health, and a self-made quality. You define your own path.',
    2:'Focus on building wealth, maintaining family traditions, and developing eloquent speech.',
    3:'Courage, initiative, and communication skills define you. Strong bond with siblings. A doer.',
    4:'Deep attachment to home, mother, and motherland. Emotional security is paramount. Property gains likely.',
    5:'Creative intelligence, love for learning, and good fortune through children. Past-life merit supports you.',
    6:'You overcome enemies and obstacles through sheer perseverance. Service-oriented with strong competitive drive.',
    7:'Partnerships and relationships shape your identity significantly. Business acumen is strong.',
    8:'A transformative life journey with interest in occult/hidden knowledge. Resilient through upheavals.',
    9:'Naturally fortunate and dharmic. Strong connection to teachers, philosophy, and higher learning.',
    10:'Career-focused personality. Authority and public reputation are central to your identity. Ambitious.',
    11:'Gains come through personal effort. Strong social network. Aspirations are fulfilled over time.',
    12:'Spiritual inclination, possible foreign connections. Expenditure needs management. Inner world is rich.'
  };
  personality += llHouseDesc[llHouse] || '';

  if (llConj.length > 0) {
    personality += ` Lagna lord conjoins ${llConj.join(', ')}, creating a complex personality blend.`;
  }

  if (h1Planets.length > 0) {
    personality += `<br><br>Your 1st house hosts <b>${h1Planets.join(', ')}</b>, `;
    if (h1Planets.includes('Jupiter')) personality += 'giving you <span style="color:var(--saffron)">Jupiterian wisdom, optimism, and a naturally benevolent disposition</span>. ';
    if (h1Planets.includes('Venus')) personality += '<span style="color:#e91e8c">Venus here bestows attractiveness, artistic sensibility, and a love of comfort</span>. ';
    if (h1Planets.includes('Moon')) personality += '<span style="color:#bdc3c7">Moon in the ascendant makes you emotionally expressive, intuitive, and publicly visible</span>. ';
  }

  sections.push({title:'Personality & Self', icon:'\u2648', content:personality});

  // 2. WEALTH & CAREER
  const h2Lord = SIGN_LORDS[(asc+1)%12];
  const h10Lord = SIGN_LORDS[(asc+9)%12];
  const h11Lord = SIGN_LORDS[(asc+10)%12];
  const h2Data = chart.planets[h2Lord];
  const h10Data = chart.planets[h10Lord];

  let career = '<b>Career & Wealth Analysis:</b><br>';

  // 10th house analysis
  const h10Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 10);
  career += `Your 10th lord <b>${h10Lord}</b> is in the <b>${ordinal(h10Data.house)} house</b>. `;

  const careerByH10 = {
    1:'Career is deeply tied to your identity. Self-employment or leadership roles suit you best.',
    2:'Career brings wealth. Family business or finance-related work is indicated.',
    3:'Communication, writing, media, or skilled trades define your career. Entrepreneurial energy.',
    4:'Career connects to property, vehicles, home, education, or government. May work from home.',
    5:'Creative, speculative, educational, or entertainment career. Working with children possible.',
    6:'Service sector, healthcare, law, or competitive fields. Overcoming daily challenges professionally.',
    7:'Business partnerships, client-facing roles, consulting, or diplomacy define your work.',
    8:'Research, investigation, insurance, occult sciences, or transformative work. Hidden earnings.',
    9:'Teaching, law, religion, philosophy, publishing, or international career.',
    10:'Very strong career placement. Ambitious, authoritative, and publicly recognized.',
    11:'Gains through career are excellent. Large organizations, networks, and technology.',
    12:'Foreign career, hospitals, ashrams, charity, or behind-the-scenes work. Spiritual vocation possible.'
  };
  career += (careerByH10[h10Data.house] || '') + '<br><br>';

  if (h10Planets.length > 0) {
    career += `<b>${h10Planets.join(', ')}</b> in 10th house: `;
    if (h10Planets.includes('Rahu')) career += 'Rahu in the 10th gives <span style="color:var(--saffron)">powerful ambition, unconventional career path, rise in worldly status, and possible foreign career connections</span>. This is one of the strongest placements for Rahu — it drives relentless professional ambition. ';
    if (h10Planets.includes('Sun')) career += 'Sun in 10th gives authority, government connections, and leadership roles. ';
    if (h10Planets.includes('Saturn')) career += 'Saturn in 10th gives slow but lasting career success through discipline. ';
    if (h10Planets.includes('Jupiter')) career += 'Jupiter in 10th gives fortune in career, respected position, and ethical profession. ';
    if (h10Planets.includes('Mars')) career += 'Mars in 10th gives dynamic career, engineering, military, or technical fields. ';
  }

  // Wealth houses
  career += `<br><b>Wealth:</b> 2nd lord <b>${h2Lord}</b> in ${ordinal(h2Data.house)} house, 11th lord <b>${h11Lord}</b> in ${ordinal(chart.planets[h11Lord].house)} house. `;
  if (chart.planets[h11Lord].house === 1) career += 'The 11th lord in 1st house is excellent — gains come to you naturally through personal effort and reputation. ';
  if (chart.planets[h2Lord].house === 1) career += 'The 2nd lord in 1st house indicates self-earned wealth and good financial sense. ';

  sections.push({title:'Career & Wealth', icon:'\u2617', content:career});

  // 3. RELATIONSHIPS & MARRIAGE
  const h7Lord = SIGN_LORDS[(asc+6)%12];
  const h7Data = chart.planets[h7Lord];
  const venusData = chart.planets.Venus;
  const h7Planets = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === 7);

  let marriage = '<b>Marriage & Relationships:</b><br>';
  marriage += `7th lord <b>${h7Lord}</b> is in the <b>${ordinal(h7Data.house)} house</b>`;
  const h7Dig = getDignity(h7Lord, h7Data.rashi.index);
  if (h7Dig === 'exalted') marriage += ' in <span style="color:var(--accent-green)">exaltation</span>';
  marriage += '. ';

  const marriageBy7L = {
    1:'Spouse is devoted and connected to your identity. Marriage is defining experience.',
    2:'Spouse contributes to family wealth. Material stability through marriage.',
    3:'Spouse is communicative, possibly artistic. Marriage requires mutual intellectual engagement.',
    4:'Spouse brings domestic happiness. Good home life and emotional support.',
    5:'Romantic, loving partnership. Children strengthen the marriage bond.',
    6:'Some challenges in marriage possible — communication and patience are key remedies.',
    7:'Strong marriage potential. Spouse is independent and influential.',
    8:'Deep, transformative relationship. Trust and loyalty are paramount. Inheritance possible through spouse.',
    9:'Fortunate marriage. Spouse may be from different cultural/philosophical background.',
    10:'Marriage enhances career and public standing. Spouse is ambitious and supportive.',
    11:'Marriage brings gains and social expansion. Friendship is the foundation of the relationship.',
    12:'Spouse may have foreign connections. Private, deeply spiritual bond. Expenses related to marriage.'
  };
  marriage += (marriageBy7L[h7Data.house] || '') + '<br><br>';

  marriage += `<b>Venus</b> (natural karaka of marriage) is in the <b>${ordinal(venusData.house)} house</b> in <b>${venusData.rashi.name}</b>. `;
  if (venusData.house === 1) marriage += 'Venus in the ascendant blesses with charm, attractiveness, and a love of beauty. Spouse is likely beautiful and culturally refined. ';
  else if (venusData.house === 7) marriage += 'Venus in the 7th is ideal for a happy, harmonious marriage. ';

  const venConj = getConjunctions('Venus', chart);
  if (venConj.includes('Jupiter')) marriage += 'Venus-Jupiter conjunction brings a dharmic, generous, and fortunate marriage. ';
  if (venConj.includes('Moon')) marriage += 'Venus-Moon conjunction gives emotional richness and romantic sensibility in relationships. ';
  if (venConj.includes('Saturn')) marriage += 'Venus-Saturn aspect/conjunction may cause some delays in marriage but bestows loyalty and stability once committed. ';

  // Manglik check
  const marsH = chart.planets.Mars.house;
  if ([1,2,4,7,8,12].includes(marsH)) {
    marriage += `<br><span style="color:var(--accent-red)"><b>Manglik Consideration:</b> Mars in the ${ordinal(marsH)} house creates Mangal Dosha. This is mitigated if Mars is in its own sign, if Saturn aspects Mars, or if the spouse also has Mangal Dosha. Performing Mangal Shanti puja and wearing Red Coral can help.</span>`;
  }

  sections.push({title:'Marriage & Relationships', icon:'\u2665', content:marriage});

  // 4. HEALTH
  let health = '<b>Health Analysis:</b><br>';
  const h6Lord = SIGN_LORDS[(asc+5)%12];
  const h8Lord = SIGN_LORDS[(asc+7)%12];

  health += `6th lord <b>${h6Lord}</b> in ${ordinal(chart.planets[h6Lord].house)} house, 8th lord <b>${h8Lord}</b> in ${ordinal(chart.planets[h8Lord].house)} house. `;

  if (chart.planets[h6Lord].house === 1) health += 'The 6th lord in the 1st house requires attention to health throughout life. Immune system may need strengthening. However, you possess the ability to overcome diseases through willpower. ';

  // Body constitution based on lagna element
  const elem = RASHIS[asc].element;
  if (elem === 'Air') health += '<br>Your airy constitution (Vata) suggests attention to nervous system, joints, and circulation. Regular routine and warm foods balance this. ';
  else if (elem === 'Fire') health += '<br>Your fiery constitution (Pitta) suggests attention to digestion, inflammation, and heat-related conditions. Cooling practices help. ';
  else if (elem === 'Earth') health += '<br>Your earthy constitution (Kapha) suggests attention to weight, congestion, and lethargy. Active lifestyle and light diet balance this. ';
  else if (elem === 'Water') health += '<br>Your watery constitution suggests attention to emotional health, fluid balance, and respiratory system. ';

  // Specific planetary indicators
  if (chart.planets.Saturn.house === 1 || getAspectsOnHouse(1, chart).includes('Saturn')) {
    health += 'Saturn\'s influence on the ascendant indicates a lean build, longevity, but possibly slow metabolism. Joint and bone health need attention in later years. ';
  }
  if (chart.planets.Mars.house === 1 || getAspectsOnHouse(1, chart).includes('Mars')) {
    health += 'Mars\'s influence gives strong physical stamina and muscular build but watch for inflammation, accidents, and blood-related issues. ';
  }

  sections.push({title:'Health & Vitality', icon:'\u2695', content:health});

  // 5. SPIRITUALITY & DHARMA
  const h9Lord = SIGN_LORDS[(asc+8)%12];
  const h12Lord = SIGN_LORDS[(asc+11)%12];
  const jupData = chart.planets.Jupiter;
  const ketuData = chart.planets.Ketu;

  let spirit = '<b>Spiritual & Dharmic Path:</b><br>';
  spirit += `9th lord (dharma) <b>${h9Lord}</b> in ${ordinal(chart.planets[h9Lord].house)} house, 12th lord (moksha) <b>${h12Lord}</b> in ${ordinal(chart.planets[h12Lord].house)} house. `;

  if (chart.planets[h9Lord].house === 1) spirit += '<span style="color:var(--saffron)">The 9th lord in 1st house is a powerful blessing — you carry dharmic fortune in your very being. Naturally righteous and fortunate.</span> ';
  spirit += `<br><br>Jupiter (Guru) in ${ordinal(jupData.house)} house indicates `;
  if (jupData.house === 1) spirit += 'a naturally wise, philosophical, and spiritually inclined personality. Teachers and wisdom traditions play a vital role in your life. ';
  else if (jupData.house === 9) spirit += 'the most fortunate placement for spiritual growth and guru connections. ';
  else if (jupData.house === 5) spirit += 'strong devotional nature and past-life spiritual merit. ';

  spirit += `<br>Ketu in ${ordinal(ketuData.house)} house suggests `;
  if (ketuData.house === 4) spirit += 'spiritual detachment from material comforts and domestic attachment. Past-life spiritual practices create a naturally renunciate quality. Deep meditation ability. ';
  else if (ketuData.house === 12) spirit += 'strong moksha potential and natural inclination toward liberation. ';
  else if (ketuData.house === 9) spirit += 'past-life guru connections and deep philosophical insights. ';

  sections.push({title:'Spirituality & Dharma', icon:'\u0950', content:spirit});

  // 6. YOGAS (already computed, but provide deeper analysis)
  let yogaText = '<b>Significant Yogas in Your Chart:</b><br><br>';
  chart.yogas.forEach(y => {
    yogaText += `<span style="color:var(--saffron)"><b>${y.name}</b></span>: ${y.desc}<br><br>`;
  });

  // Add yogakaraka analysis
  if (cls.yogakaraka) {
    yogaText += `<span style="color:var(--saffron)"><b>Yogakaraka Planet: ${cls.yogakaraka}</b></span> — `;
    yogaText += `As the lord of both a kendra and a trikona, ${cls.yogakaraka} is the single most beneficial planet for your ${RASHIS[asc].name} lagna. `;
    yogaText += `Its dasha periods, transits, and gemstone (${PLANETS_INFO[cls.yogakaraka].gem}) are especially favorable. `;
    const ykH = chart.planets[cls.yogakaraka].house;
    yogaText += `Placed in your ${ordinal(ykH)} house, it activates themes of ${HOUSE_AREAS[ykH].area}.<br><br>`;
  }

  sections.push({title:'Yogas & Special Combinations', icon:'\u2726', content:yogaText});

  return sections;
}

// ---- CHART-SPECIFIC MAHADASHA PREDICTIONS ----
function generateDashaPrediction(chart, lord) {
  const asc = chart.ascRashi.index;
  const houses = getLordships(lord, asc);
  const cls = classifyPlanets(asc);
  const p = chart.planets[lord];
  const dig = p ? getDignity(lord, p.rashi.index) : 'neutral';
  const conj = p ? getConjunctions(lord, chart) : [];
  const hAreas = houses.map(h => HOUSE_AREAS[h].short).join(' & ');
  const hFull = houses.map(h => `${ordinal(h)} (${HOUSE_AREAS[h].area})`).join(' and ');

  let pred = '';

  // Opener — lordship context
  if (houses.length > 0) {
    pred += `<b>${lord} rules your ${hFull} houses</b> and is placed in your <b>${ordinal(p.house)} house</b> (${HOUSE_AREAS[p.house].area}). `;
  } else {
    pred += `<b>${lord}</b> (shadow planet) occupies your <b>${ordinal(p.house)} house</b> (${HOUSE_AREAS[p.house].area}). `;
  }

  // Dignity effect
  if (dig === 'exalted') pred += `<span style="color:var(--accent-green)">Being exalted, ${lord} delivers its results with exceptional strength and positivity during this period.</span> `;
  else if (dig === 'debilitated') pred += `<span style="color:var(--accent-red)">${lord} is debilitated, meaning results may come with difficulty, delays, or after overcoming challenges. Remedies for ${lord} are strongly recommended.</span> `;
  else if (dig === 'own-sign') pred += `In its own sign, ${lord} delivers its results with confidence and natural authority. `;

  // Yogakaraka status
  if (cls.yogakaraka === lord) {
    pred += `<span style="color:var(--saffron)"><b>${lord} is your Yogakaraka — the most auspicious planet for your lagna.</b> This is one of the most favorable periods of your life.</span> `;
  }

  pred += '<br><br>';

  // House-specific predictions based on lordship
  houses.forEach(h => {
    pred += `<b>As ${ordinal(h)} lord:</b> `;
    const hl = HOUSE_AREAS[h];
    if (h === 1) pred += 'Focus on personal development, health improvement, and self-expression. Your identity transforms during this period. ';
    if (h === 2) pred += 'Family matters, accumulation of wealth, and speech/communication become prominent. Financial decisions carry long-term significance. ';
    if (h === 3) pred += 'Courage, initiative, and new skills develop. Sibling relationships are highlighted. Short travels and learning opportunities arise. ';
    if (h === 4) pred += 'Home, property, mother, vehicles, and emotional well-being are activated. Possible property acquisition or home changes. ';
    if (h === 5) pred += 'Children, education, creativity, and romance flourish. Speculative gains possible. Intelligence and creative expression peak. ';
    if (h === 6) pred += 'Health challenges may arise but are overcome. Competition in work, legal matters, and service-oriented activities become prominent. ';
    if (h === 7) pred += 'Marriage, partnerships, and business relationships dominate. For unmarried natives, marriage prospects arise. Public dealings increase. ';
    if (h === 8) pred += 'Transformation, sudden changes, research, and occult interests intensify. Inheritance or insurance matters surface. Watch health of close ones. ';
    if (h === 9) pred += 'Fortune, spiritual growth, long-distance travel, higher education, and connection with teachers/mentors are activated. A dharmic period. ';
    if (h === 10) pred += 'Career advancement, professional recognition, and public authority are highlighted. This is a period of achievement and responsibility. ';
    if (h === 11) pred += 'Income increases, desires are fulfilled, and social connections expand. Friends and elder siblings play important roles. ';
    if (h === 12) pred += 'Foreign travel or residence, spiritual practices, and increased expenditure are indicated. Letting go of attachments brings peace. ';
  });

  // Placement-specific effects
  pred += `<br><b>Placed in ${ordinal(p.house)} house:</b> The themes of ${HOUSE_AREAS[p.house].area} form the arena where ${hAreas} matters manifest. `;

  // Conjunction effects
  if (conj.length > 0) {
    pred += `<br><b>Conjunction with ${conj.join(', ')}:</b> `;
    conj.forEach(c => {
      const cHouses = getLordships(c, asc);
      if (cHouses.length) pred += `${c} (lord of ${cHouses.map(h => ordinal(h)).join(', ')}) brings ${HOUSE_AREAS[cHouses[0]].short.toLowerCase()} themes into this dasha. `;
    });
  }

  // Natural signification
  pred += `<br><br><b>Key themes:</b> ${PLANET_KARAKAS[lord]}. `;

  return pred;
}

// ---- ANTARDASHA PREDICTIONS ----
function generateAntarPrediction(chart, mdLord, adLord) {
  const asc = chart.ascRashi.index;
  const mdHouses = getLordships(mdLord, asc);
  const adHouses = getLordships(adLord, asc);
  const adP = chart.planets[adLord];
  const mdP = chart.planets[mdLord];

  let pred = '';
  const adHArea = adHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' and ');
  const mdHArea = mdHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' and ');

  if (mdLord === adLord) {
    pred += `${mdLord}'s own sub-period intensifies its Mahadasha effects. The themes of ${mdHArea || mdLord + '\'s significations'} are at their peak. A defining sub-period within this Mahadasha. `;
  } else {
    pred += `${adLord} activates themes of ${adHArea || adLord + '\'s significations'} within the broader ${mdLord} Mahadasha context of ${mdHArea || mdLord + '\'s significations'}. `;
  }

  // Check mutual relationship
  if (adP && mdP && adP.house === mdP.house) {
    pred += `${mdLord} and ${adLord} are conjoined in the natal chart — this sub-period is especially potent and can bring significant events. `;
  }

  // Dignity of AD lord
  const dig = adP ? getDignity(adLord, adP.rashi.index) : '';
  if (dig === 'exalted') pred += `${adLord} is exalted — expect positive outcomes. `;
  if (dig === 'debilitated') pred += `${adLord} is debilitated — challenges may arise, requiring patience and remedies. `;

  // House placement meaning
  if (adP) {
    pred += `${adLord} in the ${ordinal(adP.house)} house brings focus to ${HOUSE_AREAS[adP.house].life}. `;
  }

  return pred;
}

// ---- ENHANCED TRANSIT READING ----
function generateTransitReading(chart, transitPlanets) {
  const asc = chart.ascRashi.index;
  const moonSign = chart.planets.Moon.rashi.index;
  const readings = [];

  // Sade Sati check (Saturn transiting 12th, 1st, or 2nd from natal Moon)
  const satTransitSign = Math.floor(transitPlanets.Saturn / 30) % 12;
  const satFromMoon = ((satTransitSign - moonSign + 12) % 12);
  let sadeSati = null;
  if (satFromMoon === 11) sadeSati = {phase:'Rising (1st phase)',desc:'Saturn transiting the 12th from Moon — the beginning phase of Sade Sati. Expenses increase, mental restlessness, and changes in environment. Focus on savings and mental peace.'};
  else if (satFromMoon === 0) sadeSati = {phase:'Peak (2nd phase)',desc:'Saturn transiting over natal Moon — the peak of Sade Sati. Emotional challenges, health of self and mother needs care, career pressures mount. This is the most intense phase. Meditation, Saturn mantras, and patience are essential.'};
  else if (satFromMoon === 1) sadeSati = {phase:'Setting (3rd phase)',desc:'Saturn transiting the 2nd from Moon — the final phase of Sade Sati. Financial pressure, family tensions, and speech-related issues. The challenges begin to ease. Charitable activities bring relief.'};

  if (sadeSati) {
    readings.push({
      type: 'sadeSati',
      title: `Sade Sati — ${sadeSati.phase}`,
      content: sadeSati.desc,
      severity: 'high'
    });
  }

  // Major transits analysis
  ['Jupiter','Saturn','Rahu','Ketu'].forEach(pName => {
    const tLon = transitPlanets[pName];
    const tSign = Math.floor(tLon / 30) % 12;
    const tHouse = getHouse(tLon, chart.ascendant);
    const fromMoon = ((tSign - moonSign + 12) % 12) + 1;

    let content = `<b>${pName} transiting ${ordinal(tHouse)} house from Lagna, ${ordinal(fromMoon)} from Moon.</b><br>`;

    // From Lagna
    content += `<b>From Lagna:</b> ${pName} activates ${HOUSE_AREAS[tHouse].area}. `;

    // Specific transit effects
    if (pName === 'Jupiter') {
      if ([1,2,5,7,9,11].includes(tHouse)) content += '<span style="color:var(--accent-green)">This is a favorable transit for Jupiter — expansion and blessings in this area of life.</span> ';
      else content += 'Jupiter here brings lessons through expansion in challenging areas. Focus on wisdom over indulgence. ';

      if ([2,5,7,9,11].includes(fromMoon)) content += 'Jupiter\'s transit from Moon is also favorable — emotional well-being and fortune improve. ';
    }
    if (pName === 'Saturn') {
      if ([3,6,11].includes(fromMoon)) content += '<span style="color:var(--accent-green)">Saturn transiting the ' + ordinal(fromMoon) + ' from Moon is favorable — obstacles diminish and effort bears fruit.</span> ';
      else content += 'Saturn here demands discipline, patience, and hard work in the area of ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. ';
    }
    if (pName === 'Rahu') {
      content += 'Rahu\'s transit here creates intense desire, ambition, and unconventional developments in ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. Stay grounded and avoid shortcuts. ';
    }
    if (pName === 'Ketu') {
      content += 'Ketu\'s transit brings spiritual lessons, detachment, and past-karma resolution regarding ' + HOUSE_AREAS[tHouse].short.toLowerCase() + '. ';
    }

    // Which natal planets does the transit aspect
    const natalInHouse = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === tHouse);
    if (natalInHouse.length > 0) {
      content += `<br><b>Transit ${pName} conjuncts natal ${natalInHouse.join(', ')}</b> — this significantly activates these planets' significations. `;
    }

    readings.push({ type: 'transit', title: `${PLANETS_INFO[pName].symbol} ${pName} Transit`, content, severity: 'normal' });
  });

  return readings;
}

// ============================================================
//  YEARLY FORECAST ENGINE
// ============================================================

function generateYearPrediction(chart, year) {
  const asc = chart.ascRashi.index;
  const cls = classifyPlanets(asc);
  const moonSign = chart.planets.Moon.rashi.index;

  // --- Find all dasha periods active during this year ---
  const yearStart = new Date(year, 0, 1);
  const yearEnd = new Date(year, 11, 31, 23, 59, 59);

  // Find Mahadasha(s) active this year
  const yearMDs = [];
  chart.dashas.forEach(md => {
    if (md.endDate >= yearStart && md.startDate <= yearEnd) {
      // Find antardashas active during this year
      const yearADs = [];
      md.antardashas.forEach(ad => {
        if (ad.endDate >= yearStart && ad.startDate <= yearEnd) {
          yearADs.push(ad);
        }
      });
      yearMDs.push({ ...md, activeADs: yearADs });
    }
  });

  // --- Compute transits at 4 quarterly midpoints ---
  const quarters = [
    { label: 'Q1: Jan — Mar', month: 1, day: 15 },
    { label: 'Q2: Apr — Jun', month: 4, day: 15 },
    { label: 'Q3: Jul — Sep', month: 7, day: 15 },
    { label: 'Q4: Oct — Dec', month: 10, day: 15 }
  ];

  const quarterData = quarters.map(q => {
    const jd = julianDay(year, q.month, q.day, 12);
    const planets = calculatePlanets(jd);
    // Compute house positions from lagna
    const positions = {};
    ['Jupiter','Saturn','Rahu','Ketu','Sun','Mars','Venus','Mercury'].forEach(p => {
      const lon = planets[p];
      positions[p] = {
        lon,
        sign: Math.floor(lon / 30) % 12,
        house: getHouse(lon, chart.ascendant),
        rashi: getRashi(lon)
      };
    });

    // Find active MD/AD for this quarter
    const qDate = new Date(year, q.month - 1, q.day);
    let qMD = '', qAD = '';
    chart.dashas.forEach(md => {
      if (qDate >= md.startDate && qDate < md.endDate) {
        qMD = md.lord;
        md.antardashas.forEach(ad => {
          if (qDate >= ad.startDate && qDate < ad.endDate) {
            qAD = ad.lord;
          }
        });
      }
    });

    return { ...q, positions, md: qMD, ad: qAD };
  });

  // --- 1. YEAR OVERVIEW ---
  const primaryMD = yearMDs[0];
  const mdLord = primaryMD ? primaryMD.lord : '?';
  const mdHouses = getLordships(mdLord, asc);
  const mdAreas = mdHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' & ');
  const mdDig = primaryMD && chart.planets[mdLord] ? getDignity(mdLord, chart.planets[mdLord].rashi.index) : '';

  let overview = `<b>${year} is governed by the ${mdLord} Mahadasha</b>`;
  if (yearMDs.length > 1) overview += `, transitioning to ${yearMDs[1].lord} Mahadasha`;
  overview += '. ';

  // Antardasha transitions
  const adNames = [];
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const s = ad.startDate > yearStart ? ad.startDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Jan';
      const e = ad.endDate < yearEnd ? ad.endDate.toLocaleDateString('en-US',{month:'short',year:'numeric'}) : 'Dec';
      adNames.push(`<b>${ad.lord}</b> (${s} — ${e})`);
    });
  }
  if (adNames.length > 0) overview += `Sub-periods active: ${adNames.join(', ')}. `;

  overview += `<br><br>The overarching theme revolves around <b>${mdAreas || mdLord + '\'s significations'}</b>. `;
  if (mdDig === 'exalted') overview += `<span style="color:var(--accent-green)">${mdLord} is exalted in your chart — this year carries an especially auspicious and empowered energy.</span> `;
  else if (mdDig === 'debilitated') overview += `<span style="color:var(--accent-red)">${mdLord} is debilitated — challenges and growth through adversity define this period. Remedies are strongly recommended.</span> `;
  else if (mdDig === 'own-sign') overview += `${mdLord} is in its own sign, giving stability and authenticity to this year's themes. `;

  if (cls.yogakaraka === mdLord) overview += `<br><span style="color:var(--saffron)"><b>${mdLord} is your Yogakaraka — this year is among the most favorable in your life cycle.</b> Embrace opportunities boldly.</span> `;
  if (cls.malefics.includes(mdLord)) overview += `Being a functional malefic for your lagna, this year requires extra caution, patience, and proactive remedial measures. `;

  // Major transit overview for the year
  const jupQ1 = quarterData[0].positions.Jupiter;
  const satQ1 = quarterData[0].positions.Saturn;
  overview += `<br><br><b>Key transits:</b> Jupiter transits your <b>${ordinal(jupQ1.house)} house</b> (${RASHIS[jupQ1.sign].eng})`;
  const jupQ4 = quarterData[3].positions.Jupiter;
  if (jupQ4.house !== jupQ1.house) overview += ` moving to <b>${ordinal(jupQ4.house)} house</b> (${RASHIS[jupQ4.sign].eng}) later in the year`;
  overview += `. Saturn occupies your <b>${ordinal(satQ1.house)} house</b> (${RASHIS[satQ1.sign].eng})`;
  const satQ4 = quarterData[3].positions.Saturn;
  if (satQ4.house !== satQ1.house) overview += ` shifting to <b>${ordinal(satQ4.house)} house</b>`;
  overview += '. ';

  // Sade Sati check for the year
  const satSignQ1 = satQ1.sign;
  const satFromMoonQ1 = ((satSignQ1 - moonSign + 12) % 12);
  if ([11,0,1].includes(satFromMoonQ1)) {
    const phases = {11:'Rising (1st phase)',0:'Peak (2nd phase)',1:'Setting (3rd phase)'};
    overview += `<br><span style="color:var(--accent-red)"><b>Sade Sati is active (${phases[satFromMoonQ1]})</b> — this adds an overlay of karmic lessons, emotional tests, and the need for patience throughout ${year}.</span> `;
  }

  // --- 2. QUARTERLY BREAKDOWN ---
  const quarterPredictions = quarterData.map(q => {
    let text = '';

    // Major slow planet transits
    ['Jupiter','Saturn','Rahu','Ketu'].forEach(p => {
      const pos = q.positions[p];
      text += `<b>${p}</b> in ${ordinal(pos.house)} house (${RASHIS[pos.sign].eng}). `;
    });

    text += '<br><br>';

    // Dasha context for this quarter
    const adHouses = getLordships(q.ad, asc);
    const adAreas = adHouses.map(h => HOUSE_AREAS[h].short.toLowerCase()).join(' & ');
    text += `Under <b>${q.md}-${q.ad}</b> period, focus is on <b>${adAreas || q.ad + '\'s significations'}</b>. `;
    text += generateAntarPrediction(chart, q.md, q.ad) + ' ';

    // Jupiter's blessing or challenge
    const jH = q.positions.Jupiter.house;
    if ([1,2,5,7,9,11].includes(jH)) {
      text += `<br><span style="color:var(--accent-green)">Jupiter\'s favorable transit through the ${ordinal(jH)} house supports growth in ${HOUSE_AREAS[jH].short.toLowerCase()}.</span> `;
    }

    // Saturn's pressure or support
    const sH = q.positions.Saturn.house;
    const satFromMoon = ((q.positions.Saturn.sign - moonSign + 12) % 12) + 1;
    if ([3,6,11].includes(satFromMoon)) {
      text += `Saturn\'s transit is favorable from Moon — ${HOUSE_AREAS[sH].short.toLowerCase()} efforts bear fruit. `;
    } else {
      text += `Saturn in ${ordinal(sH)} demands discipline regarding ${HOUSE_AREAS[sH].life}. `;
    }

    // Any natal conjunctions from transits
    ['Jupiter','Saturn','Rahu'].forEach(tp => {
      const tHouse = q.positions[tp].house;
      const natal = Object.keys(chart.planets).filter(p => p !== '_debug' && chart.planets[p].house === tHouse);
      if (natal.length > 0) {
        text += `Transit ${tp} activates natal ${natal.join(', ')} — significant developments in ${HOUSE_AREAS[tHouse].short.toLowerCase()}. `;
      }
    });

    return { ...q, prediction: text };
  });

  // --- 3. LIFE AREA PREDICTIONS ---
  // Career
  const h10Lord = SIGN_LORDS[(asc+9)%12];
  const h10Data = chart.planets[h10Lord];
  let careerPred = '';
  const jupHouses = quarterData.map(q => q.positions.Jupiter.house);
  const satHouses = quarterData.map(q => q.positions.Saturn.house);
  if (jupHouses.includes(10) || jupHouses.includes(1) || jupHouses.includes(9)) {
    careerPred += '<span style="color:var(--accent-green)">Jupiter\'s transit through career-enhancing houses this year brings expansion, promotions, and recognition.</span> ';
  }
  if (satHouses.includes(10)) {
    careerPred += 'Saturn transiting the 10th house demands hard work and may bring restructuring, but lasting achievement follows. ';
  }
  careerPred += `Your 10th lord ${h10Lord} is natally in the ${ordinal(h10Data.house)} house — its dasha/antardasha activation determines the timing of career peaks. `;
  // MD lord connection to career
  if (mdHouses.includes(10) || mdHouses.includes(1) || mdHouses.includes(7)) {
    careerPred += `The ruling ${mdLord} Mahadasha directly connects to your career axis, making ${year} professionally significant. `;
  }
  // Check active ADs for career relevance
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const adH = getLordships(ad.lord, asc);
      if (adH.includes(10) || adH.includes(6)) {
        const s = ad.startDate.toLocaleDateString('en-US',{month:'short'});
        const e = ad.endDate.toLocaleDateString('en-US',{month:'short'});
        careerPred += `${ad.lord} antardasha (${s}-${e}) rules career/work houses — a period of heightened professional activity. `;
      }
    });
  }

  // Finance
  const h2Lord = SIGN_LORDS[(asc+1)%12];
  const h11Lord = SIGN_LORDS[(asc+10)%12];
  let financePred = '';
  if (jupHouses.includes(2) || jupHouses.includes(11)) {
    financePred += '<span style="color:var(--accent-green)">Jupiter transiting wealth houses (2nd/11th) is a strong indicator of financial growth and new income sources.</span> ';
  }
  if (satHouses.includes(2)) {
    financePred += 'Saturn in the 2nd house calls for disciplined saving and careful financial management. ';
  }
  if (satHouses.includes(11)) {
    financePred += 'Saturn in the 11th restricts gains initially but rewards sustained effort by year end. ';
  }
  financePred += `2nd lord ${h2Lord} (wealth) in ${ordinal(chart.planets[h2Lord].house)} house, 11th lord ${h11Lord} (gains) in ${ordinal(chart.planets[h11Lord].house)} house shape your baseline earning potential. `;
  if (mdHouses.includes(2) || mdHouses.includes(11)) {
    financePred += `The ${mdLord} Mahadasha directly activates wealth houses — financial themes are prominent in ${year}. `;
  }

  // Relationships
  const h7Lord = SIGN_LORDS[(asc+6)%12];
  let relPred = '';
  if (jupHouses.includes(7)) {
    relPred += '<span style="color:var(--accent-green)">Jupiter transiting the 7th house blesses partnerships and may bring marriage or a significant relationship.</span> ';
  }
  if (satHouses.includes(7)) {
    relPred += 'Saturn in the 7th tests relationships through responsibility and maturity. Commitment deepens for those who persevere. ';
  }
  const rahuHouses = quarterData.map(q => q.positions.Rahu.house);
  if (rahuHouses.includes(7)) {
    relPred += 'Rahu in the 7th brings intense desire for partnership, unconventional relationships, or foreign spouse connections. ';
  }
  relPred += `7th lord ${h7Lord} in the ${ordinal(chart.planets[h7Lord].house)} house and Venus in the ${ordinal(chart.planets.Venus.house)} house define your relationship karma. `;
  if (mdHouses.includes(7) || mdHouses.includes(5)) {
    relPred += `${mdLord} Mahadasha activates relationship/romance houses this year. `;
  }
  if (primaryMD) {
    primaryMD.activeADs.forEach(ad => {
      const adH = getLordships(ad.lord, asc);
      if (adH.includes(7) || adH.includes(5)) {
        const s = ad.startDate.toLocaleDateString('en-US',{month:'short'});
        const e = ad.endDate.toLocaleDateString('en-US',{month:'short'});
        relPred += `${ad.lord} sub-period (${s}-${e}) activates romance/partnership — watch for key relationship events. `;
      }
    });
  }

  // Health
  const h6Lord = SIGN_LORDS[(asc+5)%12];
  let healthPred = '';
  if (satHouses.includes(1) || satHouses.includes(6) || satHouses.includes(8)) {
    healthPred += 'Saturn transiting health-sensitive houses requires attention to physical stamina, bone/joint health, and chronic conditions. ';
  }
  if (jupHouses.includes(1) || jupHouses.includes(6)) {
    healthPred += '<span style="color:var(--accent-green)">Jupiter\'s protective influence on health houses provides recovery and vitality.</span> ';
  }
  const marsHouses = quarterData.map(q => q.positions.Mars.house);
  if (marsHouses.includes(1) || marsHouses.includes(6) || marsHouses.includes(8)) {
    healthPred += 'Mars transiting health houses can bring acute conditions, fevers, or accident risk — exercise caution during these months. ';
  }
  healthPred += `Your 6th lord ${h6Lord} in the ${ordinal(chart.planets[h6Lord].house)} house defines disease patterns. `;
  if (mdHouses.includes(6) || mdHouses.includes(8)) {
    healthPred += `The ruling Mahadasha activates health/transformation houses — proactive health management is advised in ${year}. `;
  }

  // Spiritual
  const h9Lord = SIGN_LORDS[(asc+8)%12];
  let spiritPred = '';
  if (jupHouses.includes(9) || jupHouses.includes(12) || jupHouses.includes(5)) {
    spiritPred += '<span style="color:var(--accent-green)">Jupiter in dharma/moksha houses enhances spiritual insight, guru connections, and philosophical growth.</span> ';
  }
  const ketuHouses = quarterData.map(q => q.positions.Ketu.house);
  if (ketuHouses.includes(12) || ketuHouses.includes(9) || ketuHouses.includes(5)) {
    spiritPred += 'Ketu transiting spiritual houses deepens meditation, past-life awareness, and detachment from material pursuits. ';
  }
  spiritPred += `9th lord ${h9Lord} in ${ordinal(chart.planets[h9Lord].house)} house and Jupiter in ${ordinal(chart.planets.Jupiter.house)} house shape your spiritual foundation. `;
  if (mdHouses.includes(9) || mdHouses.includes(12)) {
    spiritPred += `${mdLord} Mahadasha activates spiritual houses — ${year} can be a year of profound inner growth. `;
  }

  return {
    overview,
    quarterPredictions,
    areas: [
      { title: 'Career & Professional Life', icon: '\u2617', content: careerPred },
      { title: 'Finance & Wealth', icon: '&#x1F4B0;', content: financePred },
      { title: 'Relationships & Marriage', icon: '\u2665', content: relPred },
      { title: 'Health & Vitality', icon: '\u2695', content: healthPred },
      { title: 'Spiritual Growth', icon: '\u0950', content: spiritPred }
    ],
    mdLord,
    yearMDs
  };
}

// ============================================================
//  CHART RENDERING (SVG)
// ============================================================

function renderNorthIndianChart(chart) {
  const S = 380; // chart size
  const C = S / 2; // center
  const TL=[0,0],TR=[S,0],BR=[S,S],BL=[0,S];
  const T=[C,0],R=[S,C],B=[C,S],L=[0,C];
  const CT=[C,C];

  // Intersection points of outer diagonals with diamond edges
  const P1=[S*0.25,S*0.25]; // TL diagonal meets T-L edge
  const P2=[S*0.75,S*0.25]; // TR diagonal meets T-R edge
  const P3=[S*0.75,S*0.75]; // TL diagonal meets R-B edge
  const P4=[S*0.25,S*0.75]; // TR diagonal meets B-L edge

  // 12 house polygons
  const houses = [
    /*1*/  [T,P2,CT,P1],
    /*2*/  [T,TR,P2],
    /*3*/  [TR,R,P2],
    /*4*/  [P2,R,P3,CT],
    /*5*/  [R,BR,P3],
    /*6*/  [BR,B,P3],
    /*7*/  [P3,B,P4,CT],
    /*8*/  [B,BL,P4],
    /*9*/  [BL,L,P4],
    /*10*/ [P4,L,P1,CT],
    /*11*/ [L,TL,P1],
    /*12*/ [TL,T,P1],
  ];

  // Label positions (center of each house)
  const labelPos = houses.map(poly => {
    const cx = poly.reduce((s,p)=>s+p[0],0)/poly.length;
    const cy = poly.reduce((s,p)=>s+p[1],0)/poly.length;
    return [cx, cy];
  });

  // Build planet-to-house mapping
  const housePlanets = {};
  for (let i = 1; i <= 12; i++) housePlanets[i] = [];
  // Add ascendant marker
  const ascHouse = 1; // by definition in whole-sign system
  for (const pName in chart.planets) {
    const h = chart.planets[pName].house;
    housePlanets[h].push(pName);
  }

  let svg = `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" xmlns="http://www.w3.org/2000/svg">`;
  // Background
  svg += `<rect x="0" y="0" width="${S}" height="${S}" rx="12" fill="#FFFCF8" stroke="rgba(74,53,128,0.15)" stroke-width="1.5"/>`;

  // Draw house polygons
  houses.forEach((poly, i) => {
    const points = poly.map(p => p.join(',')).join(' ');
    const fill = i === 0 ? 'rgba(212,113,10,0.06)' : 'rgba(74,53,128,0.02)';
    svg += `<polygon points="${points}" fill="${fill}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
  });

  // House numbers
  houses.forEach((poly, i) => {
    const [cx, cy] = labelPos[i];
    const houseNum = i + 1;
    svg += `<text x="${cx}" y="${cy - 20}" text-anchor="middle" fill="rgba(212,113,10,0.45)" font-size="11" font-family="Plus Jakarta Sans,sans-serif" font-weight="600">${houseNum}</text>`;

    // Rashi for this house (whole sign from ascendant)
    const rashiIdx = (chart.ascRashi.index + i) % 12;
    svg += `<text x="${cx}" y="${cy - 8}" text-anchor="middle" fill="rgba(74,53,128,0.5)" font-size="10" font-family="Inter">${RASHIS[rashiIdx].eng.substring(0,3)}</text>`;

    // Planets in this house
    const planetList = housePlanets[houseNum];
    planetList.forEach((pName, pi) => {
      const abbr = pName === "Mercury" ? "Me" : pName === "Jupiter" ? "Ju" : pName === "Venus" ? "Ve" : pName === "Saturn" ? "Sa" : pName.substring(0, 2);
      const color = PLANET_COLORS[pName] || '#2D2B3D';
      const yOffset = 6 + pi * 15;
      svg += `<text x="${cx}" y="${cy + yOffset}" text-anchor="middle" fill="${color}" font-size="12" font-weight="600" font-family="Inter">${abbr}</text>`;
    });
  });

  // ASC marker in house 1
  svg += `<text x="${C}" y="${S*0.18}" text-anchor="middle" fill="#D4710A" font-size="10" font-weight="700" font-family="Plus Jakarta Sans,sans-serif" letter-spacing="2">ASC</text>`;

  svg += '</svg>';
  return svg;
}

function renderSouthIndianChart(chart) {
  const S = 380;
  const cellW = S / 4;
  const cellH = S / 4;

  // South Indian chart: fixed sign positions in a 4x4 grid
  // Outer 12 cells hold the 12 signs, inner 4 are empty
  // Signs go clockwise starting from Pisces (index 11) at top-left
  const signPositions = [
    {sign:11,row:0,col:0}, // Pisces
    {sign:0,row:0,col:1},  // Aries
    {sign:1,row:0,col:2},  // Taurus
    {sign:2,row:0,col:3},  // Gemini
    {sign:3,row:1,col:3},  // Cancer
    {sign:4,row:2,col:3},  // Leo
    {sign:5,row:3,col:3},  // Virgo
    {sign:6,row:3,col:2},  // Libra
    {sign:7,row:3,col:1},  // Scorpio
    {sign:8,row:3,col:0},  // Sagittarius
    {sign:9,row:2,col:0},  // Capricorn
    {sign:10,row:1,col:0}, // Aquarius
  ];

  // Map planets to signs
  const signPlanets = {};
  for (let i = 0; i < 12; i++) signPlanets[i] = [];
  for (const pName in chart.planets) {
    const rashiIdx = chart.planets[pName].rashi.index;
    signPlanets[rashiIdx].push(pName);
  }

  let svg = `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" xmlns="http://www.w3.org/2000/svg">`;
  // Background
  svg += `<rect x="0" y="0" width="${S}" height="${S}" rx="12" fill="#FFFCF8" stroke="rgba(74,53,128,0.15)" stroke-width="1.5"/>`;

  // Draw grid
  for (let i = 0; i <= 4; i++) {
    svg += `<line x1="${i*cellW}" y1="0" x2="${i*cellW}" y2="${S}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
    svg += `<line x1="0" y1="${i*cellH}" x2="${S}" y2="${i*cellH}" stroke="rgba(74,53,128,0.18)" stroke-width="1"/>`;
  }

  // Inner area
  svg += `<rect x="${cellW}" y="${cellH}" width="${cellW*2}" height="${cellH*2}" fill="rgba(212,113,10,0.03)"/>`;
  svg += `<text x="${S/2}" y="${S/2 - 8}" text-anchor="middle" fill="rgba(212,113,10,0.4)" font-size="14" font-family="Plus Jakarta Sans,sans-serif" font-weight="600">KUNDALI</text>`;
  svg += `<text x="${S/2}" y="${S/2 + 10}" text-anchor="middle" fill="rgba(74,53,128,0.35)" font-size="10" font-family="Plus Jakarta Sans,sans-serif">South Indian</text>`;

  // Draw signs and planets
  signPositions.forEach(sp => {
    const x = sp.col * cellW;
    const y = sp.row * cellH;
    const cx = x + cellW / 2;
    const cy = y + cellH / 2;
    const rashi = RASHIS[sp.sign];
    const isAscSign = sp.sign === chart.ascRashi.index;

    if (isAscSign) {
      svg += `<rect x="${x+1}" y="${y+1}" width="${cellW-2}" height="${cellH-2}" fill="rgba(212,113,10,0.06)"/>`;
      // Diagonal line in ASC cell (traditional marker)
      svg += `<line x1="${x+2}" y1="${y+2}" x2="${x+18}" y2="${y+18}" stroke="rgba(212,113,10,0.45)" stroke-width="1.5"/>`;
    }

    // Sign label: symbol + abbreviation on one line, top-left
    svg += `<text x="${x+6}" y="${y+14}" fill="rgba(212,113,10,0.35)" font-size="11">${rashi.symbol}</text>`;
    svg += `<text x="${x+20}" y="${y+14}" fill="rgba(74,53,128,0.5)" font-size="9" font-family="Inter">${rashi.eng.substring(0,3)}</text>`;

    // Planets in this sign — centered in cell, starting below the sign label
    const pList = signPlanets[sp.sign];
    pList.forEach((pName, pi) => {
      const abbr = pName === "Mercury" ? "Me" : pName === "Jupiter" ? "Ju" : pName === "Venus" ? "Ve" : pName === "Saturn" ? "Sa" : pName.substring(0, 2);
      const color = PLANET_COLORS[pName] || '#2D2B3D';
      const col = pi % 2;
      const row = Math.floor(pi / 2);
      const px = cx - 12 + col * 24;
      const py = y + 32 + row * 16;
      svg += `<text x="${px}" y="${py}" text-anchor="middle" fill="${color}" font-size="12" font-weight="600" font-family="Inter">${abbr}</text>`;
    });

    // House number
    const houseNum = ((sp.sign - chart.ascRashi.index + 12) % 12) + 1;
    svg += `<text x="${x + cellW - 8}" y="${y + cellH - 4}" text-anchor="end" fill="rgba(212,113,10,0.25)" font-size="9" font-family="Inter">${houseNum}</text>`;
  });

  svg += '</svg>';
  return svg;
}

// ============================================================
//  RENDERING FUNCTIONS
// ============================================================

let currentChart = null;
let chartStyle = 'north';
let chartMode = 'rashi'; // 'rashi' or 'bhava'
let vargaChartStyle = 'north';
let currentVarshChart = null;

// Resolve city name → coordinates (handles both dropdown selection and manual typing)
function resolveCity(inputText) {
  const text = inputText.trim().toLowerCase();
  if (!text) return null;

  // 1. Exact match on "Name, Country" (from dropdown selection)
  let match = CITIES.find(c => (c.name + ', ' + c.country).toLowerCase() === text);
  if (match) return match;

  // 2. Exact match on city name alone
  match = CITIES.find(c => c.name.toLowerCase() === text);
  if (match) return match;

  // 3. Starts-with match (e.g. user typed "kanpur" without clicking dropdown)
  const startMatches = CITIES.filter(c => c.name.toLowerCase().startsWith(text));
  if (startMatches.length === 1) return startMatches[0];

  // 4. Contains match
  const containsMatches = CITIES.filter(c => c.name.toLowerCase().includes(text));
  if (containsMatches.length === 1) return containsMatches[0];

  return null;
}

function generateChart() {
  const dob = document.getElementById('dob').value;
  const tob = document.getElementById('tob').value;
  const cityText = document.getElementById('city').value;

  // Always resolve city from the text input — never rely solely on hidden fields
  const resolved = resolveCity(cityText);
  let lat, lon, tz, cityName;

  if (resolved) {
    lat = resolved.lat;
    lon = resolved.lon;
    tz  = resolved.tz;
    cityName = resolved.name + ', ' + resolved.country;
    // Sync hidden fields and display name
    document.getElementById('cityLat').value = lat;
    document.getElementById('cityLon').value = lon;
    document.getElementById('cityTz').value  = tz;
    document.getElementById('city').value    = cityName;
  } else {
    // Fall back to hidden fields (in case user manually edited them)
    lat = parseFloat(document.getElementById('cityLat').value);
    lon = parseFloat(document.getElementById('cityLon').value);
    tz  = parseFloat(document.getElementById('cityTz').value);
    cityName = cityText;
  }

  if (!dob || !tob || isNaN(lat) || isNaN(lon) || isNaN(tz)) {
    alert('Please select a valid city from the dropdown suggestions.\nType at least 2 letters and click a city from the list.');
    return;
  }

  currentChart = calculateFullChart(dob, tob, lat, lon, tz);
  currentChart.birthInfo = { dob, tob, city: cityName, lat, lon, tz };

  document.getElementById('results').classList.add('visible');

  renderSummary();
  chartMode = 'rashi'; // reset to rashi on new chart
  document.querySelectorAll('.chart-mode-toggle button').forEach(b => b.classList.remove('active'));
  document.querySelector('.chart-mode-toggle button:first-child').classList.add('active');
  document.getElementById('bhavaShiftInfo').style.display = 'none';
  renderChartSVG();
  renderChartReading();
  renderPlanetsTable();
  renderDasha();
  renderTransits();
  populateYearSelector();
  renderRemedies();
  populateGocharYearSelector();
  renderGochar();
  populateRashiPhalYearSelector();
  renderRashiPhal();
  renderVargaChart();
  populateVarshYearSelector();
  renderVarshPhal();

  document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

function renderSummary() {
  const c = currentChart;
  const d = c.debug;
  const moonNak = c.planets.Moon.nakshatra;
  const ascNak = getNakshatra(c.ascendant);
  const ascR = c.ascRashi;
  const moonR = c.planets.Moon.rashi;
  const sunR = c.planets.Sun.rashi;

  // Find current dasha
  const now = new Date();
  let currentMD = '', currentAD = '';
  for (const md of c.dashas) {
    if (now >= md.startDate && now < md.endDate) {
      currentMD = md.lord;
      for (const ad of md.antardashas) {
        if (now >= ad.startDate && now < ad.endDate) {
          currentAD = ad.lord;
          break;
        }
      }
      break;
    }
  }

  // Build tropical longitude debug rows
  let tropRows = '';
  if (d.tropical) {
    for (const p in d.tropical) {
      if (p === 'Ketu') continue; // skip to save space
      tropRows += `<span style="color:${PLANET_COLORS[p]||'#6B6880'}">${p}: ${d.tropical[p].toFixed(2)}°</span>  `;
    }
  }

  const html = `
    <div class="chart-info-card">
      <h4>&#9788; Ascendant (Lagna)</h4>
      <p>${ascR.name} (${ascR.eng}) ${ascR.symbol} at ${degToDMS(ascR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9789; Moon Sign (Rashi)</h4>
      <p>${moonR.name} (${moonR.eng}) ${moonR.symbol} at ${degToDMS(moonR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#10038; Janma Nakshatra (Moon)</h4>
      <p>${moonNak.name} (Pada ${moonNak.currentPada}) — Lord: ${moonNak.lord}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#10038; Lagna Nakshatra</h4>
      <p>${ascNak.name} (Pada ${ascNak.currentPada}) — Lord: ${ascNak.lord}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9788; Sun Sign</h4>
      <p>${sunR.name} (${sunR.eng}) ${sunR.symbol} at ${degToDMS(sunR.degrees)}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#8982; Current Dasha</h4>
      <p>${currentMD ? currentMD + ' / ' + currentAD : 'N/A (future birth date?)'}</p>
    </div>
    <div class="chart-info-card">
      <h4>&#9734; Birth Details</h4>
      <p>${c.birthInfo.city} — ${c.birthInfo.dob} at ${c.birthInfo.tob}</p>
    </div>

    <div class="chart-info-card" style="grid-column:1/-1;background:var(--bg-card2);border:1px dashed rgba(212,113,10,0.2)">
      <h4 style="cursor:pointer" onclick="document.getElementById('debugBody').style.display=document.getElementById('debugBody').style.display==='none'?'block':'none'">&#128269; Calculation Log (click to expand)</h4>
      <div id="debugBody" style="display:none;font-family:monospace;font-size:0.78em;line-height:1.8;color:var(--text-dim);margin-top:8px">
        <div><strong style="color:var(--saffron)">Location:</strong> Lat <b>${d.inputLat}</b>°, Lon <b>${d.inputLon}</b>°, TZ offset <b>${d.inputTz >= 0 ? '+' : ''}${d.inputTz}</b> hrs (UTC${d.inputTz >= 0 ? '+' : ''}${d.inputTz})</div>
        <div><strong style="color:var(--saffron)">Time:</strong> Local ${d.localTime} → UTC hour ${d.utcHour}</div>
        <div><strong style="color:var(--saffron)">Julian Day:</strong> ${d.julianDay}</div>
        <div><strong style="color:var(--saffron)">Lahiri Ayanamsa:</strong> ${d.ayanamsa}°</div>
        <div><strong style="color:var(--saffron)">GST:</strong> ${d.gst}° &nbsp; <strong style="color:var(--saffron)">LST:</strong> ${d.lst}°</div>
        <div style="margin-top:6px"><strong style="color:var(--saffron)">Tropical longitudes:</strong><br>${tropRows}</div>
        <div style="margin-top:4px;font-size:0.72em;color:var(--text-dim)">Engine: JPL Keplerian elements (Standish 1992) · Kepler eq. solved via Newton–Raphson · heliocentric→geocentric vector conversion · Lahiri (Chitrapaksha) ayanamsa</div>
      </div>
    </div>
  `;
  document.getElementById('summaryInfo').innerHTML = html;
}

function setChartStyle(style) {
  chartStyle = style;
  const container = document.getElementById('tab-chart');
  container.querySelectorAll('.chart-toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderChartSVG();
}

function setChartMode(mode) {
  chartMode = mode;
  document.querySelectorAll('.chart-mode-toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderChartSVG();
  // Show/hide bhava shift info
  const bhavaInfo = document.getElementById('bhavaShiftInfo');
  if (bhavaInfo) bhavaInfo.style.display = mode === 'bhava' ? 'block' : 'none';
}

function renderChartSVG() {
  if (!currentChart) return;
  let chartData = currentChart;
  if (chartMode === 'bhava') {
    chartData = generateBhavaChartData(currentChart);
    renderBhavaShiftTable(currentChart, chartData);
  }
  const svg = chartStyle === 'north'
    ? renderNorthIndianChart(chartData)
    : renderSouthIndianChart(chartData);
  document.getElementById('chartContainer').innerHTML = svg;
}

function renderBhavaShiftTable(rashiChart, bhavaChart) {
  const container = document.getElementById('bhavaShiftInfo');
  if (!container) return;
  let hasShift = false;
  let html = '<div style="background:var(--bg-card2);padding:18px 22px;border-radius:14px;border:1px solid var(--border)">';
  html += '<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);font-size:0.92em;font-weight:600;margin-bottom:12px">Bh&#x0101;va Chalit — Planet Shifts</h4>';
  html += '<table class="bhava-shift-table"><thead><tr><th>Planet</th><th>Rashi House</th><th>Bh&#x0101;va House</th><th>Status</th></tr></thead><tbody>';
  const planets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  planets.forEach(p => {
    const rashiH = rashiChart.planets[p].house;
    const bhavaH = bhavaChart.planets[p].house;
    const shifted = rashiH !== bhavaH;
    if (shifted) hasShift = true;
    html += `<tr><td><span style="font-weight:500;color:${PLANET_COLORS[p]||'var(--text)'}">${p}</span></td>`;
    html += `<td>${ordinal(rashiH)}</td><td>${ordinal(bhavaH)}</td>`;
    html += shifted
      ? `<td><span class="bhava-shift">&#8596; Shifted</span></td>`
      : `<td><span class="bhava-same">&#10003; Same</span></td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  if (!hasShift) html += '<p style="color:var(--text-dim);font-size:0.88em;margin-top:10px;font-style:italic">No planets shift houses in the Bhāva Chalit for this chart.</p>';
  else {
    html += '<p style="color:var(--text-dim);font-size:0.85em;margin-top:10px;font-family:Newsreader,serif;line-height:1.65">Planets that shift houses in Bhāva Chalit give results of both the Rashi house and the Bhāva house. The Rashi chart shows ownership and signification; the Bhāva Chalit shows where the planet actually delivers its results.</p>';
    html += buildBhavaReading(rashiChart, bhavaChart);
  }
  html += '</div>';
  container.innerHTML = html;
}

// ---- BHAVA CHALIT READING ----

const HOUSE_AREAS_SHORT = {
  1:'self, personality, health, vitality',
  2:'wealth, speech, family, food',
  3:'siblings, courage, communication, short travel',
  4:'home, mother, comfort, property, vehicles',
  5:'children, creativity, romance, education, past merit',
  6:'enemies, disease, debts, service, competition',
  7:'marriage, partnerships, business, public dealings',
  8:'longevity, sudden events, inheritance, occult',
  9:'fortune, dharma, guru, father, higher learning',
  10:'career, fame, authority, public status',
  11:'gains, income, friends, fulfillment of desires',
  12:'losses, expenses, foreign lands, liberation, spirituality'
};

function buildBhavaReading(rashiChart, bhavaChart) {
  let html = '<div style="margin-top:16px">';
  html += '<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--indigo);font-size:0.88em;font-weight:600;margin-bottom:10px">Bhāva Chalit Interpretation</h4>';
  const planets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  let readingParts = [];
  planets.forEach(p => {
    const rH = rashiChart.planets[p].house;
    const bH = bhavaChart.planets[p].house;
    if (rH !== bH) {
      const rArea = HOUSE_AREAS_SHORT[rH];
      const bArea = HOUSE_AREAS_SHORT[bH];
      readingParts.push(`<b>${p}</b> shifts from the ${ordinal(rH)} house (${rArea}) to the ${ordinal(bH)} house (${bArea}) in Bhāva Chalit. While ${p} retains its lordship responsibilities as per the Rashi chart, it delivers its tangible day-to-day results through ${ordinal(bH)} house matters. This means the native experiences ${p}'s influence more concretely in areas of <i>${bArea}</i> rather than <i>${rArea}</i>.`);
    }
  });

  if (readingParts.length > 0) {
    html += '<div style="font-family:Newsreader,serif;font-size:0.98em;line-height:1.75;color:var(--text)">';
    html += readingParts.join('<br><br>');
    html += '<br><br><b>Key principle:</b> In Vedic astrology, the Rashi chart (D1) determines planetary ownership, lordship, and dignity. The Bhāva Chalit reveals where planets actually deliver results. When a planet shifts, read its significations through the Bhāva house for practical life outcomes, while retaining lordship analysis from the Rashi chart.';
    html += '</div>';
  }

  // Bhava cusp analysis
  html += '<div style="margin-top:14px;font-family:Newsreader,serif;font-size:0.95em;line-height:1.7;color:var(--text)">';
  html += '<b>Ascendant Degree:</b> ' + degToDMS(rashiChart.ascendant % 30) + ' in ' + rashiChart.ascRashi.eng + '. ';
  const ascDeg = rashiChart.ascendant % 30;
  if (ascDeg < 5 || ascDeg > 25) {
    html += 'The ascendant is near the boundary of its sign (' + (ascDeg < 5 ? 'early' : 'late') + ' degrees), which makes Bhāva Chalit shifts more significant and common in this chart. Planets near sign boundaries are more likely to shift bhavas.';
  } else if (ascDeg > 12 && ascDeg < 18) {
    html += 'The ascendant is near the middle of its sign, meaning Bhāva Chalit cusps closely align with sign boundaries. Fewer planets tend to shift in such charts.';
  }
  html += '</div>';
  html += '</div>';
  return html;
}

// ---- DIVISIONAL CHARTS RENDERING ----

function setVargaChartStyle(style) {
  vargaChartStyle = style;
  const container = document.getElementById('tab-vargas');
  container.querySelectorAll('.chart-toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderVargaChart();
}

function renderVargaChart() {
  if (!currentChart) return;
  const vargaDiv = parseInt(document.getElementById('vargaSelect').value);
  const vargaChart = calculateVargaChart(currentChart, vargaDiv);

  // Info card
  const info = VARGA_INFO[vargaDiv];
  if (info) {
    const infoCard = document.getElementById('vargaInfoCard');
    infoCard.style.display = 'block';
    infoCard.innerHTML = `<h4>${info.name} — ${info.area}</h4><p>${info.desc}</p>`;
  }

  // Render chart
  const svg = vargaChartStyle === 'north'
    ? renderNorthIndianChart(vargaChart)
    : renderSouthIndianChart(vargaChart);
  document.getElementById('vargaChartContainer').innerHTML = svg;

  // Render planets table + reading
  renderVargaPlanetsTable(vargaChart, vargaDiv);
}

function renderVargaPlanetsTable(vargaChart, vargaDiv) {
  const info = VARGA_INFO[vargaDiv] || {name:'D'+vargaDiv};
  let html = `<thead><tr><th>Planet</th><th>Natal Sign</th><th>${info.name} Sign</th><th>House in ${info.name.split(' ')[0]}</th><th>Dignity</th></tr></thead><tbody>`;

  // Ascendant row
  const natAscR = currentChart.ascRashi;
  const vAscR = vargaChart.ascRashi;
  html += `<tr style="background:rgba(212,113,10,0.04)"><td><span style="font-weight:600;color:var(--saffron)">Ascendant</span></td>`;
  html += `<td>${natAscR.name} (${natAscR.eng})</td><td>${vAscR.name} (${vAscR.eng})</td><td>1st</td><td>—</td></tr>`;

  const planets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  planets.forEach(p => {
    const vPl = vargaChart.planets[p];
    const natSign = RASHIS[vPl.natalRashiIndex];
    const color = PLANET_COLORS[p] || '#888';
    const dignity = getVargaDignity(p, vPl.rashi.index);
    html += `<tr>`;
    html += `<td><span class="planet-symbol" style="background:${color};color:white">${PLANETS_INFO[p]?.symbol||p.substring(0,2)}</span><span class="planet-name">${p}</span></td>`;
    html += `<td>${natSign.name} (${natSign.eng})</td>`;
    html += `<td>${vPl.rashi.name} (${vPl.rashi.eng})</td>`;
    html += `<td>${ordinal(vPl.house)}</td>`;
    html += `<td>${dignity}</td>`;
    html += `</tr>`;
  });
  html += '</tbody>';

  document.getElementById('vargaPlanetsTable').innerHTML = html;

  // Add comprehensive reading below table in separate container
  document.getElementById('vargaReadingContainer').innerHTML = generateVargaReading(vargaChart, vargaDiv, currentChart);
}

function getVargaDignity(planet, signIdx) {
  if (planet === 'Rahu' || planet === 'Ketu') return '—';
  const ownSigns = {Sun:[4],Moon:[3],Mars:[0,7],Mercury:[2,5],Jupiter:[8,11],Venus:[1,6],Saturn:[9,10]};
  const exaltSigns = {Sun:0,Moon:1,Mars:9,Mercury:5,Jupiter:3,Venus:11,Saturn:6};
  const debilSigns = {Sun:6,Moon:7,Mars:3,Mercury:11,Jupiter:9,Venus:5,Saturn:0};
  if (ownSigns[planet] && ownSigns[planet].includes(signIdx)) return '<span style="color:var(--accent-green);font-weight:500">Own Sign</span>';
  if (exaltSigns[planet] === signIdx) return '<span style="color:var(--accent-green);font-weight:600">Exalted</span>';
  if (debilSigns[planet] === signIdx) return '<span style="color:var(--accent-red);font-weight:500">Debilitated</span>';
  // Friendly / enemy sign detection
  const friends = {Sun:['Moon','Mars','Jupiter'],Moon:['Sun','Mercury'],Mars:['Sun','Moon','Jupiter'],
    Mercury:['Sun','Venus'],Jupiter:['Sun','Moon','Mars'],Venus:['Mercury','Saturn'],Saturn:['Mercury','Venus']};
  const enemies = {Sun:['Venus','Saturn'],Moon:[],Mars:['Mercury'],Mercury:['Moon'],Jupiter:['Mercury','Venus'],Venus:['Sun','Moon'],Saturn:['Sun','Moon','Mars']};
  const signLord = RASHIS[signIdx].lord;
  if (friends[planet] && friends[planet].includes(signLord)) return '<span style="color:#1A8A5C">Friendly</span>';
  if (enemies[planet] && enemies[planet].includes(signLord)) return '<span style="color:#C75B12">Enemy</span>';
  return 'Neutral';
}

function generateVargaReading(vargaChart, vargaDiv, natalChart) {
  const info = VARGA_INFO[vargaDiv];
  if (!info) return '';
  let html = '<div style="margin-top:24px;display:flex;flex-direction:column;gap:16px">';
  html += `<div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F4D6;</span> ${info.name} — Detailed Reading</div>`;

  const asc = vargaChart.ascRashi;
  const planets = vargaChart.planets;

  // Ascendant reading
  html += `<div class="reading-section"><h3><span class="rs-icon">&#9788;</span> ${info.name} Ascendant: ${asc.name} (${asc.eng})</h3>`;
  html += `<div class="reading-body">`;
  html += `The ${info.name} ascendant is <b>${asc.eng}</b>, ruled by <b>${asc.lord}</b>. `;
  const ascLordPl = planets[asc.lord];
  if (ascLordPl) {
    html += `The ${info.name} Lagna lord ${asc.lord} is placed in <b>${ascLordPl.rashi.eng}</b> (${ordinal(ascLordPl.house)} house). `;
    if ([1,5,9].includes(ascLordPl.house)) html += `This is a highly auspicious placement — the Lagna lord in a trikona strengthens the core significations of this divisional chart, indicating natural talent and blessings in matters of <i>${info.area.toLowerCase()}</i>. `;
    else if ([1,4,7,10].includes(ascLordPl.house)) html += `The Lagna lord in a kendra provides stability and strength to ${info.area.toLowerCase()} matters. `;
    else if ([6,8,12].includes(ascLordPl.house)) html += `The Lagna lord in a dusthana suggests challenges and karmic lessons in the area of <i>${info.area.toLowerCase()}</i> that require conscious effort to overcome. `;
  }
  html += `</div></div>`;

  // Varga-specific readings based on the type
  html += generateVargaSpecificReading(vargaChart, vargaDiv, natalChart);

  // Key dignities
  html += `<div class="reading-section"><h3><span class="rs-icon">&#x2B50;</span> Planetary Strengths in ${info.name}</h3>`;
  html += `<div class="reading-body">`;
  const plOrder = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];
  const exalted = [], ownSign = [], debilitated = [];
  plOrder.forEach(p => {
    const si = planets[p].rashi.index;
    const dText = getVargaDignity(p, si);
    if (dText.includes('Exalted')) exalted.push(p);
    else if (dText.includes('Own Sign')) ownSign.push(p);
    else if (dText.includes('Debilitated')) debilitated.push(p);
  });
  if (exalted.length > 0) html += `<b>Exalted planets:</b> ${exalted.join(', ')} — these planets are at their peak strength in this varga, greatly enhancing their significations in ${info.area.toLowerCase()} matters. `;
  if (ownSign.length > 0) html += `<b>Planets in own sign:</b> ${ownSign.join(', ')} — comfortable and strong, providing reliable support for ${info.area.toLowerCase()}. `;
  if (debilitated.length > 0) html += `<b>Debilitated planets:</b> ${debilitated.join(', ')} — weakened in this varga, suggesting areas requiring remedial attention or extra effort. `;
  if (exalted.length === 0 && ownSign.length === 0 && debilitated.length === 0) html += 'No planets are in extreme dignity (exalted, own sign, or debilitated) in this varga chart. ';

  // Benefics in kendras
  const beneficsInKendra = ['Jupiter','Venus','Mercury'].filter(p => planets[p] && [1,4,7,10].includes(planets[p].house));
  if (beneficsInKendra.length >= 2) html += `<br><br><b>${beneficsInKendra.join(' and ')}</b> occupy kendra houses in the ${info.name}, providing a strong foundation and natural ease in ${info.area.toLowerCase()} matters.`;

  html += `</div></div>`;

  // Yogas in varga
  if (vargaChart.yogas && vargaChart.yogas.length > 0) {
    html += `<div class="reading-section"><h3><span class="rs-icon">&#10038;</span> Yogas in ${info.name}</h3>`;
    html += `<div class="reading-body">`;
    vargaChart.yogas.forEach(y => {
      html += `<b>${y.name}:</b> ${y.desc}<br><br>`;
    });
    html += `</div></div>`;
  }

  html += '</div>';
  return html;
}

function generateVargaSpecificReading(vargaChart, vargaDiv, natalChart) {
  const pl = vargaChart.planets;
  let html = '';

  if (vargaDiv === 9) { // Navamsa — Marriage & Dharma
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F48D;</span> Marriage & Spouse (Navamsa)</h3>`;
    html += `<div class="reading-body">`;
    const sev = pl.Venus;
    html += `<b>Venus</b> (karaka of marriage) is in <b>${sev.rashi.eng}</b> in the ${ordinal(sev.house)} house of the Navamsa. `;
    if ([1,4,5,7,9,10].includes(sev.house)) html += 'This strong placement of Venus indicates a fulfilling marriage with harmony, love, and mutual respect. ';
    else if ([6,8,12].includes(sev.house)) html += 'Venus in a challenging house suggests the need for patience and understanding in marital relationships. ';

    const sevLord = RASHIS[(vargaChart.ascRashi.index + 6) % 12].lord;
    const slPl = pl[sevLord];
    if (slPl) {
      html += `The 7th lord of Navamsa is <b>${sevLord}</b> in <b>${slPl.rashi.eng}</b> (${ordinal(slPl.house)} house). `;
      html += `The spouse is likely to have qualities of ${slPl.rashi.eng} — ${RASHIS[slPl.rashi.index].element} element traits. `;
    }

    const jupN = pl.Jupiter;
    html += `<b>Jupiter</b> (karaka for husband) is in <b>${jupN.rashi.eng}</b> (${ordinal(jupN.house)} house). `;
    const moonN = pl.Moon;
    html += `<b>Moon</b> is in <b>${moonN.rashi.eng}</b> (${ordinal(moonN.house)} house), indicating the emotional quality of relationships.`;
    html += `</div></div>`;

    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F9D8;</span> Dharma & Spiritual Path</h3>`;
    html += `<div class="reading-body">`;
    html += `The Navamsa Lagna in <b>${vargaChart.ascRashi.eng}</b> reveals the native's deeper spiritual nature and dharmic path. `;
    const sunN = pl.Sun;
    html += `<b>Sun</b> (soul significator) is in <b>${sunN.rashi.eng}</b> (${ordinal(sunN.house)} house), showing where the soul seeks to express its purpose. `;
    const ninthLord = RASHIS[(vargaChart.ascRashi.index + 8) % 12].lord;
    const nlPl = pl[ninthLord];
    if (nlPl) html += `The 9th lord <b>${ninthLord}</b> in <b>${nlPl.rashi.eng}</b> shapes the path of dharma and spiritual evolution. `;
    html += `</div></div>`;
  }

  else if (vargaDiv === 10) { // Dashamsa — Career
    html += `<div class="reading-section"><h3><span class="rs-icon">&#127919;</span> Career & Professional Life</h3>`;
    html += `<div class="reading-body">`;
    const sun10 = pl.Sun;
    html += `<b>Sun</b> (authority, leadership) in <b>${sun10.rashi.eng}</b> (${ordinal(sun10.house)} house) of the Dashamsa. `;
    if ([1,10].includes(sun10.house)) html += 'Sun in a prominent house indicates strong leadership potential and recognition in career. ';

    const sat10 = pl.Saturn;
    html += `<b>Saturn</b> (career karaka) in <b>${sat10.rashi.eng}</b> (${ordinal(sat10.house)} house). `;
    if ([1,4,7,10].includes(sat10.house)) html += 'Saturn in a kendra of Dashamsa provides career stability and long-term professional growth. ';

    const tenthLord = RASHIS[(vargaChart.ascRashi.index + 9) % 12].lord;
    const t10Pl = pl[tenthLord];
    if (t10Pl) html += `<br><br>The 10th lord of Dashamsa is <b>${tenthLord}</b> in <b>${t10Pl.rashi.eng}</b> (${ordinal(t10Pl.house)} house), indicating the primary direction and quality of professional achievements.`;

    const mer10 = pl.Mercury;
    html += `<br><br><b>Mercury</b> (skills, communication) in <b>${mer10.rashi.eng}</b> (${ordinal(mer10.house)} house) shows intellectual capabilities in the professional domain.`;
    html += `</div></div>`;
  }

  else if (vargaDiv === 2) { // Hora — Wealth
    html += `<div class="reading-section"><h3><span class="rs-icon">&#128176;</span> Wealth & Financial Capacity</h3>`;
    html += `<div class="reading-body">`;
    html += `In the Hora chart, planets in <b>Sun's Hora (Leo)</b> indicate wealth earned through one's own effort, authority, and government/public sectors. Planets in <b>Moon's Hora (Cancer)</b> indicate wealth through public dealings, emotions, creativity, and nurturing professions.<br><br>`;
    const inSun = [], inMoon = [];
    ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'].forEach(p => {
      if (pl[p].rashi.index === 4) inSun.push(p);
      else if (pl[p].rashi.index === 3) inMoon.push(p);
    });
    if (inSun.length) html += `<b>In Sun's Hora (Leo):</b> ${inSun.join(', ')} — these planets generate wealth through self-effort, leadership, authority, and solar energy activities.<br>`;
    if (inMoon.length) html += `<b>In Moon's Hora (Cancer):</b> ${inMoon.join(', ')} — these planets generate wealth through emotional intelligence, public dealings, and nurturing professions.<br>`;
    const jup2 = pl.Jupiter;
    html += `<br><b>Jupiter</b> (wealth significator) is in <b>${jup2.rashi.eng}</b>. `;
    if (jup2.rashi.index === 4) html += 'Jupiter in Sun\'s Hora indicates wealth through wisdom, teaching, and advisory roles. ';
    else html += 'Jupiter in Moon\'s Hora suggests wealth through benevolence, spiritual pursuits, and public goodwill. ';
    html += `</div></div>`;
  }

  else if (vargaDiv === 3) { // Drekkana — Siblings & Courage
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F91D;</span> Siblings & Courage</h3>`;
    html += `<div class="reading-body">`;
    const mars3 = pl.Mars;
    html += `<b>Mars</b> (karaka of siblings and courage) in <b>${mars3.rashi.eng}</b> (${ordinal(mars3.house)} house) of the Drekkana. `;
    if ([1,4,5,7,9,10].includes(mars3.house)) html += 'Mars is well-placed, indicating harmonious sibling relationships, courage, and initiative. ';
    const thirdLord = RASHIS[(vargaChart.ascRashi.index + 2) % 12].lord;
    const tlPl = pl[thirdLord];
    if (tlPl) html += `The 3rd lord <b>${thirdLord}</b> in <b>${tlPl.rashi.eng}</b> (${ordinal(tlPl.house)} house) shapes the dynamic with siblings and one's enterprise.`;
    html += `</div></div>`;
  }

  else if (vargaDiv === 7) { // Saptamsa — Children
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F476;</span> Children & Progeny</h3>`;
    html += `<div class="reading-body">`;
    const jup7 = pl.Jupiter;
    html += `<b>Jupiter</b> (putrakaraka — children significator) in <b>${jup7.rashi.eng}</b> (${ordinal(jup7.house)} house) of the Saptamsa. `;
    if ([1,2,5,9,11].includes(jup7.house)) html += 'Jupiter is favorably placed, blessing the native with children and joy through progeny. ';
    const fifthLord = RASHIS[(vargaChart.ascRashi.index + 4) % 12].lord;
    const flPl = pl[fifthLord];
    if (flPl) html += `The 5th lord <b>${fifthLord}</b> in <b>${flPl.rashi.eng}</b> (${ordinal(flPl.house)} house) indicates the nature and fortune of children.`;
    html += `</div></div>`;
  }

  else if (vargaDiv === 4) { // Chaturthamsa — Property
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F3E0;</span> Property & Fixed Assets</h3>`;
    html += `<div class="reading-body">`;
    const mars4 = pl.Mars;
    html += `<b>Mars</b> (land karaka) in <b>${mars4.rashi.eng}</b> (${ordinal(mars4.house)} house) of the Chaturthamsa. `;
    const fourthLord = RASHIS[(vargaChart.ascRashi.index + 3) % 12].lord;
    const f4Pl = pl[fourthLord];
    if (f4Pl) html += `The 4th lord <b>${fourthLord}</b> in <b>${f4Pl.rashi.eng}</b> (${ordinal(f4Pl.house)} house) governs property acquisition and comforts. `;
    const ven4 = pl.Venus;
    html += `<b>Venus</b> (comfort) in <b>${ven4.rashi.eng}</b> (${ordinal(ven4.house)} house) indicates the quality of home comforts and vehicles.`;
    html += `</div></div>`;
  }

  else if (vargaDiv === 12) { // Dwadasamsa — Parents
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F9D3;</span> Parents & Ancestry</h3>`;
    html += `<div class="reading-body">`;
    const sun12 = pl.Sun;
    html += `<b>Sun</b> (father karaka) in <b>${sun12.rashi.eng}</b> (${ordinal(sun12.house)} house) — reveals the father's nature and influence. `;
    const moon12 = pl.Moon;
    html += `<b>Moon</b> (mother karaka) in <b>${moon12.rashi.eng}</b> (${ordinal(moon12.house)} house) — reveals the mother's nature and influence. `;
    const fourthLord12 = RASHIS[(vargaChart.ascRashi.index + 3) % 12].lord;
    const ninthLord12 = RASHIS[(vargaChart.ascRashi.index + 8) % 12].lord;
    html += `<br><br>4th lord (mother): <b>${fourthLord12}</b>. 9th lord (father): <b>${ninthLord12}</b>.`;
    html += `</div></div>`;
  }

  else { // Generic reading for other vargas
    html += `<div class="reading-section"><h3><span class="rs-icon">&#x1F52E;</span> Key Placements</h3>`;
    html += `<div class="reading-body">`;
    const keyPlanets = ['Sun','Moon','Jupiter','Venus','Saturn'];
    keyPlanets.forEach(p => {
      const vp = pl[p];
      html += `<b>${p}</b> in <b>${vp.rashi.eng}</b> (${ordinal(vp.house)} house). `;
    });
    const ascLord = vargaChart.ascRashi.lord;
    const alPl = pl[ascLord];
    if (alPl) html += `<br><br>The Lagna lord <b>${ascLord}</b> in the ${ordinal(alPl.house)} house shapes the overall direction of ${VARGA_INFO[vargaDiv]?.area || 'this varga'} matters.`;
    html += `</div></div>`;
  }

  return html;
}

// ---- VARSH PHAL RENDERING ----

function populateVarshYearSelector() {
  if (!currentChart) return;
  const [birthYear] = currentChart.birthInfo.dob.split('-').map(Number);
  const sel = document.getElementById('varshYearSelect');
  sel.innerHTML = '';
  const currentYear = new Date().getFullYear();
  const startYear = Math.max(birthYear + 1, currentYear - 5);
  const endYear = currentYear + 10;
  for (let y = startYear; y <= endYear; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    sel.appendChild(opt);
  }
}

function renderVarshPhal() {
  if (!currentChart) return;
  const year = parseInt(document.getElementById('varshYearSelect').value);
  if (!year) return;

  const loading = document.getElementById('varshPhalLoading');
  const content = document.getElementById('varshPhalContent');
  loading.style.display = 'block';
  content.innerHTML = '';

  // Use setTimeout to allow loading indicator to paint
  setTimeout(() => {
    try {
      currentVarshChart = calculateSolarReturnChart(currentChart, year);
      const html = buildVarshPhalContent(currentChart, currentVarshChart, year);
      content.innerHTML = html;
    } catch (e) {
      content.innerHTML = `<p style="color:var(--accent-red)">Error computing Varsh Phal: ${e.message}</p>`;
    }
    loading.style.display = 'none';
  }, 50);
}

function buildVarshPhalContent(natalChart, varshChart, year) {
  const vi = varshChart.varshInfo;
  const [birthYear] = natalChart.birthInfo.dob.split('-').map(Number);
  let html = '';

  // Solar Return Summary
  const srDate = vi.solarReturnDate;
  const dateStr = srDate.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const timeStr = srDate.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});

  html += `<div class="year-overview">
    <h3>&#x1F31E; Solar Return for ${year} (Age ${vi.age})</h3>
    <div class="overview-body">
      <b>Solar Return Date:</b> ${dateStr} at ${timeStr} (local time at birthplace)<br>
      <b>Varsh Lagna (Annual Ascendant):</b> ${varshChart.ascRashi.name} (${varshChart.ascRashi.eng}) — ${degToDMS(varshChart.ascendant % 30)}<br>
      <b>Muntha:</b> ${vi.muntha.sign.name} (${vi.muntha.sign.eng}) in ${ordinal(vi.muntha.house)} house<br>
      <b>Year Lord (Varshesh):</b> ${vi.yearLord} (ruler of ${vi.dayOfWeek})
    </div>
  </div>`;

  // Summary cards
  html += '<div class="varsh-summary">';

  // Year Lord card
  const ylPl = varshChart.planets[vi.yearLord];
  html += `<div class="varsh-card"><h4>&#x1F451; Year Lord: ${vi.yearLord}</h4>`;
  html += `<p>${vi.yearLord} is in ${ylPl.rashi.name} (${ylPl.rashi.eng}) in the ${ordinal(ylPl.house)} house of the annual chart.`;
  if ([1,4,5,7,9,10].includes(ylPl.house)) html += ' This is a strong placement indicating a favorable year overall.';
  else if ([6,8,12].includes(ylPl.house)) html += ' Placed in a dusthana, this suggests challenges to navigate this year.';
  html += '</p></div>';

  // Muntha card
  html += `<div class="varsh-card"><h4>&#x1F4CD; Muntha Position</h4>`;
  html += `<p>Muntha in ${vi.muntha.sign.name} (${ordinal(vi.muntha.house)} house).`;
  const munthLord = vi.muntha.sign.lord;
  const mlPl = varshChart.planets[munthLord];
  if (mlPl) {
    html += ` Muntha lord ${munthLord} is in ${mlPl.rashi.name} (${ordinal(mlPl.house)} house).`;
  }
  if ([1,4,7,10].includes(vi.muntha.house)) html += ' Muntha in a kendra is excellent for overall progress and prosperity.';
  else if ([5,9].includes(vi.muntha.house)) html += ' Muntha in a trikona brings good fortune, intelligence, and merit.';
  else if ([6,8,12].includes(vi.muntha.house)) html += ' Muntha in a dusthana suggests a year requiring effort and patience.';
  html += '</p></div>';

  // Annual Ascendant
  html += `<div class="varsh-card"><h4>&#x1F30C; Varsh Lagna Analysis</h4>`;
  html += `<p>The annual ascendant is ${varshChart.ascRashi.name} (${varshChart.ascRashi.eng}), ruled by ${varshChart.ascRashi.lord}.`;
  const ascLordPl = varshChart.planets[varshChart.ascRashi.lord];
  if (ascLordPl) {
    html += ` The annual Lagna lord is in ${ascLordPl.rashi.name} (${ordinal(ascLordPl.house)} house).`;
    if ([1,5,9].includes(ascLordPl.house)) html += ' This is very favorable for personal growth and fortune.';
  }
  html += '</p></div>';

  // Key Transits at SR moment
  html += `<div class="varsh-card"><h4>&#x2B50; Key Placements</h4><p>`;
  const jupH = varshChart.planets.Jupiter ? varshChart.planets.Jupiter.house : null;
  const satH = varshChart.planets.Saturn ? varshChart.planets.Saturn.house : null;
  if (jupH) html += `Jupiter in ${ordinal(jupH)} house. `;
  if (satH) html += `Saturn in ${ordinal(satH)} house. `;
  const venH = varshChart.planets.Venus ? varshChart.planets.Venus.house : null;
  if (venH) html += `Venus in ${ordinal(venH)} house. `;
  html += '</p></div>';
  html += '</div>';

  // Solar Return Chart
  html += '<div style="margin-top:8px">';
  html += '<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);font-size:1em;font-weight:600;margin-bottom:14px;text-align:center">Varsh Kundali (Solar Return Chart)</h4>';
  const svg = chartStyle === 'north'
    ? renderNorthIndianChart(varshChart)
    : renderSouthIndianChart(varshChart);
  html += `<div class="chart-container">${svg}</div>`;
  html += '</div>';

  // Planet positions table
  html += '<div style="overflow-x:auto;margin-top:20px"><table class="planets-table"><thead><tr>';
  html += '<th>Planet</th><th>Annual Sign</th><th>Natal Sign</th><th>Annual House</th></tr></thead><tbody>';
  const planets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  planets.forEach(p => {
    const vPl = varshChart.planets[p];
    const nPl = natalChart.planets[p];
    const color = PLANET_COLORS[p] || '#888';
    html += `<tr><td><span class="planet-symbol" style="background:${color};color:white">${PLANETS_INFO[p]?.symbol||p.substring(0,2)}</span><span class="planet-name">${p}</span></td>`;
    html += `<td>${vPl.rashi.name} (${vPl.rashi.eng})</td>`;
    html += `<td>${nPl.rashi.name} (${nPl.rashi.eng})</td>`;
    html += `<td>${ordinal(vPl.house)}</td></tr>`;
  });
  html += '</tbody></table></div>';

  // Planet-by-planet Annual Analysis
  html += '<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x2B50;</span> Planet-by-Planet Annual Analysis</div>';
  html += buildPlanetByPlanetAnalysis(natalChart, varshChart);
  html += '</div>';

  // Tajaka Yogas
  if (varshChart.tajakaYogas && varshChart.tajakaYogas.length > 0) {
    html += '<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#10038;</span> Tajaka Yogas</div>';
    varshChart.tajakaYogas.forEach(y => {
      html += `<div class="tajaka-yoga"><div class="ty-name">${y.name}</div><div class="ty-desc">${y.desc}</div></div>`;
    });
    html += '</div>';
  }

  // Detailed Muntha & Year Lord Analysis
  html += '<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F4DC;</span> Muntha & Year Lord Analysis</div>';
  html += buildMunthaYearLordReading(natalChart, varshChart);
  html += '</div>';

  // Annual Life Area Predictions
  html += '<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F52E;</span> Annual Predictions</div>';
  html += buildAnnualLifeAreas(natalChart, varshChart);
  html += '</div>';

  return html;
}

function buildPlanetByPlanetAnalysis(natalChart, varshChart) {
  const planets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  const planetSignifications = {
    Sun: {name:'Sun (Sūrya)', signifies:'soul, authority, father, government, vitality, career, self-expression',
      goodHouses:[1,5,9,10,11], badHouses:[6,8,12],
      goodText:'bestows confidence, recognition, authority, and success in career and public life',
      badText:'may bring challenges with authority figures, health concerns related to vitality, or ego conflicts'},
    Moon: {name:'Moon (Chandra)', signifies:'mind, emotions, mother, public image, mental peace, comfort',
      goodHouses:[1,4,5,7,9,10], badHouses:[6,8,12],
      goodText:'brings emotional stability, public popularity, mental peace, and nurturing relationships',
      badText:'may cause mental restlessness, emotional turbulence, or separation from comforts'},
    Mars: {name:'Mars (Maṅgala)', signifies:'courage, energy, siblings, property, competition, surgery',
      goodHouses:[3,6,10,11], badHouses:[2,4,7,8,12],
      goodText:'provides courage, competitive edge, victory over rivals, and physical energy',
      badText:'may bring conflicts, accidents, impulsive decisions, or disputes over property'},
    Mercury: {name:'Mercury (Budha)', signifies:'intellect, communication, business, education, wit, skills',
      goodHouses:[1,2,4,5,7,9,10,11], badHouses:[6,8,12],
      goodText:'enhances intellectual ability, communication skills, business acumen, and learning',
      badText:'may cause confusion in communication, nervous anxiety, or difficulties in commerce'},
    Jupiter: {name:'Jupiter (Guru)', signifies:'wisdom, expansion, fortune, children, spirituality, dharma',
      goodHouses:[1,2,4,5,7,9,10,11], badHouses:[3,6,8,12],
      goodText:'brings fortune, wisdom, spiritual growth, beneficial opportunities, and expansion',
      badText:'may lead to over-optimism, issues with guidance, or reduced fortune and blessings'},
    Venus: {name:'Venus (Śukra)', signifies:'love, marriage, luxury, art, beauty, vehicles, pleasures',
      goodHouses:[1,2,4,5,7,9,10,11], badHouses:[6,8,12],
      goodText:'brings romance, luxury, artistic success, financial gains, and harmonious partnerships',
      badText:'may cause relationship difficulties, excessive indulgence, or financial extravagance'},
    Saturn: {name:'Saturn (Śani)', signifies:'discipline, karma, longevity, hardship, service, structure',
      goodHouses:[3,6,10,11], badHouses:[1,4,5,7,8,12],
      goodText:'brings discipline, hard-earned rewards, structural accomplishments, and karmic maturity',
      badText:'may bring delays, obstacles, health issues, or feelings of isolation and heaviness'},
    Rahu: {name:'Rahu (North Node)', signifies:'ambition, illusion, foreign connections, unconventional paths, sudden events',
      goodHouses:[3,6,10,11], badHouses:[1,5,7,8,9,12],
      goodText:'brings sudden opportunities, worldly ambition, foreign connections, and breakthroughs',
      badText:'may cause confusion, deception, obsessive tendencies, or unexpected disruptions'},
    Ketu: {name:'Ketu (South Node)', signifies:'liberation, past karma, spirituality, detachment, mysticism',
      goodHouses:[3,6,9,12], badHouses:[1,2,4,5,7,8,10],
      goodText:'deepens spiritual awareness, brings liberation from past patterns, and intuitive insights',
      badText:'may cause detachment, confusion, losses, or disconnection from material pursuits'}
  };

  let html = '<div style="display:flex;flex-direction:column;gap:12px;margin-top:14px">';
  planets.forEach(p => {
    const vPl = varshChart.planets[p];
    const nPl = natalChart.planets[p];
    const info = planetSignifications[p];
    const color = PLANET_COLORS[p] || '#888';
    const symbol = PLANETS_INFO[p]?.symbol || p.substring(0,2);
    const dignity = getVargaDignity(p, vPl.rashi.index);
    const sameSign = vPl.rashi.index === nPl.rashi.index;

    html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:16px">`;
    html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">`;
    html += `<span class="planet-symbol" style="background:${color};color:white">${symbol}</span>`;
    html += `<strong style="font-family:Plus Jakarta Sans,sans-serif;color:var(--text)">${info.name}</strong>`;
    if (dignity !== '—') html += `<span style="margin-left:auto;font-size:0.85em">${dignity}</span>`;
    html += `</div>`;

    html += `<div style="font-size:0.9em;color:var(--text-dim);margin-bottom:6px">Signifies: ${info.signifies}</div>`;
    html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">`;
    html += `In the annual chart, ${p} is in <b>${vPl.rashi.name} (${vPl.rashi.eng})</b> in the <b>${ordinal(vPl.house)} house</b>`;
    if (sameSign) html += ` (same as natal position — reinforcing natal themes)`;
    else html += ` (natal: ${nPl.rashi.eng}, ${ordinal(nPl.house)} house)`;
    html += '. ';

    if (info.goodHouses.includes(vPl.house)) {
      html += `<span style="color:var(--accent-green)">${p} in the ${ordinal(vPl.house)} house ${info.goodText}.</span> `;
    } else if (info.badHouses.includes(vPl.house)) {
      html += `<span style="color:var(--accent-red)">${p} in the ${ordinal(vPl.house)} house ${info.badText}.</span> `;
    } else {
      html += `${p} in the ${ordinal(vPl.house)} house gives moderate results — neither strongly beneficial nor challenging. `;
    }

    // Check if planet is year lord
    if (varshChart.varshInfo && varshChart.varshInfo.yearLord === p) {
      html += `<b>As the Year Lord (Varshesh), ${p}'s results are amplified and will be the dominant influence throughout the year.</b> `;
    }

    // Check retrograde
    if (vPl.longitude !== undefined && nPl.longitude !== undefined) {
      const natalH = nPl.house;
      const annualH = vPl.house;
      if (natalH !== annualH) {
        html += `Moving from the natal ${ordinal(natalH)} house to the annual ${ordinal(annualH)} house shifts focus to new life areas. `;
      }
    }

    html += `</div></div>`;
  });
  html += '</div>';
  return html;
}

function buildMunthaYearLordReading(natalChart, varshChart) {
  const vi = varshChart.varshInfo;
  let html = '<div style="display:flex;flex-direction:column;gap:16px;margin-top:14px">';

  // Detailed Muntha analysis
  const munthaSign = vi.muntha.sign;
  const munthaHouse = vi.muntha.house;
  const munthaLord = munthaSign.lord;
  const munthaLordPl = varshChart.planets[munthaLord];

  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:16px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">&#x1F4CD; Muntha in ${munthaSign.name} (${munthaSign.eng}) — ${ordinal(munthaHouse)} House</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">`;
  html += `The Muntha progresses one sign per year from the natal ascendant. This year it falls in ${munthaSign.name} (${munthaSign.eng}), the ${ordinal(munthaHouse)} house of the annual chart. `;

  const munthaHouseReadings = {
    1: 'Muntha in the 1st house is highly auspicious — it enhances personal vitality, confidence, and initiative. This is an excellent year for new beginnings, personal projects, and self-improvement. You will feel more energetic and motivated.',
    2: 'Muntha in the 2nd house favors financial growth, family harmony, and accumulation of wealth. Speech becomes more influential. Good year for savings, investments, and building material security.',
    3: 'Muntha in the 3rd house boosts courage, communication, and short travels. Good for writing, media, sibling relationships, and entrepreneurial ventures. Initiative and effort bring rewards.',
    4: 'Muntha in the 4th house brings domestic happiness, property matters, and comfort from mother or homeland. Good year for real estate, home improvements, emotional security, and academic achievements.',
    5: 'Muntha in the 5th house is very favorable for creativity, romance, children, speculation, and intellectual pursuits. Spiritual merit increases. Good for education, artistic expression, and falling in love.',
    6: 'Muntha in the 6th house requires vigilance regarding health, debts, and conflicts. However, it can also mean victory over enemies and overcoming obstacles through persistent effort and discipline.',
    7: 'Muntha in the 7th house highlights partnerships, marriage, and business relationships. Good for contracts and collaborations, but may also bring some tension in close partnerships that requires diplomacy.',
    8: 'Muntha in the 8th house is considered challenging — it may bring unexpected changes, health concerns, or transformation. However, it also favors occult studies, research, and deep psychological growth.',
    9: 'Muntha in the 9th house is very auspicious — it enhances fortune, long-distance travel, higher education, spiritual growth, and guidance from teachers. Dharma (righteous path) is strengthened. Pilgrimages may occur.',
    10: 'Muntha in the 10th house is excellent for career advancement, public recognition, and professional achievement. Authority and status increase. This is one of the best placements for worldly success.',
    11: 'Muntha in the 11th house is highly favorable for gains, fulfillment of desires, networking, and income growth. Friends and elder siblings bring support. Social circle expands beneficially.',
    12: 'Muntha in the 12th house may bring increased expenses, foreign travels, or a period of withdrawal and introspection. However, it is excellent for spiritual practices, meditation, and letting go of attachments.'
  };
  html += munthaHouseReadings[munthaHouse] || '';

  if (munthaLordPl) {
    html += `<br><br><b>Muntha Lord ${munthaLord}</b> is placed in ${munthaLordPl.rashi.eng} (${ordinal(munthaLordPl.house)} house). `;
    if ([1,4,5,7,9,10].includes(munthaLordPl.house)) {
      html += `The Muntha lord in a strong house enhances the positive effects of the Muntha — the year's theme indicated by the Muntha will manifest favorably.`;
    } else if ([6,8,12].includes(munthaLordPl.house)) {
      html += `The Muntha lord in a dusthana somewhat weakens the Muntha's potential — extra effort may be needed to realize the Muntha's promises.`;
    } else {
      html += `The Muntha lord is in a neutral house, giving mixed results related to the Muntha's house themes.`;
    }
  }
  html += `</div></div>`;

  // Detailed Year Lord analysis
  const yearLord = vi.yearLord;
  const ylPl = varshChart.planets[yearLord];
  const ylNatal = natalChart.planets[yearLord];

  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:16px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">&#x1F451; Year Lord (Varshesh): ${yearLord}</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">`;
  html += `The Year Lord is determined by the day of the week on which the solar return falls (${vi.dayOfWeek}). ${yearLord} as Varshesh governs the overall tone and direction of the year. `;

  const yearLordReadings = {
    Sun: 'The Sun as Year Lord brings a year focused on authority, leadership, self-expression, and dealings with government or powerful figures. Vitality and confidence are highlighted. Father or father-figures play an important role.',
    Moon: 'The Moon as Year Lord brings a year centered on emotions, public life, nurturing, and changes. Mental state fluctuates with the Moon\'s phases. Mother, home, and emotional connections are important themes.',
    Mars: 'Mars as Year Lord brings a year of action, courage, competition, and energy. Property matters, sibling relationships, and physical activities are prominent. Guard against impulsiveness and conflicts.',
    Mercury: 'Mercury as Year Lord brings a year focused on intellect, communication, learning, business, and adaptability. Education, writing, commerce, and social networking are highlighted themes.',
    Jupiter: 'Jupiter as Year Lord is considered highly auspicious — it brings expansion, wisdom, good fortune, children, spiritual growth, and beneficial guidance. This is often one of the best Year Lords to have.',
    Venus: 'Venus as Year Lord brings a year of pleasures, romance, art, luxury, vehicles, and material comforts. Relationships, beauty, and creative pursuits are favored. Financial prosperity is likely.',
    Saturn: 'Saturn as Year Lord brings a year requiring discipline, patience, and hard work. Results come through persistent effort. Structure, responsibility, and karmic lessons are the dominant themes.'
  };
  html += yearLordReadings[yearLord] || '';

  if (ylPl) {
    html += `<br><br>In the annual chart, ${yearLord} is in <b>${ylPl.rashi.eng} (${ordinal(ylPl.house)} house)</b>. `;
    if ([1,4,5,7,9,10].includes(ylPl.house)) {
      html += `This strong placement of the Year Lord in a kendra or trikona indicates a generally favorable and productive year with visible results.`;
    } else if ([6,8,12].includes(ylPl.house)) {
      html += `The Year Lord in a dusthana suggests the year may require overcoming obstacles — persistence and faith will be important.`;
    } else if ([2,11].includes(ylPl.house)) {
      html += `The Year Lord in a wealth house bodes well for financial gains and material accumulation this year.`;
    } else {
      html += `The Year Lord in the ${ordinal(ylPl.house)} house gives mixed results that depend on supporting factors in the annual chart.`;
    }
    // Check dignity
    const ylDignity = getVargaDignity(yearLord, ylPl.rashi.index);
    if (ylDignity.includes('Exalted')) html += ' Being exalted greatly amplifies the Year Lord\'s benefic potential.';
    else if (ylDignity.includes('Own')) html += ' Being in own sign, the Year Lord is strong and delivers its promises effectively.';
    else if (ylDignity.includes('Debilitated')) html += ' Being debilitated, the Year Lord\'s ability to deliver results is weakened — remedial measures are recommended.';
  }
  html += `</div></div>`;

  // Comparison: Annual vs Natal lagna
  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:16px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">&#x1F300; Varsh Lagna vs Natal Lagna</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">`;
  const natalAsc = natalChart.ascRashi;
  const annualAsc = varshChart.ascRashi;
  const lagnaRelation = ((annualAsc.index - natalAsc.index + 12) % 12) + 1;
  html += `Natal Ascendant: <b>${natalAsc.name} (${natalAsc.eng})</b> — Annual Ascendant: <b>${annualAsc.name} (${annualAsc.eng})</b>. `;
  html += `The annual ascendant falls in the ${ordinal(lagnaRelation)} house from the natal ascendant. `;

  const lagnaRelationReadings = {
    1: 'Same as natal lagna — a year of reinforcement of natal themes, personal identity, and continuation of existing patterns. Strong self-focus.',
    2: 'Annual lagna in 2nd from natal — emphasis on finances, family, speech, and accumulated resources. A year of building material security.',
    3: 'Annual lagna in 3rd from natal — emphasis on courage, communication, short journeys, and self-effort. Siblings may feature prominently.',
    4: 'Annual lagna in 4th from natal — emphasis on home, mother, emotional peace, education, and property. Inner contentment is the theme.',
    5: 'Annual lagna in 5th from natal — emphasis on creativity, romance, children, speculation, and intellectual pursuits. A joyful and creative year.',
    6: 'Annual lagna in 6th from natal — emphasis on health, service, competition, and overcoming obstacles. Effort-driven year with potential health focus.',
    7: 'Annual lagna in 7th from natal — emphasis on partnerships, marriage, business relationships, and public dealings. Others play a key role this year.',
    8: 'Annual lagna in 8th from natal — a transformative year emphasizing change, hidden matters, research, and regeneration. Intense but potentially deeply rewarding.',
    9: 'Annual lagna in 9th from natal — a fortunate placement emphasizing luck, higher learning, travel, and spiritual growth. Guidance from teachers or mentors.',
    10: 'Annual lagna in 10th from natal — emphasis on career, status, public achievement, and ambition. One of the best placements for professional success.',
    11: 'Annual lagna in 11th from natal — emphasis on gains, friendships, networking, and fulfillment of desires. A year of social expansion and profit.',
    12: 'Annual lagna in 12th from natal — emphasis on foreign lands, expenses, spiritual retreat, and endings. Good for inner work and letting go.'
  };
  html += lagnaRelationReadings[lagnaRelation] || '';
  html += `</div></div>`;

  html += '</div>';
  return html;
}

function buildAnnualLifeAreas(natalChart, varshChart) {
  const vi = varshChart.varshInfo;
  let html = '<div style="display:flex;flex-direction:column;gap:14px;margin-top:14px">';

  const jupAH = varshChart.planets.Jupiter ? varshChart.planets.Jupiter.house : 0;
  const satAH = varshChart.planets.Saturn ? varshChart.planets.Saturn.house : 0;
  const venAH = varshChart.planets.Venus ? varshChart.planets.Venus.house : 0;
  const moonAH = varshChart.planets.Moon ? varshChart.planets.Moon.house : 0;
  const marsAH = varshChart.planets.Mars ? varshChart.planets.Mars.house : 0;
  const sunAH = varshChart.planets.Sun ? varshChart.planets.Sun.house : 0;
  const mercAH = varshChart.planets.Mercury ? varshChart.planets.Mercury.house : 0;
  const rahuAH = varshChart.planets.Rahu ? varshChart.planets.Rahu.house : 0;
  const ketuAH = varshChart.planets.Ketu ? varshChart.planets.Ketu.house : 0;

  // Career & Profession
  const tenthLord = RASHIS[(varshChart.ascRashi.index + 9) % 12].lord;
  const tenthLordPl = varshChart.planets[tenthLord];
  const sixthLord = RASHIS[(varshChart.ascRashi.index + 5) % 12].lord;
  const sixthLordPl = varshChart.planets[sixthLord];
  html += `<div class="year-area"><h4><span>&#127919;</span> Career &amp; Profession</h4>`;
  html += `<div class="area-body">`;
  html += `The 10th lord of the annual chart is <b>${tenthLord}</b>`;
  if (tenthLordPl) html += ` placed in ${tenthLordPl.rashi.eng} (${ordinal(tenthLordPl.house)} house)`;
  html += '. ';
  if ([1,4,7,10].includes(satAH)) html += 'Saturn in a kendra of the annual chart stabilizes career and brings structural growth. ';
  else if (satAH === 10) html += 'Saturn directly in the 10th house brings heavy professional responsibility but also recognition through hard work. ';
  if (tenthLordPl && [1,4,5,7,9,10].includes(tenthLordPl.house)) html += 'The 10th lord is well-placed, indicating career advancement, recognition, and professional fulfillment. ';
  else if (tenthLordPl && [6,8,12].includes(tenthLordPl.house)) html += 'The 10th lord in a challenging house suggests career transitions, workplace conflicts, or the need to adapt professionally. ';
  if (sunAH === 10) html += 'The Sun in the 10th house strongly favors authority, leadership roles, and government dealings. ';
  else if (sunAH === 1) html += 'The Sun in the 1st house enhances personal charisma and leadership qualities visible to the public. ';
  if (jupAH === 10) html += 'Jupiter in the 10th house is excellent for career growth, ethical business, and gaining wisdom through profession. ';
  if (rahuAH === 10) html += 'Rahu in the 10th house brings ambitious career moves and unconventional professional opportunities — but guard against shortcuts. ';
  if (sixthLordPl && [6,12].includes(sixthLordPl.house)) html += 'The 6th lord is well-placed, suggesting victory over workplace competition and rivals. ';
  // Summary rating
  let careerScore = 0;
  if (tenthLordPl && [1,4,5,7,9,10,11].includes(tenthLordPl.house)) careerScore += 2;
  if ([1,4,7,10].includes(satAH)) careerScore += 1;
  if (sunAH === 10 || jupAH === 10) careerScore += 2;
  if (tenthLordPl && [6,8,12].includes(tenthLordPl.house)) careerScore -= 1;
  html += `<br><b>Career outlook:</b> ${careerScore >= 3 ? 'Very Favorable' : careerScore >= 1 ? 'Favorable' : careerScore >= 0 ? 'Moderate' : 'Challenging — requires extra effort'}.`;
  html += '</div></div>';

  // Finance & Wealth
  const secondLord = RASHIS[(varshChart.ascRashi.index + 1) % 12].lord;
  const secPl = varshChart.planets[secondLord];
  const eleventhLord = RASHIS[(varshChart.ascRashi.index + 10) % 12].lord;
  const elevenPl = varshChart.planets[eleventhLord];
  html += `<div class="year-area"><h4><span>&#128176;</span> Finance &amp; Wealth</h4>`;
  html += `<div class="area-body">`;
  html += `The 2nd lord (wealth) is <b>${secondLord}</b>`;
  if (secPl) html += ` in ${secPl.rashi.eng} (${ordinal(secPl.house)} house)`;
  html += '. ';
  html += `The 11th lord (gains) is <b>${eleventhLord}</b>`;
  if (elevenPl) html += ` in ${elevenPl.rashi.eng} (${ordinal(elevenPl.house)} house)`;
  html += '. ';
  if (vi.muntha.house === 2 || vi.muntha.house === 11) html += 'Muntha in a wealth house significantly enhances financial prospects this year. ';
  if ([2,5,9,11].includes(jupAH)) html += 'Jupiter\'s placement in a favorable house strongly supports wealth accumulation and financial wisdom. ';
  if ([2,11].includes(venAH)) html += 'Venus in a wealth house brings income through luxuries, art, or partnerships. ';
  if (secPl && [1,2,5,9,10,11].includes(secPl.house)) html += 'The 2nd lord is well-placed, favoring income stability and savings. ';
  else if (secPl && [6,8,12].includes(secPl.house)) html += 'The 2nd lord in a difficult house warns of unexpected expenses or financial strain — budgeting is advised. ';
  if (elevenPl && [1,2,5,9,10,11].includes(elevenPl.house)) html += 'The 11th lord well-placed ensures gains and income growth. ';
  if (rahuAH === 2) html += 'Rahu in the 2nd house may bring sudden financial opportunities but also speculative risks. ';
  if (rahuAH === 11) html += 'Rahu in the 11th house can bring large unconventional gains but also unreliable income sources. ';
  // Summary rating
  let finScore = 0;
  if (secPl && [1,2,5,9,10,11].includes(secPl.house)) finScore += 2;
  if ([2,5,9,11].includes(jupAH)) finScore += 2;
  if (vi.muntha.house === 2 || vi.muntha.house === 11) finScore += 1;
  if (secPl && [6,8,12].includes(secPl.house)) finScore -= 1;
  html += `<br><b>Financial outlook:</b> ${finScore >= 3 ? 'Very Favorable' : finScore >= 1 ? 'Favorable' : finScore >= 0 ? 'Moderate' : 'Challenging — caution with spending advised'}.`;
  html += '</div></div>';

  // Relationships & Family
  const seventhLord = RASHIS[(varshChart.ascRashi.index + 6) % 12].lord;
  const sevPl = varshChart.planets[seventhLord];
  const fourthLord = RASHIS[(varshChart.ascRashi.index + 3) % 12].lord;
  const fourthPl = varshChart.planets[fourthLord];
  html += `<div class="year-area"><h4><span>&#10084;&#65039;</span> Relationships &amp; Family</h4>`;
  html += `<div class="area-body">`;
  html += `The 7th lord (partnerships) is <b>${seventhLord}</b>`;
  if (sevPl) html += ` in ${sevPl.rashi.eng} (${ordinal(sevPl.house)} house)`;
  html += '. ';
  if ([1,5,7,9].includes(venAH)) html += 'Venus is well-placed for harmonious relationships, romance, and social pleasures. ';
  else if ([6,8,12].includes(venAH)) html += 'Venus in a challenging house may bring tension in romantic or social relationships. ';
  if ([4,7].includes(moonAH)) html += 'The Moon in an angular house supports emotional fulfillment and family connections. ';
  if (moonAH === 1) html += 'The Moon in the 1st house highlights emotional sensitivity and nurturing this year. ';
  if (sevPl && [1,4,5,7,9,10].includes(sevPl.house)) html += 'The 7th lord is well-placed, favoring marriage, partnerships, and harmonious alliances. ';
  else if (sevPl && [6,8,12].includes(sevPl.house)) html += 'The 7th lord in a difficult house warns of misunderstandings or separations in partnerships — patience and communication are key. ';
  html += `The 4th lord (domestic happiness) is <b>${fourthLord}</b>`;
  if (fourthPl) {
    html += ` in the ${ordinal(fourthPl.house)} house. `;
    if ([1,4,5,9,10].includes(fourthPl.house)) html += 'Good domestic harmony and comfort at home. ';
    else if ([6,8,12].includes(fourthPl.house)) html += 'Some domestic unrest or challenges at home may arise. ';
  } else { html += '. '; }
  if (rahuAH === 7) html += 'Rahu in the 7th house may bring unconventional partnerships or foreign connections. ';
  // Summary rating
  let relScore = 0;
  if (sevPl && [1,4,5,7,9,10].includes(sevPl.house)) relScore += 2;
  if ([1,5,7,9].includes(venAH)) relScore += 2;
  if ([4,7].includes(moonAH)) relScore += 1;
  if (sevPl && [6,8,12].includes(sevPl.house)) relScore -= 1;
  html += `<br><b>Relationship outlook:</b> ${relScore >= 3 ? 'Very Favorable' : relScore >= 1 ? 'Favorable' : relScore >= 0 ? 'Moderate' : 'Requires patience and effort'}.`;
  html += '</div></div>';

  // Health & Vitality
  const ascLord = varshChart.ascRashi.lord;
  const ascLordPl = varshChart.planets[ascLord];
  const eighthLord = RASHIS[(varshChart.ascRashi.index + 7) % 12].lord;
  const eighthPl = varshChart.planets[eighthLord];
  html += `<div class="year-area"><h4><span>&#128154;</span> Health &amp; Vitality</h4>`;
  html += `<div class="area-body">`;
  if (ascLordPl) {
    html += `The Varsh Lagna lord <b>${ascLord}</b> is in the ${ordinal(ascLordPl.house)} house. `;
    if ([1,5,9].includes(ascLordPl.house)) html += 'This strong placement indicates good vitality, physical well-being, and overall resilience this year. ';
    else if ([6,8,12].includes(ascLordPl.house)) html += 'Lagna lord in a challenging house suggests paying extra attention to health — regular check-ups and healthy lifestyle are recommended. ';
    else if ([4,7,10].includes(ascLordPl.house)) html += 'Lagna lord in a kendra gives moderate health with good recovery ability. ';
  }
  if (marsAH === 1) html += 'Mars in the Lagna gives abundant physical energy but may bring minor injuries or inflammatory conditions. ';
  if (marsAH === 6) html += 'Mars in the 6th house gives energy to fight diseases and overcome health challenges. ';
  if (satAH === 1 || satAH === 8) html += 'Saturn influencing the health axis may bring chronic conditions or low vitality — pace yourself and rest adequately. ';
  if (sunAH === 1) html += 'Sun in the 1st house strengthens constitution and vitality. ';
  if (moonAH === 6 || moonAH === 8) html += 'The Moon in the 6th or 8th house warns of emotional or psychosomatic health concerns — stress management is important. ';
  if (sixthLordPl && [1,8].includes(sixthLordPl.house)) html += 'The 6th lord (disease) connecting with the 1st or 8th house suggests vulnerability — preventive care is strongly advised. ';
  if (eighthPl && [1,6].includes(eighthPl.house)) html += 'The 8th lord influencing the body or disease house calls for extra health vigilance. ';
  if (jupAH === 1) html += 'Jupiter in the 1st house protects health and gives a generally robust constitution. ';
  // Summary
  let healthScore = 0;
  if (ascLordPl && [1,4,5,7,9,10].includes(ascLordPl.house)) healthScore += 2;
  if (jupAH === 1) healthScore += 2;
  if (ascLordPl && [6,8,12].includes(ascLordPl.house)) healthScore -= 1;
  if (satAH === 1 || satAH === 8) healthScore -= 1;
  html += `<br><b>Health outlook:</b> ${healthScore >= 3 ? 'Very Good' : healthScore >= 1 ? 'Good' : healthScore >= 0 ? 'Moderate — maintain healthy habits' : 'Requires attention — prioritize well-being'}.`;
  html += '</div></div>';

  // Education & Learning
  const fifthLord = RASHIS[(varshChart.ascRashi.index + 4) % 12].lord;
  const fifthPl = varshChart.planets[fifthLord];
  html += `<div class="year-area"><h4><span>&#128218;</span> Education &amp; Learning</h4>`;
  html += `<div class="area-body">`;
  html += `The 5th lord (intellect, education) is <b>${fifthLord}</b>`;
  if (fifthPl) html += ` in ${fifthPl.rashi.eng} (${ordinal(fifthPl.house)} house)`;
  html += '. ';
  if (fifthPl && [1,4,5,9,10].includes(fifthPl.house)) html += 'Well-placed 5th lord favors academic success, creative learning, and intellectual achievements. ';
  else if (fifthPl && [6,8,12].includes(fifthPl.house)) html += 'The 5th lord in a challenging house suggests difficulties with studies or creative blocks — extra effort is needed. ';
  if ([1,4,5,9].includes(mercAH)) html += 'Mercury well-placed enhances communication skills, analytical thinking, and academic performance. ';
  if ([1,5,9].includes(jupAH)) html += 'Jupiter in a trikona expands wisdom, promotes higher learning, and supports teaching abilities. ';
  if (ketuAH === 5) html += 'Ketu in the 5th house may bring unique or unconventional learning experiences, spiritual education, or intuitive insights. ';
  html += '</div></div>';

  // Travel & Relocation
  const thirdLord = RASHIS[(varshChart.ascRashi.index + 2) % 12].lord;
  const thirdPl = varshChart.planets[thirdLord];
  const twelfthLord = RASHIS[(varshChart.ascRashi.index + 11) % 12].lord;
  const twelfthPl = varshChart.planets[twelfthLord];
  const ninthLord = RASHIS[(varshChart.ascRashi.index + 8) % 12].lord;
  const ninthPl = varshChart.planets[ninthLord];
  html += `<div class="year-area"><h4><span>&#9992;&#65039;</span> Travel &amp; Relocation</h4>`;
  html += `<div class="area-body">`;
  if (thirdPl) {
    html += `The 3rd lord (short travels) ${thirdLord} is in the ${ordinal(thirdPl.house)} house. `;
    if ([3,9,12].includes(thirdPl.house)) html += 'Short travels and local journeys are very likely this year. ';
  }
  if (ninthPl) {
    html += `The 9th lord (long journeys) ${ninthLord} is in the ${ordinal(ninthPl.house)} house. `;
    if ([3,7,9,12].includes(ninthPl.house)) html += 'Long-distance travel or pilgrimage is indicated. ';
  }
  if (rahuAH === 9 || rahuAH === 12) html += 'Rahu in the 9th or 12th house strongly suggests foreign travel or overseas connections this year. ';
  if ([9,12].includes(jupAH)) html += 'Jupiter\'s placement supports auspicious journeys and travel for spiritual or educational purposes. ';
  if (twelfthPl && [3,9,12].includes(twelfthPl.house)) html += 'The 12th lord\'s placement encourages overseas travel or relocation. ';
  html += '</div></div>';

  // Spirituality
  html += `<div class="year-area"><h4><span>&#128992;</span> Spiritual Growth</h4>`;
  html += `<div class="area-body">`;
  if (ninthPl) html += `The 9th lord (dharma) ${ninthLord} is in ${ninthPl.rashi.eng} (${ordinal(ninthPl.house)} house). `;
  if (ninthPl && [1,5,9].includes(ninthPl.house)) html += 'The 9th lord in a trikona greatly enhances spiritual growth, religious activities, and connection with teachers. ';
  if ([5,9,12].includes(ketuAH)) html += 'Ketu in a spiritual house deepens meditative practices, detachment, and self-discovery. ';
  if ([5,9,12].includes(jupAH)) html += 'Jupiter in a dharma or moksha house enhances spiritual wisdom, philosophical growth, and devotional practices. ';
  if (moonAH === 12) html += 'The Moon in the 12th house deepens inner contemplation and dream experiences. ';
  if (sunAH === 9) html += 'The Sun in the 9th house illuminates the path of dharma and brings inspiration from father figures or gurus. ';
  if (vi.muntha.house === 9 || vi.muntha.house === 12) html += 'Muntha in a spiritual house makes this a year of significant inner transformation and spiritual progress. ';
  html += '</div></div>';

  html += '</div>';
  return html;
}

function renderChartReading() {
  if (!currentChart) return;
  const sections = generateChartReading(currentChart);
  let html = '';
  sections.forEach(s => {
    html += `<div class="reading-section">
      <h3><span class="rs-icon">${s.icon}</span> ${s.title}</h3>
      <div class="reading-body">${s.content}</div>
    </div>`;
  });
  document.getElementById('chartReadingContainer').innerHTML = html;
}

function renderPlanetsTable() {
  const c = currentChart;
  let html = `<thead><tr>
    <th>Planet</th><th>Sign</th><th>Degree</th><th>Nakshatra</th><th>Pada</th><th>House</th>
  </tr></thead><tbody>`;

  // Add Ascendant row
  const ascR = c.ascRashi;
  const ascNak = getNakshatra(c.ascendant);
  html += `<tr>
    <td><span class="planet-symbol" style="background:rgba(212,113,10,0.1);color:#D4710A">Asc</span><span class="planet-name">Ascendant</span></td>
    <td>${ascR.symbol} ${ascR.eng}</td>
    <td>${degToDMS(ascR.degrees)}</td>
    <td><span class="nakshatra-badge">${ascNak.name}</span></td>
    <td>${ascNak.currentPada}</td>
    <td>1</td>
  </tr>`;

  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];
  planetOrder.forEach(pName => {
    const p = c.planets[pName];
    const info = PLANETS_INFO[pName];
    const color = PLANET_COLORS[pName];
    html += `<tr>
      <td><span class="planet-symbol" style="background:${color}22;color:${color}">${info.symbol}</span><span class="planet-name">${info.sanskrit} (${pName})</span></td>
      <td>${p.rashi.symbol} ${p.rashi.eng}</td>
      <td>${degToDMS(p.rashi.degrees)}</td>
      <td><span class="nakshatra-badge">${p.nakshatra.name}</span></td>
      <td>${p.nakshatra.currentPada}</td>
      <td>${p.house}</td>
    </tr>`;
  });

  html += '</tbody>';
  document.getElementById('planetsTable').innerHTML = html;

  // Render Yogas
  let yogaHtml = '';
  c.yogas.forEach(y => {
    yogaHtml += `<div class="yoga-item">
      <div class="yoga-name">${y.name}</div>
      <div class="yoga-desc">${y.desc}</div>
    </div>`;
  });
  document.getElementById('yogaList').innerHTML = yogaHtml;
}

function renderDasha() {
  if (!currentChart) return;
  const granularity = document.getElementById('dashaGranularity').value;
  const c = currentChart;
  const now = new Date();
  const birthDate = new Date(c.birthInfo.dob + 'T' + c.birthInfo.tob);

  // Populate age selector
  const ageSelect = document.getElementById('dashaAge');
  if (ageSelect.options.length <= 1) {
    ageSelect.innerHTML = '<option value="">Current</option>';
    for (let age = 0; age <= 100; age += 10) {
      ageSelect.innerHTML += `<option value="${age}">Age ${age}</option>`;
    }
  }

  let html = '';
  c.dashas.forEach((md, mdIdx) => {
    const isCurrent = now >= md.startDate && now < md.endDate;
    const mdColor = PLANET_COLORS[md.lord] || '#2D2B3D';
    const ageAtStart = ((md.startDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);
    const ageAtEnd = ((md.endDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);

    html += `<div class="dasha-period ${isCurrent ? 'current' : ''}" id="md-${mdIdx}">
      <div class="dasha-header ${isCurrent ? 'current' : ''}" onclick="toggleDasha(this)">
        <div>
          <span class="dasha-planet" style="color:${mdColor}">${PLANETS_INFO[md.lord].symbol} ${md.lord} Mahadasha</span>
          <span style="font-size:0.78em;color:var(--text-dim);margin-left:8px">(Age ${ageAtStart} — ${ageAtEnd})</span>
          ${isCurrent ? '<span style="font-size:0.7em;background:rgba(212,113,10,0.1);color:var(--saffron);padding:2px 8px;border-radius:8px;margin-left:8px;font-weight:600">CURRENT</span>' : ''}
        </div>
        <span class="dasha-dates">${formatDate(md.startDate)} — ${formatDate(md.endDate)}</span>
      </div>
      <div class="dasha-body ${isCurrent ? 'open' : ''}">
        <div style="font-family:'Newsreader',serif;font-size:1.02em;line-height:1.7">${generateDashaPrediction(c, md.lord)}</div>`;

    if (granularity !== 'maha') {
      html += '<div class="sub-dasha"><strong style="color:var(--indigo-light);font-size:0.82em;text-transform:uppercase;letter-spacing:1px;display:block;margin:16px 0 8px">Antardashas (Sub-Periods)</strong>';
      md.antardashas.forEach(ad => {
        const isAdCurrent = now >= ad.startDate && now < ad.endDate;
        const adColor = PLANET_COLORS[ad.lord] || '#2D2B3D';
        const adPred = generateAntarPrediction(c, md.lord, ad.lord);
        html += `<div class="sub-dasha-item ${isAdCurrent ? 'current' : ''}" style="margin-bottom:6px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="color:${adColor};font-weight:500">${PLANETS_INFO[ad.lord].symbol} ${md.lord}/${ad.lord}</span>
            <span style="color:var(--text-dim);font-size:0.82em">${formatDate(ad.startDate)} — ${formatDate(ad.endDate)}</span>
          </div>
          <div style="font-family:'Newsreader',serif;font-size:0.92em;line-height:1.6;color:var(--text-dim);margin:4px 0 8px;padding-left:4px">${adPred}</div>
        </div>`;

        if (granularity === 'pratyantar' && ad.pratyantardashas) {
          ad.pratyantardashas.forEach(pad => {
            const isPadCurrent = now >= pad.startDate && now < pad.endDate;
            const padColor = PLANET_COLORS[pad.lord] || '#2D2B3D';
            html += `<div class="sub-dasha-item ${isPadCurrent ? 'current' : ''}" style="padding-left:28px;font-size:0.78em">
              <span style="color:${padColor}">${md.lord}/${ad.lord}/${pad.lord}</span>
              <span style="color:var(--text-dim)">${formatDate(pad.startDate)} — ${formatDate(pad.endDate)}</span>
            </div>`;
          });
        }
      });
      html += '</div>';
    }

    html += '</div></div>';
  });

  document.getElementById('dashaTimeline').innerHTML = html;
}

function renderTransits() {
  if (!currentChart) return;
  const now = new Date();
  const utcH = now.getUTCHours() + now.getUTCMinutes() / 60;
  const jdNow = julianDay(now.getFullYear(), now.getMonth() + 1, now.getDate(), utcH);
  const transitPlanets = calculatePlanets(jdNow);

  let html = '';
  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];
  planetOrder.forEach(pName => {
    const tLon = transitPlanets[pName];
    const tRashi = getRashi(tLon);
    const tHouse = getHouse(tLon, currentChart.ascendant);
    const info = PLANETS_INFO[pName];
    const color = PLANET_COLORS[pName];
    const effect = TRANSIT_HOUSE_EFFECTS[pName][tHouse - 1] || "General influence on this house.";

    html += `<div class="transit-card">
      <div class="transit-planet" style="color:${color}">${info.symbol} ${info.sanskrit} (${pName})</div>
      <div class="transit-sign">${tRashi.symbol} ${tRashi.eng} at ${degToDMS(tRashi.degrees)}</div>
      <div class="transit-house">Transiting your ${ordinal(tHouse)} House</div>
      <div class="transit-effect">${effect}</div>
    </div>`;
  });

  document.getElementById('transitGrid').innerHTML = html;

  // Enhanced transit reading (Sade Sati, major transits analysis)
  const transitReadings = generateTransitReading(currentChart, transitPlanets);
  let alertsHtml = '';
  let deepHtml = '';

  transitReadings.forEach(r => {
    if (r.type === 'sadeSati') {
      alertsHtml += `<div class="transit-alert high">
        <h4>\u26A0 ${r.title}</h4>
        <p>${r.content}</p>
      </div>`;
    } else {
      deepHtml += `<div class="transit-alert normal">
        <h4>${r.title}</h4>
        <p>${r.content}</p>
      </div>`;
    }
  });

  document.getElementById('transitAlerts').innerHTML = alertsHtml;
  document.getElementById('transitDeepReading').innerHTML =
    deepHtml ? '<div class="section-title" style="font-size:1em;margin-bottom:12px"><span class="icon">&#x1F52D;</span> Detailed Transit Analysis</div>' + deepHtml : '';
}

function populateYearSelector() {
  const sel = document.getElementById('yearSelect');
  if (!currentChart) return;
  sel.innerHTML = '';
  const now = new Date();
  const currentYear = now.getFullYear();
  // Find the range from dasha data
  const firstDasha = currentChart.dashas[0];
  const lastDasha = currentChart.dashas[currentChart.dashas.length - 1];
  const birthYear = firstDasha.startDate.getFullYear();
  const endYear = Math.min(lastDasha.endDate.getFullYear(), birthYear + 100);
  // Show years from 5 years ago to 10 years from now as the default visible range,
  // but allow full dasha range
  for (let y = birthYear; y <= endYear; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    sel.appendChild(opt);
  }
  renderYearPrediction();
}

function renderYearPrediction() {
  if (!currentChart) return;
  const year = parseInt(document.getElementById('yearSelect').value);
  if (!year) return;

  const pred = generateYearPrediction(currentChart, year);

  // Update dasha label
  const dashaLabel = document.getElementById('yearDashaLabel');
  if (pred.yearMDs.length > 0) {
    const mdNames = pred.yearMDs.map(m => m.lord).join(' → ');
    dashaLabel.textContent = `Mahadasha: ${mdNames}`;
  }

  let html = '';

  // Year Overview
  html += `<div class="year-overview">
    <h3>&#x1F52E; ${year} — Year Overview</h3>
    <div class="overview-body">${pred.overview}</div>
  </div>`;

  // Quarterly Breakdown
  html += `<div class="section-title" style="margin-top:8px;margin-bottom:-12px"><span class="icon">&#x1F4C5;</span> Quarterly Breakdown</div>`;
  pred.quarterPredictions.forEach(q => {
    html += `<div class="quarter-card">
      <h4>${q.label}</h4>
      <div class="q-dasha">${q.md} / ${q.ad}</div>
      <div class="q-body">${q.prediction}</div>
    </div>`;
  });

  // Life Area Forecasts
  html += `<div class="section-title" style="margin-top:8px;margin-bottom:-12px"><span class="icon">&#x1F3AF;</span> Life Area Forecasts</div>`;
  pred.areas.forEach(a => {
    html += `<div class="year-area">
      <h4><span>${a.icon}</span> ${a.title}</h4>
      <div class="area-body">${a.content}</div>
    </div>`;
  });

  document.getElementById('yearPredictionContainer').innerHTML = html;
}

// ---- LANDING SCREEN NAVIGATION ----

function showLanding() {
  document.getElementById('landingSection').style.display = 'block';
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('results').classList.remove('visible');
  document.getElementById('standaloneRashiPhal').style.display = 'none';
  document.getElementById('standaloneGochar').style.display = 'none';
  window.scrollTo({top:0, behavior:'smooth'});
}

function showKundali() {
  document.getElementById('landingSection').style.display = 'none';
  document.getElementById('inputSection').style.display = 'block';
  document.getElementById('standaloneRashiPhal').style.display = 'none';
  document.getElementById('standaloneGochar').style.display = 'none';
  // If results were previously generated, keep them visible
  window.scrollTo({top:0, behavior:'smooth'});
}

function showStandaloneRashiPhal() {
  document.getElementById('landingSection').style.display = 'none';
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('results').classList.remove('visible');
  document.getElementById('standaloneGochar').style.display = 'none';
  document.getElementById('standaloneRashiPhal').style.display = 'block';
  populateSAYearSelector('saRashiPhalYear');
  renderStandaloneRashiPhal();
  window.scrollTo({top:0, behavior:'smooth'});
}

function showStandaloneGochar() {
  document.getElementById('landingSection').style.display = 'none';
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('results').classList.remove('visible');
  document.getElementById('standaloneRashiPhal').style.display = 'none';
  document.getElementById('standaloneGochar').style.display = 'block';
  populateSAYearSelector('saGocharYear');
  renderStandaloneGochar();
  window.scrollTo({top:0, behavior:'smooth'});
}

function populateSAYearSelector(selectId) {
  const sel = document.getElementById(selectId);
  if (sel.options.length > 0) return; // Already populated
  const curYear = new Date().getFullYear();
  for (let y = curYear; y <= curYear + 5; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if (y === curYear) opt.selected = true;
    sel.appendChild(opt);
  }
}

// ---- STANDALONE RASHI PHAL (All 12 Rashis, no kundali needed) ----

const RASHI_ICONS = ['&#x2648;','&#x2649;','&#x264A;','&#x264B;','&#x264C;','&#x264D;','&#x264E;','&#x264F;','&#x2650;','&#x2651;','&#x2652;','&#x2653;'];

function renderStandaloneRashiPhal() {
  const year = parseInt(document.getElementById('saRashiPhalYear').value);
  if (!year) return;
  const content = document.getElementById('saRashiPhalContent');
  content.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-dim)">Computing Rashi Phal for all 12 Rashis...</div>';

  setTimeout(() => {
    try {
      content.innerHTML = buildStandaloneRashiPhal(year);
    } catch(e) {
      content.innerHTML = `<p style="color:var(--accent-red)">Error: ${e.message}</p>`;
    }
  }, 80);
}

function buildStandaloneRashiPhal(year) {
  // Calculate transit positions at mid-year for overview
  const midJD = julianDay(year, 7, 1, 12);
  const midPlanets = calculatePlanets(midJD);
  const jupSign = Math.floor(midPlanets.Jupiter / 30) % 12;
  const satSign = Math.floor(midPlanets.Saturn / 30) % 12;
  const rahuSign = Math.floor(midPlanets.Rahu / 30) % 12;
  const ketuSign = Math.floor(midPlanets.Ketu / 30) % 12;

  // Quarter data for sign-change detection
  const quarters = [
    {label:'Jan–Mar', m:2, d:15},
    {label:'Apr–Jun', m:5, d:15},
    {label:'Jul–Sep', m:8, d:15},
    {label:'Oct–Dec', m:11, d:15}
  ];
  const qData = quarters.map(q => {
    const jd = julianDay(year, q.m, q.d, 12);
    const pl = calculatePlanets(jd);
    return { ...q, planets: pl };
  });

  let html = '';

  // Year title only
  html += `<div class="year-overview">
    <h3>&#x1F31E; ${T('rashiPhal_for')} ${year}</h3>
  </div>`;

  // Build predictions for each rashi
  html += '<div style="margin-top:20px">';
  for (let ri = 0; ri < 12; ri++) {
    const rashi = RASHIS[ri];
    const jupFrom = ((jupSign - ri + 12) % 12) + 1;
    const satFrom = ((satSign - ri + 12) % 12) + 1;
    const rahuFrom = ((rahuSign - ri + 12) % 12) + 1;
    const ketuFrom = ((ketuSign - ri + 12) % 12) + 1;

    html += `<div class="rashi-accordion" id="sa-rashi-${ri}">`;
    html += `<div class="rashi-accordion-header" onclick="toggleRashiAccordion(${ri})">`;
    html += `<div class="ra-icon">${RASHI_ICONS[ri]}</div>`;
    if (LANG === 'hi') {
      html += `<span class="ra-name">${I18N.rashi_hi[ri]}</span>`;
    } else {
      html += `<span class="ra-name">${rashi.name}</span><span class="ra-eng">(${rashi.eng})</span>`;
    }
    html += `<span class="ra-arrow">&#x25BC;</span>`;
    html += `</div>`;
    html += `<div class="rashi-accordion-body"><div class="rashi-accordion-content">`;
    html += buildSingleRashiPhal(ri, year, jupFrom, satFrom, rahuFrom, ketuFrom, jupSign, satSign, rahuSign, ketuSign, qData);
    html += `</div></div></div>`;
  }
  html += '</div>';
  return html;
}

function toggleRashiAccordion(ri) {
  const el = document.getElementById('sa-rashi-' + ri);
  el.classList.toggle('open');
}

function buildSingleRashiPhal(rashiIdx, year, jupFrom, satFrom, rahuFrom, ketuFrom, jupSign, satSign, rahuSign, ketuSign, qData) {
  const rashi = RASHIS[rashiIdx];
  const rashiEng = LANG === 'hi' ? I18N.rashi_hi[rashiIdx] : rashi.eng;
  let html = '';

  // Sade Sati check
  html += buildSadeSatiSection(satFrom, satSign, rashiIdx, year);

  // Quarterly breakdown
  const quarterLabels = LANG === 'hi' ? I18N.quarter_labels_hi : I18N.quarter_labels_en;
  const quarterMidpoints = [
    {m:2, d:15}, {m:5, d:15}, {m:8, d:15}, {m:11, d:15}
  ];

  html += '<div style="margin-top:12px">';

  quarterMidpoints.forEach((qm, qi) => {
    const jd = julianDay(year, qm.m, qm.d, 12);
    const pl = calculatePlanets(jd);

    // Compute all planet positions from this rashi
    const pos = {};
    ['Jupiter','Saturn','Rahu','Ketu','Mars','Venus','Mercury','Sun','Moon'].forEach(p => {
      const lon = pl[p];
      const sign = Math.floor(lon / 30) % 12;
      const fromRashi = ((sign - rashiIdx + 12) % 12) + 1;
      pos[p] = { sign, fromRashi, rashi: RASHIS[sign] };
    });

    // Quarter score
    let qScore = 0;
    if ([2,5,7,9,11].includes(pos.Jupiter.fromRashi)) qScore += 2;
    if ([3,6,8,12].includes(pos.Jupiter.fromRashi)) qScore -= 1;
    if ([3,6,11].includes(pos.Saturn.fromRashi)) qScore += 1;
    if ([1,4,8].includes(pos.Saturn.fromRashi)) qScore -= 1;
    if ([3,6,10,11].includes(pos.Mars.fromRashi)) qScore += 1;
    if ([1,4,5,8,9,11,12].includes(pos.Venus.fromRashi)) qScore += 1;
    if ([2,4,6,8,10,11].includes(pos.Mercury.fromRashi)) qScore += 1;
    if ([3,6,10,11].includes(pos.Rahu.fromRashi)) qScore += 1;
    const qRatingKey = qScore >= 4 ? 'rating_very_favorable' : qScore >= 2 ? 'rating_favorable' : qScore >= 0 ? 'rating_mixed' : 'rating_challenging';
    const qRating = T(qRatingKey);
    const qColor = qScore >= 4 ? 'var(--accent-green)' : qScore >= 2 ? 'var(--accent-green)' : qScore >= 0 ? '#b8860b' : 'var(--accent-red)';
    const starRating = qScore >= 4 ? '★★★★★' : qScore >= 2 ? '★★★★☆' : qScore >= 0 ? '★★★☆☆' : '★★☆☆☆';

    html += `<div class="quarter-card" style="margin-bottom:16px">`;
    html += `<h4 style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">${quarterLabels[qi]} <span style="font-size:0.8em;font-weight:500;color:${qColor}">${starRating} ${qRating}</span></h4>`;

    // Build expert jyotishi summary
    html += `<div style="font-size:0.9em;line-height:1.7;color:var(--text-primary)">`;
    html += buildExpertQuarterSummary(rashiIdx, rashiEng, pos, qScore, qi);
    html += `</div>`;

    // Quarter-specific remedies
    html += buildQuarterRemedies(rashiIdx, rashiEng, pos, qScore, qi);

    html += `</div>`;
  });

  html += '</div>';
  return html;
}

function buildExpertQuarterSummary(rashiIdx, rashiEng, pos, qScore, qi) {
  let s = '';
  const jH = pos.Jupiter.fromRashi;
  const sH = pos.Saturn.fromRashi;
  const mH = pos.Mars.fromRashi;
  const vH = pos.Venus.fromRashi;
  const meH = pos.Mercury.fromRashi;
  const rH = pos.Rahu.fromRashi;
  const kH = pos.Ketu.fromRashi;
  const qNames = LANG === 'hi' ? I18N.quarter_names_hi : I18N.quarter_names_en;
  const hi = LANG === 'hi';
  const oL = ordinalL; // shorthand
  const pN = planetName; // shorthand

  // --- CAREER & PROFESSION ---
  s += `<p style="margin:0 0 10px"><b style="color:var(--saffron)">${T('h_career')}</b> `;
  if ([1,5,7,9,10,11].includes(jH) && [3,6,10,11].includes(sH)) {
    s += hi
      ? `यह ${qNames[qi]} करियर उन्नति के लिए अत्यन्त शक्तिशाली है। ${oL(jH)} भाव में गुरु और ${oL(sH)} भाव से शनि का सहयोग व्यावसायिक सफलता के लिए एक दुर्लभ योग बनाता है। वरिष्ठ और अधिकारी वर्ग से संरक्षण मिलने की प्रबल सम्भावना है। `
      : `This ${qNames[qi]} is exceptionally powerful for career advancement. The combined blessings of Guru in the ${ordinal(jH)} bhāva and Shani supporting from the ${ordinal(sH)} create a rare alignment for professional achievement. Senior figures and authority figures are likely to offer patronage. `;
  } else if ([2,5,7,9,11].includes(jH)) {
    s += hi
      ? `${rashiEng} से ${oL(jH)} भाव में गुरु का गोचर व्यावसायिक मामलों में आशावाद और विस्तार लाता है। `
      : `Guru's transit through the ${ordinal(jH)} from ${rashiEng} brings optimism and expansion to professional matters. `;
    if ([1,4,8].includes(sH)) s += hi
      ? `किन्तु ${oL(sH)} भाव में शनि सावधानी की माँग करता है — अत्यधिक प्रतिबद्धता से बचें और कार्यस्थल की राजनीति से सचेत रहें। धैर्य और अनुशासन से ही प्रगति होगी। `
      : `However, Shani in the ${ordinal(sH)} demands caution — avoid overcommitting and be mindful of workplace politics. Progress comes through patient, disciplined effort rather than bold leaps. `;
    else if ([7,10].includes(sH)) s += hi
      ? `${oL(sH)} भाव में शनि कार्य में भारी उत्तरदायित्व जोड़ता है; इस तिमाही में सफलता अतिरिक्त कर्तव्यों को स्वीकार करने से मिलेगी। `
      : `Shani in the ${ordinal(sH)} adds heavy responsibility at work; the path to success this quarter requires shouldering additional duties without complaint. `;
    else s += hi ? `व्यावसायिक विकास सहयोगी है, परन्तु स्थिर प्रयास अचानक कदमों से बेहतर परिणाम देंगे। ` : `Professional growth is supported, though steady effort will yield better results than sudden moves. `;
  } else if ([3,6,8,12].includes(jH)) {
    s += hi
      ? `आपकी राशि से ${oL(jH)} भाव में गुरु की स्थिति व्यावसायिक जीवन में बाधाएँ उत्पन्न करती है। `
      : `Guru's placement in the ${ordinal(jH)} from your rashi creates friction in professional life. `;
    if ([3,6,11].includes(sH)) s += hi
      ? `सौभाग्य से ${oL(sH)} भाव में शनि की अनुकूल स्थिति अनुशासित दृढ़ता लाती है जो बाधाओं को पार कर सकती है। व्यवस्थित कार्य पर ध्यान दें। `
      : `Fortunately, Shani's favorable position in the ${ordinal(sH)} brings disciplined persistence that can overcome obstacles. Focus on structured work and avoid shortcuts. `;
    else s += hi
      ? `${oL(sH)} भाव में शनि के साथ कार्यस्थल की चुनौतियाँ तीव्र हो सकती हैं। यह विस्तार नहीं बल्कि संगठन का समय है। सत्यनिष्ठा बनाए रखें। `
      : `With Shani also in the ${ordinal(sH)}, workplace challenges may feel intensified. This is a period for consolidation rather than expansion. Maintain integrity and wait for better transits. `;
  } else {
    s += hi ? `इस तिमाही में व्यावसायिक दृष्टिकोण मध्यम है। ` : `The professional outlook this quarter is moderate. `;
    if ([10,11].includes(mH)) s += hi
      ? `${oL(mH)} भाव में मंगल ऊर्जा और पहल लाता है — प्रतिस्पर्धी स्थितियों और नेतृत्व भूमिकाओं के लिए अच्छा है। `
      : `Mars energizing the ${ordinal(mH)} house brings drive and initiative — good for competitive situations and leadership roles. `;
    if ([3,6,11].includes(sH)) s += hi
      ? `${oL(sH)} भाव से शनि का सहयोगी गोचर अनुशासित, दीर्घकालिक प्रयासों को पुरस्कृत करता है। `
      : `Shani's supportive transit through the ${ordinal(sH)} rewards disciplined, long-term effort. `;
  }
  if ([10,11].includes(rH)) s += hi
    ? `${oL(rH)} भाव में राहु सांसारिक महत्वाकांक्षाओं को बढ़ाता है और अप्रत्याशित करियर अवसर ला सकता है। `
    : `Rahu in the ${ordinal(rH)} amplifies worldly ambitions and may bring unexpected career opportunities through unconventional channels. `;
  if ([6,10].includes(mH)) s += hi
    ? `${oL(mH)} भाव में मंगल प्रतिस्पर्धी ऊर्जा प्रदान करता है — कठिन परियोजनाओं के लिए उपयोगी। `
    : `Mars transiting the ${ordinal(mH)} fuels competitive energy — use it for tackling difficult projects. `;
  s += `</p>`;

  // --- FINANCES & WEALTH ---
  s += `<p style="margin:0 0 10px"><b style="color:var(--saffron)">${T('h_finance')}</b> `;
  if ([2,5,9,11].includes(jH)) {
    s += hi
      ? `${oL(jH)} भाव से बृहस्पति की कृपादृष्टि धन संचय के लिए शुभ है। `
      : `Jupiter's benevolent gaze from the ${ordinal(jH)} house is auspicious for wealth accumulation. `;
    if (jH === 2) s += hi ? `द्वितीय भाव में गोचर सीधे धन मामलों को सक्रिय करता है — बचत बढ़ती है, मूल्यवान सम्पत्ति प्राप्त हो सकती है, और पारिवारिक आर्थिक स्थिति सुधरती है। ` : `The 2nd house transit directly activates dhana (wealth) matters — savings increase, valuable possessions may be acquired, and family finances improve. `;
    else if (jH === 11) s += hi ? `एकादश भाव में गोचर आय और लाभ के लिए उत्कृष्ट है — निवेश फलीभूत होते हैं, व्यापारिक लाभ बढ़ता है। ` : `The 11th house transit is outstanding for income and gains — investments bear fruit, business profits rise, and financial desires find fulfillment. `;
    else if (jH === 5) s += hi ? `सट्टा निवेश और सृजनात्मक उपक्रम आर्थिक लाभ दे सकते हैं। ` : `Speculative investments and creative ventures can bring financial rewards. `;
    else if (jH === 9) s += hi ? `धार्मिक माध्यमों से भाग्य धन पर मुस्कुराता है — विरासत, उपहार, या नैतिक प्रयासों से अप्रत्याशित लाभ। ` : `Fortune smiles on finances through righteous means — inheritance, gifting, or windfall gains from ethical endeavors. `;
  } else if ([6,8,12].includes(jH)) {
    s += hi
      ? `इस तिमाही आर्थिक सावधानी आवश्यक है क्योंकि गुरु ${oL(jH)} भाव में गोचर कर रहे हैं। `
      : `Financial caution is advised this quarter as Guru transits the ${ordinal(jH)} house. `;
    if (jH === 12) s += hi ? `व्यय बढ़ने की प्रवृत्ति है — तीर्थयात्रा, दान, या विदेशी मामलों पर खर्च अधिक सम्भव। बड़ी रकम उधार देने से बचें। ` : `Expenditures tend to rise — spending on pilgrimages, charitable causes, or foreign dealings is more likely. Avoid lending large sums. `;
    if (jH === 8) s += hi ? `अप्रत्याशित खर्च या आर्थिक व्यवधान सम्भव। बीमा और आपातकालीन निधि की समीक्षा करें। ` : `Unexpected expenses or financial disruptions are possible. Insurance and emergency funds should be reviewed. `;
    if (jH === 6) s += hi ? `स्वास्थ्य या कानूनी मामलों से सम्बन्धित खर्च उत्पन्न हो सकते हैं। परन्तु केन्द्रित प्रयास से ऋण भी चुकाए जा सकते हैं। ` : `Expenses related to health or legal matters may arise. However, debts can also be cleared with focused effort. `;
  } else {
    s += hi ? `बिना नाटकीय बदलाव के आर्थिक स्थिति स्थिर रहती है। ` : `Finances remain stable without dramatic shifts. `;
  }
  if ([2,11].includes(sH)) s += hi ? `${oL(sH)} भाव में शनि का गोचर आर्थिक अनुशासन पर बल देता है — व्यवस्थित बचत योजना और आवेगपूर्ण खरीदारी से बचना लाभदायक रहेगा। ` : `Saturn's transit through the ${ordinal(sH)} house emphasizes financial discipline — structured savings plans and avoiding impulsive purchases serve you well. `;
  if ([2,4,6,8,10,11].includes(meH)) s += hi ? `बुध की अनुकूल स्थिति व्यापारिक लेन-देन, वार्ता और अनुबन्ध आय को सहयोग करती है। ` : `Mercury's favorable placement supports commercial dealings, negotiations, and contractual income. `;
  if ([2,11].includes(rH)) s += hi ? `राहु अचानक आर्थिक अवसर ला सकता है परन्तु जोखिमपूर्ण सट्टे का प्रलोभन भी — विवेक से आगे बढ़ें। ` : `Rahu can bring sudden financial opportunities but also temptations for risky speculation — proceed with discernment. `;
  s += `</p>`;

  // --- HEALTH & WELLBEING ---
  s += `<p style="margin:0 0 10px"><b style="color:var(--saffron)">${T('h_health')}</b> `;
  const healthConcerns = [];
  if ([1,6,8].includes(sH)) healthConcerns.push('Saturn');
  if ([1,4,8].includes(mH)) healthConcerns.push('Mars');
  if ([1,6,8].includes(rH)) healthConcerns.push('Rahu');
  if ([6,8].includes(kH)) healthConcerns.push('Ketu');

  if (healthConcerns.length >= 2) {
    s += hi
      ? `इस तिमाही स्वास्थ्य पर विशेष ध्यान आवश्यक है। एकाधिक पापग्रहों (${healthConcerns.map(planetName).join(', ')}) का प्रभाव रोगों के प्रति संवेदनशीलता दर्शाता है। `
      : `Health requires careful attention this quarter. Multiple malefic influences (${healthConcerns.join(', ')}) indicate vulnerability to ailments. `;
    if (healthConcerns.includes('Saturn')) s += hi ? `${oL(sH)} भाव में शनि का कर्मिक दबाव जीर्ण दर्द, जोड़ों की समस्या, या थकान के रूप में प्रकट हो सकता है। ` : `Saturn's karmic pressure in the ${ordinal(sH)} can manifest as chronic pain, joint issues, or fatigue. `;
    if (healthConcerns.includes('Mars')) s += hi ? `${oL(mH)} भाव में मंगल सूजन, बुखार, या दुर्घटनावश चोट का जोखिम बढ़ाता है — तीखी वस्तुओं और अग्नि से सावधान रहें। ` : `Mars in the ${ordinal(mH)} increases risk of inflammation, fevers, or accidental injuries — exercise caution with sharp instruments and fire. `;
    if (healthConcerns.includes('Rahu')) s += hi ? `${oL(rH)} भाव में राहु का प्रभाव रहस्यमय लक्षण, चिन्ता, या नींद में व्यवधान उत्पन्न कर सकता है। ` : `Rahu's influence in the ${ordinal(rH)} may cause mysterious symptoms, anxiety, or sleep disturbances. `;
    s += hi ? `एक अनुशासित स्वास्थ्य व्यवस्था अनिवार्य है। ` : `A disciplined health regimen is essential. `;
  } else if (healthConcerns.length === 1) {
    const hc = healthConcerns[0];
    s += hi ? `स्वास्थ्य सामान्यतः प्रबन्धनीय है परन्तु ${planetName(hc)} का गोचर कुछ सतर्कता की माँग करता है। ` : `Health is generally manageable but ${hc}'s transit warrants some vigilance. `;
    if (hc === 'Saturn') s += hi ? `थकान, हड्डी/जोड़ों की समस्या, या वात सम्बन्धी असन्तुलन पर ध्यान दें। नियमित तेल मालिश (अभ्यंग) और गर्म, पौष्टिक भोजन सहायक है। ` : `Watch for fatigue, bone/joint issues, or Vata-related imbalances. Regular oil massage (abhyanga) and warm, nourishing foods help. `;
    if (hc === 'Mars') s += hi ? `दुर्घटनाओं, सूजन सम्बन्धी रोगों और अतिपरिश्रम से बचें। अतिरिक्त ऊर्जा को व्यायाम द्वारा निर्देशित करें। ` : `Guard against accidents, inflammatory conditions, and overexertion. Channel excess energy through exercise. `;
    if (hc === 'Rahu') s += hi ? `मानसिक स्वास्थ्य पर ध्यान दें — चिन्ता, अतिचिन्तन या असामान्य भय उभर सकते हैं। ग्राउण्डिंग अभ्यास सहायक हैं। ` : `Mental health needs attention — anxiety, overthinking, or unusual fears may surface. Grounding practices help. `;
    if (hc === 'Ketu') s += hi ? `रहस्यमय या कठिन-निदान लक्षण प्रकट हो सकते हैं। अपनी अन्तर्ज्ञान पर विश्वास रखें पर उचित चिकित्सा परामर्श भी लें। ` : `Mysterious or hard-to-diagnose symptoms may appear. Trust your intuition but also seek proper medical advice. `;
  } else {
    s += hi ? `कोई बड़ा पापग्रह प्रभाव न होने से इस तिमाही स्वास्थ्य सम्भावनाएँ अनुकूल हैं। ` : `Health prospects are favorable this quarter with no major malefic afflictions. `;
    if ([1,5,9].includes(jH)) s += hi ? `बृहस्पति की सुरक्षात्मक दृष्टि जीवन शक्ति और समग्र स्वास्थ्य को बढ़ाती है। ` : `Jupiter's protective aspect enhances vitality and overall wellbeing. `;
    if ([1,4,5,9,12].includes(vH)) s += hi ? `शुक्र आनन्द, अच्छी भूख और भावनात्मक सन्तुलन को बढ़ावा देता है। ` : `Venus promotes enjoyment, good appetite, and emotional balance. `;
    s += hi ? `अपनी नियमित स्वास्थ्य दिनचर्या बनाए रखें और इस शारीरिक सुख के काल का आनन्द लें। ` : `Maintain your regular wellness practices and enjoy this period of physical ease. `;
  }
  if (sH === 1 || sH === 12 || (sH === 2 && pos.Saturn.fromRashi === 2)) {
    s += hi ? `साढ़े साती का प्रभाव स्वास्थ्य चिन्ताओं को तीव्र करता है — विश्राम, तनाव प्रबन्धन और नियमित जाँच को प्राथमिकता दें। ` : `The Sade Sati influence intensifies health concerns — prioritize rest, stress management, and regular check-ups. `;
  }
  s += `</p>`;

  // --- RELATIONSHIPS & FAMILY ---
  s += `<p style="margin:0 0 10px"><b style="color:var(--saffron)">${T('h_relations')}</b> `;
  if ([5,7].includes(jH)) {
    s += hi ? `${oL(jH)} भाव में गुरु का शुभ गोचर सम्बन्धों को अत्यन्त अनुकूल बनाता है। ` : `Guru's auspicious transit through the ${ordinal(jH)} greatly favors relationships. `;
    if (jH === 7) s += hi ? `वैवाहिक जीवन में सुधार, साझेदारी मजबूत, और अविवाहितों को उपयुक्त जोड़ा मिल सकता है। सामाजिक प्रतिष्ठा भी बढ़ती है। ` : `Married life improves, partnerships strengthen, and singles may find compatible matches. Social prestige also rises. `;
    if (jH === 5) s += hi ? `प्रेम पुष्पित होता है, सन्तान से सम्बन्ध आनन्ददायक रहते हैं, और सृजनात्मक सहयोग फलते-फूलते हैं। ` : `Romance blooms, relationships with children bring joy, and creative collaborations flourish. `;
  } else if ([2,4].includes(jH)) {
    s += hi ? `पारिवारिक मामले केन्द्र में रहते हैं। ` : `Family matters occupy center stage. `;
    if (jH === 2) s += hi ? `द्वितीय भाव में गुरु पारिवारिक एकता, सुखद मिलन और प्रियजनों के साथ बेहतर संवाद लाता है। ` : `Guru in the 2nd brings family togetherness, pleasant gatherings, and improved communication with loved ones. `;
    if (jH === 4) s += hi ? `घरेलू जीवन गहरा होता है — गृह सुधार, माता से जुड़ाव, और भावनात्मक आधार प्रमुख रहते हैं। ` : `Domestic life deepens — home improvements, connection with mother, and emotional grounding are highlighted. `;
  } else if ([6,8,12].includes(jH)) {
    s += hi ? `सम्बन्धों में कुछ परीक्षा के समय आ सकते हैं। ${oL(jH)} भाव में गुरु साझेदारी में धैर्य और समझ की आवश्यकता दर्शाता है। ` : `Relationships may face some testing periods. Guru in the ${ordinal(jH)} suggests the need for patience and understanding in partnerships. `;
  } else {
    s += hi ? `इस तिमाही सम्बन्ध स्थिर गति से चलते हैं। ` : `Relationships follow a steady course this quarter. `;
  }
  if ([7].includes(sH)) s += hi ? `सप्तम भाव में शनि की उपस्थिति साझेदारी में गम्भीरता जोड़ती है — जो सम्बन्ध इस गोचर को सहते हैं वे और मजबूत होकर उभरते हैं। ` : `Saturn's presence in the 7th adds weight to partnerships — relationships that survive this transit emerge stronger and more committed. `;
  if ([1,2,4].includes(vH)) s += hi ? `शुक्र घरेलू सद्भाव, प्रेम भावना और दैनिक जीवन में सौन्दर्य की सराहना बढ़ाता है। ` : `Venus enhances domestic harmony, romantic feelings, and appreciation of beauty in daily life. `;
  if ([7].includes(rH)) s += hi ? `सप्तम में राहु असामान्य या विदेशी सम्बन्ध ला सकता है परन्तु साझेदारी में भ्रम भी — स्पष्ट संवाद बनाए रखें। ` : `Rahu in the 7th may bring unusual or foreign connections but also creates confusion in partnerships — maintain clear communication. `;
  if ([7].includes(kH)) s += hi ? `सप्तम में केतु सांसारिक सम्बन्धों से आध्यात्मिक वैराग्य दर्शाता है — आन्तरिक विकास बाह्य बन्धनों से ऊपर रहता है। ` : `Ketu in the 7th indicates spiritual detachment from worldly relationships — inner growth takes priority over external bonds. `;
  s += `</p>`;

  // --- SPIRITUAL & INNER GROWTH ---
  s += `<p style="margin:0 0 10px"><b style="color:var(--saffron)">${T('h_spiritual')}</b> `;
  if ([5,9,12].includes(jH)) {
    s += hi ? `यह आध्यात्मिक उन्नति के लिए एक उत्कृष्ट तिमाही है। ${oL(jH)} भाव में बृहस्पति उच्चतर चेतना के द्वार खोलता है। ` : `This is an outstanding quarter for spiritual advancement. Jupiter in the ${ordinal(jH)} opens doorways to higher consciousness. `;
    if (jH === 9) s += hi ? `नवम भाव का गोचर सबसे धार्मिक है — तीर्थयात्रा, गुरु से सम्पर्क, और गहन दार्शनिक अन्तर्दृष्टि प्रबल रूप से संकेतित हैं। ` : `The 9th house transit is the most dharmic — pilgrimages, contact with gurus, and deep philosophical insights are strongly indicated. `;
    if (jH === 12) s += hi ? `भौतिक रूप से चुनौतीपूर्ण होते हुए भी यह गोचर गहन आध्यात्मिक है। ध्यान अभ्यास गहरा होता है, स्वप्न जीवन सजीव होता है, और मोक्षोन्मुख ज्ञान प्रवाहित होता है। ` : `Though materially challenging, this transit is profoundly spiritual. Meditation practice deepens, dream life becomes vivid, and moksha-oriented wisdom flows. `;
    if (jH === 5) s += hi ? `भक्ति अभ्यास अपार आन्तरिक सन्तुष्टि लाते हैं। समर्पित अभ्यास से मन्त्र सिद्धि सम्भव है। ` : `Devotional practices (bhakti) bring immense inner satisfaction. Mantra siddhi is possible with dedicated practice. `;
  } else if ([9,12].includes(kH)) {
    s += hi ? `${oL(kH)} भाव में केतु की स्थिति वैराग्य और आध्यात्मिक खोज को बढ़ाती है। ` : `Ketu's placement in the ${ordinal(kH)} house enhances detachment and spiritual seeking. `;
    if (kH === 12) s += hi ? `यह आध्यात्मिक मुक्ति के लिए सबसे शक्तिशाली स्थितियों में से एक है — पूर्वजन्म के कर्म समर्पण और ध्यान द्वारा हल हो सकते हैं। ` : `This is one of the most powerful positions for spiritual liberation — past-life karmas may be resolved through surrender and meditation. `;
    if (kH === 9) s += hi ? `अपरम्परागत आध्यात्मिक मार्ग आकर्षित करते हैं; गुरु-शिष्य बन्धन औपचारिक धर्म से परे गहरा होता है। ` : `Unconventional spiritual paths attract you; the guru–disciple bond deepens beyond formal religion. `;
  } else if ([1,4,8,12].includes(sH)) {
    s += hi ? `${oL(sH)} भाव में शनि की परीक्षापूर्ण स्थिति, भौतिक रूप से कठिन होते हुए भी, आन्तरिक विकास के लिए उत्प्रेरक का कार्य करती है। विनम्रता से अपनाने पर कष्ट ही गुरु बन जाता है। ` : `Saturn's testing position in the ${ordinal(sH)} house, while difficult materially, serves as a catalyst for inner growth. Hardship becomes the guru when approached with humility. `;
  } else {
    s += hi ? `आध्यात्मिक जीवन स्थिर गति से जारी रहता है। ` : `Spiritual life continues at a steady pace. `;
    if ([1,5,9].includes(jH)) s += hi ? `${oL(jH)} भाव पर बृहस्पति का आशीर्वाद भक्ति और धर्मपरायण जीवन को सहयोग करता है। ` : `Jupiter's blessing on the ${ordinal(jH)} house supports devotion and righteous living. `;
    s += hi ? `नियमित प्रार्थना, ध्यान और पवित्र ग्रन्थों का पाठ आपको केन्द्रित रखता है। ` : `Regular prayer, meditation, and reading of sacred texts keep you centered. `;
  }
  s += `</p>`;

  // --- OVERALL ASSESSMENT ---
  s += `<p style="margin:0;padding:10px 14px;background:rgba(212,113,10,0.06);border-radius:8px;border-left:3px solid var(--saffron)"><b>${T('h_overall')}</b> `;
  if (qScore >= 4) {
    s += hi
      ? `यह ${rashiEng} जातकों के लिए वर्ष की सबसे शक्तिशाली तिमाहियों में से एक है। अनुकूल गोचरों का संगम करियर, धन और सम्बन्धों में अवसर की खिड़की खोलता है। अब शुरू किए गए साहसिक कार्यों को गुरु और शुभ ग्रहों का आशीर्वाद प्राप्त होगा। यही समय है महत्वपूर्ण लक्ष्यों को आगे बढ़ाने, निवेश करने और आत्मविश्वास से अपनी सीमाएँ विस्तारित करने का।`
      : `This is one of the strongest quarters of the year for ${rashiEng} natives. The confluence of favorable transits creates a window of opportunity across career, finances, and relationships. Bold initiatives launched now carry the blessings of both Guru and the benefic planets. This is the time to advance important goals, make significant investments, and expand your horizons with confidence.`;
  } else if (qScore >= 2) {
    s += hi
      ? `एक व्यापक रूप से सकारात्मक तिमाही जहाँ सचेत प्रयास से विकास सुलभ है। ग्रह विन्यास अधिकांश जीवन क्षेत्रों में स्थिर प्रगति का समर्थन करता है। प्रत्येक ग्रह अनुकूल नहीं है, परन्तु सन्तुलन अवसर की ओर झुकता है। सोच-समझकर आगे बढ़ें, महत्वपूर्ण सम्बन्ध मजबूत करें, और व्यक्तिगत विकास में निवेश करें।`
      : `A broadly positive quarter where growth is accessible through conscious effort. The planetary configuration supports steady progress in most life domains. While not every planet favors you, the balance tilts toward opportunity. Take measured steps forward, strengthen important relationships, and invest in personal development. Avoid complacency — the positive transits reward those who act.`;
  } else if (qScore >= 0) {
    s += hi
      ? `मिश्रित ऊर्जाओं की तिमाही जिसमें विवेक और सन्तुलन आवश्यक है। कुछ ग्रह आपके प्रयासों का सहयोग करते हैं जबकि अन्य धैर्य और सहनशक्ति की परीक्षा लेते हैं। विवेक ही कुंजी है — जहाँ ब्रह्माण्डीय वायु अनुकूल हो वहाँ आगे बढ़ें, और जहाँ प्रतिरोध हो वहाँ स्थिर रहें। बड़े जुआ या अपरिवर्तनीय निर्णयों से बचें।`
      : `A quarter of mixed energies requiring wisdom and balance. Some planets support your endeavors while others test your patience and resilience. The key is discernment — advance where the cosmic winds favor you, and hold steady where resistance appears. Avoid major gambles or irreversible decisions during this period. Patience, faith, and steady practice carry you through.`;
  } else {
    s += hi
      ? `एक कर्मिक रूप से माँगपूर्ण तिमाही जहाँ अनेक ग्रह बल आपके संकल्प की परीक्षा लेने के लिए अभिसरित होते हैं। यह आक्रामकता या जोखिम का नहीं बल्कि सुदृढ़ीकरण, आत्म-देखभाल और आध्यात्मिक आधार का समय है। यदि इन चुनौतियों का विनम्रता और धर्मपरायण आचरण से सामना किया जाए, तो ये भविष्य के आशीर्वादों के बीज बोती हैं। परिवार का सहारा लें, वरिष्ठजनों से मार्गदर्शन लें, और अपनी साधना तीव्र करें।`
      : `A karmically demanding quarter where several planetary forces converge to test your resolve. This is not a time for aggression or risk-taking but rather for fortification, self-care, and spiritual grounding. The challenges faced now, if met with humility and dharmic conduct, plant seeds for future blessings. Lean on family, seek guidance from elders, and intensify your spiritual practices.`;
  }
  s += `</p>`;
  return s;
}

function buildQuarterRemedies(rashiIdx, rashiEng, pos, qScore, qi) {
  const jH = pos.Jupiter.fromRashi;
  const sH = pos.Saturn.fromRashi;
  const mH = pos.Mars.fromRashi;
  const vH = pos.Venus.fromRashi;
  const meH = pos.Mercury.fromRashi;
  const rH = pos.Rahu.fromRashi;
  const kH = pos.Ketu.fromRashi;
  const hi = LANG === 'hi';

  // Determine which planets need remedies
  const remedyPlanets = [];
  if ([3,6,8,10,12].includes(jH)) remedyPlanets.push('Jupiter');
  if ([1,2,4,5,7,8,9,10,12].includes(sH)) remedyPlanets.push('Saturn');
  if ([1,4,7,8].includes(mH)) remedyPlanets.push('Mars');
  if ([6,7,10].includes(vH)) remedyPlanets.push('Venus');
  if ([1,3,5,7,9,12].includes(meH)) remedyPlanets.push('Mercury');
  if ([1,2,4,5,7,8,9,12].includes(rH)) remedyPlanets.push('Rahu');
  if ([1,2,3,4,5,7,8,10,11].includes(kH)) remedyPlanets.push('Ketu');

  if (remedyPlanets.length === 0 && qScore >= 3) {
    return `<div style="margin-top:12px;padding:12px 16px;background:rgba(34,139,34,0.06);border:1px solid rgba(34,139,34,0.15);border-radius:10px;font-size:0.88em;line-height:1.6">
      <b style="color:var(--accent-green)">&#x2728; ${T('remedies_heading_good')}</b>
      <p style="margin:6px 0 0">${hi
        ? 'इस तिमाही ग्रह योग अत्यन्त अनुकूल है। इन आशीर्वादों को अधिकतम करने के लिए, प्रतिदिन कृतज्ञता का अभ्यास करें, नियमित रूप से मन्दिर या पवित्र स्थान जाएँ, और दान-पुण्य द्वारा अपना सौभाग्य बाँटें। गुरुवार को <i>ॐ गुरवे नमः</i> का जाप बृहस्पति की कृपा बढ़ाता है। शुभ दिनों पर पीले या केसरिया वस्त्र धारण करें।'
        : 'The planetary alignment is strongly favorable this quarter. To maximize these blessings, maintain a daily practice of gratitude, visit a temple or sacred space regularly, and share your good fortune through acts of charity. Chanting <i>Om Guruve Namah</i> on Thursdays amplifies Jupiter\'s grace. Wear yellow or saffron on auspicious days.'}</p>
    </div>`;
  }

  let r = `<div style="margin-top:12px;padding:12px 16px;background:rgba(212,113,10,0.04);border:1px solid rgba(212,113,10,0.12);border-radius:10px;font-size:0.88em;line-height:1.6">`;
  r += `<b style="color:var(--saffron)">&#x1F539; ${T('remedies_heading')}</b>`;

  // Planet remedy data: { planet, nameHi, nameEn, mantra, remedyHi, remedyEn }
  const remedyData = {
    Jupiter: {
      label: hi ? 'बृहस्पति (गुरु)' : 'Jupiter (Guru)',
      remedy: hi
        ? `गुरुवार को <i>"ॐ ग्रां ग्रीं ग्रौं सः गुरवे नमः"</i> का 108 बार जाप करें। ज्योतिषी की सलाह पर पुखराज (पीला नीलम) धारण करें, या विकल्प में पीला पुखराज। गुरुवार को व्रत रखें (केवल दूध, फल और सात्विक भोजन)। गुरुवार को हल्दी, पीला वस्त्र, चना दाल, या केले का दान करें। हल्दी-चन्दन का तिलक लगाएँ। साप्ताहिक विष्णु सहस्रनाम का पाठ या श्रवण करें।`
        : `Chant <i>"Om Graam Greem Graum Sah Gurave Namah"</i> 108 times on Thursdays. Wear a yellow sapphire (Pukhraj) if recommended by a jyotishi, or use a substitute like yellow topaz. Fast on Thursdays (consuming only milk, fruits, and sattvic food). Donate yellow items — turmeric, yellow cloth, Bengal gram (chana dal), or bananas — to a Brahmin or temple on Thursdays. Apply tilak of turmeric and sandalwood paste. Read or listen to Vishnu Sahasranama weekly.`
    },
    Saturn: {
      label: hi ? 'शनि' : 'Saturn (Shani)',
      remedy: hi
        ? `शनिवार को <i>"ॐ प्रां प्रीं प्रौं सः शनैश्चराय नमः"</i> का 108 बार जाप करें। शनिवार सायं शनि मन्दिर या पीपल वृक्ष के नीचे तिल के तेल का दीया जलाएँ। शनिवार को काली वस्तुएँ — काली तिल, काला वस्त्र, लोहे के बर्तन, या सरसों का तेल — दान करें। कौओं को तिल के तेल में मिली चपाती खिलाएँ। नीलम (ब्लू सैफायर) केवल सावधानीपूर्ण ज्योतिषीय परामर्श पर ही धारण करें। शनि देव की प्रसन्नता हेतु वृद्धों और विकलांगों की सेवा करें।`
        : `Chant <i>"Om Praam Preem Praum Sah Shanaischaraya Namah"</i> 108 times on Saturdays. Light a sesame oil (til tel) diya at a Shani temple or under a Peepal tree on Saturday evenings. Donate black items — black sesame seeds (til), black cloth, iron utensils, or mustard oil — to the needy on Saturdays. Feed crows with chapati pieces mixed with sesame oil. Wear a blue sapphire (Neelam) only after careful astrological consultation. Serve the elderly and disabled as seva to propitiate Shani Dev.`,
      sadeSati: hi ? `साढ़े साती के दौरान प्रतिदिन हनुमान चालीसा का पाठ करें और प्रत्येक मंगलवार व शनिवार हनुमान मन्दिर जाएँ।` : `During Sade Sati, additionally recite Hanuman Chalisa daily and visit Hanuman temple every Tuesday and Saturday.`
    },
    Mars: {
      label: hi ? 'मंगल' : 'Mars (Mangal)',
      remedy: hi
        ? `मंगलवार को <i>"ॐ क्रां क्रीं क्रौं सः भौमाय नमः"</i> का 108 बार जाप करें। हनुमान मन्दिर में लाल फूल और सिन्दूर अर्पित करें। मंगलवार को व्रत रखें (नमक त्यागें, व्रत में केवल मीठा खाएँ)। मंगलवार को मसूर दाल, गुड़, लाल वस्त्र, या ताम्र वस्तुएँ दान करें। क्रोध और गर्मागर्म बहस से बचें — धैर्य को आध्यात्मिक अनुशासन के रूप में अपनाएँ। ज्योतिषीय उपयुक्तता पर अनामिका में मूँगा धारण करें।`
        : `Chant <i>"Om Kraam Kreem Kraum Sah Bhaumaya Namah"</i> 108 times on Tuesdays. Offer red flowers and sindoor at a Hanuman temple. Fast on Tuesdays (avoid salt, consume only sweet foods if fasting). Donate red lentils (masoor dal), jaggery, red cloth, or copper items on Tuesdays. Avoid anger and heated arguments — practice patience as a spiritual discipline. Wear red coral (Moonga) on the ring finger if astrologically suitable.`
    },
    Rahu: {
      label: hi ? 'राहु' : 'Rahu',
      remedy: hi
        ? `शनिवार या राहुकाल में <i>"ॐ भ्रां भ्रीं भ्रौं सः राहवे नमः"</i> का 108 बार जाप करें। शनिवार को गहरे नीले या काले रंग की वस्तुएँ दान करें। राहु की बेचैन ऊर्जा को शान्त करने के लिए तकिए के पास चन्दन रखें। प्रतिदिन पक्षियों, विशेषकर कौओं और कबूतरों को दाना खिलाएँ। शुक्रवार को देवी दुर्गा की पूजा या दुर्गा चालीसा का पाठ करें। इस गोचर में मादक पदार्थ, छल और गपशप से सख्ती से बचें। परामर्श पर गोमेद (हेसोनाइट) धारण राहु की ऊर्जा को रचनात्मक दिशा दे सकता है।`
        : `Chant <i>"Om Bhram Bhreem Bhroum Sah Rahave Namah"</i> 108 times on Saturdays or during Rahu Kaal. Donate dark blue or black items on Saturdays. Keep a piece of sandalwood near your pillow to calm Rahu's restless energy. Feed birds, especially crows and pigeons, daily. Worship Goddess Durga or recite Durga Chalisa on Fridays. Avoid intoxicants, deception, and gossip strictly during this transit. Wearing a Gomed (Hessonite) after consultation can help channel Rahu's energy constructively.`
    },
    Ketu: {
      label: hi ? 'केतु' : 'Ketu',
      remedy: hi
        ? `मंगलवार या शनिवार को <i>"ॐ स्रां स्रीं स्रौं सः केतवे नमः"</i> का 108 बार जाप करें। दो रंगों (भूरा और स्लेटी) के कम्बल का गरीबों को दान करें। नियमित रूप से आवारा कुत्तों को खिलाएँ क्योंकि ज्योतिष में केतु कुत्तों से सम्बन्धित है। भगवान गणेश की पूजा करें और गणेश अथर्वशीर्ष का पाठ करें। ध्यान और वैराग्य का अभ्यास करें — केतु सच्ची आध्यात्मिक खोज से प्रसन्न होता है। उचित परामर्श पर लहसुनिया (कैट्स आई) धारण करें।`
        : `Chant <i>"Om Sraam Sreem Sraum Sah Ketave Namah"</i> 108 times on Tuesdays or Saturdays. Donate a blanket with a two-colored pattern (grey and brown) to the underprivileged. Feed stray dogs regularly as Ketu is associated with dogs in Jyotish. Worship Lord Ganesha and recite Ganesha Atharvashirsha. Practice meditation and detachment — Ketu responds to genuine spiritual seeking. Wear Cat's Eye (Lehsunia) after proper consultation.`
    },
    Venus: {
      label: hi ? 'शुक्र' : 'Venus (Shukra)',
      remedy: hi
        ? `शुक्रवार को <i>"ॐ द्रां द्रीं द्रौं सः शुक्राय नमः"</i> का 108 बार जाप करें। लक्ष्मी मन्दिर में सफेद फूल, कपूर और मिठाई अर्पित करें। शुक्रवार को सफेद वस्तुएँ — चावल, शक्कर, सफेद वस्त्र, दही, या चाँदी — दान करें। स्वच्छ, सुन्दर वस्त्र पहनें और व्यक्तिगत साज-सज्जा बनाए रखें। स्त्रियों का सम्मान करें। उपयुक्त होने पर हीरा या सफेद नीलम धारण शुक्र को बलवान बनाता है।`
        : `Chant <i>"Om Draam Dreem Draum Sah Shukraya Namah"</i> 108 times on Fridays. Offer white flowers, camphor, and sweets at a Lakshmi temple. Donate white items — rice, sugar, white cloth, curd, or silver — on Fridays. Wear clean, pleasant clothing and maintain personal grooming. Respect women and avoid any form of disrespect toward the feminine. Wearing a Diamond or white sapphire (if suitable) helps strengthen Venus.`
    },
    Mercury: {
      label: hi ? 'बुध' : 'Mercury (Budh)',
      remedy: hi
        ? `बुधवार को <i>"ॐ ब्रां ब्रीं ब्रौं सः बुधाय नमः"</i> का 108 बार जाप करें। बुधवार को हरी वस्तुएँ — हरी मूँग दाल, हरा वस्त्र, या पन्ना (यदि सम्भव हो) — दान करें। गायों को हरा चारा खिलाएँ। भगवान विष्णु की पूजा करें और विष्णु स्तोत्रम् का पाठ करें। अपनी वाणी सत्य और स्पष्ट रखें — बुध सत्य संवाद को पुरस्कृत करता है। परामर्श पर कनिष्ठिका में पन्ना (एमरल्ड) धारण करें।`
        : `Chant <i>"Om Braam Breem Braum Sah Budhaya Namah"</i> 108 times on Wednesdays. Donate green items — green moong dal, green cloth, or emeralds (if possible) — on Wednesdays. Feed green grass to cows. Worship Lord Vishnu and recite Vishnu Stotram. Keep your speech honest and precise — Mercury rewards truthful communication. Wear Emerald (Panna) on the little finger after consultation.`
    }
  };

  remedyPlanets.forEach(p => {
    const d = remedyData[p];
    if (!d) return;
    r += `<p style="margin:8px 0 4px"><b>${T('remedies_for')} ${d.label}:</b> ${d.remedy}`;
    if (p === 'Saturn' && (sH === 1 || sH === 12 || sH === 2) && d.sadeSati) {
      r += ` <i>${d.sadeSati}</i>`;
    }
    r += `</p>`;
  });

  // General guidance
  r += `<p style="margin:10px 0 0;padding-top:8px;border-top:1px solid var(--border)"><b>${T('remedies_general')}</b> `;
  if (qScore < 0) {
    r += hi
      ? `इस चुनौतीपूर्ण तिमाही में प्रत्येक सुबह सूर्य नमस्कार और गायत्री मन्त्र (108 बार) से आरम्भ करें। सबसे पीड़ित ग्रह के दिन साप्ताहिक व्रत रखें। नियमित रूप से दान करें — छोटे दान भी कर्मिक ऋणों को सन्तुलित करते हैं। सात्विक आहार बनाए रखें, शीघ्र सोएँ, और ग्रहण या ग्रह अस्त काल में बड़े आर्थिक या जीवन निर्णयों से बचें। रात्रि में सोने से पूर्व हनुमान चालीसा का पाठ करें।`
      : `During this challenging quarter, begin each morning with Surya Namaskar (Sun Salutation) and the Gayatri Mantra (108 repetitions). Observe a weekly fast on the day of the most afflicted planet. Practice dāna (charity) regularly — even small acts of giving counterbalance karmic debts. Maintain a sattvic diet, retire early, and avoid major financial or life decisions during eclipses or planetary combust periods. Recite Hanuman Chalisa before bed for protection.`;
  } else if (qScore < 2) {
    r += hi
      ? `नियमित पूजा और ध्यान द्वारा सन्तुलन बनाए रखें। सुरक्षा और उपचार के लिए प्रतिदिन महामृत्युंजय मन्त्र (<i>ॐ त्र्यम्बकं यजामहे...</i>) का 11 बार जाप करें। महीने में कम से कम एक बार अपने इष्ट देवता के मन्दिर जाएँ। सभी विषयों में संयम रखें। सन्ध्या काल में अपनी घर की वेदी पर घी का दीया जलाएँ।`
      : `Maintain balance through regular worship and meditation. Chant the Maha Mrityunjaya Mantra (<i>Om Tryambakam Yajaamahe...</i>) 11 times daily for protection and healing. Visit your ishta devata temple at least once a month. Practice moderation in all things — neither over-extend nor withdraw completely. Light a ghee lamp at your home altar during sandhya kaal (dusk).`;
  } else {
    r += hi
      ? `सकारात्मक ऊर्जाओं को बनाए रखने के लिए अपनी साधना नियमित रखें। सूर्योदय पर कृतज्ञता अर्पित करें, प्रतिदिन इष्ट मन्त्र का जाप करें, और दान द्वारा अपनी समृद्धि बाँटें। शुभ तिथियों (एकादशी, पूर्णिमा, अमावस्या) पर मन्दिर जाएँ। अपने सबसे शक्तिशाली शुभ ग्रह के लिए रत्न धारण शुभ परिणामों को बढ़ाता है। स्मरण रखें — कर्म सत्कर्म और सही संकल्प दोनों से बलवान होता है।`
      : `To sustain the positive energies, maintain your spiritual practices with regularity. Offer gratitude at sunrise, chant your ishta mantra daily, and share your prosperity through charity. Visit a temple on auspicious tithis (Ekadashi, Purnima, Amavasya). Wearing gemstones for your strongest benefic planet amplifies good results. Remember — karma is strengthened by both good deeds and right intention.`;
  }
  r += `</p></div>`;
  return r;
}

// ---- STANDALONE GOCHAR (no kundali needed) ----

function renderStandaloneGochar() {
  const year = parseInt(document.getElementById('saGocharYear').value);
  if (!year) return;
  const content = document.getElementById('saGocharContent');
  content.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-dim)">${LANG==='hi'?'गोचर गणना हो रही है...':'Computing Gochar timings...'}</div>`;

  setTimeout(() => {
    try {
      content.innerHTML = buildStandaloneGochar(year);
    } catch(e) {
      content.innerHTML = `<p style="color:var(--accent-red)">Error: ${e.message}</p>`;
    }
  }, 80);
}

function buildStandaloneGochar(year) {
  const allPlanets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  const slowPlanets = ['Jupiter','Saturn','Rahu','Ketu'];

  const allTransitions = {};
  const allRetrogrades = {};
  allPlanets.forEach(p => {
    allTransitions[p] = findSignTransitions(p, year);
    allRetrogrades[p] = getRetrogradePeriods(p, year);
  });

  let html = '';

  // Year header
  const startJD = julianDay(year, 1, 1, 12);
  const startPositions = calculatePlanets(startJD);
  const hi = LANG === 'hi';
  html += `<div class="year-overview">
    <h3>&#x1F30D; ${hi ? 'गोचर — ग्रह राशि-प्रवेश समय' : 'Gochar — Planetary Transit Timings for'} ${year}</h3>
    <div class="overview-body">
      <b>${hi ? `1 जनवरी ${year} को ग्रह स्थिति:` : `Planetary positions on Jan 1, ${year}:`}</b><br>`;
  allPlanets.forEach(p => {
    const lon = startPositions[p];
    const sign = Math.floor(lon / 30) % 12;
    const color = PLANET_COLORS[p] || '#888';
    html += `<span style="display:inline-block;margin:3px 6px 3px 0;padding:3px 10px;background:rgba(245,244,240,0.9);border:1px solid var(--border);border-radius:8px;font-size:0.9em">`;
    html += `<span style="color:${color};font-weight:600">${PLANETS_INFO[p]?.symbol || p.substring(0,2)}</span> `;
    html += `${planetName(p)}: ${rashiName(sign)}</span>`;
  });
  html += `</div></div>`;

  // Slow planets
  html += `<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F311;</span> ${hi ? 'प्रमुख गोचर (मन्द ग्रह)' : 'Major Transits (Slow Planets)'}</div>`;
  html += `<p style="color:var(--text-dim);font-size:0.85em;margin:4px 0 14px 0">${hi ? 'बृहस्पति, शनि, राहु एवं केतु — ये गोचर वर्ष की प्रमुख दिशा निर्धारित करते हैं' : 'Jupiter, Saturn, Rahu & Ketu — these transits shape the year\'s major themes'}</p>`;

  slowPlanets.forEach(p => {
    html += buildStandaloneGocharCard(p, allTransitions[p], allRetrogrades[p], year);
  });
  html += '</div>';

  // Fast planets
  html += `<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x2604;&#xFE0F;</span> ${hi ? 'शीघ्र ग्रह गोचर' : 'Fast Planet Transits'}</div>`;
  ['Mars','Mercury','Venus','Sun'].forEach(p => {
    html += buildStandaloneGocharCard(p, allTransitions[p], allRetrogrades[p], year);
  });

  // Moon summary
  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px">`;
  html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">`;
  html += `<span class="planet-symbol" style="background:${PLANET_COLORS['Moon']};color:white">${PLANETS_INFO.Moon?.symbol || 'Mo'}</span>`;
  html += `<strong style="font-family:Plus Jakarta Sans,sans-serif;color:var(--text)">${hi ? 'चन्द्रमा' : 'Chandra (Moon)'}</strong></div>`;
  html += `<div style="font-size:0.9em;color:var(--text);line-height:1.6">${hi
    ? `चन्द्रमा लगभग 27.3 दिनों में सभी 12 राशियों में गोचर करता है, प्रत्येक राशि में लगभग 2.25 दिन रहता है। ${year} में चन्द्रमा लगभग <b>${allTransitions.Moon.length}</b> राशि परिवर्तन करता है। दैनिक चन्द्र गोचर समय के लिए कुण्डली बनाकर व्यक्तिगत प्रभाव देखें।`
    : `The Moon transits all 12 signs approximately every 27.3 days, spending about 2.25 days in each sign. In ${year}, the Moon makes approximately <b>${allTransitions.Moon.length}</b> sign changes. For daily Moon transit timings, generate a Kundali to see personalized effects.`
  }</div></div>`;
  html += '</div>';

  // Transit Calendar
  html += `<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F4C5;</span> ${hi ? 'गोचर पंचांग' : 'Transit Calendar'}</div>`;
  html += buildStandaloneTransitCalendar(allTransitions, allRetrogrades, year);
  html += '</div>';

  return html;
}

function buildStandaloneGocharCard(pName, transitions, retrogrades, year) {
  const hi = LANG === 'hi';
  const color = PLANET_COLORS[pName] || '#888';
  const symbol = PLANETS_INFO[pName]?.symbol || pName.substring(0,2);
  const sanskrit = PLANETS_INFO[pName]?.sanskrit || pName;
  const dispName = hi ? (I18N.planet_hi[pName] || pName) : `${sanskrit} (${pName})`;

  const startJD = julianDay(year, 1, 1, 12);
  const startLon = calculatePlanets(startJD)[pName];
  const startSign = Math.floor(startLon / 30) % 12;

  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px">`;
  html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">`;
  html += `<span class="planet-symbol" style="background:${color};color:white">${symbol}</span>`;
  html += `<div><strong style="font-family:Plus Jakarta Sans,sans-serif;color:var(--text)">${dispName}</strong>`;
  html += `<div style="font-size:0.82em;color:var(--text-dim)">${hi ? `${year} का आरम्भ ${rashiName(startSign)} में` : `Starts ${year} in ${RASHIS[startSign].name} (${RASHIS[startSign].eng})`}</div>`;
  html += `</div></div>`;

  if (transitions.length === 0) {
    html += `<div style="font-size:0.9em;color:var(--text);padding:8px 0">${hi ? `${dispName} सम्पूर्ण ${year} में ${rashiName(startSign)} में रहता है।` : `${pName} remains in ${RASHIS[startSign].name} (${RASHIS[startSign].eng}) throughout ${year}.`}</div>`;
  } else {
    html += `<table style="width:100%;border-collapse:collapse;font-size:0.9em">`;
    html += `<thead><tr style="border-bottom:2px solid var(--border)">`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${hi ? 'तिथि' : 'Date'}</th>`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${hi ? 'राशि प्रवेश' : 'Enters Rashi'}</th>`;
    html += `</tr></thead><tbody>`;

    html += `<tr style="border-bottom:1px solid rgba(0,0,0,0.05)">`;
    html += `<td style="padding:8px 10px;color:var(--text-dim)">${hi ? '1 जनवरी' : 'Jan 1'}</td>`;
    html += `<td style="padding:8px 10px"><b>${rashiName(startSign)}</b></td></tr>`;

    transitions.forEach(t => {
      html += `<tr style="border-bottom:1px solid rgba(0,0,0,0.05)">`;
      html += `<td style="padding:8px 10px;font-weight:500">${formatGocharDate(t.date)}</td>`;
      html += `<td style="padding:8px 10px"><b>${rashiName(t.toSign)}</b></td></tr>`;
    });
    html += `</tbody></table>`;
  }

  // Retrogrades
  if (retrogrades.length > 0) {
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">`;
    html += `<div style="font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--accent-red);font-weight:600;margin-bottom:6px">&#x21BA; ${hi ? 'वक्री काल' : 'Retrograde Periods'}</div>`;
    retrogrades.forEach(rr => {
      html += `<div style="font-size:0.9em;color:var(--text);padding:4px 0">`;
      html += `<b>${formatGocharDate(rr.startDate)}</b> ${hi ? 'से' : 'to'} <b>${formatGocharDate(rr.endDate)}</b>`;
      html += ` — ${hi ? 'वक्री' : 'retrograde in'} ${rashiName(rr.startSign)}`;
      if (rr.startSign !== rr.endSign) html += ` ${hi ? 'से' : 'to'} ${rashiName(rr.endSign)}`;
      html += `</div>`;
    });
    html += getRetroInterpretation(pName);
    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

function buildStandaloneTransitCalendar(allTransitions, allRetrogrades, year) {
  const hi = LANG === 'hi';
  const months = hi ? I18N.months_hi.slice(1) : ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let html = '<div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">';

  months.forEach((monthName, mi) => {
    const monthEvents = [];
    Object.keys(allTransitions).forEach(planet => {
      if (planet === 'Moon') return;
      allTransitions[planet].forEach(t => {
        if (t.date.getMonth() === mi && t.date.getFullYear() === year) {
          monthEvents.push({
            day: t.date.getDate(), date: t.date, type: 'transit', planet,
            text: hi ? `${planetName(planet)} का ${rashiName(t.toSign)} में प्रवेश` : `${planet} enters ${RASHIS[t.toSign].name} (${RASHIS[t.toSign].eng})`
          });
        }
      });
    });
    Object.keys(allRetrogrades).forEach(planet => {
      allRetrogrades[planet].forEach(r => {
        if (r.startDate.getMonth() === mi && r.startDate.getFullYear() === year) {
          monthEvents.push({ day: r.startDate.getDate(), date: r.startDate, type: 'retro-start', planet,
            text: hi ? `${planetName(planet)} ${rashiName(r.startSign)} में वक्री` : `${planet} turns retrograde in ${RASHIS[r.startSign].eng}` });
        }
        if (r.endDate.getMonth() === mi && r.endDate.getFullYear() === year) {
          monthEvents.push({ day: r.endDate.getDate(), date: r.endDate, type: 'retro-end', planet,
            text: hi ? `${planetName(planet)} ${rashiName(r.endSign)} में मार्गी` : `${planet} turns direct in ${RASHIS[r.endSign].eng}` });
        }
      });
    });
    monthEvents.sort((a, b) => a.day - b.day);
    if (monthEvents.length === 0) return;

    html += `<div style="background:rgba(245,244,240,0.5);border:1px solid var(--border);border-radius:10px;padding:14px">`;
    html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 8px 0;font-size:0.95em">${monthName} ${year}</h4>`;
    monthEvents.forEach(ev => {
      const colorStyle = ev.type === 'retro-start' ? 'color:var(--accent-red)' : ev.type === 'retro-end' ? 'color:var(--accent-green)' : 'color:var(--text)';
      const planetColor = PLANET_COLORS[ev.planet] || '#888';
      html += `<div style="padding:4px 0;font-size:0.88em;display:flex;align-items:center;gap:8px">`;
      html += `<span style="min-width:45px;font-weight:500;color:var(--text-dim)">${ev.day} ${hi ? monthName.substring(0,3) : monthName.substring(0,3)}</span>`;
      html += `<span style="color:${planetColor};font-weight:600;min-width:20px">${PLANETS_INFO[ev.planet]?.symbol || ''}</span>`;
      html += `<span style="${colorStyle}">${ev.text}</span></div>`;
    });
    html += `</div>`;
  });
  html += '</div>';
  return html;
}

// ---- GOCHAR (TRANSIT TIMINGS) ----

function populateGocharYearSelector() {
  if (!currentChart) return;
  const sel = document.getElementById('gocharYearSelect');
  const curYear = new Date().getFullYear();
  sel.innerHTML = '';
  const years = [];
  for (let y = curYear - 3; y <= curYear + 3; y++) years.push(y);
  years.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if (y === curYear) opt.selected = true;
    sel.appendChild(opt);
  });
}

function renderGochar() {
  if (!currentChart) return;
  const year = parseInt(document.getElementById('gocharYearSelect').value);
  if (!year) return;
  const content = document.getElementById('gocharContent');
  content.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-dim)">${LANG==='hi'?'गोचर गणना हो रही है...':'Computing Gochar timings...'}</div>`;
  setTimeout(() => {
    try {
      content.innerHTML = buildGochar(currentChart, year);
    } catch(e) {
      content.innerHTML = `<p style="color:var(--accent-red)">Error: ${e.message}</p>`;
    }
  }, 80);
}

function findSignTransitions(planetName, year) {
  // Returns array of {date, fromSign, toSign, jd} for each sign change in the year
  const transitions = [];
  const startJD = julianDay(year, 1, 1, 0);
  const endJD = julianDay(year, 12, 31, 23.99);

  // Step sizes: fast planets need daily, slow ones can use larger steps
  const stepDays = {
    Sun:2, Moon:0.4, Mars:2, Mercury:1, Jupiter:5, Venus:1.5, Saturn:7, Rahu:7, Ketu:7
  };
  const step = stepDays[planetName] || 2;

  let prevJD = startJD;
  let prevPlanets = calculatePlanets(prevJD);
  let prevSign = Math.floor(prevPlanets[planetName] / 30) % 12;

  for (let jd = startJD + step; jd <= endJD + step; jd += step) {
    const curJD = Math.min(jd, endJD + 0.5);
    const curPlanets = calculatePlanets(curJD);
    const curSign = Math.floor(curPlanets[planetName] / 30) % 12;

    if (curSign !== prevSign) {
      // Binary search for precise transition date
      let lo = prevJD, hi = curJD;
      for (let i = 0; i < 20; i++) {
        const mid = (lo + hi) / 2;
        const midPl = calculatePlanets(mid);
        const midSign = Math.floor(midPl[planetName] / 30) % 12;
        if (midSign === prevSign) lo = mid;
        else hi = mid;
      }
      const transJD = (lo + hi) / 2;
      // Only include if within the year
      if (transJD >= startJD - 0.5 && transJD <= endJD + 1) {
        transitions.push({
          jd: transJD,
          date: jdToDate(transJD),
          fromSign: prevSign,
          toSign: curSign,
          planet: planetName
        });
      }
      prevSign = curSign;
    }
    prevJD = curJD;
  }
  return transitions;
}

function getRetrogradePeriods(planetName, year) {
  // Detect retrograde periods (when longitude decreases)
  // Only applies to Mars, Mercury, Jupiter, Venus, Saturn
  if (['Sun','Moon','Rahu','Ketu'].includes(planetName)) return [];

  const startJD = julianDay(year, 1, 1, 0);
  const endJD = julianDay(year, 12, 31, 23.99);
  const step = planetName === 'Mercury' || planetName === 'Venus' ? 1 : 3;
  const periods = [];
  let isRetro = false;
  let retroStart = null;

  let prevLon = calculatePlanets(startJD)[planetName];

  for (let jd = startJD + step; jd <= endJD + step; jd += step) {
    const curJD = Math.min(jd, endJD + 0.5);
    const curLon = calculatePlanets(curJD)[planetName];

    // Handle sign boundary wrap (e.g. 359° → 1°)
    let diff = curLon - prevLon;
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;

    const curRetro = diff < 0;

    if (curRetro && !isRetro) {
      // Retrograde begins — binary search for precise date
      let lo = curJD - step, hi = curJD;
      for (let i = 0; i < 16; i++) {
        const mid = (lo + hi) / 2;
        const midLon = calculatePlanets(mid)[planetName];
        let d = midLon - calculatePlanets(mid - 0.5)[planetName];
        if (d > 180) d -= 360; if (d < -180) d += 360;
        if (d < 0) hi = mid; else lo = mid;
      }
      retroStart = (lo + hi) / 2;
      isRetro = true;
    } else if (!curRetro && isRetro) {
      // Retrograde ends (goes direct)
      let lo = curJD - step, hi = curJD;
      for (let i = 0; i < 16; i++) {
        const mid = (lo + hi) / 2;
        const midLon = calculatePlanets(mid)[planetName];
        let d = midLon - calculatePlanets(mid - 0.5)[planetName];
        if (d > 180) d -= 360; if (d < -180) d += 360;
        if (d >= 0) hi = mid; else lo = mid;
      }
      const retroEnd = (lo + hi) / 2;
      if (retroStart >= startJD - 30 && retroEnd <= endJD + 30) {
        periods.push({
          startJD: Math.max(retroStart, startJD),
          endJD: Math.min(retroEnd, endJD),
          startDate: jdToDate(Math.max(retroStart, startJD)),
          endDate: jdToDate(Math.min(retroEnd, endJD)),
          startSign: Math.floor(calculatePlanets(retroStart)[planetName] / 30) % 12,
          endSign: Math.floor(calculatePlanets(retroEnd)[planetName] / 30) % 12
        });
      }
      isRetro = false;
      retroStart = null;
    }
    prevLon = curLon;
  }
  // If still retrograde at year end
  if (isRetro && retroStart) {
    periods.push({
      startJD: Math.max(retroStart, startJD),
      endJD: endJD,
      startDate: jdToDate(Math.max(retroStart, startJD)),
      endDate: jdToDate(endJD),
      startSign: Math.floor(calculatePlanets(retroStart)[planetName] / 30) % 12,
      endSign: Math.floor(calculatePlanets(endJD)[planetName] / 30) % 12
    });
  }
  return periods;
}

function formatGocharDate(d) {
  if (!(d instanceof Date)) return '—';
  if (LANG === 'hi') {
    const day = d.getDate();
    const m = d.getMonth() + 1;
    const y = d.getFullYear();
    return day + ' ' + (I18N.months_hi[m] || '') + ' ' + y;
  }
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

function buildGochar(chart, year) {
  const moonSign = chart.planets.Moon.rashi.index;
  const moonSignName = chart.planets.Moon.rashi.name;
  const moonSignEng = chart.planets.Moon.rashi.eng;

  const allPlanets = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
  const slowPlanets = ['Jupiter','Saturn','Rahu','Ketu'];
  const fastPlanets = ['Sun','Moon','Mars','Mercury','Venus'];

  // Compute all transitions and retrogrades
  const allTransitions = {};
  const allRetrogrades = {};
  allPlanets.forEach(p => {
    allTransitions[p] = findSignTransitions(p, year);
    allRetrogrades[p] = getRetrogradePeriods(p, year);
  });

  let html = '';

  // Header summary
  const startJD = julianDay(year, 1, 1, 12);
  const startPositions = calculatePlanets(startJD);
  const _hi = LANG === 'hi';
  html += `<div class="year-overview">
    <h3>&#x1F30D; ${_hi ? 'गोचर — ग्रह राशि-प्रवेश समय' : 'Gochar — Planetary Transit Timings for'} ${year}</h3>
    <div class="overview-body">
      <b>${_hi ? 'आपकी जन्म राशि (चन्द्र राशि):' : 'Your Moon Sign (Janma Rashi):'}</b> ${_hi ? I18N.rashi_hi[moonSign] : moonSignName + ' (' + moonSignEng + ')'}<br>
      <b>${_hi ? `1 जनवरी ${year} को ग्रह स्थिति:` : `Planetary positions on Jan 1, ${year}:`}</b><br>`;
  allPlanets.forEach(p => {
    const lon = startPositions[p];
    const sign = Math.floor(lon / 30) % 12;
    const fromMoon = ((sign - moonSign + 12) % 12) + 1;
    const color = PLANET_COLORS[p] || '#888';
    html += `<span style="display:inline-block;margin:3px 6px 3px 0;padding:3px 10px;background:rgba(245,244,240,0.9);border:1px solid var(--border);border-radius:8px;font-size:0.9em">`;
    html += `<span style="color:${color};font-weight:600">${PLANETS_INFO[p]?.symbol || p.substring(0,2)}</span> `;
    html += `${planetName(p)}: ${rashiName(sign)} (${ordinalL(fromMoon)} ${_hi ? 'चन्द्र से' : 'from Moon'})</span>`;
  });
  html += `</div></div>`;

  // ---- SLOW PLANETS (Major transits) ----
  html += `<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F311;</span> ${_hi ? 'प्रमुख गोचर (मन्द ग्रह)' : 'Major Transits (Slow Planets)'}</div>`;
  html += `<p style="color:var(--text-dim);font-size:0.85em;margin:4px 0 14px 0">${_hi ? 'बृहस्पति, शनि, राहु एवं केतु — ये गोचर वर्ष की प्रमुख दिशा निर्धारित करते हैं' : 'Jupiter, Saturn, Rahu & Ketu — these transits shape the year\'s major themes'}</p>`;

  slowPlanets.forEach(p => {
    html += buildPlanetGocharCard(p, allTransitions[p], allRetrogrades[p], moonSign, year, chart);
  });
  html += '</div>';

  // ---- FAST PLANETS ----
  html += `<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x2604;&#xFE0F;</span> ${_hi ? 'शीघ्र ग्रह गोचर' : 'Fast Planet Transits'}</div>`;
  html += `<p style="color:var(--text-dim);font-size:0.85em;margin:4px 0 14px 0">${_hi ? 'सूर्य, चन्द्र, मंगल, बुध एवं शुक्र — विशिष्ट समय खिड़कियों को सक्रिय करने वाले लघु गोचर' : 'Sun, Moon, Mars, Mercury & Venus — shorter transits that activate specific timing windows'}</p>`;

  ['Mars','Mercury','Venus','Sun'].forEach(p => {
    html += buildPlanetGocharCard(p, allTransitions[p], allRetrogrades[p], moonSign, year, chart);
  });

  // Moon transits summary (too many to list individually)
  html += buildMoonGocharSummary(allTransitions.Moon, moonSign, year);
  html += '</div>';

  // ---- YEARLY TRANSIT CALENDAR ----
  html += `<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F4C5;</span> ${_hi ? 'गोचर पंचांग' : 'Transit Calendar'}</div>`;
  html += buildTransitCalendar(allTransitions, allRetrogrades, year, moonSign);
  html += '</div>';

  return html;
}

function buildPlanetGocharCard(pgcName, transitions, retrogrades, moonSign, year, chart) {
  const _hi = LANG === 'hi';
  const color = PLANET_COLORS[pgcName] || '#888';
  const symbol = PLANETS_INFO[pgcName]?.symbol || pgcName.substring(0,2);
  const sanskrit = PLANETS_INFO[pgcName]?.sanskrit || pgcName;
  const dispName = _hi ? (I18N.planet_hi[pgcName] || pgcName) : `${sanskrit} (${pgcName})`;

  const startJD = julianDay(year, 1, 1, 12);
  const startLon = calculatePlanets(startJD)[pgcName];
  const startSign = Math.floor(startLon / 30) % 12;
  const startFromMoon = ((startSign - moonSign + 12) % 12) + 1;

  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px">`;
  html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">`;
  html += `<span class="planet-symbol" style="background:${color};color:white">${symbol}</span>`;
  html += `<div>`;
  html += `<strong style="font-family:Plus Jakarta Sans,sans-serif;color:var(--text);font-size:1em">${dispName}</strong>`;
  html += `<div style="font-size:0.82em;color:var(--text-dim)">${_hi ? `${year} का आरम्भ ${rashiName(startSign)} में (${ordinalL(startFromMoon)} चन्द्र से)` : `Starts ${year} in ${RASHIS[startSign].eng} (${ordinal(startFromMoon)} from Moon)`}</div>`;
  html += `</div></div>`;

  if (transitions.length === 0) {
    html += `<div style="font-size:0.9em;color:var(--text);padding:8px 0">${_hi ? `${dispName} सम्पूर्ण ${year} में ${rashiName(startSign)} में रहता है।` : `${pgcName} remains in ${RASHIS[startSign].eng} throughout ${year}.`} `;
    html += getGocharHouseEffect(pgcName, startFromMoon);
    html += `</div>`;
  } else {
    html += `<table style="width:100%;border-collapse:collapse;font-size:0.9em">`;
    html += `<thead><tr style="border-bottom:2px solid var(--border)">`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${_hi ? 'तिथि' : 'Date'}</th>`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${_hi ? 'राशि प्रवेश' : 'Enters Rashi'}</th>`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${_hi ? 'चन्द्र से भाव' : 'House from Moon'}</th>`;
    html += `<th style="text-align:left;padding:6px 10px;color:var(--text-dim);font-weight:500;font-size:0.85em">${_hi ? 'प्रभाव' : 'Effect'}</th>`;
    html += `</tr></thead><tbody>`;

    html += `<tr style="border-bottom:1px solid rgba(0,0,0,0.05)">`;
    html += `<td style="padding:8px 10px;color:var(--text-dim);font-size:0.9em">${_hi ? '1 जनवरी' : 'Jan 1'}</td>`;
    html += `<td style="padding:8px 10px"><b>${rashiName(startSign)}</b></td>`;
    html += `<td style="padding:8px 10px">${ordinalL(startFromMoon)}</td>`;
    html += `<td style="padding:8px 10px">${getGocharRating(pgcName, startFromMoon)}</td>`;
    html += `</tr>`;

    transitions.forEach(t => {
      const fromMoon = ((t.toSign - moonSign + 12) % 12) + 1;
      html += `<tr style="border-bottom:1px solid rgba(0,0,0,0.05)">`;
      html += `<td style="padding:8px 10px;font-weight:500">${formatGocharDate(t.date)}</td>`;
      html += `<td style="padding:8px 10px"><b>${rashiName(t.toSign)}</b></td>`;
      html += `<td style="padding:8px 10px">${ordinalL(fromMoon)}</td>`;
      html += `<td style="padding:8px 10px">${getGocharRating(pgcName, fromMoon)}</td>`;
      html += `</tr>`;
    });
    html += `</tbody></table>`;
  }

  // Retrograde periods
  if (retrogrades.length > 0) {
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">`;
    html += `<div style="font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--accent-red);font-weight:600;margin-bottom:6px">&#x21BA; ${_hi ? 'वक्री काल' : 'Retrograde Periods'}</div>`;
    retrogrades.forEach(rr => {
      html += `<div style="font-size:0.9em;color:var(--text);padding:4px 0">`;
      html += `<b>${formatGocharDate(rr.startDate)}</b> ${_hi ? 'से' : 'to'} <b>${formatGocharDate(rr.endDate)}</b>`;
      html += ` — ${_hi ? 'वक्री' : 'retrograde in'} ${rashiName(rr.startSign)}`;
      if (rr.startSign !== rr.endSign) html += ` ${_hi ? 'से' : 'to'} ${rashiName(rr.endSign)}`;
      html += `</div>`;
    });
    html += getRetroInterpretation(pgcName);
    html += `</div>`;
  }

  // Detailed interpretation for slow planets
  if (['Jupiter','Saturn','Rahu','Ketu'].includes(pgcName)) {
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);font-size:0.9em;color:var(--text);line-height:1.6">`;
    html += getGocharHouseEffect(pgcName, startFromMoon);
    if (transitions.length > 0) {
      const lastTrans = transitions[transitions.length - 1];
      const lastFromMoon = ((lastTrans.toSign - moonSign + 12) % 12) + 1;
      if (lastFromMoon !== startFromMoon) {
        html += `<br><br><b>${_hi ? formatGocharDate(lastTrans.date) + ' के बाद:' : 'After ' + formatGocharDate(lastTrans.date) + ':'}</b> ${getGocharHouseEffect(pgcName, lastFromMoon)}`;
      }
    }
    html += `</div>`;
  }

  html += buildGocharNatalInteraction(pgcName, transitions, chart, year);
  html += `</div>`;
  return html;
}

function getGocharRating(planet, houseFromMoon) {
  // Vedic Ashtakavarga-style favorable/unfavorable houses from Moon
  const favorableHouses = {
    Sun: [3,6,10,11],
    Moon: [1,3,6,7,10,11],
    Mars: [3,6,11],
    Mercury: [2,4,6,8,10,11],
    Jupiter: [2,5,7,9,11],
    Venus: [1,2,3,4,5,8,9,11,12],
    Saturn: [3,6,11],
    Rahu: [3,6,10,11],
    Ketu: [3,6,9,11,12]
  };
  const fav = favorableHouses[planet] || [];
  if (fav.includes(houseFromMoon)) {
    return `<span style="color:var(--accent-green);font-weight:500">${LANG === 'hi' ? 'शुभ' : 'Favorable'}</span>`;
  } else {
    return `<span style="color:var(--accent-red);font-weight:500">${LANG === 'hi' ? 'चुनौतीपूर्ण' : 'Challenging'}</span>`;
  }
}

function getGocharHouseEffect(planet, houseFromMoon) {
  const hi = LANG === 'hi';
  const effects_en = {
    Jupiter: {1:'Jupiter over Moon sign brings optimism, health, wisdom, and new beginnings. Personal growth accelerates.',2:'Jupiter in 2nd brings financial growth, family harmony, eloquent speech, and savings increase.',3:'Jupiter in 3rd may bring stagnation, sibling issues, and unfulfilled efforts. Patience needed.',4:'Jupiter in 4th gives mixed results — domestic changes but inner growth and education benefit.',5:'Jupiter in 5th is excellent — creativity, romance, children\'s welfare, and spiritual merit flourish.',6:'Jupiter in 6th may bring health concerns or debt, but also strength to overcome enemies.',7:'Jupiter in 7th is very auspicious for partnerships, marriage, travel, and social reputation.',8:'Jupiter in 8th brings obstacles, health issues, and delays. Focus on research and inner transformation.',9:'Jupiter in 9th is supremely auspicious — fortune, pilgrimage, higher learning, and guru\'s blessings.',10:'Jupiter in 10th brings career ambition but mixed results. Professional reputation fluctuates.',11:'Jupiter in 11th is outstanding for gains, new friendships, and fulfillment of desires.',12:'Jupiter in 12th increases expenses but favors spiritual retreats, foreign travel, and charitable giving.'},
    Saturn: {1:'Saturn over Moon sign (Sade Sati peak) — emotional tests, health vigilance, and karmic lessons.',2:'Saturn in 2nd — financial discipline needed, family dynamics become serious, guard speech.',3:'Saturn in 3rd — one of the best transits: courage, successful ventures, sibling support.',4:'Saturn in 4th (Dhaiya) — domestic challenges, mother\'s health, emotional heaviness.',5:'Saturn in 5th — creativity blocked, children concerns, avoid speculation. Structured study helps.',6:'Saturn in 6th — excellent for defeating enemies, resolving debts, and overcoming health issues.',7:'Saturn in 7th — partnerships tested, relationships feel heavy but mature through shared responsibility.',8:'Saturn in 8th (Dhaiya) — health risks, sudden changes, hidden matters surface. Caution essential.',9:'Saturn in 9th — fortune requires extra effort, father\'s health needs attention, delayed travels.',10:'Saturn in 10th — heavy professional responsibility but lasting career achievements through discipline.',11:'Saturn in 11th — the best Saturn transit: income growth, desires fulfilled, social recognition.',12:'Saturn in 12th (Sade Sati rising) — expenses rise, sleep issues, spiritual preparation phase.'},
    Rahu: {1:'Rahu over Moon sign — obsessive thinking, identity shifts, foreign connections. Grounding practices essential.',2:'Rahu in 2nd — sudden financial swings, unusual speech patterns, family disruptions possible.',3:'Rahu in 3rd — amplified courage, tech success, bold communication. Generally favorable.',4:'Rahu in 4th — domestic upheaval, property surprises, mother\'s health watchful.',5:'Rahu in 5th — intense creativity and romance, but speculative risks. Children need attention.',6:'Rahu in 6th — victory over enemies through clever strategies, innovative health solutions.',7:'Rahu in 7th — unconventional partnerships, foreign spouse/partner, contracts need scrutiny.',8:'Rahu in 8th — sudden events, health scares, but deep occult knowledge and possible inheritance.',9:'Rahu in 9th — spiritual confusion, foreign long travel, unconventional beliefs emerge.',10:'Rahu in 10th — ambitious career moves, sudden elevation, but guard against shortcuts.',11:'Rahu in 11th — large gains, ambitious networking, foreign income sources. Excellent placement.',12:'Rahu in 12th — expenditure spikes, vivid dreams, foreign travel. Meditation helps.'},
    Ketu: {1:'Ketu over Moon sign — spiritual awakening, ego dissolution, identity transformation.',2:'Ketu in 2nd — financial detachment, family distance, speech becomes spiritually inclined.',3:'Ketu in 3rd — intuitive decisions, reduced conventional courage, spiritual communication.',4:'Ketu in 4th — home detachment, relocation possible, inner peace through spiritual means.',5:'Ketu in 5th — spiritual intelligence, past-life recall, unconventional education. Romance cools.',6:'Ketu in 6th — enemies dissolve naturally, chronic health improves through alternative healing.',7:'Ketu in 7th — partnership detachment, self-reliance grows, spiritual understanding of relationships.',8:'Ketu in 8th — deep transformation, psychic abilities, liberation from karmic debts.',9:'Ketu in 9th — profound spiritual wisdom, unusual pilgrimages, guru\'s blessings manifest unexpectedly.',10:'Ketu in 10th — career detachment, service-oriented work, past professional karma resolves.',11:'Ketu in 11th — material gains reduce but spiritual friendships deepen. Simple desires.',12:'Ketu in 12th — excellent for moksha, meditation, transcendence. Past-life connections activate.'}
  };
  const effects_hi = {
    Jupiter: {1:'चन्द्र राशि पर बृहस्पति आशावाद, स्वास्थ्य, ज्ञान और नई शुरुआत लाता है। व्यक्तिगत विकास तीव्र होता है।',2:'द्वितीय भाव में बृहस्पति आर्थिक वृद्धि, पारिवारिक सद्भाव, मधुर वाणी और बचत में वृद्धि लाता है।',3:'तृतीय भाव में बृहस्पति ठहराव, भाई-बहन से कठिनाई और अपूर्ण प्रयास ला सकता है। धैर्य आवश्यक।',4:'चतुर्थ भाव में बृहस्पति मिश्रित परिणाम देता है — घरेलू बदलाव परन्तु आन्तरिक विकास और शिक्षा लाभ।',5:'पंचम भाव में बृहस्पति उत्कृष्ट है — सृजनशीलता, प्रेम, सन्तान कल्याण और आध्यात्मिक पुण्य फलता-फूलता है।',6:'षष्ठ भाव में बृहस्पति स्वास्थ्य चिन्ता या ऋण ला सकता है, परन्तु शत्रुओं पर विजय की शक्ति भी।',7:'सप्तम भाव में बृहस्पति साझेदारी, विवाह, यात्रा और सामाजिक प्रतिष्ठा के लिए अत्यन्त शुभ है।',8:'अष्टम भाव में बृहस्पति बाधाएँ, स्वास्थ्य समस्याएँ और विलम्ब लाता है। अनुसन्धान और आन्तरिक रूपान्तरण पर ध्यान दें।',9:'नवम भाव में बृहस्पति परम शुभ है — भाग्य, तीर्थयात्रा, उच्च शिक्षा और गुरु कृपा।',10:'दशम भाव में बृहस्पति करियर महत्वाकांक्षा लाता है परन्तु मिश्रित परिणाम। व्यावसायिक प्रतिष्ठा में उतार-चढ़ाव।',11:'एकादश भाव में बृहस्पति लाभ, नई मित्रता और इच्छापूर्ति के लिए उत्कृष्ट है।',12:'द्वादश भाव में बृहस्पति व्यय बढ़ाता है परन्तु आध्यात्मिक एकान्तवास, विदेश यात्रा और दान को अनुकूल करता है।'},
    Saturn: {1:'चन्द्र राशि पर शनि (साढ़े साती चरम) — भावनात्मक परीक्षा, स्वास्थ्य सतर्कता और कर्मिक सबक।',2:'द्वितीय में शनि — आर्थिक अनुशासन आवश्यक, पारिवारिक गतिशीलता गम्भीर, वाणी पर संयम।',3:'तृतीय में शनि — सर्वश्रेष्ठ गोचरों में से एक: साहस, सफल उपक्रम, भाई-बहन का सहयोग।',4:'चतुर्थ में शनि (ढैय्या) — घरेलू चुनौतियाँ, माता का स्वास्थ्य, भावनात्मक भारीपन।',5:'पंचम में शनि — सृजनशीलता अवरुद्ध, सन्तान चिन्ता, सट्टे से बचें। व्यवस्थित अध्ययन सहायक।',6:'षष्ठ में शनि — शत्रुओं पर विजय, ऋण निवारण और स्वास्थ्य सुधार के लिए उत्कृष्ट।',7:'सप्तम में शनि — साझेदारी की परीक्षा, सम्बन्ध भारी परन्तु साझा उत्तरदायित्व से परिपक्व।',8:'अष्टम में शनि (ढैय्या) — स्वास्थ्य जोखिम, अचानक परिवर्तन, छिपे मामले प्रकट। सावधानी अनिवार्य।',9:'नवम में शनि — भाग्य में अतिरिक्त प्रयास, पिता के स्वास्थ्य पर ध्यान, विलम्बित यात्राएँ।',10:'दशम में शनि — भारी व्यावसायिक उत्तरदायित्व परन्तु अनुशासन से स्थायी करियर उपलब्धियाँ।',11:'एकादश में शनि — सर्वश्रेष्ठ शनि गोचर: आय वृद्धि, इच्छापूर्ति, सामाजिक मान्यता।',12:'द्वादश में शनि (साढ़े साती आरम्भ) — व्यय वृद्धि, नींद समस्या, आध्यात्मिक तैयारी चरण।'},
    Rahu: {1:'चन्द्र राशि पर राहु — जुनूनी चिन्तन, पहचान में बदलाव, विदेशी सम्पर्क। ग्राउण्डिंग अभ्यास अनिवार्य।',2:'द्वितीय में राहु — अचानक आर्थिक उतार-चढ़ाव, असामान्य वाणी, पारिवारिक व्यवधान सम्भव।',3:'तृतीय में राहु — साहस वृद्धि, तकनीकी सफलता, साहसिक संवाद। सामान्यतः शुभ।',4:'चतुर्थ में राहु — घरेलू उथल-पुथल, सम्पत्ति आश्चर्य, माता के स्वास्थ्य पर ध्यान।',5:'पंचम में राहु — तीव्र सृजनशीलता और प्रेम, परन्तु सट्टा जोखिम। सन्तान पर ध्यान आवश्यक।',6:'षष्ठ में राहु — चतुर रणनीतियों से शत्रुओं पर विजय, नवीन स्वास्थ्य समाधान।',7:'सप्तम में राहु — अपरम्परागत साझेदारी, विदेशी जीवनसाथी, अनुबन्धों की जाँच आवश्यक।',8:'अष्टम में राहु — अचानक घटनाएँ, स्वास्थ्य भय, परन्तु गहन तान्त्रिक ज्ञान और सम्भव विरासत।',9:'नवम में राहु — आध्यात्मिक भ्रम, विदेशी दीर्घ यात्रा, अपरम्परागत विश्वास उभरते हैं।',10:'दशम में राहु — महत्वाकांक्षी करियर कदम, अचानक उन्नति, परन्तु शॉर्टकट से बचें।',11:'एकादश में राहु — बड़ा लाभ, महत्वाकांक्षी नेटवर्किंग, विदेशी आय स्रोत। उत्कृष्ट स्थिति।',12:'द्वादश में राहु — व्यय वृद्धि, सजीव स्वप्न, विदेश यात्रा। ध्यान सहायक।'},
    Ketu: {1:'चन्द्र राशि पर केतु — आध्यात्मिक जागृति, अहंकार विलय, पहचान रूपान्तरण।',2:'द्वितीय में केतु — आर्थिक वैराग्य, परिवार से दूरी, वाणी आध्यात्मिक झुकाव की ओर।',3:'तृतीय में केतु — सहज निर्णय, पारम्परिक साहस में कमी, आध्यात्मिक संवाद।',4:'चतुर्थ में केतु — गृह वैराग्य, स्थानान्तरण सम्भव, आध्यात्मिक साधनों से आन्तरिक शान्ति।',5:'पंचम में केतु — आध्यात्मिक बुद्धि, पूर्वजन्म स्मृति, अपरम्परागत शिक्षा। प्रेम शीतल।',6:'षष्ठ में केतु — शत्रु स्वाभाविक रूप से विलीन, वैकल्पिक उपचार से जीर्ण स्वास्थ्य सुधार।',7:'सप्तम में केतु — साझेदारी वैराग्य, आत्मनिर्भरता बढ़ती है, सम्बन्धों की आध्यात्मिक समझ।',8:'अष्टम में केतु — गहन रूपान्तरण, मानसिक क्षमताएँ, कर्मिक ऋणों से मुक्ति।',9:'नवम में केतु — गहन आध्यात्मिक ज्ञान, असामान्य तीर्थयात्राएँ, गुरु कृपा अप्रत्याशित रूप से प्रकट।',10:'दशम में केतु — करियर वैराग्य, सेवा-उन्मुख कार्य, विगत व्यावसायिक कर्म का समाधान।',11:'एकादश में केतु — भौतिक लाभ कम परन्तु आध्यात्मिक मित्रताएँ गहरी। सरल इच्छाएँ।',12:'द्वादश में केतु — मोक्ष, ध्यान, उत्कर्ष के लिए उत्कृष्ट। पूर्वजन्म सम्बन्ध सक्रिय।'}
  };

  const effects = hi ? effects_hi : effects_en;
  if (effects[planet] && effects[planet][houseFromMoon]) {
    return effects[planet][houseFromMoon];
  }
  return '';
}

function getRetroInterpretation(planet) {
  const wrap = t => `<div style="font-size:0.88em;color:var(--text);margin-top:6px;line-height:1.5">${t}</div>`;
  const hi = LANG === 'hi';
  const interps_en = {
    Mars: 'Mars retrograde slows momentum, revisits old conflicts, and redirects energy inward. Avoid starting new aggressive ventures. Good for completing unfinished projects and resolving past disputes.',
    Mercury: 'Mercury retrograde affects communication, technology, travel plans, and contracts. Double-check documents, back up data, and avoid signing important agreements. Good for review, revision, and reconnecting with old contacts.',
    Jupiter: 'Jupiter retrograde turns wisdom inward — a period for philosophical reflection, reviewing beliefs, and inner growth. External expansion pauses, but spiritual understanding deepens. Past blessings may return.',
    Venus: 'Venus retrograde re-evaluates relationships, values, and pleasures. Past lovers may reappear. Avoid major purchases of luxury items and cosmetic procedures. Good for introspecting on what truly matters in love and beauty.',
    Saturn: 'Saturn retrograde intensifies karmic lessons and may revisit old responsibilities or restrictions. Delays become more pronounced, but this is an excellent period for restructuring, disciplined inner work, and clearing karmic debts.'
  };
  const interps_hi = {
    Mars: 'मंगल वक्री गति धीमी करता है, पुराने संघर्षों को पुनर्जीवित करता है, और ऊर्जा को अन्तर्मुखी करता है। नए आक्रामक उपक्रम शुरू करने से बचें। अधूरी परियोजनाओं को पूरा करने और पिछले विवादों को सुलझाने के लिए अच्छा समय।',
    Mercury: 'बुध वक्री संवाद, प्रौद्योगिकी, यात्रा योजनाओं और अनुबन्धों को प्रभावित करता है। दस्तावेज़ दोबारा जाँचें, डेटा बैकअप लें, और महत्वपूर्ण समझौतों पर हस्ताक्षर करने से बचें। समीक्षा, संशोधन और पुराने सम्पर्कों से पुनः जुड़ने के लिए अच्छा।',
    Jupiter: 'बृहस्पति वक्री ज्ञान को अन्तर्मुखी करता है — दार्शनिक चिन्तन, विश्वासों की समीक्षा और आन्तरिक विकास का काल। बाह्य विस्तार रुकता है, परन्तु आध्यात्मिक समझ गहरी होती है। पिछले आशीर्वाद लौट सकते हैं।',
    Venus: 'शुक्र वक्री सम्बन्धों, मूल्यों और सुखों का पुनर्मूल्यांकन करता है। पिछले प्रेमी पुनः प्रकट हो सकते हैं। विलासिता की बड़ी खरीदारी और सौन्दर्य प्रक्रियाओं से बचें। प्रेम और सौन्दर्य में वास्तव में क्या महत्वपूर्ण है इस पर आत्मचिन्तन के लिए अच्छा।',
    Saturn: 'शनि वक्री कर्मिक पाठों को तीव्र करता है और पुरानी ज़िम्मेदारियों या प्रतिबन्धों को पुनर्जीवित कर सकता है। विलम्ब और अधिक स्पष्ट हो जाते हैं, परन्तु यह पुनर्गठन, अनुशासित आन्तरिक कार्य और कर्मिक ऋणों के निवारण के लिए उत्कृष्ट काल है।'
  };
  const interps = hi ? interps_hi : interps_en;
  return interps[planet] ? wrap(interps[planet]) : '';
}

function buildGocharNatalInteraction(planet, transitions, chart, year) {
  // Check if transiting planet passes over any natal planet positions
  if (['Moon'].includes(planet)) return ''; // Too many for Moon
  const hi = LANG === 'hi';
  const natalPlanets = Object.keys(chart.planets).filter(p => p !== '_debug');
  const interactions = [];

  transitions.forEach(t => {
    natalPlanets.forEach(np => {
      const natalSign = chart.planets[np].rashi.index;
      if (t.toSign === natalSign) {
        interactions.push({
          date: t.date,
          natalPlanet: np,
          signIdx: t.toSign
        });
      }
    });
  });

  // Also check starting sign
  const startJD = julianDay(year, 1, 1, 12);
  const startSign = Math.floor(calculatePlanets(startJD)[planet] / 30) % 12;
  natalPlanets.forEach(np => {
    if (startSign === chart.planets[np].rashi.index) {
      interactions.unshift({date: new Date(year, 0, 1), natalPlanet: np, signIdx: startSign, isStart: true});
    }
  });

  if (interactions.length === 0) return '';

  let html = `<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">`;
  html += `<div style="font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--indigo);font-weight:600;margin-bottom:6px">&#x2728; ${hi ? 'जन्म ग्रह सक्रियता' : 'Natal Planet Activations'}</div>`;
  interactions.forEach(ix => {
    const pDisp = planetName(planet);
    const npDisp = planetName(ix.natalPlanet);
    const signDisp = hi ? rashiName(ix.signIdx) : RASHIS[ix.signIdx].eng;
    const conjunction = planet === ix.natalPlanet
      ? (hi ? 'अपनी जन्म स्थिति पर लौटता है' : 'returns to natal position')
      : (hi ? `जन्म ${npDisp} से युति करता है` : `conjuncts natal ${ix.natalPlanet}`);
    html += `<div style="font-size:0.88em;color:var(--text);padding:3px 0">`;
    if (ix.isStart) {
      html += hi
        ? `वर्ष आरम्भ: गोचर ${pDisp} ${conjunction} ${signDisp} में`
        : `At year start: Transit ${planet} ${conjunction} in ${RASHIS[ix.signIdx].eng}`;
    } else {
      html += hi
        ? `<b>${formatGocharDate(ix.date)}</b>: गोचर ${pDisp} ${conjunction} ${signDisp} में`
        : `<b>${formatGocharDate(ix.date)}</b>: Transit ${planet} ${conjunction} in ${RASHIS[ix.signIdx].eng}`;
    }
    html += hi
      ? ` — ${npDisp} के जन्मकालीन फलों को सक्रिय करता है`
      : ` — activates ${ix.natalPlanet}'s natal significations`;
    html += `</div>`;
  });
  html += `</div>`;
  return html;
}

function buildMoonGocharSummary(moonTransitions, moonSign, year) {
  const hi = LANG === 'hi';
  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px">`;
  const color = PLANET_COLORS['Moon'] || '#888';
  html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">`;
  html += `<span class="planet-symbol" style="background:${color};color:white">${PLANETS_INFO.Moon?.symbol || 'Mo'}</span>`;
  html += `<strong style="font-family:Plus Jakarta Sans,sans-serif;color:var(--text)">${hi ? 'चन्द्र (Moon)' : 'Chandra (Moon)'}</strong>`;
  html += `</div>`;
  html += `<div style="font-size:0.9em;color:var(--text);line-height:1.6">`;
  const moonRashi = hi ? rashiName(moonSign) : RASHIS[moonSign].eng;
  if (hi) {
    html += `चन्द्रमा लगभग 27.3 दिनों (एक नाक्षत्र मास) में सभी 12 राशियों से गोचर करता है, प्रत्येक राशि में लगभग 2.25 दिन रहता है। ${year} में चन्द्रमा लगभग <b>${moonTransitions.length}</b> राशि परिवर्तन करता है।<br><br>`;
    html += `<b>${moonRashi} चन्द्र राशि के लिए प्रमुख चन्द्र गोचर दिवस:</b><br>`;
    html += `• चन्द्रमा स्वराशि (${moonRashi}) में गोचर — भावनात्मक स्वास्थ्य और व्यक्तिगत निर्णयों के लिए अनुकूल<br>`;
    const fav2 = (moonSign + 2) % 12;
    const fav5 = (moonSign + 6) % 12;
    const fav8 = (moonSign + 10) % 12;
    html += `• चन्द्रमा ${rashiName(fav2)} (चन्द्र से तृतीय) में — साहस, संवाद और लघु यात्राओं के लिए शुभ<br>`;
    html += `• चन्द्रमा ${rashiName(fav5)} (चन्द्र से सप्तम) में — साझेदारी और सामाजिक संबंधों के लिए अनुकूल<br>`;
    html += `• चन्द्रमा ${rashiName(fav8)} (चन्द्र से एकादश) में — लाभ, मित्रता और इच्छा पूर्ति के लिए उत्तम<br>`;
    html += `<br><i>सुझाव: दैनिक समय मार्गदर्शन के लिए "वर्तमान गोचर" टैब में चन्द्रमा की वर्तमान गोचर राशि देखें।</i>`;
  } else {
    html += `The Moon transits through all 12 signs approximately every 27.3 days (one sidereal month), spending roughly 2.25 days in each sign. In ${year}, the Moon makes approximately <b>${moonTransitions.length}</b> sign changes.<br><br>`;
    html += `<b>Key Moon transit days for ${moonRashi} Moon sign:</b><br>`;
    html += `• Moon transiting your own sign (${moonRashi}) — favorable for emotional well-being and personal decisions<br>`;
    const fav2 = (moonSign + 2) % 12;
    const fav5 = (moonSign + 6) % 12;
    const fav8 = (moonSign + 10) % 12;
    html += `• Moon in ${RASHIS[fav2].eng} (3rd from Moon) — good for courage, communication, and short travels<br>`;
    html += `• Moon in ${RASHIS[fav5].eng} (7th from Moon) — favorable for partnerships and social interactions<br>`;
    html += `• Moon in ${RASHIS[fav8].eng} (11th from Moon) — excellent for gains, friendships, and fulfilling desires<br>`;
    html += `<br><i>Tip: Check the Moon\'s current transit sign in the "Current Transits" tab for daily timing guidance.</i>`;
  }
  html += `</div></div>`;
  return html;
}

function buildTransitCalendar(allTransitions, allRetrogrades, year, moonSign) {
  const hi = LANG === 'hi';
  const months_en = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const months_hi = ['जनवरी','फरवरी','मार्च','अप्रैल','मई','जून','जुलाई','अगस्त','सितम्बर','अक्टूबर','नवम्बर','दिसम्बर'];
  const months = hi ? months_hi : months_en;
  const monthsShort_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthsShort_hi = ['जन','फर','मार्च','अप्रै','मई','जून','जुला','अग','सित','अक्टू','नव','दिस'];
  const monthsShort = hi ? monthsShort_hi : monthsShort_en;

  let html = '<div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">';

  months.forEach((monthName, mi) => {
    const monthEvents = [];

    Object.keys(allTransitions).forEach(planet => {
      if (planet === 'Moon') return;
      allTransitions[planet].forEach(t => {
        if (t.date.getMonth() === mi && t.date.getFullYear() === year) {
          const fromMoon = ((t.toSign - moonSign + 12) % 12) + 1;
          const signDisp = hi ? rashiName(t.toSign) : RASHIS[t.toSign].eng;
          const pDisp = planetName(planet);
          const ordStr = hi ? ordinalL(fromMoon) : ordinal(fromMoon);
          const fromLabel = hi ? 'चन्द्र से' : 'from Moon';
          const entersLabel = hi ? 'प्रवेश' : 'enters';
          const rating = getGocharRating(planet, fromMoon);
          monthEvents.push({
            day: t.date.getDate(),
            date: t.date,
            type: 'transit',
            planet,
            text: `${pDisp} ${entersLabel} ${signDisp} (${ordStr} ${fromLabel})`,
            favorable: rating.includes('Favorable') || rating.includes('शुभ')
          });
        }
      });
    });

    Object.keys(allRetrogrades).forEach(planet => {
      allRetrogrades[planet].forEach(r => {
        if (r.startDate.getMonth() === mi && r.startDate.getFullYear() === year) {
          const signDisp = hi ? rashiName(r.startSign) : RASHIS[r.startSign].eng;
          const pDisp = planetName(planet);
          monthEvents.push({
            day: r.startDate.getDate(),
            date: r.startDate,
            type: 'retro-start',
            planet,
            text: hi ? `${pDisp} ${signDisp} में वक्री` : `${planet} turns retrograde in ${RASHIS[r.startSign].eng}`,
            favorable: false
          });
        }
        if (r.endDate.getMonth() === mi && r.endDate.getFullYear() === year) {
          const signDisp = hi ? rashiName(r.endSign) : RASHIS[r.endSign].eng;
          const pDisp = planetName(planet);
          monthEvents.push({
            day: r.endDate.getDate(),
            date: r.endDate,
            type: 'retro-end',
            planet,
            text: hi ? `${pDisp} ${signDisp} में मार्गी` : `${planet} turns direct in ${RASHIS[r.endSign].eng}`,
            favorable: true
          });
        }
      });
    });

    monthEvents.sort((a, b) => a.day - b.day);

    if (monthEvents.length === 0) return;

    html += `<div style="background:rgba(245,244,240,0.5);border:1px solid var(--border);border-radius:10px;padding:14px">`;
    html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 8px 0;font-size:0.95em">${monthName} ${year}</h4>`;
    monthEvents.forEach(ev => {
      const icon = ev.type === 'retro-start' ? '&#x21BA;' : ev.type === 'retro-end' ? '&#x21BB;' : '&#x27A1;&#xFE0F;';
      const colorStyle = ev.favorable ? 'color:var(--accent-green)' : ev.type === 'retro-start' ? 'color:var(--accent-red)' : 'color:var(--text)';
      const planetColor = PLANET_COLORS[ev.planet] || '#888';
      html += `<div style="padding:4px 0;font-size:0.88em;display:flex;align-items:center;gap:8px">`;
      html += `<span style="min-width:45px;font-weight:500;color:var(--text-dim)">${monthsShort[mi]} ${ev.day}</span>`;
      html += `<span style="color:${planetColor};font-weight:600;min-width:20px">${PLANETS_INFO[ev.planet]?.symbol || ''}</span>`;
      html += `<span style="${colorStyle}">${ev.text}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  });

  html += '</div>';
  return html;
}

// ---- RASHI PHAL (MOON SIGN YEARLY PREDICTIONS) ----

function populateRashiPhalYearSelector() {
  if (!currentChart) return;
  const sel = document.getElementById('rashiPhalYearSelect');
  const now = new Date();
  const curYear = now.getFullYear();
  sel.innerHTML = '';
  for (let y = curYear; y >= curYear - 5; y--) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if (y === curYear) opt.selected = true;
    sel.appendChild(opt);
  }
  for (let y = curYear + 1; y <= curYear + 3; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    sel.appendChild(opt);
  }
  // Sort options
  const opts = Array.from(sel.options);
  opts.sort((a,b) => parseInt(b.value) - parseInt(a.value));
  sel.innerHTML = '';
  opts.forEach(o => sel.appendChild(o));
  sel.value = curYear;
}

function renderRashiPhal() {
  if (!currentChart) return;
  const year = parseInt(document.getElementById('rashiPhalYearSelect').value);
  if (!year) return;
  const content = document.getElementById('rashiPhalContent');
  content.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-dim)">Computing Rashi Phal...</div>';
  setTimeout(() => {
    try {
      content.innerHTML = buildRashiPhal(currentChart, year);
    } catch(e) {
      content.innerHTML = `<p style="color:var(--accent-red)">Error: ${e.message}</p>`;
    }
  }, 50);
}

function buildRashiPhal(chart, year) {
  const moonSign = chart.planets.Moon.rashi.index;
  const moonSignName = chart.planets.Moon.rashi.name;
  const moonSignEng = chart.planets.Moon.rashi.eng;
  const moonNak = chart.planets.Moon.nakshatra;

  // Calculate transit positions at mid-year and quarterly
  const quarters = [
    {label:'Jan–Mar', m:2, d:15},
    {label:'Apr–Jun', m:5, d:15},
    {label:'Jul–Sep', m:8, d:15},
    {label:'Oct–Dec', m:11, d:15}
  ];
  const midYearJD = julianDay(year, 7, 1, 12);
  const midPlanets = calculatePlanets(midYearJD);

  const qData = quarters.map(q => {
    const jd = julianDay(year, q.m, q.d, 12);
    const pl = calculatePlanets(jd);
    const positions = {};
    ['Jupiter','Saturn','Rahu','Ketu','Mars','Venus','Mercury','Sun','Moon'].forEach(p => {
      const lon = pl[p];
      const sign = Math.floor(lon / 30) % 12;
      const fromMoon = ((sign - moonSign + 12) % 12) + 1;
      positions[p] = { lon, sign, fromMoon, rashi: RASHIS[sign] };
    });
    return { ...q, positions };
  });

  // Major slow-planet transit positions from Moon sign
  const jupSign = Math.floor(midPlanets.Jupiter / 30) % 12;
  const satSign = Math.floor(midPlanets.Saturn / 30) % 12;
  const rahuSign = Math.floor(midPlanets.Rahu / 30) % 12;
  const ketuSign = Math.floor(midPlanets.Ketu / 30) % 12;
  const jupFromMoon = ((jupSign - moonSign + 12) % 12) + 1;
  const satFromMoon = ((satSign - moonSign + 12) % 12) + 1;
  const rahuFromMoon = ((rahuSign - moonSign + 12) % 12) + 1;
  const ketuFromMoon = ((ketuSign - moonSign + 12) % 12) + 1;

  let html = '';

  // Header: Moon Sign info
  html += `<div class="year-overview">
    <h3>&#x1F319; Rashi Phal for ${year} — ${moonSignName} (${moonSignEng}) Rashi</h3>
    <div class="overview-body">
      <b>Your Moon Sign (Janma Rashi):</b> ${moonSignName} (${moonSignEng}), ruled by ${RASHIS[moonSign].lord}<br>
      <b>Nakshatra:</b> ${moonNak.name} (Pada ${moonNak.pada})<br>
      <b>Jupiter Transit:</b> ${ordinal(jupFromMoon)} house from Moon (${RASHIS[jupSign].eng})<br>
      <b>Saturn Transit:</b> ${ordinal(satFromMoon)} house from Moon (${RASHIS[satSign].eng})<br>
      <b>Rahu Transit:</b> ${ordinal(rahuFromMoon)} house from Moon (${RASHIS[rahuSign].eng})<br>
      <b>Ketu Transit:</b> ${ordinal(ketuFromMoon)} house from Moon (${RASHIS[ketuSign].eng})
    </div>
  </div>`;

  // Sade Sati / Dhaiya check
  html += buildSadeSatiSection(satFromMoon, satSign, moonSign, year);

  // Jupiter Transit Reading (Guru Gochar)
  html += '<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x2728;</span> Jupiter Transit (Guru Gochar)</div>';
  html += buildJupiterTransitReading(jupFromMoon, jupSign, moonSignEng, year, qData);
  html += '</div>';

  // Saturn Transit Reading (Shani Gochar)
  html += '<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F6E1;</span> Saturn Transit (Shani Gochar)</div>';
  html += buildSaturnTransitReading(satFromMoon, satSign, moonSignEng, year);
  html += '</div>';

  // Rahu-Ketu Transit
  html += '<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F300;</span> Rahu-Ketu Axis Transit</div>';
  html += buildRahuKetuTransitReading(rahuFromMoon, ketuFromMoon, rahuSign, ketuSign, moonSignEng);
  html += '</div>';

  // Life Area Predictions from Moon Sign
  html += '<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F52E;</span> Life Area Predictions from Moon Sign</div>';
  html += buildRashiPhalLifeAreas(moonSign, jupFromMoon, satFromMoon, rahuFromMoon, ketuFromMoon, qData);
  html += '</div>';

  // Quarterly Transit Overview
  html += '<div style="margin-top:20px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F4C5;</span> Quarterly Transit Overview</div>';
  html += buildRashiPhalQuarters(qData, moonSign);
  html += '</div>';

  return html;
}

function buildSadeSatiSection(satFromMoon, satSign, moonSign, year) {
  let html = '';
  const hi = LANG === 'hi';
  if ([12,1,2].includes(satFromMoon)) {
    const phases = hi
      ? {12:'आरोही चरण (शनि चन्द्रमा से 12वें भाव में)',1:'चरम चरण (शनि चन्द्र राशि पर)',2:'अवरोही चरण (शनि चन्द्रमा से 2रे भाव में)'}
      : {12:'Rising Phase (Ascending — Saturn in 12th from Moon)',1:'Peak Phase (Saturn over Moon Sign)',2:'Setting Phase (Descending — Saturn in 2nd from Moon)'};
    const phaseDescs = hi
      ? {
        12:'शनि आपकी चन्द्र राशि से पूर्व की राशि में प्रवेश कर रहा है, साढ़े साती काल का आरम्भ। यह चरण मुख्य रूप से वित्त, मानसिक शान्ति और घरेलू सुख को प्रभावित करता है। बेचैनी और अनिर्धारित चिन्ता अनुभव हो सकती है। अपरिचित स्थानों की यात्रा सम्भव। आन्तरिक दृढ़ता निर्माण पर ध्यान केन्द्रित करें।',
        1:'शनि सीधे आपकी चन्द्र राशि पर गोचर कर रहा है — साढ़े साती का सबसे तीव्र चरण। यह अवधि भावनाओं, परिवार (विशेषकर माता) से सम्बन्ध, मानसिक स्वास्थ्य और समग्र सुरक्षा बोध की गहन परीक्षा लेती है। व्यावसायिक चुनौतियाँ चरम पर हो सकती हैं। परन्तु यह सबसे रूपान्तरकारी चरण भी है — जो धैर्य रखते हैं वे और सशक्त होकर उभरते हैं। आध्यात्मिक साधना अत्यधिक अनुशंसित है।',
        2:'शनि आपकी चन्द्र राशि के बाद की राशि में है, साढ़े साती का अन्तिम चरण। यह चरण मुख्य रूप से पारिवारिक वित्त, वाणी और पारिवारिक सद्भाव को प्रभावित करता है। तीव्रता कम होने लगती है, परन्तु आर्थिक अनुशासन महत्वपूर्ण रहता है। इस चरण का अन्त अधिक परिपक्वता की नई शुरुआत का प्रतीक है।'
      }
      : {
        12:'Saturn is entering the sign before your Moon sign, beginning the Sade Sati period. This phase primarily affects finances, mental peace, and domestic comfort. You may feel a sense of restlessness and undefined anxiety. Travel to unfamiliar places is possible. Focus on building inner resilience.',
        1:'Saturn is transiting directly over your Moon sign — the most intense phase of Sade Sati. This period deeply tests emotions, relationships with family (especially mother), mental health, and overall sense of security. Professional challenges may peak. However, this is also the most transformative phase — those who persevere emerge stronger. Spiritual practices are highly recommended.',
        2:'Saturn is in the sign after your Moon sign, marking the final phase of Sade Sati. This phase primarily affects family finances, speech, and family harmony. While the intensity begins to reduce, financial discipline remains important. The end of this phase marks a new beginning of greater maturity.'
      };
    const titlePrefix = hi ? 'साढ़े साती सक्रिय' : 'Sade Sati Active';
    html += `<div style="background:rgba(200,50,50,0.06);border:1px solid rgba(200,50,50,0.2);border-radius:12px;padding:18px;margin-top:16px">`;
    html += `<h4 style="color:var(--accent-red);font-family:Plus Jakarta Sans,sans-serif;margin:0 0 10px 0">&#x26A0;&#xFE0F; ${titlePrefix} — ${phases[satFromMoon]}</h4>`;
    html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${phaseDescs[satFromMoon]}</div>`;
    html += `</div>`;
  } else if (satFromMoon === 4 || satFromMoon === 8) {
    const dhName = hi
      ? (satFromMoon === 4 ? 'लघु पनौती (ढैय्या) — शनि चन्द्र से चतुर्थ भाव में' : 'लघु पनौती (ढैय्या) — शनि चन्द्र से अष्टम भाव में')
      : (satFromMoon === 4 ? 'Small Panoti (Dhaiya) — Saturn in 4th from Moon' : 'Small Panoti (Dhaiya) — Saturn in 8th from Moon');
    const dhDesc = hi
      ? (satFromMoon === 4
        ? 'चन्द्रमा से चतुर्थ भाव में शनि का गोचर घरेलू शान्ति, माता के स्वास्थ्य, सम्पत्ति मामलों, वाहनों और मानसिक सुख को प्रभावित करता है। घर पर कुछ भावनात्मक भारीपन या चुनौतियाँ अनुभव हो सकती हैं। यह ढाई वर्ष की अवधि है जिसमें व्यक्तिगत मामलों में धैर्य आवश्यक है।'
        : 'चन्द्रमा से अष्टम भाव में शनि का गोचर स्वास्थ्य, दीर्घायु सम्बन्धी चिन्ताओं, अचानक बाधाओं और रूपान्तरकारी अनुभवों को प्रभावित करता है। यह अप्रत्याशित परिवर्तनों और सम्भावित स्वास्थ्य समस्याओं का काल है। जोखिम में विवेक और नियमित स्वास्थ्य जाँच अनुशंसित है।')
      : (satFromMoon === 4
        ? 'Saturn transiting the 4th from Moon affects domestic peace, mother\'s health, property matters, vehicles, and mental comfort. You may experience some emotional heaviness or challenges at home. This is a 2.5-year period requiring patience in personal matters.'
        : 'Saturn transiting the 8th from Moon affects health, longevity concerns, sudden obstacles, and transformative experiences. This is a period of unexpected changes and potential health issues. Prudence with risks and regular health check-ups are advised.');
    html += `<div style="background:rgba(200,150,50,0.08);border:1px solid rgba(200,150,50,0.3);border-radius:12px;padding:18px;margin-top:16px">`;
    html += `<h4 style="color:#c89632;font-family:Plus Jakarta Sans,sans-serif;margin:0 0 10px 0">&#x26A0;&#xFE0F; ${dhName}</h4>`;
    html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${dhDesc}</div>`;
    html += `</div>`;
  }
  return html;
}

function buildJupiterTransitReading(jupFromMoon, jupSign, moonSignEng, year, qData) {
  const jupiterHouseReadings = {
    1: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Excellent — Peak Fortune', text:'Jupiter transiting over your Moon sign is one of the most auspicious transits. It brings personal growth, optimism, health improvement, wisdom, and a general sense of well-being. New opportunities arise naturally. Self-confidence soars and you feel expansive and generous. This is an ideal time to start new ventures, take on leadership roles, and make important life decisions.'},
    2: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Excellent — Wealth & Family', text:'Jupiter in the 2nd from Moon is highly favorable for financial growth, family harmony, savings, and accumulation of assets. Speech becomes sweet and influential. Investments made during this period tend to yield good returns. Family celebrations and increase in family members (births/marriages) are possible. Food and nourishment improve.'},
    3: {rating:'&#x2B50;', summary:'Challenging — Effort Required', text:'Jupiter in the 3rd from Moon is generally not considered favorable in Vedic transit analysis. It may bring obstacles in plans, disagreements with siblings, and stagnation in growth. Communication efforts may not yield expected results. Short travels may be unsatisfying. However, self-effort and perseverance can mitigate the effects. Focus on completing pending projects.'},
    4: {rating:'&#x2B50;&#x2B50;', summary:'Mixed — Emotional Growth', text:'Jupiter in the 4th from Moon brings mixed results. While there may be some domestic unrest or changes in living situation, it also promotes inner growth, spiritual reflection, and academic pursuits. Property matters may stall. Mother may need attention. Educational endeavors benefit from deeper study and contemplation. Emotional maturity increases.'},
    5: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Outstanding — Great Fortune', text:'Jupiter in the 5th from Moon is one of the best possible transits. It bestows intelligence, creativity, romance, children-related happiness, and spiritual merit (Purva Punya activation). Students excel in examinations. Creative professionals achieve recognition. Romantic relationships deepen or new love enters life. Investments in speculation may prosper. Spiritual practices bear fruit.'},
    6: {rating:'&#x2B50;&#x2B50;', summary:'Mixed — Obstacles with Hidden Benefits', text:'Jupiter in the 6th from Moon may bring health concerns, debts, or enmity with others. However, it also gives the strength to overcome enemies and can bring legal victories. Health issues are usually manageable with attention. Borrowing should be avoided. Service-oriented activities bring karmic merit. Competition can be defeated through righteous effort.'},
    7: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Very Good — Relationships & Partnerships', text:'Jupiter in the 7th from Moon is very favorable for marriage, partnerships, and business collaborations. New beneficial alliances form. Existing relationships become more harmonious and fulfilling. Business partnerships prosper. Travel, especially to distant places, is beneficial. Social reputation improves significantly. Good period for negotiations and contracts.'},
    8: {rating:'&#x2B50;', summary:'Difficult — Transformation Period', text:'Jupiter in the 8th from Moon is one of the more challenging transits. It may bring sudden obstacles, health concerns, mental stress, and delays in important matters. However, it also deepens occult knowledge, promotes research, and can bring unexpected inheritances. Caution with health and finances is essential. This is a period of deep inner transformation.'},
    9: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Outstanding — Supreme Fortune', text:'Jupiter in the 9th from Moon (its natural house of Dharma) is supremely auspicious. Fortune smiles, spiritual growth accelerates, long-distance travel (especially pilgrimages) is likely, and guidance from teachers/mentors comes naturally. Higher education flourishes. Father\'s blessings strengthen. Legal matters resolve favorably. This is considered the most fortunate Jupiter transit.'},
    10: {rating:'&#x2B50;&#x2B50;', summary:'Mixed — Career Challenges', text:'Jupiter in the 10th from Moon brings mixed results for career. While ambition increases, there may be dissatisfaction with current position or conflicts with authority. Job changes are possible. However, righteous conduct during this period builds long-term professional reputation. Public image fluctuates. Focus on ethical behavior and patience brings eventual rewards.'},
    11: {rating:'&#x2B50;&#x2B50;&#x2B50;&#x2B50;&#x2B50;', summary:'Outstanding — Gains & Fulfillment', text:'Jupiter in the 11th from Moon is supremely favorable for gains, fulfillment of desires, new friendships, and expansion of social network. Income increases from multiple sources. Investments yield profits. Elder siblings prosper. All wishes find favorable winds. This is an excellent period for networking, launching new projects, and expanding business. Dreams come within reach.'},
    12: {rating:'&#x2B50;&#x2B50;', summary:'Mixed — Expenditure & Spiritual Growth', text:'Jupiter in the 12th from Moon may increase expenses, bring some isolation, or cause losses. However, it strongly favors spiritual retreats, foreign travel, charitable giving, and liberation-seeking activities. Donations made during this period generate great merit. Sleep quality may be affected. This transit prepares the ground for Jupiter\'s entry into your sign, which follows — so endings lead to new beginnings.'}
  };

  const reading = jupiterHouseReadings[jupFromMoon] || {rating:'&#x2B50;&#x2B50;&#x2B50;', summary:'Moderate', text:'Jupiter brings its expansion and wisdom to this area of your life from Moon sign.'};

  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-top:12px">`;
  html += `<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0;font-size:0.98em">Jupiter in ${ordinal(jupFromMoon)} House from ${moonSignEng} (${RASHIS[jupSign].eng})</h4>`;
  html += `<span style="font-size:0.85em">${reading.rating} — ${reading.summary}</span>`;
  html += `</div>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${reading.text}</div>`;

  // Check for sign change during the year
  const jupQ1 = qData[0].positions.Jupiter;
  const jupQ4 = qData[3].positions.Jupiter;
  if (jupQ1.sign !== jupQ4.sign) {
    const newFrom = jupQ4.fromMoon;
    const newReading = jupiterHouseReadings[newFrom] || {summary:'Transition'};
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);font-size:0.9em;color:var(--text-dim)">`;
    html += `<b>Note:</b> Jupiter changes sign during ${year} — moving from ${jupQ1.rashi.eng} to ${jupQ4.rashi.eng} (${ordinal(newFrom)} from Moon). The latter part of the year shifts the theme to: <b>${newReading.summary}</b>.`;
    html += `</div>`;
  }
  html += `</div>`;
  return html;
}

function buildSaturnTransitReading(satFromMoon, satSign, moonSignEng, year) {
  const saturnHouseReadings = {
    1: {rating:'Challenging', text:'Saturn directly over the Moon sign brings a period of emotional heaviness, responsibilities, and karmic reckoning. Health and mental peace need careful attention. Relationships with elders and authority figures become more complex. However, disciplined effort leads to lasting achievements. This is the heart of Sade Sati for your rashi.'},
    2: {rating:'Moderate-Difficult', text:'Saturn in the 2nd from Moon affects family finances, speech, and food habits. Savings may be tested. Family dynamics become more serious. Be mindful of harsh words. Financial discipline is essential — avoid unnecessary expenditure and risky investments. Building an emergency fund is wise.'},
    3: {rating:'Favorable', text:'Saturn in the 3rd from Moon is one of its best transits. It bestows courage, successful short travels, improved communication, and victories through effort. Sibling relationships may improve. Business endeavors succeed through persistent work. This is a great period for starting new projects that require sustained effort.'},
    4: {rating:'Difficult', text:'Saturn in the 4th from Moon (Dhaiya) affects domestic harmony, mother\'s health, emotional well-being, and property matters. Home may feel restrictive. Vehicle-related issues possible. Academic focus may waver. However, it builds emotional resilience and detachment from material comforts leads to inner strength.'},
    5: {rating:'Moderate-Difficult', text:'Saturn in the 5th from Moon affects creativity, romance, children-related matters, and speculative investments. Students may face concentration issues. Romantic relationships become more serious or strained. Avoid speculative investments. However, disciplined study and structured creative work can still produce good results.'},
    6: {rating:'Favorable', text:'Saturn in the 6th from Moon is a strong transit for overcoming enemies, diseases, and debts. Health issues get resolved through systematic treatment. Legal matters favor you. Competitors are defeated. Service-oriented work brings recognition. This is one of Saturn\'s most productive placements.'},
    7: {rating:'Moderate', text:'Saturn in the 7th from Moon affects partnerships, marriage, and business collaborations. Relationships become more serious and may feel heavy. Business partnerships need careful handling. Travel to distant places is possible but tiring. However, committed relationships deepen through shared responsibility.'},
    8: {rating:'Difficult', text:'Saturn in the 8th from Moon (Ashtama Shani / Dhaiya) is one of the more challenging transits. Health issues, obstacles, and unexpected changes may arise. Longevity of close ones may be a concern. Hidden matters surface. However, this transit also deepens occult knowledge and promotes transformation. Be cautious with health and safety.'},
    9: {rating:'Moderate-Difficult', text:'Saturn in the 9th from Moon may obstruct fortune, long travels, and religious activities. Father\'s health may need attention. Luck seems to require more effort than usual. Pilgrimages may be delayed. However, disciplined spiritual practice during this period builds lasting faith. Higher education requires more persistence.'},
    10: {rating:'Moderate', text:'Saturn in the 10th from Moon brings mixed career results. Professional responsibilities increase significantly. Hard work is unavoidable but rewarded. Career changes or restructuring possible. Authority comes with heavy burdens. Those in disciplined professions (law, engineering, governance) benefit most. Lasting professional foundations are built during this transit.'},
    11: {rating:'Very Favorable', text:'Saturn in the 11th from Moon is the best possible Saturn transit. It brings increased income, fulfillment of long-held desires, new valuable friendships, and recognition of past efforts. Property acquisitions succeed. Elder siblings prosper. Social circle expands with reliable, quality connections. Financial stability improves significantly.'},
    12: {rating:'Moderate-Difficult', text:'Saturn in the 12th from Moon begins the approach of Sade Sati. Expenses may rise, sleep quality may suffer, and a sense of endings pervades. Foreign travel or relocation is possible. Hospital-related expenses may occur. However, this transit strongly supports spiritual practices, charity, and letting go of attachments.'}
  };

  const reading = saturnHouseReadings[satFromMoon] || {rating:'Moderate', text:'Saturn brings its discipline and karmic lessons to this area.'};

  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-top:12px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">Saturn in ${ordinal(satFromMoon)} House from ${moonSignEng} (${RASHIS[satSign].eng}) — ${reading.rating}</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${reading.text}</div>`;
  html += `</div>`;
  return html;
}

function buildRahuKetuTransitReading(rahuFrom, ketuFrom, rahuSign, ketuSign, moonSignEng) {
  const rahuKetuReadings = {
    1: {rahu:'Rahu over Moon sign brings obsessive thinking, identity confusion, and worldly ambitions. Foreign connections increase. Unconventional desires surface. Guard against deception and over-ambition. Meditation and grounding practices are essential.', ketu:'Ketu over Moon sign brings spiritual awakening, detachment from ego, and psychic sensitivity. Past-life karmas manifest. Identity undergoes transformation. While confusing, this is a deeply spiritual transit that promotes liberation.'},
    2: {rahu:'Rahu in the 2nd from Moon affects speech, finances, and family. Sudden financial opportunities (and risks) arise. Speech may become manipulative — guard against dishonesty. Unusual food habits may develop. Foreign-sourced income possible.', ketu:'Ketu in the 2nd from Moon may cause financial uncertainty, detachment from family, or speech-related issues. Savings may fluctuate. However, it promotes non-attachment to material wealth and deeper family understanding.'},
    3: {rahu:'Rahu in the 3rd from Moon is generally favorable — it amplifies courage, communication skills, and entrepreneurial drive. Technology-related ventures succeed. Short travels multiply. Siblings may behave unexpectedly but beneficially.', ketu:'Ketu in the 3rd from Moon reduces initiative and conventional courage but enhances intuitive decision-making. Communication becomes more subtle and spiritual. Siblings may face changes.'},
    4: {rahu:'Rahu in the 4th from Moon disrupts domestic peace but may bring unexpected property opportunities. Mother\'s health needs watching. Home environment feels foreign. Real estate speculation possible but risky.', ketu:'Ketu in the 4th from Moon creates detachment from home comforts and may cause relocation. Mother\'s health or emotional well-being needs attention. Inner peace comes through spiritual practices rather than material comforts.'},
    5: {rahu:'Rahu in the 5th from Moon affects children, creativity, and romance with intensity. Speculative tendencies increase — caution is needed. Unusual romantic attractions possible. Creativity takes unconventional forms. Students may pursue foreign education.', ketu:'Ketu in the 5th from Moon brings spiritual intelligence and past-life memories. Children may cause concern. Romantic relationships become less worldly. Creative expression turns inward and meditative. Students benefit from contemplative studies.'},
    6: {rahu:'Rahu in the 6th from Moon is one of its best placements — victory over enemies, overcoming obstacles through clever strategies, and success in competitive exams. Health issues get innovative solutions. Legal battles favor you.', ketu:'Ketu in the 6th from Moon helps dissolve enmities and overcome chronic health issues through alternative healing. Service-oriented activities bring spiritual merit. Enemies lose their power naturally without confrontation.'},
    7: {rahu:'Rahu in the 7th from Moon strongly affects partnerships and marriage. Unconventional relationships or foreign partners become prominent. Business partnerships with foreigners succeed. Guard against deception in relationships. Contract terms need careful scrutiny.', ketu:'Ketu in the 7th from Moon creates detachment in partnerships. Relationships may feel spiritually flat or distant. However, this promotes self-reliance and understanding of true partnership beyond material bonds.'},
    8: {rahu:'Rahu in the 8th from Moon is considered challenging — sudden events, health scares, and hidden information surfacing. However, it also deepens occult knowledge, promotes research abilities, and may bring unexpected gains through insurance or inheritance.', ketu:'Ketu in the 8th from Moon is actually one of its stronger placements — it promotes spiritual transformation, psychic abilities, and liberation from past karmic debts. Health issues may arise but resolve through alternative healing.'},
    9: {rahu:'Rahu in the 9th from Moon may disrupt religious beliefs or create confusion about dharma. Unconventional spiritual paths attract. Father\'s health needs attention. Foreign long travels are very likely. Higher education in foreign institutions possible.', ketu:'Ketu in the 9th from Moon deepens spiritual wisdom beyond conventional religion. Pilgrimages to remote places. Father figure\'s influence transforms. Past-life spiritual merit (Purva Punya) activates. Guru\'s blessings manifest unexpectedly.'},
    10: {rahu:'Rahu in the 10th from Moon can bring sudden career elevation, fame, and powerful positions — but through unconventional means. Professional reputation may fluctuate. Foreign career opportunities abound. Guard against ethical shortcuts in the workplace.', ketu:'Ketu in the 10th from Moon creates detachment from worldly ambition and career. Professional direction may feel unclear. However, service-oriented or spiritual careers thrive. Past professional karma resolves.'},
    11: {rahu:'Rahu in the 11th from Moon is excellent for gains, large-network building, and fulfillment of ambitious desires. Income from foreign or technology-related sources increases. Social circle expands dramatically. Elder siblings prosper.', ketu:'Ketu in the 11th from Moon reduces material gains but increases spiritual friendships and connections with like-minded seekers. Desires become simpler. Social circle may shrink but becomes more meaningful.'},
    12: {rahu:'Rahu in the 12th from Moon increases expenditure, foreign travel, and may cause sleep disturbances or vivid dreams. Hospital-related events possible. However, it also promotes meditation, spiritual retreats abroad, and liberation-seeking activities.', ketu:'Ketu in the 12th from Moon is one of its best placements — it strongly promotes spiritual liberation (moksha), meditation, and transcendence. Dreams become prophetic. Past-life connections activate. Expenses may increase but for spiritual purposes.'}
  };

  const rReading = rahuKetuReadings[rahuFrom] || {};
  const kReading = rahuKetuReadings[ketuFrom] || {};

  let html = `<div style="display:flex;flex-direction:column;gap:14px;margin-top:12px">`;
  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">Rahu in ${ordinal(rahuFrom)} House from ${moonSignEng} (${RASHIS[rahuSign].eng})</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${rReading.rahu || 'Rahu brings its ambitious and unconventional energy to this house from your Moon sign.'}</div>`;
  html += `</div>`;
  html += `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 10px 0;font-size:0.98em">Ketu in ${ordinal(ketuFrom)} House from ${moonSignEng} (${RASHIS[ketuSign].eng})</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.6">${kReading.ketu || 'Ketu brings spiritual detachment and karmic resolution to this area.'}</div>`;
  html += `</div></div>`;
  return html;
}

function buildRashiPhalLifeAreas(moonSign, jupFrom, satFrom, rahuFrom, ketuFrom, qData) {
  let html = '<div style="display:flex;flex-direction:column;gap:14px;margin-top:12px">';

  // Career from Moon
  let careerText = '';
  const sat10 = satFrom === 10, jup10 = jupFrom === 10;
  if ([3,6,10,11].includes(satFrom)) careerText += 'Saturn\'s transit is favorable for career, supporting disciplined growth and structural achievements. ';
  else if ([1,4,8].includes(satFrom)) careerText += 'Saturn\'s transit creates professional pressure — extra effort and patience needed for career progress. ';
  if ([1,2,5,7,9,11].includes(jupFrom)) careerText += 'Jupiter\'s transit supports career growth through wisdom, opportunities, and beneficial associations. ';
  else if ([3,6,8,12].includes(jupFrom)) careerText += 'Jupiter\'s transit is not particularly helpful for career — rely on self-effort rather than luck. ';
  if ([3,6,10,11].includes(rahuFrom)) careerText += 'Rahu supports ambitious career moves and unconventional professional opportunities. ';
  html += `<div class="year-area"><h4><span>&#127919;</span> Career</h4><div class="area-body">${careerText || 'Career proceeds at a steady pace this year.'}</div></div>`;

  // Finance from Moon
  let finText = '';
  if ([2,5,9,11].includes(jupFrom)) finText += 'Jupiter strongly favors financial growth — new income channels and wise investments prosper. ';
  if (satFrom === 11) finText += 'Saturn in 11th from Moon is excellent for steady income growth and fulfillment of material desires. ';
  else if ([2,8,12].includes(satFrom)) finText += 'Saturn\'s transit calls for financial caution — avoid risky investments and build savings. ';
  if ([2,6,11].includes(rahuFrom)) finText += 'Rahu may bring sudden financial opportunities (and risks) — unconventional income sources possible. ';
  html += `<div class="year-area"><h4><span>&#128176;</span> Finance</h4><div class="area-body">${finText || 'Financial situation remains moderate — disciplined management is key.'}</div></div>`;

  // Relationships from Moon
  let relText = '';
  if ([1,5,7,9].includes(jupFrom)) relText += 'Jupiter\'s influence on relationship houses brings harmony, understanding, and joyful connections. ';
  if ([1,4,7].includes(satFrom)) relText += 'Saturn\'s transit requires patience in relationships — emotional distances may be felt but lead to mature bonding. ';
  if (rahuFrom === 7) relText += 'Rahu in the 7th from Moon brings intense and possibly unconventional relationship dynamics. ';
  if (ketuFrom === 7) relText += 'Ketu in the 7th from Moon promotes spiritual understanding in partnerships but may cause emotional distance. ';
  html += `<div class="year-area"><h4><span>&#10084;&#65039;</span> Relationships</h4><div class="area-body">${relText || 'Relationships remain stable with gradual deepening through shared experiences.'}</div></div>`;

  // Health from Moon
  let healthText = '';
  if ([1,6,8].includes(satFrom)) healthText += 'Saturn\'s transit warrants careful attention to health — chronic conditions may flare up. Regular routines and rest are vital. ';
  if ([1,8].includes(rahuFrom)) healthText += 'Rahu\'s transit may cause anxiety, sleep disturbance, or mysterious health symptoms. ';
  if ([1,6].includes(jupFrom)) healthText += 'Jupiter provides a protective influence on health — recovery from illnesses is swift. ';
  else if (jupFrom === 8) healthText += 'Jupiter in 8th from Moon requires health vigilance despite its general beneficence. ';
  html += `<div class="year-area"><h4><span>&#128154;</span> Health</h4><div class="area-body">${healthText || 'Health remains generally stable — maintain healthy habits for best results.'}</div></div>`;

  // Spirituality from Moon
  let spiritText = '';
  if ([5,9,12].includes(jupFrom)) spiritText += 'Jupiter in a dharma or moksha house from Moon strongly activates spiritual growth, pilgrimage possibilities, and devotional practices. ';
  if ([5,9,12].includes(ketuFrom)) spiritText += 'Ketu in a spiritual house from Moon deepens meditative experiences, past-life recall, and liberation-seeking practices. ';
  if ([4,8,12].includes(satFrom)) spiritText += 'Saturn\'s transit through introspective houses promotes detachment and karmic understanding. ';
  html += `<div class="year-area"><h4><span>&#128992;</span> Spirituality</h4><div class="area-body">${spiritText || 'Spiritual growth continues steadily — consistent practice will deepen insights.'}</div></div>`;

  html += '</div>';
  return html;
}

function buildRashiPhalQuarters(qData, moonSign) {
  let html = '<div style="display:flex;flex-direction:column;gap:14px;margin-top:12px">';
  qData.forEach(q => {
    html += `<div class="quarter-card"><h4>${q.label}</h4><div class="q-body">`;
    const jup = q.positions.Jupiter;
    const sat = q.positions.Saturn;
    const rahu = q.positions.Rahu;
    const mars = q.positions.Mars;
    const ven = q.positions.Venus;
    html += `<b>Jupiter</b> in ${ordinal(jup.fromMoon)} from Moon (${jup.rashi.eng}). `;
    html += `<b>Saturn</b> in ${ordinal(sat.fromMoon)} from Moon (${sat.rashi.eng}). `;
    html += `<b>Rahu</b> in ${ordinal(rahu.fromMoon)} from Moon (${rahu.rashi.eng}). `;
    html += `<b>Mars</b> in ${ordinal(mars.fromMoon)} from Moon (${mars.rashi.eng}). `;
    html += `<b>Venus</b> in ${ordinal(ven.fromMoon)} from Moon (${ven.rashi.eng}). `;
    html += '<br><br>';
    // Brief quarter assessment
    let score = 0;
    if ([1,2,5,7,9,11].includes(jup.fromMoon)) score += 2;
    if ([3,6,11].includes(sat.fromMoon)) score += 1;
    if ([3,6,10,11].includes(rahu.fromMoon)) score += 1;
    if ([3,6,10,11].includes(mars.fromMoon)) score += 1;
    if ([1,4,5,7,9,11].includes(ven.fromMoon)) score += 1;
    if ([1,4,8].includes(sat.fromMoon)) score -= 1;
    if ([3,8,12].includes(jup.fromMoon)) score -= 1;
    html += `<b>Quarter Assessment:</b> ${score >= 4 ? 'Very Favorable' : score >= 2 ? 'Favorable' : score >= 0 ? 'Moderate' : 'Challenging'}.`;
    html += '</div></div>';
  });
  html += '</div>';
  return html;
}

// ---- ENHANCED REMEDIES ----

function renderRemedies() {
  if (!currentChart) return;
  const c = currentChart;
  const asc = c.ascRashi.index;

  // Current transit data
  const now = new Date();
  const nowJD = julianDay(now.getFullYear(), now.getMonth() + 1, now.getDate(), 12);
  const transitPlanets = calculatePlanets(nowJD);
  const moonSign = c.planets.Moon.rashi.index;

  // Compute functional benefics/malefics
  const cls = classifyPlanets(asc);

  // Analyze chart for weak/afflicted planets with comprehensive scoring
  const remedyPlanets = [];
  const planetOrder = ["Sun","Moon","Mars","Mercury","Jupiter","Venus","Saturn","Rahu","Ketu"];
  const debilSigns = {Sun:6,Moon:7,Mars:3,Mercury:11,Jupiter:9,Venus:5,Saturn:0,Rahu:8,Ketu:2};
  const exaltSigns = {Sun:0,Moon:1,Mars:9,Mercury:5,Jupiter:3,Venus:11,Saturn:6};
  const ownSigns = {Sun:[4],Moon:[3],Mars:[0,7],Mercury:[2,5],Jupiter:[8,11],Venus:[1,6],Saturn:[9,10]};

  planetOrder.forEach(pName => {
    const p = c.planets[pName];
    const info = PLANETS_INFO[pName];
    let urgency = 0; // 0-10 scale
    const reasons = [];
    const remedyTypes = [];

    // Debilitation check (major affliction)
    if (debilSigns[pName] !== undefined && p.rashi.index === debilSigns[pName]) {
      urgency += 4;
      reasons.push('Debilitated in natal chart — significantly weakened');
      remedyTypes.push('strengthen');
    }

    // Exaltation check (beneficial — reduces urgency)
    if (exaltSigns[pName] === p.rashi.index) {
      urgency -= 2;
      reasons.push('Exalted — naturally strong');
    }

    // Own sign (beneficial)
    if (ownSigns[pName] && ownSigns[pName].includes(p.rashi.index)) {
      urgency -= 1;
      reasons.push('In own sign — self-sufficient');
    }

    // Dusthana placement
    if ([6, 8, 12].includes(p.house)) {
      urgency += 2;
      reasons.push(`In ${ordinal(p.house)} house (dusthana) — karmic challenges`);
      remedyTypes.push('propitiate');
    }

    // Functional malefic for this ascendant
    if (cls.malefics && cls.malefics.includes(pName)) {
      urgency += 1;
      reasons.push('Functional malefic for your ascendant');
      remedyTypes.push('propitiate');
    }

    // Functional benefic in bad position
    if (cls.benefics && cls.benefics.includes(pName) && [6,8,12].includes(p.house)) {
      urgency += 2;
      reasons.push('Benefic planet in a difficult house — good results are blocked');
      remedyTypes.push('strengthen');
    }

    // Yogakaraka weakened
    if (cls.yogakaraka === pName && urgency > 0) {
      urgency += 2;
      reasons.push('Yogakaraka weakened — strengthening is critical for overall fortune');
      remedyTypes.push('strengthen');
    }

    // Current transit affliction (Sade Sati, etc.)
    if (pName === 'Saturn') {
      const satTransitSign = Math.floor(transitPlanets.Saturn / 30) % 12;
      const satFromMoon = ((satTransitSign - moonSign + 12) % 12) + 1;
      if ([12,1,2].includes(satFromMoon)) {
        urgency += 3;
        const phase = {12:'Rising',1:'Peak',2:'Setting'}[satFromMoon];
        reasons.push(`Sade Sati active (${phase} phase) — Saturn remedies are urgent`);
        remedyTypes.push('propitiate');
      } else if (satFromMoon === 4 || satFromMoon === 8) {
        urgency += 2;
        reasons.push(`Dhaiya (Small Panoti) active — Saturn in ${ordinal(satFromMoon)} from Moon`);
        remedyTypes.push('propitiate');
      }
    }

    // Rahu-Ketu transit over natal Moon
    if (pName === 'Rahu' || pName === 'Ketu') {
      const transitSign = Math.floor(transitPlanets[pName] / 30) % 12;
      if (transitSign === moonSign) {
        urgency += 2;
        reasons.push(`Currently transiting over your Moon sign — mental stress likely`);
        remedyTypes.push('propitiate');
      }
    }

    // Current dasha lord — if running, remedies more impactful
    let isCurrentDashaLord = false;
    if (c.dashas) {
      c.dashas.forEach(md => {
        if (now >= md.startDate && now < md.endDate && md.lord === pName) {
          isCurrentDashaLord = true;
          urgency += 1;
          reasons.push('Currently running Mahadasha — remedies will have maximum impact');
        }
        if (md.antardashas) {
          md.antardashas.forEach(ad => {
            if (now >= ad.startDate && now < ad.endDate && ad.lord === pName) {
              isCurrentDashaLord = true;
              urgency += 1;
              reasons.push('Currently running Antardasha — remedies are timely');
            }
          });
        }
      });
    }

    // Combust (too close to Sun)
    if (!['Sun','Rahu','Ketu'].includes(pName)) {
      const sunLon = c.planets.Sun.longitude;
      const plLon = p.longitude;
      if (sunLon !== undefined && plLon !== undefined) {
        const diff = Math.abs(sunLon - plLon);
        const angDiff = diff > 180 ? 360 - diff : diff;
        const combustLimits = {Moon:12, Mars:17, Mercury:14, Jupiter:11, Venus:10, Saturn:15};
        if (angDiff < (combustLimits[pName] || 10)) {
          urgency += 2;
          reasons.push('Combust (too close to Sun) — planet\'s significations are weakened');
          remedyTypes.push('strengthen');
        }
      }
    }

    // Normalize urgency
    urgency = Math.max(0, Math.min(10, urgency));
    const priority = urgency >= 5 ? 'high' : urgency >= 2 ? 'medium' : 'low';

    remedyPlanets.push({
      name: pName, info, priority, urgency, reasons,
      remedyTypes: [...new Set(remedyTypes)],
      house: p.house, rashi: p.rashi, isCurrentDashaLord
    });
  });

  // Sort by urgency (highest first)
  remedyPlanets.sort((a, b) => b.urgency - a.urgency);

  let html = '';

  // Expert Summary
  html += buildRemedySummary(c, remedyPlanets, transitPlanets, moonSign, cls);

  // Priority Remedies (high urgency first)
  html += '<div style="margin-top:24px"><div class="section-title" style="font-size:1.05em"><span class="icon">&#x1F48E;</span> Planet-wise Remedies (Prioritized)</div></div>';

  remedyPlanets.forEach(rp => {
    if (rp.urgency <= 0 && rp.priority === 'low') return; // Skip very low urgency planets

    const i = rp.info;
    const color = PLANET_COLORS[rp.name];
    const priorityClass = `priority-${rp.priority}`;
    const urgencyBar = '&#x2588;'.repeat(Math.max(1, rp.urgency)) + '<span style="opacity:0.2">' + '&#x2588;'.repeat(Math.max(0, 10 - rp.urgency)) + '</span>';

    html += `<div class="remedy-card">
      <h4><span style="color:${color}">${i.symbol}</span> ${i.sanskrit} (${rp.name}) <span class="remedy-priority ${priorityClass}">${rp.priority} priority</span></h4>
      <div style="font-size:0.75em;color:var(--text-dim);margin-bottom:6px">Urgency: <span style="font-family:monospace;letter-spacing:-1px">${urgencyBar}</span> (${rp.urgency}/10)</div>
      <div style="font-size:0.85em;color:var(--text);margin-bottom:12px;line-height:1.5">`;

    rp.reasons.forEach(r => {
      html += `<span style="display:inline-block;background:rgba(212,113,10,0.08);border-radius:6px;padding:2px 8px;margin:2px 4px 2px 0;font-size:0.9em">${r}</span>`;
    });

    html += `</div>
      <div class="remedy-item"><span class="remedy-label">&#x1F48E; Gemstone</span><span class="remedy-value">${i.gem}${rp.remedyTypes.includes('strengthen') ? ' <b>(Recommended)</b>' : ''}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F4FF; Mantra</span><span class="remedy-value">${i.mantra}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F3A8; Favorable Color</span><span class="remedy-value">${i.color}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F4C5; Day</span><span class="remedy-value">${i.day}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F64F; Deity</span><span class="remedy-value">${i.deity}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F381; Donate</span><span class="remedy-value">${i.donate}</span></div>
      <div class="remedy-item"><span class="remedy-label">&#x1F374; Fasting</span><span class="remedy-value">${i.fast}</span></div>`;

    // Additional specific remedies based on context
    html += buildSpecificRemedies(rp);

    html += `</div>`;
  });

  document.getElementById('remedyGrid').innerHTML = html;
}

function buildRemedySummary(chart, remedyPlanets, transitPlanets, moonSign, cls) {
  const highPriority = remedyPlanets.filter(r => r.priority === 'high');
  const medPriority = remedyPlanets.filter(r => r.priority === 'medium');

  // Current dasha
  const now = new Date();
  let currentMD = '', currentAD = '';
  if (chart.dashas) {
    chart.dashas.forEach(md => {
      if (now >= md.startDate && now < md.endDate) {
        currentMD = md.lord;
        if (md.antardashas) {
          md.antardashas.forEach(ad => {
            if (now >= ad.startDate && now < ad.endDate) currentAD = ad.lord;
          });
        }
      }
    });
  }

  // Sade Sati check
  const satTransitSign = Math.floor(transitPlanets.Saturn / 30) % 12;
  const satFromMoon = ((satTransitSign - moonSign + 12) % 12) + 1;
  const isSadeSati = [12,1,2].includes(satFromMoon);
  const isDhaiya = satFromMoon === 4 || satFromMoon === 8;

  let html = `<div style="background:linear-gradient(135deg,rgba(212,113,10,0.06),rgba(52,73,94,0.04));border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px">`;
  html += `<h3 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 14px 0;font-size:1.1em">&#x1F9D9; Analysis & Remedy Recommendations</h3>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.7">`;

  // Current dasha context
  if (currentMD) {
    html += `<b>Current Period:</b> ${currentMD} Mahadasha`;
    if (currentAD) html += ` / ${currentAD} Antardasha`;
    html += '. ';
    const mdPl = remedyPlanets.find(r => r.name === currentMD);
    if (mdPl && mdPl.urgency >= 3) {
      html += `<span style="color:var(--accent-red)">The current Mahadasha lord ${currentMD} is afflicted in your chart — focused remedies for ${currentMD} will have the strongest impact during this period.</span> `;
    } else if (mdPl) {
      html += `${currentMD} is reasonably well-placed, supporting a generally productive period. `;
    }
    if (currentAD) {
      const adPl = remedyPlanets.find(r => r.name === currentAD);
      if (adPl && adPl.urgency >= 3) {
        html += `The Antardasha lord ${currentAD} also needs remedial attention for best results during this sub-period. `;
      }
    }
  }

  // Sade Sati warning
  if (isSadeSati) {
    html += `<br><br><span style="color:var(--accent-red)"><b>&#x26A0; Sade Sati is currently active</b> — Saturn remedies are the single most important remedial action right now. Regular Hanuman Chalisa recitation, Shani mantras, and donations on Saturdays are strongly advised. Wearing a Blue Sapphire is recommended ONLY after careful analysis — an Iron ring (Shani ki Anguthi) is a safer alternative.</span> `;
  } else if (isDhaiya) {
    html += `<br><br><span style="color:#c89632"><b>&#x26A0; Dhaiya (Small Panoti) is active</b> — Saturn remedies will help alleviate the pressure. Regular Saturday fasting and Hanuman worship are beneficial.</span> `;
  }

  // Top priority planets
  if (highPriority.length > 0) {
    html += `<br><br><b>Most Urgent Remedies Needed For:</b> `;
    highPriority.forEach(rp => {
      html += `<span style="display:inline-block;background:rgba(200,50,50,0.1);color:var(--accent-red);border-radius:8px;padding:3px 10px;margin:3px;font-weight:500">${rp.info.symbol} ${rp.name}</span>`;
    });
    html += '. These planets are significantly afflicted and require priority attention. ';
  }

  if (medPriority.length > 0) {
    html += `<br><b>Secondary Remedies Recommended For:</b> `;
    medPriority.forEach(rp => {
      html += `<span style="display:inline-block;background:rgba(200,150,50,0.1);color:#b8860b;border-radius:8px;padding:3px 10px;margin:3px;font-weight:500">${rp.info.symbol} ${rp.name}</span>`;
    });
    html += '. ';
  }

  // Yogakaraka note
  if (cls.yogakaraka) {
    html += `<br><br><b>Yogakaraka:</b> ${cls.yogakaraka} is the most beneficial planet for your ${chart.ascRashi.eng} ascendant. Strengthening ${cls.yogakaraka} through gemstone, mantra, and worship of its deity will bring the greatest overall benefit to your life.`;
  }

  // General timing advice
  html += `<br><br><b>General Remedy Guidelines:</b> Mantras are most effective when chanted during the planet\'s hora (planetary hour) or on the planet\'s day. Gemstones should ideally be worn after proper energization (Prāṇa Pratiṣṭhā) on the planet\'s day during the appropriate hora. Donations and fasting generate the strongest results during the relevant planet\'s dasha or transit period.`;

  html += `</div></div>`;

  // Daily Remedy Routine
  html += buildDailyRemedyRoutine(highPriority, medPriority, isSadeSati, isDhaiya, currentMD, currentAD);

  return html;
}

function buildDailyRemedyRoutine(highPri, medPri, isSadeSati, isDhaiya, currentMD, currentAD) {
  let html = `<div style="background:rgba(245,244,240,0.7);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px">`;
  html += `<h4 style="font-family:Plus Jakarta Sans,sans-serif;color:var(--saffron);margin:0 0 12px 0;font-size:1em">&#x1F4CB; Recommended Daily/Weekly Remedy Routine</h4>`;
  html += `<div style="font-size:0.92em;color:var(--text);line-height:1.7">`;

  // Morning routine
  html += `<b>Morning (Brahma Muhurta — before sunrise):</b><br>`;
  html += `• Light a diya (oil lamp) and offer prayers to your Ishta Devata<br>`;
  if (highPri.length > 0) {
    html += `• Chant the mantra of your most afflicted planet: <b>${highPri[0].info.mantra}</b> (${highPri[0].name}) — minimum 108 times<br>`;
    if (highPri.length > 1) {
      html += `• Additionally chant: <b>${highPri[1].info.mantra}</b> (${highPri[1].name}) — 21 or 108 times<br>`;
    }
  }
  html += `• Surya Namaskar and Gayatri Mantra (strengthens Sun and overall vitality)<br>`;

  // Weekly schedule
  html += `<br><b>Weekly Schedule:</b><br>`;
  const dayPlanets = {
    'Sunday': 'Sun', 'Monday': 'Moon', 'Tuesday': 'Mars',
    'Wednesday': 'Mercury', 'Thursday': 'Jupiter', 'Friday': 'Venus', 'Saturday': 'Saturn'
  };
  const allPriority = [...highPri, ...medPri];
  const priorityNames = allPriority.map(r => r.name);

  Object.entries(dayPlanets).forEach(([day, planet]) => {
    const rp = allPriority.find(r => r.name === planet);
    if (rp) {
      html += `• <b>${day}</b>: ${rp.info.mantra} (108×). `;
      if (rp.info.fast) html += `Fast or eat light. `;
      if (rp.info.donate) html += `Donate: ${rp.info.donate}. `;
      html += `Wear ${rp.info.color} clothing.<br>`;
    }
  });

  if (isSadeSati || isDhaiya) {
    html += `<br><b>Special Saturday Routine (Sade Sati/Dhaiya):</b><br>`;
    html += `• Visit Shani temple or Hanuman temple<br>`;
    html += `• Recite Hanuman Chalisa (at least once, ideally 7 times)<br>`;
    html += `• Offer mustard oil at Shani idol<br>`;
    html += `• Donate black sesame seeds (til), iron items, or dark blankets to the needy<br>`;
    html += `• Chant "Om Sham Shanaishcharaya Namah" 108 times<br>`;
  }

  // Specific transit remedies
  html += `<br><b>Additional Recommendations for Current Period:</b><br>`;
  if (currentMD) {
    const mdInfo = PLANETS_INFO[currentMD];
    if (mdInfo) {
      html += `• Worship ${mdInfo.deity} regularly during ${currentMD} Mahadasha<br>`;
      html += `• Wear or keep ${mdInfo.gem} (after consulting an astrologer) for ${currentMD} strength<br>`;
    }
  }
  html += `• Practice meditation daily for at least 15 minutes to strengthen overall planetary balance<br>`;
  html += `• Perform charity and service (Seva) — this is the universal remedy that benefits all planetary positions<br>`;

  html += `</div></div>`;
  return html;
}

function buildSpecificRemedies(rp) {
  let html = '';
  const specificRemedies = {
    Sun: [
      'Offer water (Arghya) to the rising Sun every morning with a copper vessel',
      'Chant Aditya Hridayam Stotram on Sundays for overall vitality',
      'Respect and serve your father and father-figures',
      'Donate wheat, jaggery, or copper items on Sundays',
      'Wear a Ruby or Garnet in gold on the ring finger (right hand) on Sunday morning'
    ],
    Moon: [
      'Wear a Pearl or Moonstone in silver on the little finger (right hand) on Monday',
      'Keep a silver vessel filled with water by your bedside',
      'Respect and serve your mother; maintain close family bonds',
      'Drink water from a silver glass or vessel regularly',
      'Chant "Om Chandraya Namah" during Moon\'s hora on Mondays',
      'Donate white rice, milk, or white cloth on Mondays'
    ],
    Mars: [
      'Recite Hanuman Chalisa daily (especially on Tuesdays)',
      'Donate red lentils (masoor dal), jaggery, or red cloth on Tuesdays',
      'Wear a Red Coral (Moonga) in gold/copper on the ring finger on Tuesday',
      'Practice physical exercise regularly to channel Mars energy constructively',
      'Offer sindoor (vermillion) at Hanuman temple on Tuesdays',
      'Avoid anger and aggressive behavior — practice patience as a spiritual discipline'
    ],
    Mercury: [
      'Chant Vishnu Sahasranama or "Om Budhaya Namah" on Wednesdays',
      'Wear an Emerald in gold on the little finger (right hand) on Wednesday',
      'Donate green moong dal, green vegetables, or green cloth on Wednesdays',
      'Engage in continuous learning and skill development',
      'Feed green grass to cows on Wednesdays',
      'Practice Pranayama (breathing exercises) for mental clarity'
    ],
    Jupiter: [
      'Chant "Om Guruve Namah" or Guru Stotram on Thursdays (108 or 1008 times)',
      'Wear a Yellow Sapphire (Pukhraj) in gold on the index finger on Thursday',
      'Donate yellow items: turmeric, chana dal, bananas, or yellow cloth on Thursdays',
      'Respect teachers, elders, and learned scholars',
      'Water a Peepal tree on Thursdays and circumambulate it',
      'Study sacred texts and engage in philosophical discussions regularly'
    ],
    Venus: [
      'Chant "Om Shukraya Namah" on Fridays (108 times)',
      'Wear a Diamond or White Sapphire in platinum/silver on the middle finger on Friday',
      'Donate white items: rice, sugar, white cloth, or dairy products on Fridays',
      'Respect women and maintain harmonious relationships',
      'Engage in art, music, or creative activities regularly',
      'Offer white flowers at a Lakshmi temple on Fridays'
    ],
    Saturn: [
      'Chant "Om Sham Shanaishcharaya Namah" 108 times daily (especially on Saturdays)',
      'Recite Hanuman Chalisa daily (Hanuman is the remedy deity for Saturn)',
      'Wear a Blue Sapphire (Neelam) ONLY after thorough astrological consultation — use Iron ring as safer alternative',
      'Donate black sesame seeds (til), mustard oil, iron items, or dark blankets on Saturdays',
      'Feed crows and black dogs on Saturdays',
      'Serve elderly people and laborers — Saturn rewards humble service',
      'Visit Shani temple or Hanuman temple regularly, especially on Saturdays',
      'Practice patience, discipline, and acceptance of karmic lessons'
    ],
    Rahu: [
      'Chant "Om Raam Rahave Namah" 108 times daily',
      'Wear a Hessonite Garnet (Gomed) in silver on the middle finger on Saturday',
      'Donate dark blue or black items on Saturdays',
      'Keep a piece of sandalwood (chandan) near your pillow for peaceful sleep',
      'Offer coconut to flowing water on Saturdays',
      'Avoid intoxicants, gambling, and speculative activities during Rahu dasha',
      'Worship Goddess Durga or recite Durga Saptashati for Rahu pacification',
      'Feed birds, especially crows, to appease Rahu'
    ],
    Ketu: [
      'Chant "Om Kem Ketave Namah" 108 times daily',
      'Wear a Cat\'s Eye (Lehsunia) in silver on the middle finger after proper consultation',
      'Donate multicolored blankets, sesame seeds, or gray items on Tuesdays or Saturdays',
      'Worship Lord Ganesha regularly for Ketu pacification',
      'Practice meditation and spiritual disciplines — Ketu responds to genuine spiritual effort',
      'Feed stray dogs, especially spotted/multicolored ones',
      'Keep a Ketu yantra at your place of worship',
      'Pilgrimage and visiting sacred places helps align Ketu\'s spiritual energy'
    ]
  };

  const remedies = specificRemedies[rp.name];
  if (remedies && rp.urgency >= 1) {
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">`;
    html += `<div style="font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--saffron);font-weight:600;margin-bottom:8px">Specific Remedial Actions</div>`;
    html += `<div style="font-size:0.88em;color:var(--text);line-height:1.7">`;
    remedies.forEach(r => {
      html += `<div style="padding:4px 0;padding-left:16px;position:relative"><span style="position:absolute;left:0;color:var(--saffron)">•</span>${r}</div>`;
    });
    html += `</div></div>`;
  }
  return html;
}

// ============================================================
//  UTILITY FUNCTIONS
// ============================================================

function formatDate(d) {
  if (!(d instanceof Date)) return '';
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}

function ordinal(n) {
  const s = ['th','st','nd','rd'], v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function toggleDasha(el) {
  const body = el.nextElementSibling;
  body.classList.toggle('open');
}

function jumpToDashaAge() {
  const ageVal = document.getElementById('dashaAge').value;
  if (!ageVal && ageVal !== '0') {
    // Scroll to current
    const curr = document.querySelector('.dasha-period.current');
    if (curr) curr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  const age = parseInt(ageVal);
  const birthDate = new Date(currentChart.birthInfo.dob + 'T' + currentChart.birthInfo.tob);
  const targetDate = addYears(birthDate, age);
  // Find the mahadasha containing this age
  currentChart.dashas.forEach((md, idx) => {
    if (targetDate >= md.startDate && targetDate < md.endDate) {
      const el = document.getElementById('md-' + idx);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const body = el.querySelector('.dasha-body');
        if (body && !body.classList.contains('open')) body.classList.add('open');
      }
    }
  });
}

// ============================================================
//  CITY AUTOCOMPLETE
// ============================================================

const cityInput = document.getElementById('city');
const cityDropdown = document.getElementById('cityDropdown');

cityInput.addEventListener('input', function() {
  const val = this.value.toLowerCase().trim();
  if (val.length < 2) { cityDropdown.classList.remove('active'); updateCityIndicator(null); return; }

  // Split input on commas/spaces to match each term independently
  // e.g. "Delhi, India" matches cities where name contains "delhi" AND combined string contains "india"
  const terms = val.split(/[,\s]+/).filter(t => t.length >= 2);
  const matches = CITIES.filter(c => {
    const combined = (c.name + ' ' + c.country).toLowerCase();
    return terms.every(t => combined.includes(t));
  }).slice(0, 10);

  if (matches.length === 0) { cityDropdown.classList.remove('active'); updateCityIndicator(null); return; }

  // Auto-resolve: if exact name match or only one result, lock in coordinates
  const resolved = resolveCity(this.value);
  updateCityIndicator(resolved);
  if (resolved) {
    document.getElementById('cityLat').value = resolved.lat;
    document.getElementById('cityLon').value = resolved.lon;
    document.getElementById('cityTz').value  = resolved.tz;
  }

  cityDropdown.innerHTML = matches.map(c =>
    `<div class="city-option" data-lat="${c.lat}" data-lon="${c.lon}" data-tz="${c.tz}" data-name="${c.name}, ${c.country}">
      ${c.name} <span class="country">${c.country} &nbsp; ${c.lat.toFixed(2)}&deg;N, ${c.lon.toFixed(2)}&deg;E</span>
    </div>`
  ).join('');

  cityDropdown.classList.add('active');
});

// Show a small indicator next to city input: ✓ resolved or ✗ not found
function updateCityIndicator(resolved) {
  let ind = document.getElementById('cityIndicator');
  if (!ind) {
    ind = document.createElement('div');
    ind.id = 'cityIndicator';
    ind.style.cssText = 'font-size:0.75em;margin-top:3px;min-height:1.1em;';
    cityInput.parentNode.appendChild(ind);
  }
  if (resolved) {
    ind.innerHTML = '<span style="color:#0D9488">&#10003; ' + resolved.name + ' (' + resolved.lat.toFixed(4) + '&deg;N, ' + resolved.lon.toFixed(4) + '&deg;E, UTC' + (resolved.tz>=0?'+':'') + resolved.tz + ')</span>';
  } else if (cityInput.value.trim().length >= 2) {
    ind.innerHTML = '<span style="color:#DC4A38">&#10007; City not found — select from dropdown</span>';
  } else {
    ind.innerHTML = '';
  }
}

function selectCityOption(e) {
  const opt = e.target.closest('.city-option');
  if (!opt) return;
  e.preventDefault();
  e.stopPropagation();
  cityInput.value = opt.dataset.name;
  document.getElementById('cityLat').value = opt.dataset.lat;
  document.getElementById('cityLon').value = opt.dataset.lon;
  document.getElementById('cityTz').value = opt.dataset.tz;
  cityDropdown.classList.remove('active');
  cityInput.blur(); // dismiss mobile keyboard
  const resolved = resolveCity(opt.dataset.name);
  updateCityIndicator(resolved);
}
cityDropdown.addEventListener('click', selectCityOption);
cityDropdown.addEventListener('touchend', selectCityOption);

document.addEventListener('click', function(e) {
  if (!e.target.closest('.city-wrapper')) cityDropdown.classList.remove('active');
});

// ============================================================
//  TAB NAVIGATION
// ============================================================

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    // Scroll active tab into view on mobile
    this.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
  });
});

// ============================================================
//  STARFIELD BACKGROUND
// ============================================================

(function createStars() {
  const container = document.getElementById('stars');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    const size = Math.random() * 2 + 0.5;
    star.style.width = size + 'px';
    star.style.height = size + 'px';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    star.style.setProperty('--dur', (Math.random() * 3 + 2) + 's');
    star.style.setProperty('--max-o', Math.random() * 0.5 + 0.3);
    star.style.animationDelay = Math.random() * 3 + 's';
    container.appendChild(star);
  }
})();

// ============================================================
//  SET DEFAULT CITY
// ============================================================
(function setDefault() {
  const defaultCity = CITIES[0]; // New Delhi
  cityInput.value = defaultCity.name + ', ' + defaultCity.country;
  document.getElementById('cityLat').value = defaultCity.lat;
  document.getElementById('cityLon').value = defaultCity.lon;
  document.getElementById('cityTz').value = defaultCity.tz;
})();
</script>
</body>
</html>
